STRUCTURE:
â”œâ”€â”€ ...
â”œâ”€â”€ .gitignore
â”œâ”€â”€ INSTRUCTIONS_OAUTH.md
â”œâ”€â”€ LOCKED_FILES.md
â”œâ”€â”€ apply.js
â”œâ”€â”€ apply_status.json
â”œâ”€â”€ cleanup.js
â”œâ”€â”€ client/
â”‚   â”œâ”€â”€ .eslintrc.cjs
â”‚   â”œâ”€â”€ .gitignore
â”‚   â”œâ”€â”€ README.md
â”‚   â”œâ”€â”€ index.html
â”‚   â”œâ”€â”€ package.json
â”‚   â”œâ”€â”€ postcss.config.cjs
â”‚   â”œâ”€â”€ public/
â”‚   â”‚   â””â”€â”€ vite.svg
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ App.css
â”‚   â”‚   â”œâ”€â”€ App.jsx
â”‚   â”‚   â”œâ”€â”€ assets/
â”‚   â”‚   â”‚   â””â”€â”€ react.svg
â”‚   â”‚   â”œâ”€â”€ features/
â”‚   â”‚   â”‚   â”œâ”€â”€ admin/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ AdminPage.css
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ AdminPage.jsx
â”‚   â”‚   â”‚   â”œâ”€â”€ auth/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ Login.css
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ Login.jsx
â”‚   â”‚   â”‚   â”œâ”€â”€ eleve/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ElevePage.css
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ElevePage.jsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ BehaviorTimer.css
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ BehaviorTimer.jsx
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ DashboardFolder.css
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ DashboardFolder.jsx
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ EleveHeader.css
â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ EleveHeader.jsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ games/
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ GamesGrid.css
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ GamesGrid.jsx
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ mainGames.js
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ starship/
â”‚   â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ StarshipWrapper.jsx
â”‚   â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ starship_core.js
â”‚   â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ starship_style.css
â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ zombie/
â”‚   â”‚   â”‚   â”‚   â”‚       â”œâ”€â”€ ZombieGame.css
â”‚   â”‚   â”‚   â”‚   â”‚       â”œâ”€â”€ ZombieGame.js
â”‚   â”‚   â”‚   â”‚   â”‚       â”œâ”€â”€ ZombieWrapper.jsx
â”‚   â”‚   â”‚   â”‚   â”‚       â”œâ”€â”€ zombie_core.js
â”‚   â”‚   â”‚   â”‚   â”‚       â””â”€â”€ zombie_style.css
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ homework/
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ Homework.css
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ HomeworkList.jsx
â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ HomeworkWorkspace.jsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ mistakes/
â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ MistakesBook.jsx
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ productions/
â”‚   â”‚   â”‚   â”‚       â””â”€â”€ ProductionsList.jsx
â”‚   â”‚   â”‚   â””â”€â”€ prof/
â”‚   â”‚   â”‚       â”œâ”€â”€ Prof.css
â”‚   â”‚   â”‚       â”œâ”€â”€ ProfPage.css
â”‚   â”‚   â”‚       â”œâ”€â”€ ProfPage.jsx
â”‚   â”‚   â”‚       â”œâ”€â”€ activities/
â”‚   â”‚   â”‚       â”‚   â”œâ”€â”€ ActivityStudio.css
â”‚   â”‚   â”‚       â”‚   â””â”€â”€ ActivityStudio.jsx
â”‚   â”‚   â”‚       â”œâ”€â”€ admin/
â”‚   â”‚   â”‚       â”‚   â”œâ”€â”€ AdminDashboard.css
â”‚   â”‚   â”‚       â”‚   â””â”€â”€ AdminDashboard.jsx
â”‚   â”‚   â”‚       â”œâ”€â”€ chapters/
â”‚   â”‚   â”‚       â”‚   â””â”€â”€ ChapterManager.jsx
â”‚   â”‚   â”‚       â”œâ”€â”€ classroom/
â”‚   â”‚   â”‚       â”‚   â”œâ”€â”€ ClassroomManager.css
â”‚   â”‚   â”‚       â”‚   â””â”€â”€ ClassroomManager.jsx
â”‚   â”‚   â”‚       â”œâ”€â”€ components/
â”‚   â”‚   â”‚       â”‚   â”œâ”€â”€ ConsoleHUD.jsx
â”‚   â”‚   â”‚       â”‚   â”œâ”€â”€ ConsoleReporter.css
â”‚   â”‚   â”‚       â”‚   â”œâ”€â”€ ConsoleReporter.jsx
â”‚   â”‚   â”‚       â”‚   â”œâ”€â”€ DatabaseViewer.css
â”‚   â”‚   â”‚       â”‚   â”œâ”€â”€ DatabaseViewer.jsx
â”‚   â”‚   â”‚       â”‚   â”œâ”€â”€ DriveViewer.css
â”‚   â”‚   â”‚       â”‚   â”œâ”€â”€ DriveViewer.jsx
â”‚   â”‚   â”‚       â”‚   â”œâ”€â”€ ProfHeader.jsx
â”‚   â”‚   â”‚       â”‚   â”œâ”€â”€ ProfNav.jsx
â”‚   â”‚   â”‚       â”‚   â”œâ”€â”€ ProfStudioFolder.jsx
â”‚   â”‚   â”‚       â”‚   â”œâ”€â”€ ProjectTreeViewer.css
â”‚   â”‚   â”‚       â”‚   â”œâ”€â”€ ProjectTreeViewer.jsx
â”‚   â”‚   â”‚       â”‚   â”œâ”€â”€ SystemDocs.css
â”‚   â”‚   â”‚       â”‚   â””â”€â”€ SystemDocs.jsx
â”‚   â”‚   â”‚       â”œâ”€â”€ games/
â”‚   â”‚   â”‚       â”‚   â”œâ”€â”€ GameStudio.css
â”‚   â”‚   â”‚       â”‚   â””â”€â”€ GameStudio.jsx
â”‚   â”‚   â”‚       â”œâ”€â”€ homework/
â”‚   â”‚   â”‚       â”‚   â”œâ”€â”€ HomeworkResults.css
â”‚   â”‚   â”‚       â”‚   â”œâ”€â”€ HomeworkResults.jsx
â”‚   â”‚   â”‚       â”‚   â”œâ”€â”€ HomeworkStudio.css
â”‚   â”‚   â”‚       â”‚   â””â”€â”€ HomeworkStudio.jsx
â”‚   â”‚   â”‚       â”œâ”€â”€ scans/
â”‚   â”‚   â”‚       â”‚   â”œâ”€â”€ ScansStudio.css
â”‚   â”‚   â”‚       â”‚   â””â”€â”€ ScansStudio.jsx
â”‚   â”‚   â”‚       â”œâ”€â”€ students/
â”‚   â”‚   â”‚       â”‚   â”œâ”€â”€ StudentsManager.css
â”‚   â”‚   â”‚       â”‚   â””â”€â”€ StudentsManager.jsx
â”‚   â”‚   â”‚       â””â”€â”€ studio/
â”‚   â”‚   â”‚           â”œâ”€â”€ StudioDashboard.css
â”‚   â”‚   â”‚           â””â”€â”€ StudioDashboard.jsx
â”‚   â”‚   â”œâ”€â”€ index.css
â”‚   â”‚   â”œâ”€â”€ main.jsx
â”‚   â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”‚   â””â”€â”€ api.js
â”‚   â”‚   â”œâ”€â”€ test_ok.txt
â”‚   â”‚   â”œâ”€â”€ test_token_crash.js
â”‚   â”‚   â””â”€â”€ test_token_valid.txt
â”‚   â”œâ”€â”€ tailwind.config.cjs
â”‚   â””â”€â”€ vite.config.js
â”œâ”€â”€ git-auto.js
â”œâ”€â”€ history.txt
â”œâ”€â”€ init-db.js
â”œâ”€â”€ magic-paste.js
â”œâ”€â”€ package.json
â”œâ”€â”€ projectMap.txt
â”œâ”€â”€ public/
â”‚   â”œâ”€â”€ images/
â”‚   â”‚   â”œâ”€â”€ Fiche_Croissance_Demographique_5e.docx
â”‚   â”‚   â”œâ”€â”€ hero.png
â”‚   â”‚   â”œâ”€â”€ jetpack.png
â”‚   â”‚   â”œâ”€â”€ jumper.png
â”‚   â”‚   â”œâ”€â”€ projectile.png
â”‚   â”‚   â”œâ”€â”€ ship.png
â”‚   â”‚   â”œâ”€â”€ zombi.png
â”‚   â”‚   â””â”€â”€ ~$che_Croissance_Demographique_5e.docx
â”‚   â”œâ”€â”€ style.css
â”‚   â””â”€â”€ uploads/
â”‚       â”œâ”€â”€ 00074c1d609912c65c51155b418dabce
â”‚       â”œâ”€â”€ 052ab3c8f8468e7f52ed76c06b28b36c
â”‚       â”œâ”€â”€ 0717c54fc34cd56505db1ada55b5a128
â”‚       â”œâ”€â”€ 07b4ded2280d7ad22dc0daa2c90f4107
â”‚       â”œâ”€â”€ 0c0daa9f4b95728fbd6744579a949866
â”‚       â”œâ”€â”€ 1317d865b5a81abc4ffab8c95bd916a6
â”‚       â”œâ”€â”€ 179b96e657c91102b91b1031e6903d7a
â”‚       â”œâ”€â”€ 187f36a3832211a9ac5609451dbcc07e
â”‚       â”œâ”€â”€ 1aeb825cbd9d5c70134d755dbd67fb30
â”‚       â”œâ”€â”€ 1e0cfd7b4b9c8bf14b57cbf00d295305
â”‚       â”œâ”€â”€ 1f8bb989dcddf547b87d29823748eaec
â”‚       â”œâ”€â”€ 25ae4a24457eb6085b6acfac3a088927
â”‚       â”œâ”€â”€ 262f72cd65ccb7a5e9683572acb3e77e
â”‚       â”œâ”€â”€ 27edd398376f5b66dbb2e8f693acafeb
â”‚       â”œâ”€â”€ 2e60b469304ca62fbee3ab3570d179c9
â”‚       â”œâ”€â”€ 3314c59868ed0fdaf43713663e092ee2
â”‚       â”œâ”€â”€ 39e59123b81f986d90689b3d9ba307a6
â”‚       â”œâ”€â”€ 3fa4df6f9df4d3adf97df942093c70b2
â”‚       â”œâ”€â”€ 414db1aeec50cd975840251ee09952f5
â”‚       â”œâ”€â”€ 41e8d9571f1f9cefe06c74a1d6f9d22d
â”‚       â”œâ”€â”€ 4606714bcf37808bf5bb4046090f8e07
â”‚       â”œâ”€â”€ 463ed86d6e598b9caeec4cd388cf2c41
â”‚       â”œâ”€â”€ 46b781ca6b50d61e08289ac3528b2a37
â”‚       â”œâ”€â”€ 475a9fbcb23396694d9f72993a852467
â”‚       â”œâ”€â”€ 48b421fe199f71b88556902ee8e07703
â”‚       â”œâ”€â”€ 4a43c1df546502e0eeb7b11ecfb37566
â”‚       â”œâ”€â”€ 4c36c39708a1d772537a0ebd47e3eddd
â”‚       â”œâ”€â”€ 535614caff7a20a0c7cd820854175c01
â”‚       â”œâ”€â”€ 5362fd2b26409028107cb2bf0b6e183f
â”‚       â”œâ”€â”€ 57c379caff0c0948e8bd1759536e68d5
â”‚       â”œâ”€â”€ 59105c71abdd1166db1a6e8215e1a500
â”‚       â”œâ”€â”€ 5fdee988fa12526b09a3279e25c03e4b
â”‚       â”œâ”€â”€ 6124963df3f30761cd2bfecadb1eb7c9
â”‚       â”œâ”€â”€ 66c56b4125db7dd70c0f1e1dd12afd8b
â”‚       â”œâ”€â”€ 67a4b68652a4244e7ce1773626d3bf8f
â”‚       â”œâ”€â”€ 6d363d5dc961fe2f9d9bd834619bf42a
â”‚       â”œâ”€â”€ 7318f9d346d09a948e2b1091362844ba
â”‚       â”œâ”€â”€ 78441ed55f78839508d6cbe6140901fb
â”‚       â”œâ”€â”€ 7917645a7cb6159d05cd1d60493ecd3a
â”‚       â”œâ”€â”€ 7d343cb08b23bb58b187ff750d791b97
â”‚       â”œâ”€â”€ 7e7b5a674ea0ef272a0095b11ecb3521
â”‚       â”œâ”€â”€ 87b083483c4ab06d99b78c3688e349e0
â”‚       â”œâ”€â”€ 8ddbe74b35a0914e75e150b5389df420
â”‚       â”œâ”€â”€ 8dfabdc4f70fe54049c0fa14e2fad9c3
â”‚       â”œâ”€â”€ 8fc74b97cbb3f971d37f15e01f7f4ef6
â”‚       â”œâ”€â”€ 92641164cb332ab43552b5de9e8c4af1
â”‚       â”œâ”€â”€ 95b6e11513d1e1bf2146f1edd2f37e10
â”‚       â”œâ”€â”€ 9658cef0694494aa04e0a7144bab9160
â”‚       â”œâ”€â”€ 9b0aa346caa5feac06ad153ad803052e
â”‚       â”œâ”€â”€ 9e02a1e0c5937d5dc9b5b3bf41d67128
â”‚       â”œâ”€â”€ 9ea4d0bf219b361d2bf2929996c4f304
â”‚       â”œâ”€â”€ 9f3c04d4e50d5f63662ec145f4c40fbb
â”‚       â”œâ”€â”€ a4f70d13fdfc2a1b44c5f77c5a78c044
â”‚       â”œâ”€â”€ a8bca3310ba3a8072b5a54e8d2f2c83d
â”‚       â”œâ”€â”€ ai-1769124390020.jpg
â”‚       â”œâ”€â”€ ai-1769124788771.jpg
â”‚       â”œâ”€â”€ ai-1769124836695.jpg
â”‚       â”œâ”€â”€ ai-1769124938381.jpg
â”‚       â”œâ”€â”€ ai-1769125037098.jpg
â”‚       â”œâ”€â”€ ai-1769125110210.jpg
â”‚       â”œâ”€â”€ b2e95253f50fb5a724d0f8e205bb60d3
â”‚       â”œâ”€â”€ b4cff4272b9a06cccc9d9ec9e7097354
â”‚       â”œâ”€â”€ b50cd7e78c26e7316e45656c98743e75
â”‚       â”œâ”€â”€ b705e0b2fe6c124755c5c7b6d999975e
â”‚       â”œâ”€â”€ b8ac0517684936d20dc47eb7d4c722d7
â”‚       â”œâ”€â”€ ba2ecae20864307e22d433eaaa4e35b5
â”‚       â”œâ”€â”€ bc199f06f744958b60903b2790bc0d50
â”‚       â”œâ”€â”€ bc436827d84a92c7ec80b124e45c2669
â”‚       â”œâ”€â”€ bca5f21524fde8c5583641c838b4ecc6
â”‚       â”œâ”€â”€ bcb64ba2d4874c03ae7e8bd55d7e032b
â”‚       â”œâ”€â”€ bd2239f03012fbf22dcb05bf7de62b11
â”‚       â”œâ”€â”€ bfda63e80077af95459b2ae363cc44b2
â”‚       â”œâ”€â”€ c3d832b15c3b319612a86ab88fb481b3
â”‚       â”œâ”€â”€ c536b44022497153eb3030b1271fca17
â”‚       â”œâ”€â”€ c781c10d33c99b504c143c0420572726
â”‚       â”œâ”€â”€ c94f62c0b4c3b419fd30c32bdc4b567e
â”‚       â”œâ”€â”€ cb6731e49ed1c7c04e941e5ba88722d4
â”‚       â”œâ”€â”€ cd6a47b1a3833f4f51f5aa3919557f98
â”‚       â”œâ”€â”€ ce37872717b97074ff79aa9ef0800e95
â”‚       â”œâ”€â”€ cfff13574e6c6cb4f8e6bc9cd65ef85b
â”‚       â”œâ”€â”€ d0a87000b759379834f99b8c9a4df6c9
â”‚       â”œâ”€â”€ d18627deaf38f38d882572ddfab4eb39
â”‚       â”œâ”€â”€ d1e99c4392a90046d1deeacea6cf25a1
â”‚       â”œâ”€â”€ d22151e5aa0ef7543e24fa79004161a3
â”‚       â”œâ”€â”€ d95029d8faae77aed415f3b925c74bd6
â”‚       â”œâ”€â”€ deabfabd437271b22d6bd1b206e255a5
â”‚       â”œâ”€â”€ dffe2204bd1c8e6b5e20afa76e551b59
â”‚       â”œâ”€â”€ e7c2d8d1268ccea15c1920e5554ded5e
â”‚       â”œâ”€â”€ ead7ef4df14adde2405c7721afc45227
â”‚       â”œâ”€â”€ ef71d5f09f26309ba5b7cc48f06616df
â”‚       â”œâ”€â”€ f091edfce30ee30223bb59ea7c6f0dfa
â”‚       â”œâ”€â”€ f632acc0575231c503e392ad9d3193e2
â”‚       â”œâ”€â”€ fa8d7a7fac887bd021a688bfb9f9408c
â”‚       â”œâ”€â”€ fb06a55d64aad030b305716b76cc31f5
â”‚       â”œâ”€â”€ fb305669f9570391964e533741582fff
â”‚       â”œâ”€â”€ fbcaf74c48169980d99220f61a4e0825
â”‚       â”œâ”€â”€ fc88b53296bf75ff5b944e92693b568d
â”‚       â”œâ”€â”€ ff932e78b518c269162589592cbbc99f
â”‚       â”œâ”€â”€ hw-1768842185845-Capture dÃ¢Â€Â™eÃŒÂcran 2026-01-03 aÃŒÂ€ 18.02.42.png
â”‚       â”œâ”€â”€ hw-1768842199185-Capture dÃ¢Â€Â™eÃŒÂcran 2026-01-03 aÃŒÂ€ 18.02.35.png
â”‚       â”œâ”€â”€ hw-1768842332574-Capture_d___e__cran_2026_01_03_a___18.02.35.png
â”‚       â”œâ”€â”€ hw-1768842400075-Capture_d___e__cran_2026_01_03_a___18.03.11.png
â”‚       â”œâ”€â”€ hw-1768842654963-789792041.png
â”‚       â”œâ”€â”€ hw-1768842664226-638058245.png
â”‚       â”œâ”€â”€ hw-1768842664227-297622102.png
â”‚       â”œâ”€â”€ hw-1768842664228-560329720.png
â”‚       â”œâ”€â”€ hw-1768843131454-861939700.png
â”‚       â”œâ”€â”€ hw-1768843167449-411426516.png
â”‚       â”œâ”€â”€ hw-1768843167449-944076928.png
â”‚       â”œâ”€â”€ hw-1768843167450-303721170.png
â”‚       â”œâ”€â”€ hw-1768843167450-551022433.png
â”‚       â”œâ”€â”€ hw-1768843217201-680118374.png
â”‚       â”œâ”€â”€ hw-1768843223136-847471712.png
â”‚       â”œâ”€â”€ hw-1768929994306-182372983.png
â”‚       â”œâ”€â”€ hw-1768930008932-36084891.png
â”‚       â”œâ”€â”€ hw-1768930263345-43633593.png
â”‚       â”œâ”€â”€ hw-1768930270421-87854074.png
â”‚       â”œâ”€â”€ hw-1768930277825-50869949.png
â”‚       â”œâ”€â”€ hw-1768930277834-557759832.png
â”‚       â”œâ”€â”€ hw-1768930277835-700051807.png
â”‚       â”œâ”€â”€ hw-1768930277839-182489643.png
â”‚       â”œâ”€â”€ hw-1768930277843-623757244.png
â”‚       â”œâ”€â”€ hw-1768930471298-235573698.png
â”‚       â”œâ”€â”€ hw-1768930471304-758162697.png
â”‚       â”œâ”€â”€ hw-1768930471305-399548601.png
â”‚       â”œâ”€â”€ hw-1768930494157-614117768.png
â”‚       â”œâ”€â”€ scan-1769442857662-233577422.jpg
â”‚       â”œâ”€â”€ scan-1769442935800-339439845.jpg
â”‚       â”œâ”€â”€ scan-1769442940694-934050144.jpg
â”‚       â”œâ”€â”€ scan-1769442958244-371731746.jpg
â”‚       â”œâ”€â”€ scan-1769447913991-499356024.jpg
â”‚       â”œâ”€â”€ scan-1769447930973-599328993.jpg
â”‚       â”œâ”€â”€ scan-1769448031681-992915761.jpg
â”‚       â”œâ”€â”€ scan-1769448062214-894867719.jpg
â”‚       â”œâ”€â”€ scan-1769448067344-501428200.jpg
â”‚       â”œâ”€â”€ scan-1769448298236-135295901.jpg
â”‚       â”œâ”€â”€ studio-1769191920520-2043.jpg
â”‚       â”œâ”€â”€ studio-1769192516290-6814.jpg
â”‚       â”œâ”€â”€ studio-1769193745171-4536.jpg
â”‚       â”œâ”€â”€ studio-1769193797546-165.jpg
â”‚       â”œâ”€â”€ studio-1769305491929-8279.png
â”‚       â”œâ”€â”€ studio-1769305749890-482.png
â”‚       â”œâ”€â”€ studio-1769306007315-9193.png
â”‚       â”œâ”€â”€ studio-1769306172468-7033.png
â”‚       â”œâ”€â”€ studio_1769198134006-222869832.png
â”‚       â”œâ”€â”€ studio_1769198134010-937784732.png
â”‚       â”œâ”€â”€ studio_1769198134012-756464366.png
â”‚       â”œâ”€â”€ studio_1769198134013-594476183.png
â”‚       â”œâ”€â”€ studio_1769198134016-848496616.png
â”‚       â”œâ”€â”€ studio_1769198134027-39263879.png
â”‚       â”œâ”€â”€ studio_1769198134058-561747833.png
â”‚       â”œâ”€â”€ studio_1769198134061-396103129.png
â”‚       â”œâ”€â”€ studio_1769198134069-632386481.png
â”‚       â”œâ”€â”€ studio_1769198134070-91215709.png
â”‚       â”œâ”€â”€ studio_1769198134080-256767984.png
â”‚       â”œâ”€â”€ studio_1769198134090-925171104.png
â”‚       â”œâ”€â”€ studio_1769198134109-414501045.png
â”‚       â”œâ”€â”€ studio_1769198134112-187639441.png
â”‚       â”œâ”€â”€ studio_1769198134114-566663002.png
â”‚       â”œâ”€â”€ studio_1769198134120-622948676.png
â”‚       â”œâ”€â”€ studio_1769212412693-91284378.png
â”‚       â”œâ”€â”€ studio_1769212412699-452486225.png
â”‚       â”œâ”€â”€ studio_1769212412701-586705440.png
â”‚       â”œâ”€â”€ studio_1769212412705-136057589.png
â”‚       â”œâ”€â”€ studio_1769212412727-278311843.png
â”‚       â”œâ”€â”€ studio_1769212412732-717637994.png
â”‚       â”œâ”€â”€ studio_1769212412735-176507695.png
â”‚       â”œâ”€â”€ studio_1769212412754-789285101.png
â”‚       â”œâ”€â”€ studio_1769212412771-933056836.png
â”‚       â”œâ”€â”€ studio_1769212412776-959789731.png
â”‚       â”œâ”€â”€ studio_1769212412790-512526583.png
â”‚       â”œâ”€â”€ studio_1769212412809-929788064.png
â”‚       â”œâ”€â”€ studio_1769212412812-787599283.png
â”‚       â”œâ”€â”€ studio_1769212412820-916918492.png
â”‚       â”œâ”€â”€ studio_1769212412824-344221292.png
â”‚       â”œâ”€â”€ studio_1769212412830-370566478.png
â”‚       â”œâ”€â”€ studio_1769213855791-88787683.png
â”‚       â”œâ”€â”€ studio_1769213855792-20039475.png
â”‚       â”œâ”€â”€ studio_1769213855793-36017550.png
â”‚       â”œâ”€â”€ studio_1769213855795-341052217.png
â”‚       â”œâ”€â”€ studio_1769213855807-719319689.png
â”‚       â”œâ”€â”€ studio_1769213855817-848689105.png
â”‚       â”œâ”€â”€ studio_1769213855860-229811711.png
â”‚       â”œâ”€â”€ studio_1769213855862-168986176.png
â”‚       â”œâ”€â”€ studio_1769213855863-325183899.png
â”‚       â”œâ”€â”€ studio_1769213855876-759387937.png
â”‚       â”œâ”€â”€ studio_1769213855881-969210674.png
â”‚       â”œâ”€â”€ studio_1769213855890-99286334.png
â”‚       â”œâ”€â”€ studio_1769213855893-33501019.png
â”‚       â”œâ”€â”€ studio_1769213855894-101454023.png
â”‚       â”œâ”€â”€ studio_1769213855899-658573476.png
â”‚       â”œâ”€â”€ studio_1769213855907-567277804.png
â”‚       â”œâ”€â”€ temp/
â”‚       â”œâ”€â”€ temp-1768930953731-74258377.png
â”‚       â”œâ”€â”€ temp-1768930953739-334352580.png
â”‚       â”œâ”€â”€ temp-1768930953739-999763234.png
â”‚       â”œâ”€â”€ temp-1768930970208-122420991.png
â”‚       â”œâ”€â”€ temp-1768930995933-178348470.png
â”‚       â”œâ”€â”€ temp-1768930995934-231290464.png
â”‚       â”œâ”€â”€ temp-1768930995934-436591443.png
â”‚       â”œâ”€â”€ temp-1768931039002-806235743.png
â”‚       â”œâ”€â”€ temp-1768931039003-724912416.png
â”‚       â”œâ”€â”€ temp-1768931039007-504705663.png
â”‚       â”œâ”€â”€ temp-1768931039008-40320897.png
â”‚       â”œâ”€â”€ temp-1768931050617-313743097.png
â”‚       â”œâ”€â”€ temp-1768931050617-626599309.png
â”‚       â”œâ”€â”€ temp-1768931050633-635055580.png
â”‚       â”œâ”€â”€ temp-1768931266164-197387129.png
â”‚       â”œâ”€â”€ temp-1768931266166-306969703.png
â”‚       â”œâ”€â”€ temp-1768931266167-807528579.png
â”‚       â”œâ”€â”€ temp-1768931272176-142481523.png
â”‚       â”œâ”€â”€ temp-1768931272177-645918406.png
â”‚       â””â”€â”€ temp-1768931272183-246830552.png
â”œâ”€â”€ server/
â”‚   â”œâ”€â”€ core/
â”‚   â”‚   â”œâ”€â”€ ai.engine.js
â”‚   â”‚   â””â”€â”€ drive.engine.js
â”‚   â”œâ”€â”€ domains/
â”‚   â”‚   â”œâ”€â”€ admin/
â”‚   â”‚   â”‚   â”œâ”€â”€ admin.routes.js
â”‚   â”‚   â”‚   â”œâ”€â”€ ai/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ admin.ai.js
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ project-doc.ai.js
â”‚   â”‚   â”‚   â”œâ”€â”€ db/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ admin.db.js
â”‚   â”‚   â”‚   â””â”€â”€ experts/
â”‚   â”‚   â”‚       â”œâ”€â”€ admin.db.js
â”‚   â”‚   â”‚       â””â”€â”€ admin.expert.js
â”‚   â”‚   â”œâ”€â”€ auth/
â”‚   â”‚   â”‚   â”œâ”€â”€ auth.routes.js
â”‚   â”‚   â”‚   â”œâ”€â”€ db/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ auth.db.js
â”‚   â”‚   â”‚   â””â”€â”€ experts/
â”‚   â”‚   â”‚       â””â”€â”€ auth.expert.js
â”‚   â”‚   â”œâ”€â”€ classroom/
â”‚   â”‚   â”‚   â”œâ”€â”€ ai/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ plan.ai.js
â”‚   â”‚   â”‚   â”œâ”€â”€ classroom.routes.js
â”‚   â”‚   â”‚   â””â”€â”€ experts/
â”‚   â”‚   â”‚       â””â”€â”€ classroom.expert.js
â”‚   â”‚   â”œâ”€â”€ games/
â”‚   â”‚   â”‚   â”œâ”€â”€ ai/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ games.ai.js
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ quiz-creator.ai.js
â”‚   â”‚   â”‚   â”œâ”€â”€ db/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ games.db.js
â”‚   â”‚   â”‚   â”œâ”€â”€ experts/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ games.db.js
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ quiz-creator.ai.js
â”‚   â”‚   â”‚   â””â”€â”€ games.routes.js
â”‚   â”‚   â”œâ”€â”€ homework/
â”‚   â”‚   â”‚   â”œâ”€â”€ ai/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ homework.ai.js
â”‚   â”‚   â”‚   â”œâ”€â”€ db/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ homework.db.js
â”‚   â”‚   â”‚   â”œâ”€â”€ experts/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ homework.ai.js
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ homework.db.js
â”‚   â”‚   â”‚   â””â”€â”€ homework.routes.js
â”‚   â”‚   â”œâ”€â”€ scans/
â”‚   â”‚   â”‚   â”œâ”€â”€ ai/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ scan.ai.js
â”‚   â”‚   â”‚   â””â”€â”€ scans.routes.js
â”‚   â”‚   â”œâ”€â”€ structure/
â”‚   â”‚   â”‚   â”œâ”€â”€ db/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ structure.db.js
â”‚   â”‚   â”‚   â”œâ”€â”€ drive/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ structure.drive.js
â”‚   â”‚   â”‚   â”œâ”€â”€ experts/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ structure.db.js
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ structure.drive.js
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ structure.expert.js
â”‚   â”‚   â”‚   â””â”€â”€ structure.routes.js
â”‚   â”‚   â”œâ”€â”€ students/
â”‚   â”‚   â”‚   â””â”€â”€ experts/
â”‚   â”‚   â”‚       â””â”€â”€ student.drive.js
â”‚   â”‚   â””â”€â”€ studio/
â”‚   â”‚       â”œâ”€â”€ ai/
â”‚   â”‚       â”‚   â”œâ”€â”€ game-generator.ai.js
â”‚   â”‚       â”‚   â””â”€â”€ studio.ai.js
â”‚   â”‚       â”œâ”€â”€ db/
â”‚   â”‚       â”‚   â””â”€â”€ studio.db.js
â”‚   â”‚       â”œâ”€â”€ experts/
â”‚   â”‚       â”‚   â”œâ”€â”€ studio.drive.js
â”‚   â”‚       â”‚   â””â”€â”€ studio.expert.js
â”‚   â”‚       â””â”€â”€ studio.routes.js
â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â”œâ”€â”€ AcademicYear.js
â”‚   â”‚   â”œâ”€â”€ AccessLog.js
â”‚   â”‚   â”œâ”€â”€ Admin.js
â”‚   â”‚   â”œâ”€â”€ Bug.js
â”‚   â”‚   â”œâ”€â”€ BugReport.js
â”‚   â”‚   â”œâ”€â”€ Chapter.js
â”‚   â”‚   â”œâ”€â”€ Classroom.js
â”‚   â”‚   â”œâ”€â”€ DeploySignal.js
â”‚   â”‚   â”œâ”€â”€ Enrollment.js
â”‚   â”‚   â”œâ”€â”€ Game.js
â”‚   â”‚   â”œâ”€â”€ GameLevel.js
â”‚   â”‚   â”œâ”€â”€ GameProgress.js
â”‚   â”‚   â”œâ”€â”€ Homework.js
â”‚   â”‚   â”œâ”€â”€ MistakesBook.js
â”‚   â”‚   â”œâ”€â”€ Player.js
â”‚   â”‚   â”œâ”€â”€ ProjectDoc.js
â”‚   â”‚   â”œâ”€â”€ ScanSession.js
â”‚   â”‚   â”œâ”€â”€ Student.js
â”‚   â”‚   â”œâ”€â”€ StudioProject.js
â”‚   â”‚   â”œâ”€â”€ Subject.js
â”‚   â”‚   â”œâ”€â”€ Submission.js
â”‚   â”‚   â”œâ”€â”€ Teacher.js
â”‚   â”‚   â””â”€â”€ TeacherStyle.js
â”‚   â”œâ”€â”€ server.js
â”‚   â””â”€â”€ version.json
â”œâ”€â”€ snap.js
â”œâ”€â”€ systemInstructions.md
â”œâ”€â”€ tests/
â”‚   â””â”€â”€ integrity.test.js
â”œâ”€â”€ tree.txt
â”œâ”€â”€ uploads/
â”‚   â””â”€â”€ temp/
â””â”€â”€ verificatons.txt


CODE:

[[[Â£ FILE: INSTRUCTIONS_OAUTH.md Â£]]]
# ğŸ” RÃ‰PARER L'ERREUR INVALID_GRANT
Si ton token expire, lance : http://localhost:3000/api/auth/google/login
Puis colle le code dans ton .env (GOOGLE_REFRESH_TOKEN).
[[[Â£ END: INSTRUCTIONS_OAUTH.md Â£]]]

[[[Â£ FILE: LOCKED_FILES.md Â£]]]
# ğŸ”’ FICHIERS SANCTUARISÃ‰S
- server/server.js (Enregistrement ModÃ¨les)
- client/src/App.jsx (Logiciel de synchronisation)
[[[Â£ END: LOCKED_FILES.md Â£]]]

[[[Â£ FILE: apply.js Â£]]]
const fs = require('fs');
const path = require('path');
const inputFile = 'update.txt';
const statusFile = 'apply_status.json';

console.log("------------------------------------------------");
console.log("ğŸ¤– [CONSTITUTION] apply.js v32 actif.");
console.log("ğŸš€ Correction Boucle Sync - Build #369");
console.log("------------------------------------------------");

function setStatus(status, file = null) {
    try { fs.writeFileSync(statusFile, JSON.stringify({ status, file, timestamp: Date.now() }, null, 2)); } catch (e) {}
}

function applyUpdate() {
    if (!fs.existsSync(inputFile)) return;
    let rawContent = "";
    try { rawContent = fs.readFileSync(inputFile, 'utf8'); } catch (e) { return; }
    if (rawContent.trim().length < 10) return;

    let processed = false;
    const startRegex = /\[\[\[Â£\s*FILE\s*:\s*([^Â£\]\s]+)\s*Â£\]\]\]/g;
    let startMatch;

    while ((startMatch = startRegex.exec(rawContent)) !== null) {
        const filePath = startMatch[1].trim();
        const contentStartIndex = startMatch.index + startMatch[0].length;
        const endTag = `[[[Â£ END: ${filePath} Â£]]]`;
        const endIdx = rawContent.indexOf(endTag);

        if (endIdx !== -1) {
            const fileContent = rawContent.substring(contentStartIndex, endIdx).trim();
            const fullPath = path.join(__dirname, filePath);
            if (!fs.existsSync(path.dirname(fullPath))) fs.mkdirSync(path.dirname(fullPath), { recursive: true });
            fs.writeFileSync(fullPath, fileContent);
            console.log(`   âœ… ALIGNÃ‰ : ${filePath}`);
            processed = true;
        }
    }
    if (processed) {
        fs.writeFileSync(inputFile, '');
        setStatus('OK');
        console.log("âœ¨ SYNC TERMINÃ‰E.");
    }
}
setStatus('OK');
setInterval(applyUpdate, 1000);
[[[Â£ END: apply.js Â£]]]

[[[Â£ FILE: apply_status.json Â£]]]
{
  "status": "OK",
  "file": null,
  "timestamp": 1769447808275
}
[[[Â£ END: apply_status.json Â£]]]

[[[Â£ FILE: cleanup.js Â£]]]
const fs = require('fs');
const path = require('path');

const DIRS_TO_CLEAN = [
    'public/uploads',
    'public/uploads/temp'
];

console.log("ğŸ§¹ NETTOYAGE DES FICHIERS TEMPORAIRES...");

function cleanDir(directory) {
    const fullPath = path.join(__dirname, directory);
    if (fs.existsSync(fullPath)) {
        const files = fs.readdirSync(fullPath);
        for (const file of files) {
            if (file === '.gitkeep') continue;
            try {
                fs.unlinkSync(path.join(fullPath, file));
                console.log(`   ğŸ—‘ï¸ SupprimÃ© : ${file}`);
            } catch (e) {
                console.error(`   âŒ Erreur suppression ${file}`);
            }
        }
    } else {
        // CrÃ©ation si inexistant pour Ã©viter crash
        fs.mkdirSync(fullPath, { recursive: true });
    }
}

DIRS_TO_CLEAN.forEach(dir => cleanDir(dir));

console.log("âœ¨ DOSSIER UPLOADS VIDÃ‰ (Fichiers inutiles supprimÃ©s).");
[[[Â£ END: cleanup.js Â£]]]

[[[Â£ FILE: client/README.md Â£]]]
# React + Vite

This template provides a minimal setup to get React working in Vite with HMR and some ESLint rules.

Currently, two official plugins are available:

- [@vitejs/plugin-react](https://github.com/vitejs/vite-plugin-react/blob/main/packages/plugin-react/README.md) uses [Babel](https://babeljs.io/) for Fast Refresh
- [@vitejs/plugin-react-swc](https://github.com/vitejs/vite-plugin-react-swc) uses [SWC](https://swc.rs/) for Fast Refresh
[[[Â£ END: client/README.md Â£]]]

[[[Â£ FILE: client/index.html Â£]]]
<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Condamine Pro</title>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.jsx"></script>
  </body>
</html>
[[[Â£ END: client/index.html Â£]]]

[[[Â£ FILE: client/package.json Â£]]]
{
  "name": "client",
  "private": true,
  "version": "0.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite --host",
    "build": "vite build",
    "preview": "vite preview"
  },
  "dependencies": {
    "react": "^18.2.0",
    "react-dom": "^18.2.0",
    "react-router-dom": "^7.11.0",
    "@vitejs/plugin-basic-ssl": "1.1.0"
  },
  "devDependencies": {
    "@vitejs/plugin-react": "^4.0.3",
    "autoprefixer": "^10.4.16",
    "postcss": "^8.4.31",
    "tailwindcss": "^3.4.1",
    "vite": "^4.4.5"
  }
}
[[[Â£ END: client/package.json Â£]]]

[[[Â£ FILE: client/src/App.css Â£]]]
.app-wrapper {
    min-height: 100vh;
    background-color: #f8fafc;
    position: relative;
    display: flex;
    flex-direction: column;
}

/* BANDEAU DE SÃ‰CURITÃ‰ V99 : INTÃ‰GRÃ‰ AU FLUX (NE POLLUE PLUS) */
.v99-test-header {
    background: #dc2626;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 15px;
    color: white;
    font-family: 'JetBrains Mono', monospace;
    font-weight: 900;
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 1px;
    z-index: 11000;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
}

.btn-back-dev-mini {
    background: white;
    color: #dc2626;
    border: none;
    padding: 4px 12px;
    border-radius: 6px;
    font-weight: 950;
    font-size: 0.6rem;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-back-dev-mini:hover {
    transform: scale(1.05);
    background: #fef2f2;
}

.sync-overlay {
    position: fixed; inset: 0; background: #0f172a;
    display: flex; align-items: center; justify-content: center;
    z-index: 9999999;
}
[[[Â£ END: client/src/App.css Â£]]]

[[[Â£ FILE: client/src/App.jsx Â£]]]
import React, { useState, useEffect, useRef } from 'react';
import Login from './features/auth/Login';
import ProfPage from './features/prof/ProfPage';
import ElevePage from './features/eleve/ElevePage';
import AdminPage from './features/admin/AdminPage';
import './App.css';

export default function App() {
  const [user, setUser] = useState(null);
  const [isSyncing, setIsSyncing] = useState(false);
  const bootIdRef = useRef(null);

  useEffect(() => {
    const checkUpdate = async () => {
      try {
        const res = await fetch('/api/check-deploy');
        const data = await res.json();
        if (!bootIdRef.current) bootIdRef.current = data.bootId;
        else if (data.bootId !== bootIdRef.current) {
          setIsSyncing(true);
          setTimeout(() => window.location.reload(), 1000);
        }
      } catch (e) {}
    };
    const timer = setInterval(checkUpdate, 5000);
    return () => clearInterval(timer);
  }, []);

  useEffect(() => {
    const saved = localStorage.getItem('player');
    if (saved) {
        const parsed = JSON.parse(saved);
        setUser({ ...parsed, id: parsed._id || parsed.id });
    }
  }, []);

  const handleLogout = () => { localStorage.clear(); setUser(null); };

  const handleBackToDev = async () => {
      try {
          const res = await fetch('/api/auth/login', {
              method: 'POST',
              headers: {'Content-Type': 'application/json'},
              body: JSON.stringify({ role: 'ADMIN', firstName: 'Jean', lastName: 'Vuillet', password: 'A' })
          });
          const data = await res.json();
          if (res.ok) {
              localStorage.setItem('player', JSON.stringify(data.user));
              window.location.reload();
          }
      } catch(e) { console.error(e); }
  };

  if (isSyncing) return <div className="sync-overlay"><h2 style={{color:'white', fontWeight:900}}>SYNCHRONISATION...</h2></div>;
  if (!user) return <div className="app-wrapper"><Login onLoginSuccess={setUser} /></div>;

  const isTestAccount = user.isTestAccount === true;

  return (
    <div className="app-wrapper">
      {/* BANDEAU DE SÃ‰CURITÃ‰ V99 (Pousse le contenu vers le bas) */}
      {isTestAccount && (
        <div className="v99-test-header">
           <span>ğŸ› ï¸ MODE TEST ACTIF : {user.firstName} {user.lastName}</span>
           <button className="btn-back-dev-mini" onClick={handleBackToDev}>âš¡ RETOUR DÃ‰VELOPPEUR</button>
        </div>
      )}

      {/* ROUTAGE PRINCIPAL */}
      {(user.isDeveloper || user.role === 'prof') ? (
          <ProfPage user={user} onLogout={handleLogout} />
      ) : user.role === 'admin' ? (
          <AdminPage user={user} onLogout={handleLogout} />
      ) : (
          <ElevePage user={user} onLogout={handleLogout} onBackToProf={() => setUser({ ...user, role: "prof" })} />
      )}
    </div>
  );
}
[[[Â£ END: client/src/App.jsx Â£]]]

[[[Â£ FILE: client/src/features/admin/AdminPage.css Â£]]]
.admin-page-wrapper {
    min-height: 100vh;
    background-color: #f1f5f9;
    padding: 2rem;
    max-width: 1400px;
    margin: 0 auto;
}

.admin-header-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: white;
    padding: 1.5rem 2rem;
    border-radius: 25px;
    margin-bottom: 2rem;
    box-shadow: 0 10px 30px -10px rgba(0,0,0,0.05);
    border: 1px solid #e2e8f0;
}

.admin-content-area {
    /* Le Dashboard prend toute la place */
}
[[[Â£ END: client/src/features/admin/AdminPage.css Â£]]]

[[[Â£ FILE: client/src/features/admin/AdminPage.jsx Â£]]]
import React from 'react';
import AdminDashboard from '../prof/admin/AdminDashboard'; // On rÃ©utilise le composant existant
import './AdminPage.css';

export default function AdminPage({ user, onLogout }) {
  // Fonction vide pour le refresh car l'admin gÃ¨re sa propre data
  const handleRefresh = () => {};

  return (
    <div className="admin-page-wrapper">
      <div className="admin-header-bar">
        <div className="flex items-center gap-4">
            <span className="text-3xl">ğŸ›¡ï¸</span>
            <div>
                <h1 className="text-xl font-black text-slate-800 uppercase tracking-tight">Espace Administration</h1>
                <p className="text-xs font-bold text-slate-400 uppercase">Bienvenue, {user.firstName}</p>
            </div>
        </div>
        <button onClick={onLogout} className="bg-white text-slate-400 hover:text-red-500 px-4 py-2 rounded-xl font-black text-xs border border-slate-200 transition-colors">
            DÃ‰CONNEXION
        </button>
      </div>
      
      <div className="admin-content-area">
        <AdminDashboard user={user} onRefresh={handleRefresh} />
      </div>
    </div>
  );
}
[[[Â£ END: client/src/features/admin/AdminPage.jsx Â£]]]

[[[Â£ FILE: client/src/features/auth/Login.css Â£]]]
.login-screen { display: flex; align-items: center; justify-content: center; min-height: 100vh; background-color: #f8fafc; }
.login-card { background: white; padding: 2.5rem; border-radius: 40px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.1); width: 100%; max-width: 900px; text-align: center; transition: all 0.3s; }
.login-card.narrow { max-width: 450px; }

.app-logo { font-weight: 900; font-size: 2rem; color: #1e293b; margin-bottom: 0.5rem; letter-spacing: -1px; text-transform: uppercase; }
.app-subtitle { color: #94a3b8; font-weight: 700; margin-bottom: 3rem; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; }

/* ROLE SELECTOR GRID */
.role-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem; }
@media (max-width: 768px) { .role-grid { grid-template-columns: 1fr; } }

.role-card { background: #f1f5f9; border: 2px solid transparent; border-radius: 25px; padding: 2rem 1rem; cursor: pointer; transition: all 0.2s; display: flex; flex-direction: column; align-items: center; gap: 1rem; }
.role-card:hover { transform: translateY(-5px); background: white; shadow: 0 10px 30px rgba(0,0,0,0.05); }

.role-icon { font-size: 3rem; margin-bottom: 0.5rem; }
.role-label { font-weight: 900; font-size: 1.1rem; color: #475569; text-transform: uppercase; }

/* SPECIFIC COLORS */
.role-student:hover { border-color: #f97316; } .role-student:hover .role-label { color: #f97316; }
.role-teacher:hover { border-color: #7c3aed; } .role-teacher:hover .role-label { color: #7c3aed; }
.role-admin:hover { border-color: #1e293b; } .role-admin:hover .role-label { color: #1e293b; }

/* FORMS COMMON */
.login-inputs { display: flex; flex-direction: column; gap: 1rem; text-align: left; position: relative; }
.login-field { width: 100%; padding: 1.2rem; border-radius: 18px; border: 2px solid #e2e8f0; background: #f8fafc; font-weight: 700; outline: none; transition: all 0.2s; }
.login-field:focus { border-color: #2563eb; background: white; }

.login-submit-btn { width: 100%; padding: 1.25rem; background-color: #2563eb; color: white; border-radius: 20px; font-weight: 900; cursor: pointer; border: none; text-transform: uppercase; margin-top: 1rem; transition: transform 0.1s; }
.login-submit-btn:active { transform: scale(0.98); }
.login-submit-btn:disabled { opacity: 0.5; cursor: not-allowed; background-color: #cbd5e1; }

.back-btn { background: transparent; border: none; font-weight: 800; color: #94a3b8; cursor: pointer; margin-bottom: 1.5rem; display: inline-flex; align-items: center; gap: 0.5rem; font-size: 0.8rem; text-transform: uppercase; }
.back-btn:hover { color: #1e293b; }

/* --- FINDER STUDENT V2 (3 CHAMPS) --- */
.finder-wrapper { position: relative; display: flex; flex-direction: column; gap: 10px; }
.finder-row { display: flex; gap: 10px; }
.finder-col-class { flex: 1; }
.finder-col-name { flex: 2; }

.suggestions-box {
    position: absolute; top: 100%; left: 0; right: 0;
    background: white; border: 2px solid #e2e8f0; border-radius: 15px;
    max-height: 200px; overflow-y: auto; z-index: 50;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1); margin-top: 5px;
}
.suggestion-item {
    padding: 12px 15px; cursor: pointer; font-weight: 700; color: #475569; border-bottom: 1px solid #f1f5f9;
    display: flex; justify-content: space-between;
}
.suggestion-item:hover { background: #f0f9ff; color: #2563eb; }
.suggestion-detail { font-size: 0.75rem; color: #94a3b8; font-weight: 900; text-transform: uppercase; }

.selected-student-card {
    background: #ecfdf5; border: 2px solid #34d399; color: #065f46;
    padding: 1rem; border-radius: 20px; text-align: center;
    font-weight: 900; font-size: 1.1rem;
    display: flex; justify-content: space-between; align-items: center;
}
.reset-selection-btn {
    background: #065f46; color: white; width: 30px; height: 30px; border-radius: 50%;
    border: none; cursor: pointer; display: flex; align-items: center; justify-content: center;
}
[[[Â£ END: client/src/features/auth/Login.css Â£]]]

[[[Â£ FILE: client/src/features/auth/Login.jsx Â£]]]
import React, { useState, useEffect } from 'react';
import './Login.css';

export default function Login({ onLoginSuccess }) {
  const [mode, setMode] = useState(null);
  
  // --- FINDER STATE ---
  const [allStudentsData, setAllStudentsData] = useState([]); // DonnÃ©es brutes lÃ©gÃ¨res
  const [inputClass, setInputClass] = useState('');
  const [inputLast, setInputLast] = useState('');
  const [inputFirst, setInputFirst] = useState('');
  const [selectedStudent, setSelectedStudent] = useState(null);
  const [suggestions, setSuggestions] = useState([]);
  const [activeField, setActiveField] = useState(null);

  // --- STAFF STATE ---
  const [fName, setFName] = useState('');
  const [lName, setLName] = useState('');
  const [password, setPassword] = useState('');
  const [showPassword, setShowPassword] = useState(false);
  
  const [loading, setLoading] = useState(false);

  // Charger la liste lÃ©gÃ¨re au montage si mode Ã©lÃ¨ve
  useEffect(() => {
    if (mode === 'student') {
        setLoading(true);
        fetch('/api/auth/finder-data')
            .then(res => res.json())
            .then(data => {
                setAllStudentsData(data);
                setLoading(false);
            })
            .catch(() => setLoading(false));
    }
  }, [mode]);

  // --- MOTEUR DE RECHERCHE CROISÃ‰ ---
  useEffect(() => {
    if (selectedStudent) return; // Si dÃ©jÃ  choisi, pas de suggestions

    const clean = (str) => str.toLowerCase().trim().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
    
    const sClass = clean(inputClass);
    const sLast = clean(inputLast);
    const sFirst = clean(inputFirst);

    if (!sClass && !sLast && !sFirst) {
        setSuggestions([]);
        return;
    }

    const matches = allStudentsData.filter(s => {
        const matchClass = s.className ? clean(s.className).includes(sClass) : true;
        const matchLast = s.lastName ? clean(s.lastName).includes(sLast) : true;
        const matchFirst = s.firstName ? clean(s.firstName).includes(sFirst) : true;
        return matchClass && matchLast && matchFirst;
    });

    setSuggestions(matches.slice(0, 8)); // Max 8 suggestions
  }, [inputClass, inputLast, inputFirst, allStudentsData, selectedStudent]);

  const handleSelectSuggestion = (s) => {
      setSelectedStudent(s);
      setInputClass(s.className || '');
      setInputLast(s.lastName);
      setInputFirst(s.firstName);
      setSuggestions([]);
  };

  const handleReset = () => {
      setSelectedStudent(null);
      setInputClass('');
      setInputLast('');
      setInputFirst('');
      setSuggestions([]);
  };

  const handleLogin = async (e) => {
    e.preventDefault();
    setLoading(true);
    
    let roleToSend = 'STUDENT';
    if (mode === 'teacher') roleToSend = 'TEACHER';
    if (mode === 'admin') roleToSend = 'ADMIN';
    
    const body = (roleToSend === 'TEACHER' || roleToSend === 'ADMIN')
        ? { role: roleToSend, firstName: fName, lastName: lName, password }
        : { role: 'STUDENT', studentId: selectedStudent?.id };

    try {
        const res = await fetch('/api/auth/login', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify(body)
        });
        const data = await res.json();
        
        if (res.ok) {
            localStorage.setItem('player', JSON.stringify(data.user));
            onLoginSuccess(data.user);
        } else {
            alert(data.message || "Identifiants incorrects");
        }
    } catch(e) { alert("Le serveur est injoignable."); }
    setLoading(false);
  };

  // 1. Ã‰CRAN DE SÃ‰LECTION DU RÃ”LE
  if (!mode) {
    return (
        <div className="login-screen">
            <div className="login-card">
                <h1 className="app-logo">Condamine Pro</h1>
                <p className="app-subtitle">Choisissez votre espace de connexion</p>
                <div className="role-grid">
                    <div className="role-card role-student" onClick={() => setMode('student')}>
                        <span className="role-icon">ğŸ‘¨â€ğŸ“</span>
                        <span className="role-label">Ã‰lÃ¨ve</span>
                    </div>
                    <div className="role-card role-teacher" onClick={() => setMode('teacher')}>
                        <span className="role-icon">ğŸ‘¨â€ğŸ«</span>
                        <span className="role-label">Enseignant</span>
                    </div>
                    <div className="role-card role-admin" onClick={() => setMode('admin')}>
                        <span className="role-icon">ğŸ›¡ï¸</span>
                        <span className="role-label">Administrateur</span>
                    </div>
                </div>
            </div>
        </div>
    );
  }

  // 2. FORMULAIRES
  return (
    <div className="login-screen">
      <div className="login-card narrow">
        <button onClick={() => { setMode(null); handleReset(); }} className="back-btn">â¬… Changer de rÃ´le</button>
        
        <h2 className="app-logo">
            {mode === 'student' ? 'Espace Ã‰lÃ¨ve' : (mode === 'teacher' ? 'Espace Prof' : 'Administration')}
        </h2>

        <form onSubmit={handleLogin} className="login-inputs mt-6">
            
            {/* --- MODE Ã‰LÃˆVE (NOUVEAU FINDER 3 CHAMPS) --- */}
            {mode === 'student' && (
                <>
                    {!selectedStudent ? (
                        <div className="finder-wrapper">
                            {/* LIGNE 1 : CLASSE */}
                            <input 
                                className="login-field" 
                                placeholder="Classe (ex: 6A)" 
                                value={inputClass}
                                onChange={e => setInputClass(e.target.value)}
                                onFocus={() => setActiveField('class')}
                            />
                            
                            {/* LIGNE 2 : NOM & PRENOM */}
                            <div className="finder-row">
                                <div className="finder-col-name">
                                    <input 
                                        className="login-field" 
                                        placeholder="Nom" 
                                        value={inputLast}
                                        onChange={e => setInputLast(e.target.value)}
                                        onFocus={() => setActiveField('last')}
                                    />
                                </div>
                                <div className="finder-col-name">
                                    <input 
                                        className="login-field" 
                                        placeholder="PrÃ©nom" 
                                        value={inputFirst}
                                        onChange={e => setInputFirst(e.target.value)}
                                        onFocus={() => setActiveField('first')}
                                    />
                                </div>
                            </div>

                            {/* LISTE DE SUGGESTIONS INTELLIGENTE */}
                            {suggestions.length > 0 && (
                                <div className="suggestions-box custom-scrollbar">
                                    {suggestions.map(s => (
                                        <div key={s.id} className="suggestion-item" onClick={() => handleSelectSuggestion(s)}>
                                            <span>{s.firstName} <strong>{s.lastName}</strong></span>
                                            <span className="suggestion-detail">{s.className}</span>
                                        </div>
                                    ))}
                                </div>
                            )}
                            {suggestions.length === 0 && (inputClass || inputLast || inputFirst) && (
                                <div className="text-xs text-slate-400 text-center italic">Aucun Ã©lÃ¨ve trouvÃ©.</div>
                            )}
                        </div>
                    ) : (
                        <div className="selected-student-card animate-in">
                            <span>âœ… {selectedStudent.firstName} {selectedStudent.lastName} ({selectedStudent.className})</span>
                            <button type="button" onClick={handleReset} className="reset-selection-btn">âœ•</button>
                        </div>
                    )}
                </>
            )}

            {/* --- MODE STAFF --- */}
            {(mode === 'teacher' || mode === 'admin') && (
                <div className="space-y-4">
                    <input className="login-field" placeholder="PrÃ©nom" value={fName} onChange={e=>setFName(e.target.value)} required />
                    <input className="login-field" placeholder="Nom" value={lName} onChange={e=>setLName(e.target.value)} required />
                    <div className="relative">
                        <input type={showPassword ? "text" : "password"} className="login-field" placeholder="Mot de passe" value={password} onChange={e=>setPassword(e.target.value)} required />
                        <button type="button" onClick={() => setShowPassword(!showPassword)} className="absolute right-4 top-1/2 -translate-y-1/2 text-[10px] uppercase font-black text-slate-400">
                            {showPassword ? "Cacher" : "Voir"}
                        </button>
                    </div>
                </div>
            )}

            <button className="login-submit-btn" disabled={loading || (mode === 'student' && !selectedStudent)}>
                {loading ? 'Connexion...' : 'Entrer'}
            </button>
        </form>
      </div>
    </div>
  );
}
[[[Â£ END: client/src/features/auth/Login.jsx Â£]]]

[[[Â£ FILE: client/src/features/eleve/ElevePage.css Â£]]]
.eleve-page-wrapper { min-height: 100vh; background-color: #fdf2f8; transition: background-color 0.5s ease; }
.eleve-page-container { max-width: 1100px; margin: 0 auto; padding: 2rem; }
.animate-in { animation: fadeIn 0.5s ease-out forwards; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
[[[Â£ END: client/src/features/eleve/ElevePage.css Â£]]]

[[[Â£ FILE: client/src/features/eleve/ElevePage.jsx Â£]]]
import React, { useState, useEffect } from 'react';
import EleveHeader from './components/EleveHeader';
import HomeworkList from './homework/HomeworkList';
import MistakesBook from './mistakes/MistakesBook';
import GamesGrid from './games/GamesGrid';
import './ElevePage.css';

export default function ElevePage({ user, onLogout, onBackToProf }) {
  const [tab, setTab] = useState('devoirs');
  const [freshUser, setFreshUser] = useState(user);

  // On rÃ©cupÃ¨re les donnÃ©es fraÃ®ches (croix/bonus/punitions)
  useEffect(() => {
      const fetchFreshData = async () => {
          try {
              const id = user._id || user.id;
              const res = await fetch(`/api/auth/student-fresh/${id}`);
              if (res.ok) {
                  const data = await res.json();
                  // On fusionne pour garder les infos de base (role, etc.)
                  setFreshUser(prev => ({ ...prev, ...data }));
              }
          } catch (e) { console.error("Sync behavior error", e); }
      };
      fetchFreshData();
      // Polling lÃ©ger pour garder synchro si le prof met une croix en direct
      const interval = setInterval(fetchFreshData, 10000);
      return () => clearInterval(interval);
  }, [user]);

  return (
    <div className="eleve-page-wrapper">
        <div className="eleve-page-container">
          {/* On passe freshUser partout pour avoir les Ã©tats Ã  jour */}
          <EleveHeader user={freshUser} onLogout={onLogout} onBackToProf={onBackToProf} activeTab={tab} onTabChange={setTab} />
          
          <div className="mt-8">
            {/* CORRECTION V222 : On passe freshUser Ã  HomeworkList pour qu'il connaisse le statut Puni */}
            {tab === 'devoirs' && <HomeworkList user={freshUser} />}
            {tab === 'francais' && <MistakesBook user={freshUser} />}
            {tab === 'jeux' && <GamesGrid user={freshUser} />}
          </div>
        </div>
    </div>
  );
}
[[[Â£ END: client/src/features/eleve/ElevePage.jsx Â£]]]

[[[Â£ FILE: client/src/features/eleve/components/BehaviorTimer.css Â£]]]
.behavior-timer-wrapper {
    background: white;
    border-radius: 30px;
    padding: 0;
    margin-bottom: 2rem;
    box-shadow: 0 15px 40px -10px rgba(0, 0, 0, 0.1);
    border: 1px solid #e2e8f0;
    overflow: hidden;
    animation: slideDown 0.5s ease-out;
    display: flex;
    flex-direction: column;
}

/* SECTION COMMUNE */
.bt-section {
    padding: 1.5rem 2rem;
    display: flex;
    flex-direction: column;
    gap: 10px;
}

/* --- ZONE SANCTIONS (HAUT) --- */
.bt-section.sanctions {
    background: linear-gradient(to bottom, #fff, #fef2f2);
    border-bottom: 2px dashed #fecaca;
}

.bt-header-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 5px;
}

.bt-title {
    font-weight: 950;
    text-transform: uppercase;
    font-size: 0.8rem;
    letter-spacing: 1px;
    display: flex;
    align-items: center;
    gap: 8px;
}
.bt-title.red { color: #ef4444; }
.bt-title.green { color: #10b981; }

/* CROIX ET Ã‰TOILES VISUELLES */
.bt-icons-container {
    display: flex;
    gap: 10px;
    height: 40px;
    align-items: center;
}

.bt-icon-slot {
    width: 35px;
    height: 35px;
    border-radius: 10px;
    background: rgba(255,255,255,0.5);
    border: 2px solid rgba(0,0,0,0.05);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
    transition: all 0.3s;
}

.bt-icon-slot.filled-cross {
    background: #fee2e2;
    border-color: #ef4444;
    box-shadow: 0 4px 10px rgba(239, 68, 68, 0.2);
    animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

.bt-icon-slot.filled-star {
    background: #f0fdf4;
    border-color: #10b981;
    box-shadow: 0 4px 10px rgba(16, 185, 129, 0.2);
    animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

/* BARRES DE PROGRESSION */
.bt-bar-container {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.bt-label-mini {
    font-size: 0.65rem;
    font-weight: 800;
    color: #94a3b8;
    text-transform: uppercase;
    display: flex;
    justify-content: space-between;
}

.bt-progress-track {
    width: 100%;
    height: 10px;
    background: #f1f5f9;
    border-radius: 10px;
    overflow: hidden;
    position: relative;
    border: 1px solid rgba(0,0,0,0.05);
}

.bt-progress-fill {
    height: 100%;
    border-radius: 10px;
    transition: width 1s ease-in-out;
}
.bt-progress-fill.red { background: linear-gradient(90deg, #ef4444, #f87171); }
.bt-progress-fill.gold { background: linear-gradient(90deg, #fbbf24, #f59e0b); }

/* --- ZONE BONUS (BAS) --- */
.bt-section.bonus {
    background: linear-gradient(to bottom, #f0fdf4, #fff);
}

.bt-aplus-badge {
    background: #fbbf24;
    color: white;
    padding: 4px 10px;
    border-radius: 20px;
    font-weight: 900;
    font-size: 0.7rem;
    box-shadow: 0 4px 10px rgba(251, 191, 36, 0.4);
    text-shadow: 0 1px 2px rgba(0,0,0,0.1);
}

@keyframes popIn {
    0% { transform: scale(0); opacity: 0; }
    80% { transform: scale(1.2); opacity: 1; }
    100% { transform: scale(1); opacity: 1; }
}

@keyframes slideDown {
    from { opacity: 0; transform: translateY(-20px); }
    to { opacity: 1; transform: translateY(0); }
}
[[[Â£ END: client/src/features/eleve/components/BehaviorTimer.css Â£]]]

[[[Â£ FILE: client/src/features/eleve/components/BehaviorTimer.jsx Â£]]]
import React from 'react';
import './BehaviorTimer.css';

export default function BehaviorTimer({ studentData }) {
    if (!studentData || !studentData.behaviorRecords) return null;

    // RÃ©cupÃ©ration des donnÃ©es du prof (ou prend le dernier record actif)
    // Ici on suppose que le systÃ¨me gÃ¨re un tableau, on prend celui qui a de l'activitÃ©
    const activeRecord = studentData.behaviorRecords.length > 0 
        ? studentData.behaviorRecords[studentData.behaviorRecords.length - 1] 
        : { crosses: 0, bonuses: 0, weeksToRedemption: 3 };

    // --- LOGIQUE CROIX ---
    const crosses = activeRecord.crosses || 0;
    const weeksLeft = activeRecord.weeksToRedemption || 3;
    const redemptionPct = (weeksLeft / 3) * 100;

    // --- LOGIQUE BONUS ---
    const totalBonuses = activeRecord.bonuses || 0;
    const currentCycleBonuses = totalBonuses % 4; // Combien de bonus dans le cycle actuel (0, 1, 2, 3)
    const bonusesNeeded = 4 - currentCycleBonuses;
    const totalAPlus = Math.floor(totalBonuses / 4); // Nombre de cycles A+ complÃ©tÃ©s
    const bonusPct = (currentCycleBonuses / 4) * 100;

    return (
        <div className="behavior-timer-wrapper">
            
            {/* 1. ZONE SANCTIONS (ROUGE) */}
            <div className="bt-section sanctions">
                <div className="bt-header-row">
                    <span className="bt-title red">
                        <span>âš ï¸</span> SANCTIONS EN COURS
                    </span>
                    <span className="text-[10px] font-black text-red-400">{crosses}/3 AVANT PUNITION</span>
                </div>

                {/* LIGNE DES CROIX VISUELLES */}
                <div className="bt-icons-container">
                    {[...Array(3)].map((_, i) => (
                        <div key={i} className={`bt-icon-slot ${i < crosses ? 'filled-cross' : ''}`}>
                            {i < crosses ? 'âŒ' : ''}
                        </div>
                    ))}
                </div>

                {/* BARRE DE RACHAT (Si croix existantes) */}
                {crosses > 0 && (
                    <div className="bt-bar-container animate-in fade-in">
                        <div className="bt-label-mini">
                            <span>Temps avant annulation d'une croix</span>
                            <span>{weeksLeft} sem.</span>
                        </div>
                        <div className="bt-progress-track">
                            <div className="bt-progress-fill red" style={{ width: `${redemptionPct}%` }}></div>
                        </div>
                    </div>
                )}
            </div>

            {/* 2. ZONE BONUS (VERT/OR) */}
            <div className="bt-section bonus">
                <div className="bt-header-row">
                    <span className="bt-title green">
                        <span>ğŸ†</span> MÃ‰RITES & EFFORTS
                    </span>
                    {totalAPlus > 0 && (
                        <div className="bt-aplus-badge">
                            {totalAPlus} x A+ OBTENUS ğŸŒŸ
                        </div>
                    )}
                </div>

                {/* LIGNE DES BONUS VISUELS */}
                <div className="bt-icons-container">
                    {[...Array(4)].map((_, i) => (
                        <div key={i} className={`bt-icon-slot ${i < currentCycleBonuses ? 'filled-star' : ''}`}>
                            {i < currentCycleBonuses ? 'â­' : ''}
                        </div>
                    ))}
                </div>

                {/* BARRE VERS LE A+ */}
                <div className="bt-bar-container">
                    <div className="bt-label-mini">
                        <span style={{color: '#d97706'}}>Progression vers le prochain A+</span>
                        <span style={{color: '#d97706'}}>{bonusesNeeded} bonus restants</span>
                    </div>
                    <div className="bt-progress-track">
                        <div className="bt-progress-fill gold" style={{ width: `${bonusPct}%` }}></div>
                    </div>
                </div>
            </div>

        </div>
    );
}
[[[Â£ END: client/src/features/eleve/components/BehaviorTimer.jsx Â£]]]

[[[Â£ FILE: client/src/features/eleve/components/DashboardFolder.css Â£]]]
/* FLUX D'ACTIVITÃ‰S (STREAM VIEW) */
.stream-container {
    display: flex;
    flex-direction: column;
    gap: 15px;
    max-width: 800px;
    margin: 0 auto;
    padding-bottom: 40px;
}

.stream-card {
    background: white;
    border-radius: 20px;
    padding: 20px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.03);
    border: 1px solid #f1f5f9;
    cursor: pointer;
    transition: all 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    display: flex;
    flex-direction: column;
    gap: 10px;
    position: relative;
    overflow: hidden;
}

.stream-card:hover {
    transform: translateY(-3px) scale(1.01);
    box-shadow: 0 10px 30px rgba(0,0,0,0.08);
    border-color: #cbd5e1;
}

/* HEADER : MATIÃˆRE & DATE */
.card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.subject-badge {
    font-size: 0.65rem;
    font-weight: 900;
    text-transform: uppercase;
    padding: 4px 10px;
    border-radius: 8px;
    letter-spacing: 0.05em;
    display: inline-block;
}

/* COULEURS MATIÃˆRES */
.sub-maths { background: #eff6ff; color: #2563eb; border: 1px solid #dbeafe; }
.sub-fr { background: #fdf2f8; color: #db2777; border: 1px solid #fce7f3; }
.sub-hist { background: #fff7ed; color: #ea580c; border: 1px solid #ffedd5; }
.sub-lang { background: #f5f3ff; color: #7c3aed; border: 1px solid #ede9fe; }
.sub-sci { background: #f0fdf4; color: #16a34a; border: 1px solid #dcfce7; }
.sub-art { background: #fefce8; color: #ca8a04; border: 1px solid #fef9c3; }
.sub-gen { background: #f8fafc; color: #64748b; border: 1px solid #e2e8f0; }

/* TITRE */
.card-title {
    font-size: 1.1rem;
    font-weight: 800;
    color: #1e293b;
    line-height: 1.3;
}

/* FOOTER : STATUT */
.card-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-top: 1px solid #f8fafc;
    padding-top: 10px;
    margin-top: 5px;
}

.status-badge {
    font-size: 0.7rem;
    font-weight: 900;
    text-transform: uppercase;
    display: flex;
    align-items: center;
    gap: 6px;
}

.status-todo { color: #ef4444; }
.status-done { color: #10b981; }
.status-prog { color: #3b82f6; }

.punishment-flag {
    background: #fee2e2;
    color: #b91c1c;
    font-size: 0.6rem;
    font-weight: 900;
    padding: 2px 6px;
    border-radius: 4px;
    border: 1px solid #fecaca;
    text-transform: uppercase;
    animation: pulse 2s infinite;
}

.card-arrow {
    width: 30px; height: 30px;
    border-radius: 50%;
    background: #f8fafc;
    color: #cbd5e1;
    display: flex; align-items: center; justify-content: center;
    font-weight: 900;
    font-size: 0.8rem;
    transition: all 0.2s;
}

.stream-card:hover .card-arrow {
    background: #1e293b;
    color: white;
    transform: translateX(5px);
}

@keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

/* EMPTY STATE */
.empty-stream {
    text-align: center;
    padding: 60px;
    opacity: 0.5;
}
.empty-icon { font-size: 3rem; margin-bottom: 10px; display: block; }
.empty-text { font-weight: 800; font-size: 0.9rem; text-transform: uppercase; color: #94a3b8; }
[[[Â£ END: client/src/features/eleve/components/DashboardFolder.css Â£]]]

[[[Â£ FILE: client/src/features/eleve/components/DashboardFolder.jsx Â£]]]
import React from 'react';
import './DashboardFolder.css';

/**
 * ğŸŒŠ DASHBOARD STREAM (Ex-Folder)
 * Affiche une liste plate chronologique avec badge matiÃ¨re.
 */
export default function DashboardFolder({ items, type, onSelect }) {
  
  // 1. TRI CHRONOLOGIQUE (Le plus rÃ©cent en haut)
  // On utilise createdAt ou date s'il existe, sinon on garde l'ordre par dÃ©faut
  const sortedItems = [...items].sort((a, b) => {
      const dateA = new Date(a.createdAt || a.date || 0);
      const dateB = new Date(b.createdAt || b.date || 0);
      return dateB - dateA; // Descendant
  });

  // 2. HELPER COULEURS
  const getSubjectClass = (subject) => {
      const s = (subject || "").toUpperCase();
      if (s.includes('MATH')) return 'sub-maths';
      if (s.includes('FRAN')) return 'sub-fr';
      if (s.includes('HIST') || s.includes('GEO') || s.includes('EMC')) return 'sub-hist';
      if (s.includes('ANGL') || s.includes('ESP') || s.includes('ALL') || s.includes('LANG')) return 'sub-lang';
      if (s.includes('SCI') || s.includes('SVT') || s.includes('PHY') || s.includes('TECH')) return 'sub-sci';
      if (s.includes('ART') || s.includes('MUSI')) return 'sub-art';
      return 'sub-gen';
  };

  // 3. RENDU VIDE
  if (sortedItems.length === 0) {
      return (
          <div className="empty-stream">
              <span className="empty-icon">{type === 'homework' ? 'ğŸ“š' : 'ğŸ®'}</span>
              <span className="empty-text">Aucun {type === 'homework' ? 'devoir' : 'jeu'} pour le moment.</span>
          </div>
      );
  }

  // 4. RENDU LISTE
  return (
    <div className="stream-container animate-in">
      {sortedItems.map(item => {
          const subjectName = item.subject || "GÃ‰NÃ‰RAL";
          const isDone = item.status === 'done';
          
          return (
            <div key={item._id} onClick={() => onSelect(item)} className="stream-card group">
                {/* LIGNE 1 : MATIÃˆRE + FLAG PUNITION */}
                <div className="card-header">
                    <span className={`subject-badge ${getSubjectClass(subjectName)}`}>
                        {subjectName}
                    </span>
                    {item.isPunishment && <span className="punishment-flag">âš ï¸ PUNITION</span>}
                </div>

                {/* LIGNE 2 : TITRE */}
                <div className="card-title">
                    {item.title}
                </div>

                {/* LIGNE 3 : STATUT */}
                <div className="card-footer">
                    {isDone ? (
                        <div className="status-badge status-done">
                            <span>âœ…</span> <span>FAIT</span>
                        </div>
                    ) : (
                        <div className="status-badge status-todo">
                            <span>â­•</span> <span>Ã€ FAIRE</span>
                        </div>
                    )}
                    
                    <div className="card-arrow">â”</div>
                </div>
            </div>
          );
      })}
    </div>
  );
}
[[[Â£ END: client/src/features/eleve/components/DashboardFolder.jsx Â£]]]

[[[Â£ FILE: client/src/features/eleve/components/EleveHeader.css Â£]]]
.header-wrapper { display: flex; flex-direction: column; gap: 1.5rem; margin-bottom: 2rem; }

/* TOP BAR (IdentitÃ©) */
.top-bar { display: flex; justify-content: space-between; align-items: center; background: white; padding: 1rem 2rem; border-radius: 25px; border: 2px solid #fce7f3; }
.brand-name { color: #db2777; font-weight: 900; font-size: 1.5rem; text-transform: uppercase; letter-spacing: -1px; }

.v80-user-info { display: flex; flex-direction: column; align-items: flex-end; gap: 2px; }
.v80-user-name { font-weight: 900; color: #1e293b; font-size: 0.9rem; text-transform: uppercase; }

.v80-badges-row { display: flex; gap: 5px; align-items: center; }

/* CLASSE PRINCIPALE (ROSE) */
.v80-user-class { font-weight: 950; color: #db2777; font-size: 0.7rem; background: #fdf2f8; padding: 2px 8px; border-radius: 6px; border: 1px solid #fbcfe8; white-space: nowrap; }

/* OPTIONS (ORANGE) - NOUVEAU V374 */
.v80-user-option { font-weight: 950; color: #ea580c; font-size: 0.6rem; background: #ffedd5; padding: 2px 6px; border-radius: 6px; border: 1px solid #fed7aa; white-space: nowrap; text-transform: uppercase; }

.v80-logout-btn { width: 35px; height: 35px; border-radius: 50%; background: #f1f5f9; color: #94a3b8; border: none; cursor: pointer; font-weight: 900; transition: all 0.2s; }
.v80-logout-btn:hover { background: #fee2e2; color: #ef4444; }
.v80-back-prof { background: #1e293b; color: white; padding: 5px 12px; border-radius: 10px; font-weight: 900; font-size: 8px; text-transform: uppercase; letter-spacing: 1px; border: none; cursor: pointer; }

/* NAVIGATION BAR + MINI STATS */
.nav-bar-container {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: white;
    border-radius: 20px;
    border: 2px solid #fce7f3;
    padding: 0.4rem;
    flex-wrap: wrap;
    gap: 1rem;
}

.nav-tabs { display: flex; gap: 0.5rem; }
.tab-item { padding: 0.8rem 2rem; border-radius: 16px; font-weight: 800; font-size: 0.9rem; color: #f472b6; cursor: pointer; border: none; background: transparent; }
.tab-active { background: #db2777 !important; color: white !important; box-shadow: 0 4px 12px rgba(219, 39, 119, 0.3); }

/* --- MINI HUD STATS (A DROITE) --- */
.mini-stats-box {
    display: flex;
    flex-direction: column;
    justify-content: center;
    padding-right: 1.5rem;
    gap: 4px;
}

.mini-stat-row {
    display: flex;
    align-items: center;
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.7rem;
    font-weight: 800;
    text-transform: uppercase;
    gap: 8px;
}

.ms-label { font-weight: 950; min-width: 50px; text-align: right; }
.ms-visual { letter-spacing: 2px; }
.ms-info { opacity: 0.6; margin-left: 5px; font-size: 0.65rem; }

/* COULEURS */
.row-cross { color: #ef4444; }
.row-bonus { color: #d97706; }

/* --- BANNER PUNITION --- */
.punishment-alert {
    background: #fff1f2;
    border: 3px solid #fda4af;
    color: #be123c;
    padding: 15px;
    border-radius: 20px;
    margin-bottom: 5px; /* Juste au dessus de la top bar */
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 15px;
    font-weight: 900;
    font-size: 0.9rem;
    box-shadow: 0 4px 15px rgba(251, 113, 133, 0.2);
    animation: pulse-alert 2s infinite;
}

.punishment-alert.late {
    background: #ef4444;
    color: white;
    border-color: #b91c1c;
    animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
}

.punishment-days {
    background: white;
    color: #be123c;
    padding: 4px 10px;
    border-radius: 8px;
    font-size: 1.1rem;
    font-family: 'JetBrains Mono', monospace;
}

@keyframes pulse-alert {
    0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(251, 113, 133, 0.7); }
    70% { transform: scale(1.02); box-shadow: 0 0 0 10px rgba(251, 113, 133, 0); }
    100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(251, 113, 133, 0); }
}

@keyframes shake {
  10%, 90% { transform: translate3d(-1px, 0, 0); }
  20%, 80% { transform: translate3d(2px, 0, 0); }
  30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
  40%, 60% { transform: translate3d(4px, 0, 0); }
}

@media (max-width: 768px) {
    .nav-bar-container { flex-direction: column; align-items: stretch; }
    .nav-tabs { overflow-x: auto; }
    .mini-stats-box { border-top: 1px solid #f1f5f9; padding-top: 10px; padding-right: 0; align-items: center; }
}
[[[Â£ END: client/src/features/eleve/components/EleveHeader.css Â£]]]

[[[Â£ FILE: client/src/features/eleve/components/EleveHeader.jsx Â£]]]
import React from 'react';
import './EleveHeader.css';

export default function EleveHeader({ user, onLogout, onBackToProf, activeTab, onTabChange }) {
  const isJean = user.firstName === 'Jean' && user.lastName === 'Vuillet';

  // --- LOGIQUE STATS ---
  const record = (user.behaviorRecords && user.behaviorRecords.length > 0) 
      ? user.behaviorRecords[user.behaviorRecords.length - 1] 
      : { crosses: 0, bonuses: 0, weeksToRedemption: 3 };

  const crosses = record.crosses || 0;
  const weeksLeft = record.weeksToRedemption || 3;
  
  const totalBonuses = record.bonuses || 0;
  const currentBonuses = totalBonuses % 4; // 0, 1, 2, 3
  const nextAPlus = 4 - currentBonuses;

  const crossVisual = "âŒ".repeat(crosses) + ".".repeat(3 - crosses);
  const bonusVisual = "ğŸŒŸ".repeat(currentBonuses) + ".".repeat(4 - currentBonuses);

  // --- LOGIQUE PUNITION (COMPTE Ã€ REBOURS) ---
  let punishmentAlert = null;
  
  if (user.punishmentStatus === 'PENDING' || user.punishmentStatus === 'LATE') {
      const dueDate = user.punishmentDueDate ? new Date(user.punishmentDueDate) : new Date();
      const now = new Date();
      const diffTime = dueDate - now;
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
      const isLate = diffDays < 0 || user.punishmentStatus === 'LATE';

      punishmentAlert = (
          <div className={`punishment-alert ${isLate ? 'late' : ''}`}>
              <span className="text-2xl">{isLate ? 'ğŸš¨' : 'âš–ï¸'}</span>
              <div className="flex flex-col">
                  <span>{isLate ? "PUNITION EN RETARD !" : "PUNITION EN COURS"}</span>
                  <span className="text-[10px] opacity-80 uppercase font-bold">
                      {isLate ? "Rendez votre travail immÃ©diatement." : "Travail Ã  rendre dans la section Devoirs."}
                  </span>
              </div>
              {!isLate && (
                  <div className="flex items-center gap-2 ml-4">
                      <span className="text-xs font-bold opacity-60">IL RESTE</span>
                      <span className="punishment-days">{diffDays}j</span>
                  </div>
              )}
          </div>
      );
  }

  // GESTION DES OPTIONS (Groupes)
  // Si assignedGroups contient des objets (peuplÃ©s par le backend), on affiche le nom.
  const groups = Array.isArray(user.assignedGroups) ? user.assignedGroups : [];

  return (
    <div className="header-wrapper">
      
      {punishmentAlert}

      {/* 1. TOP BAR (IdentitÃ©) */}
      <div className="top-bar">
        <div className="flex items-center gap-4">
          <h1 className="brand-name">Condamine</h1>
          {(user.isDeveloper || isJean) && (
            <button onClick={onBackToProf} className="v80-back-prof">ğŸ“ RETOUR PROF</button>
          )}
        </div>

        <div className="flex items-center gap-3">
            <div className="v80-user-info">
                <span className="v80-user-name">{user.firstName} {user.lastName}</span>
                <div className="v80-badges-row">
                    <span className="v80-user-class">{user.currentClass || 'CLASSE ?'}</span>
                    {groups.map((grp, i) => (
                        <span key={i} className="v80-user-option">
                            {typeof grp === 'object' ? grp.name : 'OPTION'}
                        </span>
                    ))}
                </div>
            </div>
            <button onClick={onLogout} className="v80-logout-btn">âœ•</button>
        </div>
      </div>

      {/* 2. NAV BAR + MINI STATS */}
      <div className="nav-bar-container">
        {/* Onglets Ã  Gauche */}
        <div className="nav-tabs">
            <button onClick={() => onTabChange('devoirs')} className={`tab-item ${activeTab === 'devoirs' ? 'tab-active' : ''}`}>ğŸ“š DEVOIRS</button>
            <button onClick={() => onTabChange('francais')} className={`tab-item ${activeTab === 'francais' ? 'tab-active' : ''}`}>ğŸ‡«ğŸ‡· FRANÃ‡AIS</button>
            <button onClick={() => onTabChange('jeux')} className={`tab-item ${activeTab === 'jeux' ? 'tab-active' : ''}`}>ğŸ® JEUX</button>
        </div>

        {/* Stats Ã  Droite (Simple et discret) */}
        <div className="mini-stats-box">
            {/* LIGNE CROIX */}
            <div className="mini-stat-row row-cross">
                <span className="ms-label">CROIX:</span>
                <span className="ms-visual">{crosses > 0 ? crossVisual : "..."}</span>
                {crosses > 0 && <span className="ms-info">(Annul. {weeksLeft} sem.)</span>}
            </div>
            
            {/* LIGNE BONUS */}
            <div className="mini-stat-row row-bonus">
                <span className="ms-label">BONUS:</span>
                <span className="ms-visual">{currentBonuses > 0 ? bonusVisual : "...."}</span>
                <span className="ms-info">({nextAPlus} avant A+)</span>
            </div>
        </div>
      </div>
    </div>
  );
}
[[[Â£ END: client/src/features/eleve/components/EleveHeader.jsx Â£]]]

[[[Â£ FILE: client/src/features/eleve/games/GamesGrid.css Â£]]]
.game-selector-overlay { position: fixed; inset: 0; z-index: 9999; background: rgba(253, 242, 248, 0.95); display: flex; align-items: center; justify-content: center; }
.selector-card { background: white; padding: 3rem; border-radius: 60px; text-align: center; border: 8px solid #fbcfe8; }
.game-choice-btn { height: 180px; width: 220px; border-radius: 40px; border: none; cursor: pointer; font-weight: 900; color: white; font-size: 1.2rem; }
.zombie-btn { background: #22c55e; margin-right: 20px; }
.starship-btn { background: #3b82f6; }
[[[Â£ END: client/src/features/eleve/games/GamesGrid.css Â£]]]

[[[Â£ FILE: client/src/features/eleve/games/GamesGrid.jsx Â£]]]
import React, { useState, useEffect } from 'react';
import ZombieWrapper from './zombie/ZombieWrapper';
import StarshipWrapper from './starship/StarshipWrapper';
import DashboardFolder from '../components/DashboardFolder';
import './GamesGrid.css';

export default function GamesGrid({ user }) {
  const [quizzes, setQuizzes] = useState([]);
  const [chapters, setChapters] = useState([]);
  const [selectedQuiz, setSelectedQuiz] = useState(null);
  const [activeGame, setActiveGame] = useState(null);
  const [refreshing, setRefreshing] = useState(false);

  const loadData = async () => {
    setRefreshing(true);
    const myId = String(user._id || user.id);
    const myClass = (user.currentClass || "").trim().toUpperCase();
    
    const rawGroups = user.assignedGroups || [];
    const myGroupIds = rawGroups.map(g => (typeof g === 'object' && g !== null) ? String(g._id) : String(g));

    try {
        const [allGames, allProgs, allClasses] = await Promise.all([
            fetch('/api/games/all').then(r => r.json()),
            fetch('/api/games/progress').then(r => r.json()),
            fetch('/api/auth/config').then(r => r.json()).then(d => d.classrooms || [])
        ]);

        const myGroupNames = allClasses
            .filter(c => myGroupIds.includes(String(c._id)))
            .map(c => c.name.toUpperCase().trim());

        const myTargets = [myClass, ...myGroupNames];

        const filtered = allGames.filter(g => {
            const targets = (g.targetClassrooms || (g.classroom ? [g.classroom] : [])).map(t => t.toUpperCase().trim());
            const assignedIds = (g.assignedStudents || []).map(id => String(id));

            if (assignedIds.includes(myId)) return true;

            // Matching robuste (case insensitive, trim)
            const isTargetedGroup = targets.some(t => myTargets.includes(t));
            
            if (isTargetedGroup) {
                if (g.isAllClass === true) return true;
                // Si "AssignedStudents" est vide mais "isAllClass" est false (cas ambigu), on affiche quand mÃªme si cible
                if (assignedIds.length === 0) return true;
            }
            return false;
        }).map(g => {
            const prog = allProgs.find(p => String(p.studentId) === myId && String(p.gameId) === String(g._id));
            let status = 'todo'; 
            if (prog) {
                if (prog.levelReached >= 1) status = 'done'; 
                else status = 'inprogress'; 
            }
            return { ...g, status };
        });

        setQuizzes(filtered);
    } catch(e) { console.error("GamesGrid Error:", e); }
    setRefreshing(false);
  };

  useEffect(() => {
    loadData();
    fetch('/api/structure/chapters').then(r => r.json()).then(setChapters);
  }, [user]);

  if (activeGame && selectedQuiz) {
      const close = () => { 
          setActiveGame(null); 
          setSelectedQuiz(null);
          loadData(); 
      };
      return activeGame === 'zombie' ? <ZombieWrapper user={user} level={selectedQuiz} onClose={close} /> : <StarshipWrapper user={user} level={selectedQuiz} onClose={close} />;
  }

  if (selectedQuiz) return (
      <div className="game-selector-overlay">
          <div className="selector-card">
              <div className="flex gap-4">
                  <button onClick={() => setActiveGame('zombie')} className="game-choice-btn zombie-btn">ğŸ§Ÿ ZOMBIE</button>
                  <button onClick={() => setActiveGame('starship')} className="game-choice-btn starship-btn">ğŸš€ STARSHIP</button>
              </div>
              <button onClick={() => setSelectedQuiz(null)} className="mt-8 font-black text-pink-300 border-none bg-transparent cursor-pointer">RETOUR</button>
          </div>
      </div>
  );

  return (
    <div className="flex flex-col gap-4">
        <div className="flex justify-end">
            <button onClick={loadData} className="text-[10px] font-black text-slate-400 bg-white px-3 py-1 rounded-xl border border-slate-200 hover:text-slate-600 transition-colors">
                {refreshing ? '...' : 'ğŸ”„ ACTUALISER'}
            </button>
        </div>
        <DashboardFolder items={quizzes} chapters={chapters} type="game" onSelect={setSelectedQuiz} />
    </div>
  );
}
[[[Â£ END: client/src/features/eleve/games/GamesGrid.jsx Â£]]]

[[[Â£ FILE: client/src/features/eleve/games/mainGames.js Â£]]]
export class GameProgression {
    constructor(questions, maxLives = 4) {
        this.questions = questions;
        this.lives = maxLives;
        this.states = questions.map(() => ({ level: 0, done: false }));
    }
    normalize(str) { return str.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[^a-z0-9]/g, ""); }
    getNextActiveQuestion() {
        const idx = this.states.findIndex(s => !s.done);
        return idx === -1 ? null : { q: this.questions[idx], idx, level: this.states[idx].level };
    }
    submitAnswer(qIdx, answer) {
        const q = this.questions[qIdx];
        const state = this.states[qIdx];
        let success = state.level < 2 ? (parseInt(answer) === q.a) : (this.normalize(answer) === this.normalize(q.options[q.a]));
        if (success) { state.level++; if (state.level >= 3) state.done = true; }
        else if (state.level > 0) state.level--;
        return { success, isDone: state.done };
    }
    loseLife(qIdx) { this.lives--; if (this.states[qIdx].level > 0) this.states[qIdx].level--; return { lives: this.lives, isDead: this.lives <= 0 }; }
    getTrackerData() {
        const current = this.states.reduce((acc, s) => acc + Math.min(s.level, 3), 0);
        return { dots: this.states.map(s => ({ pct: (s.level/3)*100, done: s.done })), globalPct: (current / (this.states.length * 3)) * 100 };
    }
    getLives() { return this.lives; }
}
[[[Â£ END: client/src/features/eleve/games/mainGames.js Â£]]]

[[[Â£ FILE: client/src/features/eleve/games/starship/StarshipWrapper.jsx Â£]]]
import React, { useEffect, useRef } from 'react';
import { initStarshipGame } from './starship_core';
import './starship_style.css';

export default function StarshipWrapper({ user, level, onClose }) {
    const boxRef = useRef(null);

    const saveProgress = async (score, lvl) => {
        if (!user || !level) return;
        try {
            await fetch('/api/games/save-progress', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    studentId: user._id || user.id,
                    gameId: level._id,
                    score: score,
                    levelReached: lvl
                })
            });
        } catch (e) { console.error("Save fail", e); }
    };

    const handleGameFinish = (score, success) => {
        saveProgress(score, success ? 1 : 0);
        onClose();
    };

    useEffect(() => {
        if (level && boxRef.current) {
            // 1. SIGNAL DE DÃ‰PART (Pastille Bleue)
            saveProgress(0, 0);

            // 2. Moteur
            const engine = initStarshipGame(boxRef.current, { level, user, onFinish: handleGameFinish }, onClose);
            return () => engine.destroy();
        }
    }, [level]);

    return (
        <div className="fixed inset-0 bg-black z-[9999] flex flex-col w-full h-full">
            <div id="starship-root" ref={boxRef} className="w-full h-full relative overflow-hidden"></div>
        </div>
    );
}
[[[Â£ END: client/src/features/eleve/games/starship/StarshipWrapper.jsx Â£]]]

[[[Â£ FILE: client/src/features/eleve/games/starship/starship_core.js Â£]]]
import { GameProgression } from '../mainGames';

export function initStarshipGame(root, api, onExit) {
    let questionsList = api.level.questions || [{ q: "Erreur", options: ["Bug"], a: 0 }];
    const questionStates = questionsList.map(() => 0);
    
    let currentQIndex = -1;
    let currentQ = null; 
    let lives = 4;
    
    let shipX = 50; 
    let projectiles = []; 
    let enemies = []; 
    let spawnInterval;
    let isPaused = false;
    let frameId;
    
    root.innerHTML = `
        <div class="s-game-wrapper">
            <div class="s-stars"></div>
            <div class="s-hud">
                <div class="s-lives">â¤ï¸â¤ï¸â¤ï¸â¤ï¸</div>
                <div class="s-bars-container" id="s-bars"></div>
                <button class="s-quit-btn">QUITTER</button>
            </div>
            <div id="s-q-banner" class="s-question-banner">PrÃªt ?</div>
            <div class="s-play-area" id="s-area">
                <div id="s-ship" class="s-ship">ğŸš€</div>
                <div id="s-projectiles-layer"></div>
                <div id="s-enemies-layer"></div>
            </div>
            <div class="s-boss-interface" id="s-boss-ui" style="display:none">
                <input type="text" id="s-boss-input" class="s-boss-input" placeholder="CODE DE TIR !" autocomplete="off">
                <button id="s-nuke-btn" class="s-nuke-btn">â˜¢ï¸ NUKE</button>
            </div>
            <button class="s-mobile-shoot" id="s-mobile-fire">ğŸ”¥</button>
        </div>
    `;

    const els = {
        ship: root.querySelector('#s-ship'),
        area: root.querySelector('#s-area'),
        pLayer: root.querySelector('#s-projectiles-layer'),
        eLayer: root.querySelector('#s-enemies-layer'),
        qText: root.querySelector('#s-q-banner'),
        bars: root.querySelector('#s-bars'),
        lives: root.querySelector('.s-lives'),
        bossUI: root.querySelector('#s-boss-ui'),
        bossInput: root.querySelector('#s-boss-input'),
        nukeBtn: root.querySelector('#s-nuke-btn')
    };

    const renderBars = () => {
        els.bars.innerHTML = '';
        questionStates.forEach((score, i) => {
            const box = document.createElement('div');
            box.className = 's-mini-bar-box';
            if (i === currentQIndex) box.classList.add('active');
            for(let s=0; s<3; s++) {
                const seg = document.createElement('div');
                seg.className = 's-bar-seg';
                if (score > s) seg.classList.add('filled');
                box.appendChild(seg);
            }
            els.bars.appendChild(box);
        });
    };

    const normalize = (str) => (str || "").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[^a-z0-9]/g, "");

    const failAction = (msg) => {
        lives--;
        els.lives.innerText = "â¤ï¸".repeat(lives);
        if (questionStates[currentQIndex] > 0) questionStates[currentQIndex]--;

        const fb = document.createElement('div');
        fb.className = 's-feedback';
        fb.innerText = msg || "IMPACT !";
        root.appendChild(fb);
        setTimeout(() => fb.remove(), 1500);

        if (lives <= 0) {
            alert("VAISSEAU DÃ‰TRUIT !");
            if (api.onFinish) api.onFinish(0, true); 
            else onExit();
        } else {
            loadRound(); 
        }
    };

    const triggerNuke = () => {
        isPaused = true;
        const flash = document.createElement('div');
        flash.className = 's-nuke-flash';
        root.appendChild(flash);
        setTimeout(() => { flash.remove(); isPaused = false; loadRound(); }, 800);
    };

    const handleBossInput = () => {
        if (isPaused) return;
        const qData = questionsList[currentQIndex];
        const correctTxt = qData.options[qData.a];
        if (normalize(els.bossInput.value) === normalize(correctTxt)) {
            questionStates[currentQIndex]++;
            triggerNuke();
        } else {
            failAction(`Non ! C'Ã©tait : ${correctTxt}`);
        }
    };

    const moveShip = (delta) => { if (!isPaused) { shipX = Math.max(5, Math.min(95, shipX + delta)); els.ship.style.left = shipX + '%'; } };

    const fire = () => {
        if (isPaused || questionStates[currentQIndex] >= 2) return;
        const p = document.createElement('div');
        p.className = 's-projectile';
        p.style.left = shipX + '%';
        p.style.bottom = '80px'; 
        els.pLayer.appendChild(p);
        projectiles.push({ div: p, xPct: shipX, y: 80 });
    };

    const startBossPhase = () => {
        const boss = document.createElement('div');
        boss.className = 's-boss';
        boss.innerText = "ğŸ›¸"; 
        boss.style.left = '50%';
        boss.style.top = '10%';
        els.eLayer.appendChild(boss);
        enemies.push({ div: boss, xPct: 50, y: 50, speed: 0.2, isCorrect: true, type: 'boss' });
    };

    const startInvaderPhase = () => {
        const qData = questionsList[currentQIndex];
        spawnInterval = setInterval(() => {
            if (isPaused || enemies.length > 6) return;
            const opts = qData.options;
            const rIdx = Math.floor(Math.random() * opts.length);
            const isCorrect = (rIdx === qData.a);
            const el = document.createElement('div');
            el.className = isCorrect ? 's-enemy s-correct-target' : 's-enemy';
            el.innerText = opts[rIdx];
            const startX = 10 + Math.random() * 80;
            el.style.left = startX + '%';
            el.style.top = '-60px';
            els.eLayer.appendChild(el);
            enemies.push({ div: el, xPct: startX, y: -60, speed: 1.5 + (Math.random() * 1), isCorrect: isCorrect, type: 'invader' });
        }, 1500);
    };

    const clearLevel = () => {
        clearInterval(spawnInterval);
        enemies.forEach(e => e.div.remove()); enemies = [];
        projectiles.forEach(p => p.div.remove()); projectiles = [];
    };

    const getNextQuestion = () => {
        if (currentQIndex !== -1 && questionStates[currentQIndex] < 3) return currentQIndex;
        const available = questionStates.map((s, i) => s < 3 ? i : -1).filter(i => i !== -1);
        if (available.length === 0) return null;
        return available[Math.floor(Math.random() * available.length)];
    };

    const loadRound = () => {
        clearLevel();
        const nextIdx = getNextQuestion();
        if (nextIdx === null) {
            alert("GALAXIE SAUVÃ‰E !");
            if (api.onFinish) api.onFinish(lives * 100, true);
            else onExit();
            return;
        }
        currentQIndex = nextIdx;
        currentQ = questionsList[currentQIndex];
        const qData = currentQ;
        const score = questionStates[currentQIndex];
        els.qText.innerText = qData.q;
        renderBars();
        if (score >= 2) {
            els.bossUI.style.display = 'flex';
            els.bossInput.value = '';
            setTimeout(() => els.bossInput.focus(), 50);
            startBossPhase();
        } else {
            els.bossUI.style.display = 'none';
            startInvaderPhase();
        }
    };

    const update = () => {
        if (!isPaused) {
            for (let i = projectiles.length - 1; i >= 0; i--) {
                const p = projectiles[i];
                p.y += 8;
                p.div.style.bottom = p.y + 'px';
                if (p.y > window.innerHeight) { p.div.remove(); projectiles.splice(i, 1); }
            }
            for (let i = enemies.length - 1; i >= 0; i--) {
                const e = enemies[i];
                e.y += e.speed;
                e.div.style.top = e.y + 'px';
                if (e.type === 'invader') {
                    const eRect = e.div.getBoundingClientRect();
                    for (let j = projectiles.length - 1; j >= 0; j--) {
                        const p = projectiles[j];
                        const pRect = p.div.getBoundingClientRect();
                        if (!(pRect.right < eRect.left || pRect.left > eRect.right || pRect.bottom < eRect.top || pRect.top > eRect.bottom)) {
                            p.div.remove(); projectiles.splice(j, 1);
                            e.div.remove(); enemies.splice(i, 1);
                            if (e.isCorrect) { questionStates[currentQIndex]++; loadRound(); } else { failAction("MAUVAISE CIBLE !"); }
                            return; 
                        }
                    }
                }
                const shipRect = els.ship.getBoundingClientRect();
                const eRect = e.div.getBoundingClientRect();
                const hitbox = { left: shipRect.left + 10, right: shipRect.right - 10, top: shipRect.top + 10, bottom: shipRect.bottom - 10 };
                if (!(hitbox.right < eRect.left || hitbox.left > eRect.right || hitbox.bottom < eRect.top || hitbox.top > eRect.bottom)) {
                    failAction("COLLISION !"); return;
                }
                if (e.y > window.innerHeight - 50) { e.div.remove(); enemies.splice(i, 1); }
            }
        }
        frameId = requestAnimationFrame(update);
    };

    root.querySelector('.s-quit-btn').onclick = onExit;
    const handleKey = (e) => { if (e.key === 'ArrowLeft') moveShip(-5); if (e.key === 'ArrowRight') moveShip(5); if (e.code === 'Space') { e.preventDefault(); fire(); } };
    document.addEventListener('keydown', handleKey);
    root.addEventListener('touchstart', (e) => { if(e.target.tagName !== 'BUTTON' && e.target.tagName !== 'INPUT') { const x = e.touches[0].clientX; if (x < window.innerWidth / 2) moveShip(-5); else moveShip(5); } });
    root.querySelector('#s-mobile-fire').onclick = (e) => { e.stopPropagation(); fire(); };
    els.bossInput.onkeydown = (e) => { if(e.key === 'Enter') handleBossInput(); };
    els.nukeBtn.onclick = handleBossInput;

    loadRound();
    update();

    return { destroy: () => { cancelAnimationFrame(frameId); clearInterval(spawnInterval); document.removeEventListener('keydown', handleKey); } };
}
[[[Â£ END: client/src/features/eleve/games/starship/starship_core.js Â£]]]

[[[Â£ FILE: client/src/features/eleve/games/starship/starship_style.css Â£]]]
/* DESIGN SPACE INVADERS */
.s-game-wrapper {
    position: relative; width: 100%; height: 100%;
    background: #000; /* Espace noir */
    font-family: 'Orbitron', sans-serif;
    color: white; overflow: hidden;
    user-select: none;
}

/* Ã‰toiles fond (CSS pur) */
.s-stars {
    position: absolute; inset: 0;
    background-image: 
        radial-gradient(white 1px, transparent 1px),
        radial-gradient(white 1px, transparent 1px);
    background-size: 50px 50px, 100px 100px;
    background-position: 0 0, 25px 25px;
    opacity: 0.5;
}

/* HUD */
.s-hud {
    position: absolute; top: 0; width: 100%; height: 60px;
    display: flex; justify-content: space-between; align-items: center;
    padding: 0 20px; background: rgba(0,0,0,0.8);
    border-bottom: 1px solid #333; z-index: 50;
}
.s-lives { font-size: 1.2rem; letter-spacing: 2px; }
.s-quit-btn {
    background: #ef4444; border: 1px solid #f87171; color: white;
    border-radius: 4px; padding: 5px 10px; cursor: pointer;
    font-family: inherit; font-weight: bold;
}

/* BARRES PROGRESSION */
.s-bars-container { display: flex; gap: 6px; }
.s-mini-bar-box {
    display: flex; gap: 2px; padding: 2px;
    border: 1px solid #333; border-radius: 2px;
}
.s-mini-bar-box.active { border-color: #06b6d4; box-shadow: 0 0 5px #06b6d4; }
.s-bar-seg {
    width: 10px; height: 6px; background: #1e293b;
}
.s-bar-seg.filled { background: #06b6d4; box-shadow: 0 0 5px #06b6d4; }

/* BANNER QUESTION */
.s-question-banner {
    position: absolute; top: 70px; width: 100%; text-align: center;
    font-size: 1.3rem; font-weight: 900; color: #facc15;
    text-shadow: 0 0 10px #facc15; z-index: 10;
    padding: 0 20px;
}

/* PLAY AREA */
.s-play-area {
    position: absolute; inset: 0;
}

/* VAISSEAU */
.s-ship {
    position: absolute; bottom: 30px; 
    font-size: 3rem; transform: translateX(-50%);
    text-shadow: 0 0 20px #3b82f6;
    transition: left 0.05s linear;
    z-index: 20;
}

/* ENNEMIS (RÃ©ponses) */
.s-enemy {
    position: absolute; 
    background: #1e293b; border: 2px solid #ef4444; color: white;
    padding: 8px 12px; border-radius: 6px; 
    font-size: 0.9rem; font-weight: bold;
    transform: translateX(-50%);
    box-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
    white-space: nowrap; z-index: 15;
}
/* Juste pour debug visuel (optionnel) */
/* .s-correct-target { border-color: #22c55e; } */

.s-projectile {
    position: absolute; width: 4px; height: 15px;
    background: #06b6d4; box-shadow: 0 0 8px #06b6d4;
    transform: translateX(-50%); z-index: 18;
}

/* BOSS */
.s-boss {
    position: absolute; font-size: 5rem;
    transform: translateX(-50%);
    text-shadow: 0 0 30px #a855f7; z-index: 25;
}

/* BOSS INPUT UI */
.s-boss-interface {
    position: absolute; bottom: 100px; width: 100%;
    display: flex; gap: 10px; justify-content: center;
    z-index: 60;
}
.s-boss-input {
    background: rgba(0,0,0,0.8); border: 2px solid #a855f7;
    color: #a855f7; padding: 10px; font-family: inherit; font-size: 1.2rem;
    text-transform: uppercase; text-align: center;
}
.s-nuke-btn {
    background: #a855f7; color: white; border: none; padding: 0 20px;
    font-weight: bold; cursor: pointer;
}

/* FEEDBACK */
.s-feedback {
    position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
    font-size: 3rem; color: #ef4444; font-weight: 900;
    text-shadow: 0 0 20px red; pointer-events: none; z-index: 100;
}

.s-nuke-flash {
    position: fixed; inset: 0; background: white; z-index: 200;
    animation: flash 0.8s ease-out forwards;
}
@keyframes flash { from { opacity: 1; } to { opacity: 0; } }

.s-mobile-shoot {
    position: absolute; bottom: 20px; right: 20px;
    width: 70px; height: 70px; background: rgba(255,255,255,0.1);
    border: 2px solid rgba(255,255,255,0.3); border-radius: 50%;
    font-size: 2rem; display: flex; align-items: center; justify-content: center;
    color: white; z-index: 50;
}
[[[Â£ END: client/src/features/eleve/games/starship/starship_style.css Â£]]]

[[[Â£ FILE: client/src/features/eleve/games/zombie/ZombieGame.css Â£]]]
.z-container { width: 100%; max-width: 800px; background: white; border-radius: 30px; border: 4px solid #1e293b; overflow: hidden; }
#zombie-arena { height: 200px; background: #1e293b; position: relative; }
[[[Â£ END: client/src/features/eleve/games/zombie/ZombieGame.css Â£]]]

[[[Â£ FILE: client/src/features/eleve/games/zombie/ZombieGame.js Â£]]]
export class ZombieGame {
    constructor(container, ctrl) { this.c = container; this.ctrl = ctrl; }
    loadQuestion(q) { this.c.querySelector('#z-q').textContent = q.q; }
}
[[[Â£ END: client/src/features/eleve/games/zombie/ZombieGame.js Â£]]]

[[[Â£ FILE: client/src/features/eleve/games/zombie/ZombieWrapper.jsx Â£]]]
import React, { useEffect, useRef } from 'react';
import { initZombieGame } from './zombie_core';
import './zombie_style.css';

export default function ZombieWrapper({ user, level, onClose }) {
    const boxRef = useRef(null);
    
    // Fonction gÃ©nÃ©rique pour sauvegarder
    const saveProgress = async (score, lvl) => {
        if (!user || !level) return;
        try {
            await fetch('/api/games/save-progress', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    studentId: user._id || user.id,
                    gameId: level._id,
                    score: score,
                    levelReached: lvl
                })
            });
        } catch (e) { console.error("Save fail", e); }
    };

    // Callback Fin de jeu (Win/Lose)
    const handleGameFinish = (score, success) => {
        saveProgress(score, success ? 1 : 0); // 1 = Violet, 0 = Bleu
        onClose();
    };

    useEffect(() => {
        if (!level || !boxRef.current) return;

        // 1. SIGNAL DE DÃ‰PART : On marque "Bleu" (0) dÃ¨s l'ouverture
        // Comme Ã§a, mÃªme si l'Ã©lÃ¨ve quitte avec la croix, c'est marquÃ© "Vu/EssayÃ©"
        saveProgress(0, 0);

        // 2. Lancement du jeu
        const engine = initZombieGame(boxRef.current, { level, user, onFinish: handleGameFinish }, onClose);
        
        return () => engine.destroy();
    }, [level]);

    return (
        <div className="fixed inset-0 bg-black z-[9999] flex flex-col">
            <div id="zombie-root" ref={boxRef} className="w-full h-full"></div>
        </div>
    );
}
[[[Â£ END: client/src/features/eleve/games/zombie/ZombieWrapper.jsx Â£]]]

[[[Â£ FILE: client/src/features/eleve/games/zombie/zombie_core.js Â£]]]
export function initZombieGame(root, api, onExit) {
    // --- 1. DONNÃ‰ES & Ã‰TAT ---
    let questionsList = api.level.questions;
    if (!questionsList || !Array.isArray(questionsList) || questionsList.length === 0) {
        questionsList = [{ q: "Erreur config", options: ["OK"], a: 0 }];
    }

    const questionStates = questionsList.map(() => 0); 
    let currentQIndex = -1;
    let lives = 4;
    
    // Mouvement
    let zombiePos = 0; 
    let zombieSpeed = 0.035; 
    let frameId;
    let isPaused = false; 

    // --- 2. HTML UI ---
    root.innerHTML = `
        <div class="z-game-wrapper">
            <div class="z-hud">
                <div class="z-lives">â¤ï¸â¤ï¸â¤ï¸â¤ï¸</div>
                <div class="z-bars-container" id="bars-container"></div>
                <button class="z-quit-btn">QUITTER</button>
            </div>
            <div id="arena">
                <div id="hero-container" class="z-char-box" style="left: 5%;">
                    <div class="z-emoji">ğŸ§™â€â™‚ï¸</div>
                    <img src="/images/hero.png" class="z-img-layer" onload="this.style.opacity=1" onerror="this.style.display='none'"/>
                </div>
                <div id="zombie-container" class="z-char-box" style="right: 0%;">
                    <div class="z-emoji">ğŸ§Ÿ</div>
                    <img src="/images/zombi.png" class="z-img-layer" onload="this.style.opacity=1" onerror="this.style.display='none'"/>
                </div>
                <div id="projectile">ğŸ”¥</div>
                <div id="feedback-msg" class="z-feedback"></div>
            </div>
            <div class="z-interaction-zone">
                <div id="question-text" class="z-q-text">Chargement...</div>
                <div id="choices-area" class="z-choices-grid"></div>
                <div id="input-area" class="z-input-box" style="display:none">
                    <input type="text" id="answer-input" placeholder="TAPEZ LA RÃ‰PONSE..." autocomplete="off" />
                    <button id="validate-btn">TIRER</button>
                </div>
            </div>
        </div>
    `;

    const els = {
        hero: root.querySelector('#hero-container'),
        zombie: root.querySelector('#zombie-container'),
        zombieImg: root.querySelector('#zombie-container .z-img-layer'),
        zombieEmoji: root.querySelector('#zombie-container .z-emoji'),
        projectile: root.querySelector('#projectile'),
        lives: root.querySelector('.z-lives'),
        bars: root.querySelector('#bars-container'),
        qText: root.querySelector('#question-text'),
        choices: root.querySelector('#choices-area'),
        inputArea: root.querySelector('#input-area'),
        input: root.querySelector('#answer-input'),
        validateBtn: root.querySelector('#validate-btn'),
        feedback: root.querySelector('#feedback-msg')
    };

    const updatePositions = () => {
        els.zombie.style.right = zombiePos + '%';
    };

    // QUITTER SANS SAUVEGARDER (Bouton Quitter)
    root.querySelector('.z-quit-btn').onclick = onExit;
    
    els.validateBtn.onclick = () => handleInputAnswer();
    els.input.onkeydown = (e) => { if(e.key === 'Enter') handleInputAnswer(); };

    const renderBars = () => {
        els.bars.innerHTML = '';
        questionStates.forEach((score, i) => {
            const barBox = document.createElement('div');
            barBox.className = 'z-mini-bar-box';
            if (i === currentQIndex) barBox.classList.add('active-q');
            for(let s=0; s<3; s++) {
                const seg = document.createElement('div');
                seg.className = 'z-bar-seg';
                if (score > s) seg.classList.add('filled');
                barBox.appendChild(seg);
            }
            els.bars.appendChild(barBox);
        });
    };

    const getNextQuestion = () => {
        if (currentQIndex !== -1 && questionStates[currentQIndex] < 3) return currentQIndex;
        const available = questionStates.map((s, i) => s < 3 ? i : -1).filter(i => i !== -1);
        if (available.length === 0) return null;
        return available[Math.floor(Math.random() * available.length)];
    };

    const normalize = (str) => (str || "").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[^a-z0-9]/g, "");

    const loadRound = () => {
        const nextIdx = getNextQuestion();
        
        // --- VICTOIRE ---
        if (nextIdx === null) {
            alert("VICTOIRE !");
            // CALCUL DU SCORE (Basique : Vies restantes * 100)
            const finalScore = lives * 100;
            // APPEL API POUR SAUVEGARDER
            if (api.onFinish) api.onFinish(finalScore, true);
            else onExit();
            return;
        }

        currentQIndex = nextIdx;
        const qData = questionsList[currentQIndex];
        const score = questionStates[currentQIndex];

        els.qText.innerText = qData.q || "Question vide";
        renderBars();

        if (score >= 2) {
            els.choices.style.display = 'none';
            els.inputArea.style.display = 'flex';
            els.input.value = '';
            setTimeout(() => els.input.focus(), 50);
            els.zombieEmoji.innerText = "ğŸ‘¹"; 
            els.zombieImg.style.filter = "drop-shadow(0 0 15px red) hue-rotate(-50deg)";
        } else {
            els.inputArea.style.display = 'none';
            els.choices.style.display = 'grid';
            els.zombieEmoji.innerText = "ğŸ§Ÿ";
            els.zombieImg.style.filter = "none";
            els.choices.innerHTML = '';
            const rawOpts = qData.options || ["A", "B", "C", "D"];
            const opts = rawOpts.map((txt, idx) => ({ txt, idx }));
            opts.sort(() => Math.random() - 0.5);
            opts.forEach(o => {
                const btn = document.createElement('button');
                btn.className = 'z-btn';
                btn.style.color = "#000"; 
                btn.innerText = o.txt;
                btn.onclick = () => {
                    if (o.idx === qData.a) fireProjectile(true);
                    else failAction();
                };
                els.choices.appendChild(btn);
            });
        }
    };

    const handleInputAnswer = () => {
        if (isPaused) return;
        const qData = questionsList[currentQIndex];
        const correctTxt = qData.options[qData.a]; 
        if (normalize(els.input.value) === normalize(correctTxt)) fireProjectile(true);
        else {
            showFeedback(`RÃ©ponse : ${correctTxt}`, false);
            failAction();
        }
    };

    const failAction = () => {
        showFeedback("RATÃ‰ !", false);
        zombiePos += 15; 
        updatePositions();
    };

    const fireProjectile = (isHit) => {
        isPaused = true;
        els.projectile.style.display = 'block';
        let projX = 10;
        const targetX = 100 - zombiePos - 10; 

        const anim = setInterval(() => {
            projX += 4;
            els.projectile.style.left = projX + '%';

            if (projX >= targetX) {
                clearInterval(anim);
                els.projectile.style.display = 'none';
                if (isHit) {
                    questionStates[currentQIndex]++;
                    zombiePos = 0; 
                    updatePositions();
                    showFeedback("TOUCHÃ‰ !", true);
                    setTimeout(() => {
                        isPaused = false;
                        loadRound();
                    }, 500);
                }
            }
        }, 16);
    };

    const showFeedback = (msg, good) => {
        els.feedback.innerText = msg;
        els.feedback.style.color = good ? '#22c55e' : '#ef4444';
        els.feedback.style.opacity = 1;
        els.feedback.style.transform = 'translate(-50%, -50%) scale(1.5)';
        setTimeout(() => {
            els.feedback.style.opacity = 0;
            els.feedback.style.transform = 'translate(-50%, -50%) scale(0)';
        }, 1000);
    };

    const loop = () => {
        if (!isPaused) {
            zombiePos += zombieSpeed;
            updatePositions();

            if (zombiePos >= 85) {
                lives--;
                els.lives.innerText = "â¤ï¸".repeat(lives);
                if (questionStates[currentQIndex] > 0) {
                    questionStates[currentQIndex]--;
                    showFeedback("RECULE !", false);
                }
                zombiePos = 0; 
                updatePositions();
                document.querySelector('.z-game-wrapper').style.background = '#fee2e2';
                setTimeout(() => document.querySelector('.z-game-wrapper').style.background = '#f0f9ff', 200);

                // --- DÃ‰FAITE ---
                if (lives <= 0) {
                    alert("GAME OVER !");
                    // SAUVEGARDE MÃŠME EN CAS DE DÃ‰FAITE (Score partiel)
                    // On considÃ¨re que le jeu est "FAIT" mÃªme si perdu, pour enlever le badge rouge
                    // Ou alors false pour levelReached pour dire "Non validÃ©"
                    if (api.onFinish) api.onFinish(0, true); 
                    else onExit();
                } else {
                    loadRound();
                }
            }
        }
        frameId = requestAnimationFrame(loop);
    };

    updatePositions();
    loadRound();
    loop();

    return { destroy: () => cancelAnimationFrame(frameId) };
}
[[[Â£ END: client/src/features/eleve/games/zombie/zombie_core.js Â£]]]

[[[Â£ FILE: client/src/features/eleve/games/zombie/zombie_style.css Â£]]]
.z-game-wrapper {
    position: relative; width: 100%; height: 100%;
    display: flex; flex-direction: column; 
    background: #f0f9ff;
    font-family: 'Segoe UI', sans-serif;
    user-select: none;
    overflow: hidden; /* EmpÃªche le scroll */
}

/* HUD (Hauteur Fixe) */
.z-hud {
    height: 60px; flex-shrink: 0;
    background: #1e293b; color: white;
    display: flex; justify-content: space-between; align-items: center;
    padding: 0 20px;
    z-index: 50;
    border-bottom: 2px solid #334155;
}
.z-lives { font-size: 1.5rem; letter-spacing: 3px; }
.z-quit-btn {
    background: #ef4444; border: none; color: white; padding: 8px 16px;
    border-radius: 8px; font-weight: bold; cursor: pointer;
}

/* BARRES */
.z-bars-container { display: flex; gap: 6px; }
.z-mini-bar-box {
    display: flex; gap: 2px; padding: 2px;
    background: #334155; border-radius: 4px;
    border: 2px solid transparent;
}
.z-mini-bar-box.active-q { border-color: #fbbf24; }
.z-bar-seg {
    width: 12px; height: 8px; background: #475569; border-radius: 1px;
}
.z-bar-seg.filled { background: #22c55e; }

/* ARÃˆNE (Prend le reste de l'espace, minimum 50%) */
#arena {
    flex: 1; position: relative;
    background: linear-gradient(to bottom, #bae6fd 0%, #e0f2fe 80%, #64748b 80%, #475569 100%);
    overflow: hidden;
    min-height: 200px; /* SÃ©curitÃ© */
}

/* PERSONNAGES (Box Conteneur) */
.z-char-box {
    position: absolute; bottom: 15%;
    width: 120px; height: 120px;
    display: flex; align-items: center; justify-content: center;
}
/* Emoji en fond */
.z-emoji {
    font-size: 5rem; position: absolute; z-index: 1;
}
/* Image par dessus (opacitÃ© 0 au dÃ©but) */
.z-img-layer {
    width: 100%; height: 100%; object-fit: contain;
    filter: drop-shadow(0 10px 5px rgba(0,0,0,0.3));
    z-index: 2; opacity: 0; transition: opacity 0.2s;
}

#projectile {
    position: absolute; display: none;
    width: 40px; height: 40px; border-radius: 50%;
    background: radial-gradient(circle, #facc15, #ef4444);
    bottom: 20%; z-index: 20;
    font-size: 1.5rem; line-height: 40px; text-align: center;
    box-shadow: 0 0 20px #f59e0b;
}

.z-feedback {
    position: absolute; top: 50%; left: 50%;
    transform: translate(-50%, -50%) scale(0);
    font-size: 3rem; font-weight: 900;
    text-shadow: 3px 3px 0 white;
    pointer-events: none; transition: transform 0.2s, opacity 0.2s;
    z-index: 100; text-align: center;
    width: 100%;
}

/* ZONE QUIZ (Hauteur Fixe Importante pour visibilitÃ©) */
.z-interaction-zone {
    height: 40%; /* 40% de l'Ã©cran quoi qu'il arrive */
    flex-shrink: 0; /* Ne rÃ©trÃ©cit pas */
    background: white;
    border-top: 6px solid #cbd5e1;
    display: flex; flex-direction: column;
    padding: 15px; gap: 10px;
    box-shadow: 0 -10px 20px rgba(0,0,0,0.1);
}

.z-q-text {
    font-size: 1.3rem; font-weight: 800; color: #1e293b;
    text-align: center; width: 100%;
    padding: 10px; background: #f1f5f9; border-radius: 10px;
    border: 2px solid #e2e8f0;
    min-height: 50px; display: flex; align-items: center; justify-content: center;
}

/* GRILLE BOUTONS */
.z-choices-grid {
    display: grid; grid-template-columns: 1fr 1fr; gap: 10px;
    width: 100%; height: 100%;
}
.z-btn {
    background: white; border: 2px solid #94a3b8; border-radius: 12px;
    font-size: 1.1rem; font-weight: bold; color: #0f172a !important; /* NOIR FORCÃ‰ */
    cursor: pointer; box-shadow: 0 4px 0 #cbd5e1;
    transition: transform 0.1s;
    padding: 5px;
    white-space: normal; line-height: 1.2;
}
.z-btn:active { transform: translateY(4px); box-shadow: none; }
.z-btn:hover { border-color: #3b82f6; background: #eff6ff; }

/* INPUT BOSS */
.z-input-box {
    display: flex; gap: 10px; width: 100%; height: 100%; align-items: center; justify-content: center;
}
#answer-input {
    flex: 1; padding: 15px; font-size: 1.3rem; text-align: center;
    border: 4px solid #ef4444; border-radius: 12px;
    font-weight: bold; text-transform: uppercase; color: #b91c1c;
}
#validate-btn {
    padding: 0 30px; height: 60px;
    background: #ef4444; color: white;
    border: none; border-radius: 12px; font-weight: 900; font-size: 1.2rem;
    cursor: pointer; box-shadow: 0 4px 0 #991b1b;
}
[[[Â£ END: client/src/features/eleve/games/zombie/zombie_style.css Â£]]]

[[[Â£ FILE: client/src/features/eleve/homework/Homework.css Â£]]]
/* DÃ‰TECTEUR DE TRICHE (CHEAT ALERT) */
.cheat-alert-box {
    position: absolute;
    top: 30px; left: 50%; transform: translateX(-50%);
    background: #dc2626; color: white; padding: 15px 30px;
    border-radius: 50px; font-family: 'JetBrains Mono', monospace;
    font-weight: 900; font-size: 1.2rem; text-transform: uppercase;
    box-shadow: 0 20px 50px rgba(220, 38, 38, 0.5);
    z-index: 20000; animation: dropIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    border: 3px solid #fecaca; white-space: nowrap; pointer-events: none;
}
@keyframes dropIn { 0% { transform: translate(-50%, -100px); opacity: 0; } 100% { transform: translate(-50%, 0); opacity: 1; } }

.homework-container.v8-liseuse {
    background: #020617; height: 100vh; display: flex; flex-direction: column; overflow: hidden; position: fixed; inset: 0; z-index: 9999;
}

/* --- ZONE DU HAUT (SUJET) --- */
.viewer-top-area {
    flex: 65; /* Un peu moins de place pour laisser respirer le bas */
    position: relative; background: #0f172a; overflow: hidden;
    display: flex; align-items: center; justify-content: center;
    border-bottom: 4px solid #f97316;
    background-image: radial-gradient(#1e293b 1px, transparent 1px);
    background-size: 20px 20px;
}

/* BOUTON QUITTER */
.v8-quit-btn {
    position: absolute; top: 20px; left: 20px; z-index: 100;
    background: rgba(255, 255, 255, 0.1); color: white;
    font-family: 'JetBrains Mono', monospace; font-weight: 900; font-size: 11px;
    padding: 10px 20px; border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.2);
    cursor: pointer; backdrop-filter: blur(5px); transition: all 0.2s; text-transform: uppercase;
}
.v8-quit-btn:hover { background: #dc2626; border-color: #dc2626; transform: scale(1.05); }

/* CONTENEUR PANORAMIQUE COMMUN */
.v8-pan-container {
    display: flex; align-items: center; justify-content: center;
    height: 100%; width: 100%;
    transform-origin: center;
    cursor: grab;
    will-change: transform;
}
.v8-pan-container:active { cursor: grabbing; }

.v8-main-img {
    height: 90%; width: auto; object-fit: contain;
    box-shadow: 0 20px 60px rgba(0,0,0,0.8);
    border: 1px solid rgba(255,255,255,0.1);
    pointer-events: none; /* Important pour le drag */
}

/* --- CONTRÃ”LES ZOOM (NOUVEAU) --- */
.v8-zoom-controls {
    position: absolute; bottom: 20px; right: 20px; z-index: 50;
    display: flex; flex-direction: column; gap: 5px;
    background: rgba(0, 0, 0, 0.6); padding: 5px; border-radius: 12px;
    border: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(4px);
}
.btn-zoom {
    width: 35px; height: 35px; background: rgba(255,255,255,0.1); color: white;
    border: none; border-radius: 8px; font-weight: 900; font-size: 1.2rem;
    cursor: pointer; display: flex; align-items: center; justify-content: center;
    transition: background 0.2s;
}
.btn-zoom:hover { background: rgba(255,255,255,0.3); }

/* NAVIGATION ARROWS */
.v8-nav-arrow {
    position: absolute; top: 50%; transform: translateY(-50%); z-index: 10;
    background: rgba(15, 23, 42, 0.6); color: white;
    border: 2px solid rgba(255,255,255,0.2); width: 60px; height: 60px;
    border-radius: 50%; font-size: 24px; cursor: pointer; transition: all 0.2s;
    display: flex; align-items: center; justify-content: center;
}
.v8-nav-arrow:hover { background: #f97316; border-color: white; transform: translateY(-50%) scale(1.1); }
.v8-nav-arrow.left { left: 30px; }
.v8-nav-arrow.right { right: 30px; }

.v8-doc-counter {
    position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
    background: rgba(0,0,0,0.8); color: white; padding: 6px 20px;
    border-radius: 20px; font-size: 11px; font-weight: 900; letter-spacing: 0.1em;
}

/* --- ZONE DU BAS (CONSIGNE + RÃ‰PONSE) --- */
.interaction-bottom-area {
    flex: 35; /* Plus d'espace pour la consigne */
    background: white; display: flex; min-height: 0; /* Important pour le scroll interne */
}

/* PANNEAU CONSIGNE (GAUCHE) */
.question-panel {
    width: 40%;
    display: flex; flex-direction: column;
    border-right: 4px solid #f1f5f9;
    position: relative;
    background: #f8fafc;
    overflow: hidden; /* Pour le pan/zoom */
}

.question-header {
    padding: 10px 15px; background: white; border-bottom: 2px solid #e2e8f0;
    display: flex; justify-content: space-between; align-items: center;
    z-index: 10; flex-shrink: 0;
}

.v8-instruction-text-mini {
    font-size: 11px; color: #334155; font-weight: 600; 
    max-height: 40px; overflow-y: auto; line-height: 1.2;
}

.v8-instruction-viewer {
    flex: 1; position: relative; overflow: hidden;
    background-image: radial-gradient(#cbd5e1 1px, transparent 1px);
    background-size: 15px 15px;
    cursor: grab;
}
.v8-instruction-viewer:active { cursor: grabbing; }

.v8-instr-img {
    max-width: 90%; max-height: 90%;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    pointer-events: none;
}

.v8-page-badge {
    font-size: 9px; font-weight: 950; background: #f1f5f9; color: #64748b;
    padding: 4px 10px; border-radius: 6px; text-transform: uppercase;
}

/* PANNEAU RÃ‰PONSE (DROITE) */
.answer-panel {
    width: 60%; padding: 20px; display: flex; flex-direction: column; gap: 15px;
}

.answer-input {
    flex: 1; border: 2px solid #f1f5f9; border-radius: 20px; padding: 20px;
    font-size: 16px; font-weight: 600; outline: none; resize: none;
    transition: border-color 0.2s; background: #f8fafc;
}
.answer-input:focus { border-color: #2563eb; background: white; }

.v8-footer-actions { display: flex; justify-content: space-between; align-items: center; }
.v8-progress { font-weight: 950; font-size: 12px; color: #cbd5e1; text-transform: uppercase; }

.btn-send-ai {
    background: #2563eb; color: white; border: none; padding: 14px 30px;
    border-radius: 18px; font-weight: 950; font-size: 13px; cursor: pointer;
    transition: all 0.2s; box-shadow: 0 10px 15px -3px rgba(37, 99, 235, 0.3);
}
.btn-send-ai:hover { transform: translateY(-2px); background: #1d4ed8; }

/* MODALE FEEDBACK */
.ai-modal-overlay { position: fixed; inset: 0; z-index: 20000; background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(5px); display: flex; align-items: center; justify-content: center; }
.ai-modal-box { background: white; border-radius: 30px; padding: 40px; max-width: 600px; width: 90%; text-align: center; box-shadow: 0 50px 100px -20px rgba(0,0,0,0.5); }
.v8-grade-badge { width: 80px; height: 80px; background: #2563eb; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 32px; font-weight: 950; margin: 0 auto 20px; box-shadow: 0 10px 25px rgba(37, 99, 235, 0.4); }
.v8-feedback-content { background: #f8fafc; padding: 20px; border-radius: 20px; max-height: 250px; overflow-y: auto; font-size: 15px; line-height: 1.6; color: #475569; margin-bottom: 25px; text-align: left; border: 1px solid #e2e8f0; }
.v8-next-page-btn { width: 100%; padding: 20px; background: #1e293b; color: white; border-radius: 20px; font-weight: 950; font-size: 14px; border: none; cursor: pointer; transition: background 0.2s; }
.v8-next-page-btn:hover { background: #0f172a; }
[[[Â£ END: client/src/features/eleve/homework/Homework.css Â£]]]

[[[Â£ FILE: client/src/features/eleve/homework/HomeworkList.jsx Â£]]]
import React, { useState, useEffect } from 'react';
import HomeworkWorkspace from './HomeworkWorkspace';
import DashboardFolder from '../components/DashboardFolder';

export default function HomeworkList({ user }) {
  const [homeworks, setHomeworks] = useState([]);
  const [chapters, setChapters] = useState([]);
  const [selectedHw, setSelectedHw] = useState(null);

  const loadData = async () => {
    // SÃ©curisation des donnÃ©es utilisateur
    const myId = String(user._id || user.id);
    const myClass = (user.currentClass || "").toUpperCase().trim();
    
    // VÃ©rification du statut punition
    const isPunished = user.punishmentStatus === 'PENDING' || user.punishmentStatus === 'LATE';

    try {
        const [allHw, allSubs] = await Promise.all([
            fetch('/api/homework/all').then(r => r.json()),
            fetch('/api/homework/submissions').then(r => r.json())
        ]);

        // Liste des IDs de devoirs dÃ©jÃ  rendus par l'Ã©lÃ¨ve
        const myDoneHwIds = allSubs
            .filter(s => s.studentId && String(s.studentId) === myId)
            .map(s => String(s.homeworkId));

        const filtered = allHw.filter(hw => {
            // 1. CIBLAGE (Est-ce que ce devoir concerne ma classe ?)
            const targets = (hw.targetClassrooms || []).map(t => t.toUpperCase().trim());
            const legacyTarget = hw.classroom ? hw.classroom.toUpperCase().trim() : null;
            const isMyClassTargeted = targets.includes(myClass) || legacyTarget === myClass;

            // 2. LOGIQUE SPÃ‰CIALE PUNITION
            if (hw.isPunishment) {
                // Si ce n'est pas pour ma classe, je ne le vois pas
                if (!isMyClassTargeted) return false;

                // Si je suis PUNI, je DOIS voir la punition de ma classe
                if (isPunished) {
                    // Sauf si je l'ai dÃ©jÃ  rendue (auquel cas elle disparaÃ®t)
                    const isDone = myDoneHwIds.includes(String(hw._id));
                    return !isDone;
                }
                
                // Si je ne suis pas puni, je ne vois jamais les punitions
                return false;
            }

            // 3. LOGIQUE DEVOIRS NORMAUX
            const isAssignedIndividually = hw.assignedStudents?.some(id => String(id) === myId);
            const isAssigned = isAssignedIndividually || (isMyClassTargeted && hw.isAllClass);
            
            return isAssigned;

        }).map(hw => ({
            ...hw,
            status: myDoneHwIds.includes(String(hw._id)) ? 'done' : 'todo'
        }));

        setHomeworks(filtered);
    } catch(e) { console.error("Err loading HW", e); }
  };

  useEffect(() => {
    loadData();
    fetch('/api/structure/chapters').then(r => r.json()).then(setChapters);
  }, [user]); 

  if (selectedHw) return (
      <HomeworkWorkspace 
        homework={selectedHw} 
        user={user} 
        onQuit={() => { setSelectedHw(null); loadData(); }} 
      />
  );

  return <DashboardFolder items={homeworks} chapters={chapters} type="homework" onSelect={setSelectedHw} />;
}
[[[Â£ END: client/src/features/eleve/homework/HomeworkList.jsx Â£]]]

[[[Â£ FILE: client/src/features/eleve/homework/HomeworkWorkspace.jsx Â£]]]
import React, { useState, useEffect } from 'react';
import './Homework.css';

export default function HomeworkWorkspace({ homework, user, onQuit }) {
  const [pageIdx, setPageIdx] = useState(0);
  const [activeDocIdx, setActiveDocIdx] = useState(0);
  const [activeInstrIdx, setActiveInstrIdx] = useState(0);
  const [answer, setAnswer] = useState('');
  const [submitting, setSubmitting] = useState(false);
  const [aiResult, setAiResult] = useState(null);
  const [showCheatAlert, setShowCheatAlert] = useState(false);

  const [docState, setDocState] = useState({ scale: 1, x: 0, y: 0, dragging: false, startX: 0, startY: 0 });
  const [instrState, setInstrState] = useState({ scale: 1, x: 0, y: 0, dragging: false, startX: 0, startY: 0 });

  const currentPage = homework.levels[pageIdx];
  const instrDocs = currentPage.instructionUrls || [];
  const workDocs = currentPage.attachmentUrls || [];

  // CORRECTION V380 : RÃ©solution d'URL Intelligente
  const resolveSource = (url) => {
      if (!url) return '';
      // Cas 1 : URL complÃ¨te (ex: https://...)
      if (url.startsWith('http')) return url;
      // Cas 2 : Upload local (ex: /uploads/...)
      if (url.startsWith('/uploads')) return url;
      // Cas 3 : ID Drive ou autre -> Proxy
      return `/api/structure/proxy/${url}`;
  };

  useEffect(() => {
    setDocState({ scale: 1, x: 0, y: 0, dragging: false, startX: 0, startY: 0 });
    setInstrState({ scale: 1, x: 0, y: 0, dragging: false, startX: 0, startY: 0 });
    setActiveDocIdx(0);
    setActiveInstrIdx(0);
  }, [pageIdx]);

  const handleModalAction = () => {
      if (!aiResult) return;
      const g = aiResult.grade;
      if (g === 'C' || g.includes('C')) { setAnswer(''); setAiResult(null); }
      else if (g === 'B' || g.includes('B')) { setAiResult(null); }
      else { setAiResult(null); if(pageIdx < homework.levels.length - 1) { setPageIdx(pageIdx + 1); setAnswer(''); } else { onQuit(); } }
  };

  const getModalConfig = () => {
      if (!aiResult) return {};
      const g = aiResult.grade;
      if (g === 'C' || g.includes('C')) return { title: "TRAVAIL INSUFFISANT (C)", btn: "RECOMMENCER Ã€ ZÃ‰RO â†º", color: "#ef4444", msg: "Ta rÃ©ponse va Ãªtre effacÃ©e." };
      if (g === 'B' || g.includes('B')) return { title: "COMPÃ‰TENCE EN COURS (B)", btn: "COMPLÃ‰TER MA RÃ‰PONSE âœï¸", color: "#eab308", msg: "ComplÃ¨te ta rÃ©ponse." };
      if (g === 'A+' || g.includes('+')) return { title: "EXCELLENT TRAVAIL (A+)", btn: "PAGE SUIVANTE â”", color: "#14532d", msg: "Parfait !" };
      return { title: "TRAVAIL VALIDÃ‰ (A)", btn: "PAGE SUIVANTE â”", color: "#22c55e", msg: "C'est validÃ©." };
  };
  const modalConfig = getModalConfig();

  const handleZoom = (type, delta) => { if (type === 'doc') { setDocState(prev => ({ ...prev, scale: Math.max(0.5, Math.min(4, prev.scale + delta)) })); } else { setInstrState(prev => ({ ...prev, scale: Math.max(0.5, Math.min(4, prev.scale + delta)) })); } };
  const handleMouseDown = (e, type) => { const state = type === 'doc' ? docState : instrState; const setState = type === 'doc' ? setDocState : setInstrState; setState({ ...state, dragging: true, startX: e.clientX - state.x, startY: e.clientY - state.y }); };
  const handleMouseMove = (e, type) => { const state = type === 'doc' ? docState : instrState; const setState = type === 'doc' ? setDocState : setInstrState; if (state.dragging) { setState({ ...state, x: e.clientX - state.startX, y: e.clientY - state.startY }); } };
  const handleMouseUp = (type) => { const state = type === 'doc' ? docState : instrState; const setState = type === 'doc' ? setDocState : setInstrState; setState({ ...state, dragging: false }); };
  const handleInputCheck = (e) => { const newValue = e.target.value; if (newValue.length - answer.length > 50) { setShowCheatAlert(true); setTimeout(() => setShowCheatAlert(false), 4000); } setAnswer(newValue); };
  
  const submitToIA = async () => { 
      if(!answer.trim()) return; 
      setSubmitting(true); 
      try { 
          const res = await fetch('/api/homework/analyze-homework', { 
              method: 'POST', 
              headers: {'Content-Type':'application/json'}, 
              body: JSON.stringify({ userText: answer, homeworkId: homework._id, levelIndex: pageIdx, playerId: user._id || user.id }) 
          }).then(r => r.json()); 
          setAiResult(res); 
      } catch(e) { alert("Erreur serveur IA"); } 
      setSubmitting(false); 
  };

  return (
    <div className="homework-container v8-liseuse">
      {showCheatAlert && <div className="cheat-alert-box">ğŸš¨ COPIER-COLLER DÃ‰TECTÃ‰ ! Ã‰CRIS TOI-MÃŠME.</div>}
      <button onClick={onQuit} className="v8-quit-btn">â¬… QUITTER</button>

      {/* ZONE SUJET */}
      <div className="viewer-top-area" onMouseDown={(e) => handleMouseDown(e, 'doc')} onMouseMove={(e) => handleMouseMove(e, 'doc')} onMouseUp={() => handleMouseUp('doc')} onMouseLeave={() => handleMouseUp('doc')}>
          <div className="v8-zoom-controls">
              <button className="btn-zoom" onClick={(e) => { e.stopPropagation(); handleZoom('doc', 0.2); }}>+</button>
              <button className="btn-zoom" onClick={(e) => { e.stopPropagation(); handleZoom('doc', -0.2); }}>-</button>
          </div>
          {workDocs.length > 1 && (<><button className="v8-nav-arrow left" onClick={(e) => { e.stopPropagation(); setActiveDocIdx(Math.max(0, activeDocIdx - 1)); }}>â®</button><button className="v8-nav-arrow right" onClick={(e) => { e.stopPropagation(); setActiveDocIdx(Math.min(workDocs.length - 1, activeDocIdx + 1)); }}>â¯</button><div className="v8-doc-counter">{activeDocIdx + 1} / {workDocs.length}</div></>)}
          <div className="v8-pan-container" style={{ transform: `translate(${docState.x}px, ${docState.y}px) scale(${docState.scale})` }}>
              {workDocs.length > 0 ? (
                  <img src={resolveSource(workDocs[activeDocIdx])} className="v8-main-img" draggable="false" />
              ) : <div className="text-slate-700 font-black opacity-20">AUCUN DOCUMENT</div>}
          </div>
      </div>

      {/* ZONE BAS */}
      <div className="interaction-bottom-area">
          <div className="question-panel">
              <div className="question-header"><div className="v8-page-badge">Ã‰TAPE {pageIdx + 1}</div><div className="v8-instruction-text-mini">{currentPage.instruction || "Observez le document."}</div></div>
              <div className="v8-instruction-viewer" onMouseDown={(e) => handleMouseDown(e, 'instr')} onMouseMove={(e) => handleMouseMove(e, 'instr')} onMouseUp={() => handleMouseUp('instr')} onMouseLeave={() => handleMouseUp('instr')}>
                  <div className="v8-zoom-controls" style={{ bottom: '10px', right: '10px' }}><button className="btn-zoom" onClick={(e) => { e.stopPropagation(); handleZoom('instr', 0.2); }}>+</button><button className="btn-zoom" onClick={(e) => { e.stopPropagation(); handleZoom('instr', -0.2); }}>-</button></div>
                  <div className="v8-pan-container" style={{ transform: `translate(${instrState.x}px, ${instrState.y}px) scale(${instrState.scale})` }}>
                      {instrDocs.length > 0 ? (
                          <img src={resolveSource(instrDocs[activeInstrIdx])} className="v8-instr-img" draggable="false" />
                      ) : <div className="flex items-center justify-center h-full text-slate-300 font-bold text-xs uppercase">Aucune consigne image</div>}
                  </div>
              </div>
              {instrDocs.length > 1 && (<div className="flex gap-2 p-2 bg-white border-t border-slate-100 overflow-x-auto">{instrDocs.map((url, i) => (<img key={i} src={resolveSource(url)} onClick={() => setActiveInstrIdx(i)} className={`w-10 h-10 object-cover rounded border-2 cursor-pointer ${activeInstrIdx === i ? 'border-blue-500' : 'border-slate-200'}`} />))}</div>)}
          </div>

          <div className="answer-panel">
              <textarea className="answer-input" value={answer} onChange={handleInputCheck} placeholder="Votre rÃ©ponse ici..." />
              <div className="v8-footer-actions">
                  <div className="v8-progress">PAGE {pageIdx + 1} / {homework.levels.length}</div>
                  <button onClick={submitToIA} disabled={submitting} className="btn-send-ai">{submitting ? 'ANALYSE...' : 'ENVOYER ğŸ¤–'}</button>
              </div>
          </div>
      </div>

      {aiResult && (
          <div className="ai-modal-overlay">
              <div className="ai-modal-box">
                  <div className="v8-grade-badge" style={{backgroundColor: modalConfig.color}}>{aiResult.grade}</div>
                  <h2 style={{color: modalConfig.color, fontWeight:900, marginBottom: '5px', textTransform:'uppercase'}}>{modalConfig.title}</h2>
                  <p className="text-xs text-slate-400 font-bold mb-4 uppercase">{modalConfig.msg}</p>
                  <div dangerouslySetInnerHTML={{__html: aiResult.feedback_fond}} className="v8-feedback-content custom-scrollbar" />
                  <button onClick={handleModalAction} className="v8-next-page-btn" style={{backgroundColor: modalConfig.color}}>{modalConfig.btn}</button>
              </div>
          </div>
      )}
    </div>
  );
}
[[[Â£ END: client/src/features/eleve/homework/HomeworkWorkspace.jsx Â£]]]

[[[Â£ FILE: client/src/features/eleve/mistakes/MistakesBook.jsx Â£]]]
import React, { useState, useEffect } from 'react';

export default function MistakesBook({ user }) {
  const [mistakes, setMistakes] = useState([]);
  useEffect(() => {
    fetch('/api/players').then(r => r.json()).then(all => {
        const me = all.find(p => p._id === (user._id || user.id));
        setMistakes(me?.spellingMistakes || []);
    });
  }, []);

  return (
    <div className="bg-white p-8 rounded-[40px] shadow-sm animate-in">
      <h2 className="text-2xl font-black mb-6">Mon Carnet d'Orthographe âœ’ï¸</h2>
      <div className="space-y-3">
        {mistakes.map((m, i) => (
            <div key={i} className="p-4 bg-slate-50 rounded-2xl flex gap-4">
                <span className="text-red-500 line-through font-bold">{m.wrong}</span>
                <span>â”</span>
                <span className="text-green-600 font-black">{m.correct}</span>
            </div>
        ))}
        {mistakes.length === 0 && <p className="text-slate-300">Aucune erreur enregistrÃ©e.</p>}
      </div>
    </div>
  );
}
[[[Â£ END: client/src/features/eleve/mistakes/MistakesBook.jsx Â£]]]

[[[Â£ FILE: client/src/features/eleve/productions/ProductionsList.jsx Â£]]]
import React from 'react';
export default function ProductionsList() { return <div>Mes productions</div>; }
[[[Â£ END: client/src/features/eleve/productions/ProductionsList.jsx Â£]]]

[[[Â£ FILE: client/src/features/prof/Prof.css Â£]]]
.prof-table th { color: #94a3b8; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.1em; }
[[[Â£ END: client/src/features/prof/Prof.css Â£]]]

[[[Â£ FILE: client/src/features/prof/ProfPage.css Â£]]]
/* ... (Code existant) ... */

/* --- AJOUTS DE SÃ‰CURITÃ‰ RESPONSIVE --- */

/* Force le masquage du Desktop Header sur mobile */
@media (max-width: 768px) {
    .desktop-only-header {
        display: none !important;
    }
    .mobile-only-header {
        display: flex !important;
    }
}

/* Force le masquage du Mobile Header sur Desktop */
@media (min-width: 769px) {
    .desktop-only-header {
        display: flex !important;
    }
    .mobile-only-header {
        display: none !important;
    }
}
[[[Â£ END: client/src/features/prof/ProfPage.css Â£]]]

[[[Â£ FILE: client/src/features/prof/ProfPage.jsx Â£]]]
import React, { useState, useEffect } from 'react';
import ProfHeader from './components/ProfHeader';
import ProfNav from './components/ProfNav';
import StudentsManager from './students/StudentsManager';
import ActivityStudio from './activities/ActivityStudio';
import AdminDashboard from './admin/AdminDashboard';
import ConsoleReporter from './components/ConsoleReporter';
import StudioDashboard from './studio/StudioDashboard'; 
import ClassroomManager from './classroom/ClassroomManager'; 
import ScansStudio from './scans/ScansStudio';
import './ProfPage.css';

export default function ProfPage({ user, onLogout }) {
  const getInitialUser = () => {
      const isJean = (user.firstName === 'Jean' && user.lastName === 'Vuillet');
      return { ...user, isDeveloper: user.isDeveloper === true || isJean };
  };

  const [liveUser, setLiveUser] = useState(getInitialUser());
  const [tab, setTab] = useState('activities');
  const [classes, setClasses] = useState([]);
  const [selectedClassId, setSelectedClassId] = useState("");
  const [loading, setLoading] = useState(true);
  const [fetchError, setFetchError] = useState(null);

  const loadProfileAndClasses = async () => {
    setLoading(true);
    setFetchError(null);
    try {
        const userId = liveUser.id || liveUser._id;
        const resCls = await fetch('/api/admin/classrooms');
        if (!resCls.ok) throw new Error("Erreur chargement classes");
        const allCls = await resCls.json();
        const resMe = await fetch(`/api/admin/teachers/${userId}?report-silent=true`);
        if (!resMe.ok) throw new Error("Erreur chargement profil");
        const freshProfile = await resMe.json();
        setLiveUser(prev => ({ ...prev, ...freshProfile, isDeveloper: prev.isDeveloper }));
        let filteredCls = [];
        if (liveUser.isDeveloper) filteredCls = allCls;
        else {
            const assignedIds = freshProfile.assignedClasses || [];
            filteredCls = allCls.filter(c => assignedIds.some(id => String(id) === String(c._id)));
        }
        setClasses(filteredCls);
        if (filteredCls.length > 0) {
            const stillExists = filteredCls.some(c => String(c._id) === String(selectedClassId));
            if (!selectedClassId || !stillExists) setSelectedClassId(filteredCls[0]._id);
        }
    } catch(e) { console.error("Sync Profile Error:", e.message); setFetchError("Ã‰CHEC CONNEXION"); }
    setLoading(false);
  };

  useEffect(() => { loadProfileAndClasses(); }, [tab]);

  const currentClassObj = classes.find(c => String(c._id) === String(selectedClassId));
  const currentClassName = currentClassObj?.name || "";
  const currentLevel = currentClassObj?.level || "";

  return (
    <div className="prof-page-container">
      <div className="prof-card shadow-2xl">
        <ProfHeader user={liveUser} onLogout={onLogout} />
        
        <div className="px-8 py-4 flex gap-2 border-b bg-slate-50/50 overflow-x-auto no-scrollbar items-center min-h-[70px]">
            <span className="text-[10px] font-black text-slate-400 mr-2 uppercase tracking-widest whitespace-nowrap">
                {liveUser.isDeveloper ? 'ğŸ› ï¸ MODE ARCHITECTE :' : 'ğŸ“š MES CLASSES :'}
            </span>
            {loading ? (
                <span className="text-[10px] text-slate-300 font-black animate-pulse">CHARGEMENT EN COURS...</span>
            ) : fetchError ? (
                <button onClick={loadProfileAndClasses} className="bg-red-500 text-white px-4 py-2 rounded-xl font-black text-[10px] shadow-lg animate-bounce flex items-center gap-2 hover:bg-red-600 transition-colors">âš ï¸ {fetchError} â€¢ RÃ‰ESSAYER</button>
            ) : classes.length === 0 ? (
                <span className="text-[10px] text-slate-400 font-bold italic bg-slate-100 px-3 py-1 rounded">Aucune classe assignÃ©e.</span>
            ) : (
                <>
                    {classes.map(c => (
                        <button key={c._id} onClick={() => setSelectedClassId(c._id)} 
                                className={`px-5 py-2 rounded-xl font-black text-[10px] transition-all whitespace-nowrap border-2 flex items-center gap-2 ${String(selectedClassId) === String(c._id) ? 'bg-indigo-600 border-indigo-600 text-white shadow-lg' : 'bg-white text-slate-400 border-slate-100 hover:border-slate-200'}`}>
                            {c.type === 'GROUP' ? 'ğŸ‘¥' : 'ğŸ«'} {c.name}
                            {c.level && <span className="bg-white/20 px-1 rounded text-[8px] opacity-70">{c.level}</span>}
                        </button>
                    ))}
                </>
            )}
        </div>

        <ProfNav activeTab={tab} onTabChange={setTab} user={liveUser} />
        
        {/* MODIFICATION ICI : On enlÃ¨ve le padding 'p-8' sur mobile (md:p-8) pour que la grille touche les bords */}
        <div className="md:p-8 p-0 bg-white min-h-[600px]">
          {!selectedClassId && !loading && !fetchError ? (
             <div className="flex flex-col items-center justify-center h-[400px] text-slate-300">
                <span className="text-4xl mb-4">ğŸ‘ˆ</span>
                <span className="font-black text-xl uppercase">SÃ‰LECTIONNEZ UNE CLASSE CI-DESSUS</span>
             </div>
          ) : (
             <>
                {tab === 'activities' && <ActivityStudio globalClass={currentClassName} globalClassId={selectedClassId} globalLevel={currentLevel} user={liveUser} onRefreshRequest={loadProfileAndClasses} />}
                {tab === 'classroom' && <ClassroomManager globalClassId={selectedClassId} user={liveUser} />}
                {tab === 'scans' && <ScansStudio user={liveUser} globalClass={currentClassName} />}
                {tab === 'studio' && <StudioDashboard user={liveUser} />}
                {tab === 'students' && <StudentsManager globalClassId={selectedClassId} />}
                {tab === 'admin' && <AdminDashboard user={liveUser} onRefresh={loadProfileAndClasses} />}
             </>
          )}
        </div>
      </div>
      {liveUser.isDeveloper && <ConsoleReporter user={liveUser} />}
    </div>
  );
}
[[[Â£ END: client/src/features/prof/ProfPage.jsx Â£]]]

[[[Â£ FILE: client/src/features/prof/activities/ActivityStudio.css Â£]]]
.assign-card { background: #fff; padding: 1rem; border-radius: 20px; border: 1px solid #eee; }
[[[Â£ END: client/src/features/prof/activities/ActivityStudio.css Â£]]]

[[[Â£ FILE: client/src/features/prof/activities/ActivityStudio.jsx Â£]]]
import React, { useState, useEffect } from 'react';
import HomeworkStudio from '../homework/HomeworkStudio';
import GameStudio from '../games/GameStudio';
import ProfStudioFolder from '../components/ProfStudioFolder';

export default function ActivityStudio({ globalClass, globalClassId, globalLevel, user, onRefreshRequest }) {
    const [activities, setActivities] = useState([]);
    const [chapters, setChapters] = useState([]);
    const [allStudents, setAllStudents] = useState([]);
    
    // editingItem contient maintenant : { type: 'homework', data: null, section: 'MATHS' }
    const [editingItem, setEditingItem] = useState(null);
    const [loading, setLoading] = useState(false);

    const loadData = async () => {
        setLoading(true);
        try {
            const fetchJson = async (url) => {
                const res = await fetch(url);
                if (!res.ok) return [];
                return res.json();
            };

            const [hw, gm, sc, cp, sts] = await Promise.all([
                fetchJson('/api/homework/all'),
                fetchJson('/api/games/all'),
                fetchJson('/api/scans/sessions'), 
                fetchJson('/api/structure/chapters'),
                fetchJson('/api/admin/students')
            ]);
            
            setActivities([
                ...hw.map(x => ({...x, actType: 'homework', typeLabel: 'ğŸ“ DM'})), 
                ...gm.map(x => ({...x, actType: 'game', typeLabel: 'ğŸ® JEU'})),
                ...sc.map(x => ({...x, actType: 'scan', typeLabel: 'ğŸ“¸ DC', title: x.title || 'Scan sans titre'})) 
            ]);
            setChapters(cp || []);
            setAllStudents(sts || []);
        } catch (e) { console.error("ActivityStudio Load error:", e); }
        setLoading(false);
    };

    useEffect(() => { loadData(); }, [globalClass]);

    const handleDeleteItem = async (id, type) => {
        if (!confirm(`âš ï¸ Supprimer cet Ã©lÃ©ment ?`)) return;
        const url = type === 'game' ? `/api/games/${id}` 
                  : (type === 'homework' ? `/api/homework/${id}` 
                  : (type === 'scan' ? `/api/scans/sessions/${id}` 
                  : `/api/structure/chapters/${id}`));
                  
        const res = await fetch(url, { method: 'DELETE' });
        if (res.ok) loadData();
    };

    // --- RENDER MODALES ---
    if (editingItem) {
        if (editingItem.type === 'homework') {
            return (
                <HomeworkStudio 
                    initialData={editingItem.data} 
                    chapters={chapters} 
                    globalClass={globalClass} 
                    user={user} 
                    targetSection={editingItem.section} // <--- ON PASSE LA SECTION CIBLE
                    onClose={() => {setEditingItem(null); loadData();}} 
                />
            );
        }
        if (editingItem.type === 'game') {
            return (
                <GameStudio 
                    initialData={editingItem.data} 
                    chapters={chapters} 
                    classFilter={globalClass} 
                    user={user} 
                    targetSection={editingItem.section} // <--- IDEM
                    onClose={() => {setEditingItem(null); loadData();}} 
                />
            );
        }
        if (editingItem.type === 'scan') {
            alert("Pour modifier ce DC, veuillez passer par l'onglet ğŸ“¸ SCAN.");
            setEditingItem(null);
            return null;
        }
    }

    return (
        <div className="space-y-8 animate-in fade-in relative">
            {loading && (
                <div className="absolute top-4 right-4 z-50 bg-indigo-600 text-white px-3 py-1 rounded-full text-[10px] font-black animate-pulse shadow-lg">
                    SYNCHRONISATION...
                </div>
            )}

            {/* LES BOUTONS ONT Ã‰TÃ‰ DÃ‰PLACÃ‰S DANS LE COMPOSANT FOLDER POUR LE CONTEXTE */}
            
            <ProfStudioFolder 
                chapters={chapters} 
                items={activities} 
                studentsRef={allStudents}
                classFilter={globalClass}
                levelFilter={globalLevel}
                user={user}
                onEditItem={(it) => setEditingItem({type: it.actType, data: it})}
                onCreateActivity={(type, section) => setEditingItem({ type, section })} // <--- NOUVEAU CALLBACK
                onDeleteItem={handleDeleteItem}
                onRefresh={() => { loadData(); if(onRefreshRequest) onRefreshRequest(); }}
            />
        </div>
    );
}
[[[Â£ END: client/src/features/prof/activities/ActivityStudio.jsx Â£]]]

[[[Â£ FILE: client/src/features/prof/admin/AdminDashboard.css Â£]]]
.admin-tab { padding: 0.6rem 1.2rem; border-radius: 12px; font-weight: 800; font-size: 0.7rem; color: #94a3b8; background: transparent; transition: all 0.2s; white-space: nowrap; }
.admin-tab.active { background: white; color: #4f46e5; shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
.admin-input { width: 100%; padding: 0.8rem 1rem; border-radius: 14px; border: 2px solid #f1f5f9; background: #f8fafc; font-weight: 700; font-size: 0.85rem; outline: none; transition: border-color 0.2s; }
.admin-input:focus { border-color: #4f46e5; }
.admin-btn-submit { width: 100%; padding: 1rem; background: #4f46e5; color: white; border-radius: 14px; font-weight: 900; font-size: 0.8rem; margin-top: 1rem; box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3); }
.admin-table { width: 100%; border-collapse: collapse; }
.admin-table th { text-align: left; }
.admin-table td { font-size: 0.85rem; }
.no-scrollbar::-webkit-scrollbar { display: none; }

/* --- MODALE "FIT-SCREEN" (V189) --- */
.zoom-overlay { 
    position: fixed; inset: 0; 
    z-index: 20000; background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(5px); 
    display: flex; align-items: center; justify-content: center; 
}
.zoom-overlay.level-2 { z-index: 20001; }

.zoom-card { 
    background: white; 
    width: 90vw; max-width: 1100px; 
    /* HAUTEUR FIXE RELATIVE A L'ECRAN : GARANTIT QUE TOUT RENTRE */
    height: 85vh; 
    
    border-radius: 25px; 
    box-shadow: 0 50px 100px -20px rgba(0, 0, 0, 0.6); 
    
    display: flex; flex-direction: column; /* Structure Verticale */
    overflow: hidden; /* Rien ne doit dÃ©passer de la carte */
}

/* HEADER (Fixe) */
.z-header { 
    flex-shrink: 0; /* Ne rÃ©trÃ©cit pas */
    padding: 1.5rem 2rem 1rem 2rem; 
    background: white; 
    z-index: 20; 
}

/* CORPS (Flexible mais contraint) */
.z-body { 
    flex: 1; /* Prend tout l'espace disponible entre header et footer */
    display: flex; flex-direction: column; 
    padding: 0 2rem 1rem 2rem; 
    min-height: 0; /* CRUCIAL : Permet aux enfants de scroller */
    overflow: hidden; /* EmpÃªche le corps lui-mÃªme de scroller globalement */
    background: #fff;
}

/* FOOTER (Fixe) */
.z-footer { 
    flex-shrink: 0; /* Ne rÃ©trÃ©cit pas */
    padding: 1.2rem 2rem; 
    background: #f8fafc; border-top: 1px solid #e2e8f0; 
    z-index: 20; 
    display: flex; gap: 15px; justify-content: flex-end; 
}

@keyframes zoomIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }

/* UTILS */
.dev-shortcuts { display: flex; gap: 10px; margin-bottom: 2rem; background: #1e293b; padding: 10px; border-radius: 20px; align-items: center; overflow-x: auto; }
.dev-label { font-size: 10px; color: #64748b; text-transform: uppercase; margin-right: 10px; white-space: nowrap; font-weight: 900; }
.btn-shortcut { padding: 8px 16px; border-radius: 12px; border: none; cursor: pointer; font-size: 10px; font-weight: 900; color: white; text-transform: uppercase; transition: transform 0.1s; white-space: nowrap; }
.btn-shortcut:hover { transform: scale(1.05); }
.sc-admin { background: #f43f5e; } .sc-prof { background: #8b5cf6; } .sc-eleve { background: #f97316; } .sc-jean { background: #3b82f6; border: 2px solid #60a5fa; }

/* LISTE MEMBRES */
.member-list { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 5px; margin-bottom: 20px; border: 1px solid #f1f5f9; border-radius: 15px; padding: 10px; background: #f8fafc; min-height: 100px; }
.member-row { display: flex; justify-content: space-between; align-items: center; background: white; padding: 10px 15px; border-radius: 10px; font-size: 0.8rem; font-weight: 700; color: #475569; border: 1px solid transparent; transition: all 0.2s; }
.member-row:hover { border-color: #cbd5e1; }
.member-btn-remove { width: 25px; height: 25px; display: flex; align-items: center; justify-content: center; background: #fee2e2; color: #ef4444; border-radius: 8px; cursor: pointer; border: none; font-weight: 900; }
.member-add-box { display: flex; flex-direction: column; gap: 10px; border-top: 2px solid #f1f5f9; padding-top: 15px; }
.finder-results-mini { max-height: 150px; overflow-y: auto; background: white; border: 2px solid #e2e8f0; border-radius: 12px; margin-top: 5px; }
.finder-row-mini { padding: 8px 12px; font-size: 10px; font-weight: 700; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
.finder-row-mini:hover { background: #eff6ff; color: #2563eb; }
[[[Â£ END: client/src/features/prof/admin/AdminDashboard.css Â£]]]

[[[Â£ FILE: client/src/features/prof/admin/AdminDashboard.jsx Â£]]]
import React, { useState, useEffect, useRef } from 'react';
import './AdminDashboard.css';

export default function AdminDashboard({ user, onRefresh }) {
    const [view, setView] = useState('classes'); 
    const [items, setItems] = useState([]);
    const [loading, setLoading] = useState(false);
    const [importing, setImporting] = useState(false);
    const [activeClassTab, setActiveClassTab] = useState('ALL');
    const [searchTerm, setSearchTerm] = useState('');
    const [modalMode, setModalMode] = useState(null); 
    const [currentItem, setCurrentItem] = useState(null);
    
    // DATA REFERENCES
    const [allClasses, setAllClasses] = useState([]);
    const [allSubjects, setAllSubjects] = useState([]);
    const [allStudents, setAllStudents] = useState([]); 
    
    // MAGIC MODAL
    const [showMagicModal, setShowMagicModal] = useState(false);
    const [magicText, setMagicText] = useState("");
    const [magicClass, setMagicClass] = useState("");
    const [magicForceOption, setMagicForceOption] = useState("");
    
    // MEMBER MANAGEMENT
    const [manageItem, setManageItem] = useState(null); 
    const [memberSearch, setMemberSearch] = useState(""); 

    // FILTERS FOR MODAL
    const [filterSub, setFilterSub] = useState("");
    const [filterClass, setFilterClass] = useState("");
    const [filterGroup, setFilterGroup] = useState("");
    
    const fileInputRef = useRef(null);

    const loadData = async () => {
        setLoading(true);
        try {
            const [rC, rS, rSt] = await Promise.all([
                fetch('/api/admin/classrooms').then(r => r.ok ? r.json() : []),
                fetch('/api/admin/subjects').then(r => r.ok ? r.json() : []),
                fetch('/api/admin/students').then(r => r.ok ? r.json() : [])
            ]);
            setAllClasses(Array.isArray(rC) ? rC.sort((a,b) => (a.name||"").localeCompare(b.name||"")) : []);
            setAllSubjects(Array.isArray(rS) ? rS : []);
            setAllStudents(Array.isArray(rSt) ? rSt : []);

            const map = { 'classes': 'classrooms', 'groups': 'classrooms', 'teachers': 'teachers', 'staff': 'admins', 'subjects': 'subjects', 'students': 'students' };
            const r = await fetch(`/api/admin/${map[view]}`);
            if (r.ok) {
                const data = await r.json();
                let list = Array.isArray(data) ? data : [];
                if (view === 'classes') list = list.filter(c => c.type === 'CLASS');
                else if (view === 'groups') list = list.filter(c => c.type === 'GROUP');
                setItems(list);
            }
        } catch (e) { console.error("Error", e); }
        setLoading(false);
    };

    useEffect(() => { loadData(); setSearchTerm(''); if (view !== 'students') setActiveClassTab('ALL'); }, [view]);

    useEffect(() => {
        if (modalMode) { setFilterSub(""); setFilterClass(""); setFilterGroup(""); }
    }, [modalMode]);

    const getDisplayedItems = () => {
        let res = items;
        if (view === 'students' && activeClassTab !== 'ALL') res = res.filter(s => String(s.classId) === String(activeClassTab));
        if (searchTerm.trim() !== '') {
            const term = searchTerm.toLowerCase();
            res = res.filter(item => {
                const n = item.name ? item.name.toLowerCase() : '';
                const f = item.firstName ? item.firstName.toLowerCase() : '';
                const l = item.lastName ? item.lastName.toLowerCase() : '';
                return n.includes(term) || f.includes(term) || l.includes(term);
            });
        }
        return res;
    };
    const displayedItems = getDisplayedItems();

    const handleResetActivities = async () => {
        if (!confirm("âš ï¸ ATTENTION ! VOULEZ-VOUS VRAIMENT TOUT EFFACER ?\n\nCela supprimera :\n- Tous les devoirs et copies\n- Tous les jeux et scores\n- Tous les scans\n\nCette action est irrÃ©versible.")) return;
        setImporting(true);
        try {
            const res = await fetch('/api/admin/maintenance/reset-content', { method: 'DELETE' });
            const data = await res.json();
            if (res.ok) { alert("âœ… " + (data.message || "Nettoyage rÃ©ussi !")); onRefresh(); } else { alert("âŒ " + (data.error || "Erreur")); }
        } catch(e) { alert("âŒ Erreur RÃ©seau"); }
        setImporting(false);
    };

    const getActiveContext = () => { if (activeClassTab && activeClassTab !== 'ALL') { const cls = allClasses.find(c => c._id === activeClassTab); return cls ? { name: cls.name, level: cls.level, id: cls._id } : null; } return null; };
    
    const handleOpenCreate = () => { 
        let defaults = { firstName: '', lastName: '', email: '', parentEmail: '', classId: '', currentLevel: '', assignedGroups: [], name: '', level: '', type: 'CLASS', password: '', taughtSubjects: [], assignedClasses: [] }; 
        const context = getActiveContext(); 
        if (view === 'groups') { defaults.type = 'GROUP'; if (context) defaults.level = context.level; } 
        else if (view === 'classes') { defaults.type = 'CLASS'; } 
        else if (view === 'students' && context) { defaults.classId = context.id; defaults.currentClass = context.name; defaults.currentLevel = context.level; } 
        setCurrentItem(defaults); setModalMode('create'); 
    };

    const toggleArrayItem = (field, id) => { 
        const list = currentItem[field] || []; 
        setCurrentItem({ 
            ...currentItem, 
            [field]: list.includes(id) ? list.filter(x => x !== id) : [...list, id] 
        }); 
    };

    const handleOpenMagic = () => { const context = getActiveContext(); if (context) setMagicClass(context.name); else setMagicClass(""); setMagicForceOption(""); setMagicText(""); setShowMagicModal(true); };
    const handleMagicImport = async () => { if (!magicText || magicText.length < 10) return alert("Collez les donnÃ©es !"); setImporting(true); try { const res = await fetch('/api/admin/import-magic', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ rawText: magicText, defaultClass: magicClass.toUpperCase(), forceOption: magicForceOption }) }); const data = await res.json(); if (res.ok) { alert("âœ… " + data.message); setShowMagicModal(false); loadData(); onRefresh(); } else { alert("âŒ " + data.error); } } catch(e) { alert("Erreur rÃ©seau"); } setImporting(false); };
    const handleFileSelect = async (e) => { const file = e.target.files[0]; if (!file) return; setImporting(true); const formData = new FormData(); formData.append('file', file); formData.append('defaultClass', magicClass.toUpperCase()); formData.append('forceOption', magicForceOption); try { const res = await fetch('/api/admin/import-csv', { method: 'POST', body: formData }); const data = await res.json(); if (res.ok) { alert("âœ… " + data.message); setShowMagicModal(false); loadData(); onRefresh(); } else { alert("âŒ " + data.error); } } catch (err) { alert("Erreur rÃ©seau lors de l'upload."); } setImporting(false); e.target.value = null; };
    const handleMigration = async () => { if(!confirm("âš ï¸ NETTOYAGE BDD ?")) return; setImporting(true); try { const res = await fetch('/api/admin/maintenance/migrate-students', { method: 'POST' }); const data = await res.json(); alert(data.message); loadData(); } catch(e) {} setImporting(false); };
    const getMembersOf = (item) => { if (!item) return []; if (item.type === 'CLASS') return allStudents.filter(s => String(s.classId) === String(item._id)); if (item.type === 'GROUP') return allStudents.filter(s => (s.assignedGroups || []).includes(item._id)); return []; };
    const handleMembership = async (action, studentId) => { if (!manageItem) return; try { await fetch('/api/admin/membership', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ studentId, targetId: manageItem._id, type: manageItem.type, action }) }); await loadData(); } catch (e) {} };
    const currentMembers = getMembersOf(manageItem);
    const potentialMembers = memberSearch.length > 1 ? allStudents.filter(s => { const isInside = currentMembers.some(m => m._id === s._id); if (isInside) return false; return s.firstName.toLowerCase().includes(memberSearch.toLowerCase()) || s.lastName.toLowerCase().includes(memberSearch.toLowerCase()); }) : [];
    const openEdit = (it) => { setCurrentItem({ ...it }); setModalMode('edit'); };
    const handleSave = async () => { const map = { 'classes': 'classrooms', 'groups': 'classrooms', 'teachers': 'teachers', 'staff': 'admins', 'subjects': 'subjects', 'students': 'students' }; if (view === 'students' && currentItem.classId) currentItem.currentClass = allClasses.find(c => c._id === currentItem.classId)?.name || ''; try { const res = await fetch(`/api/admin/${map[view]}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(currentItem) }); if (res.ok) { setModalMode(null); loadData(); if(['classes','groups','teachers'].includes(view)) onRefresh(); } else { const err = await res.json(); alert("Erreur: " + err.error); } } catch(e) { alert("Erreur RÃ©seau"); } };
    const handleDelete = async (id) => { if (!confirm("Supprimer ?")) return; const map = { 'classes': 'classrooms', 'groups': 'classrooms', 'teachers': 'teachers', 'staff': 'admins', 'subjects': 'subjects', 'students': 'students' }; await fetch(`/api/admin/${map[view]}/${id}`, { method: 'DELETE' }); loadData(); };
    const isGroupMode = view === 'groups';

    return (
        <>
            <input type="file" ref={fileInputRef} onChange={handleFileSelect} accept=".csv,.txt" style={{display:'none'}} />
            {importing && <div className="zoom-overlay level-2"><div className="text-white font-black text-2xl animate-pulse text-center">ğŸ”® TRAITEMENT...</div></div>}
            
            {showMagicModal && (<div className="zoom-overlay" onClick={() => setShowMagicModal(false)}><div className="zoom-card !w-[800px] !max-w-none" onClick={e => e.stopPropagation()}><div className="z-header"><h2 className={`text-xl font-black mb-1 uppercase ${isGroupMode ? 'text-orange-500' : 'text-indigo-600'}`}>{isGroupMode ? 'ğŸ”® IMPORTATION GROUPE & Ã‰LÃˆVES' : 'ğŸ”® IMPORTATION CLASSE & Ã‰LÃˆVES'}</h2><p className="text-[10px] text-slate-400 font-bold uppercase">Copiez un tableau Excel/Sheets (Nom, PrÃ©nom, etc.)</p></div><div className="z-body">{isGroupMode ? (<div className="flex gap-4 mb-4"><div className="flex-1"><label className="text-[9px] font-black text-slate-400 uppercase ml-2">CLASSE DE RATTACHEMENT (Obligatoire)</label><input className="admin-input border-indigo-100 focus:border-indigo-500" placeholder="ex: 6D, T1..." value={magicClass} onChange={e => setMagicClass(e.target.value)} /></div><div className="flex-1"><label className="text-[9px] font-black text-slate-400 uppercase ml-2">NOM DU GROUPE (Option forcÃ©e)</label><input className="admin-input border-orange-200 focus:border-orange-500 bg-orange-50" placeholder="ex: ANGLAIS LVA, CHORALE..." value={magicForceOption} onChange={e => setMagicForceOption(e.target.value)} /></div></div>) : (<div className="flex gap-4 mb-4"><div className="flex-1"><label className="text-[9px] font-black text-slate-400 uppercase ml-2">NOM DE LA CLASSE PAR DÃ‰FAUT</label><input className="admin-input border-indigo-100 focus:border-indigo-500" placeholder="ex: 6D, T1" value={magicClass} onChange={e => setMagicClass(e.target.value)} /></div></div>)}<textarea className="w-full h-[300px] p-4 bg-slate-50 border-2 border-slate-100 rounded-2xl font-mono text-xs mb-6 outline-none focus:border-slate-300 transition-all" placeholder="Collez le tableau ici..." value={magicText} onChange={e => setMagicText(e.target.value)} /></div><div className="z-footer"><button onClick={() => fileInputRef.current.click()} className="flex-1 py-4 bg-emerald-50 text-emerald-600 rounded-xl font-black text-xs border border-emerald-100 hover:bg-emerald-100 transition-colors">ğŸ“‚ UPLOAD CSV / TXT</button><button onClick={() => setShowMagicModal(false)} className="flex-1 py-4 bg-slate-100 text-slate-500 rounded-xl font-black text-xs">ANNULER</button><button onClick={handleMagicImport} className={`flex-1 py-4 text-white rounded-xl font-black text-xs shadow-lg animate-pulse ${isGroupMode ? 'bg-orange-500' : 'bg-indigo-600'}`}>LANCER L'IA ğŸ¤–</button></div></div></div>)}
            {manageItem && (<div className="zoom-overlay" onClick={() => setManageItem(null)}><div className="zoom-card" onClick={e => e.stopPropagation()}><div className="z-header"><h2 className="text-xl font-black mb-1 uppercase text-slate-800">{manageItem.type === 'CLASS' ? 'ğŸ«' : 'ğŸ‘¥'} {manageItem.name}</h2><p className="text-[10px] font-bold text-slate-400 uppercase">GESTION DES EFFECTIFS ({getMembersOf(manageItem).length} Ã‰lÃ¨ves)</p></div><div className="z-body"><div className="member-list custom-scrollbar">{getMembersOf(manageItem).map(m => (<div key={m._id} className="member-row"><span>{m.firstName} {m.lastName} <span className="text-[9px] text-slate-400">({m.currentClass})</span></span><button onClick={() => handleMembership('remove', m._id)} className="member-btn-remove" title="Retirer">âœ•</button></div>))}{getMembersOf(manageItem).length === 0 && <div className="p-4 text-center text-slate-300 italic text-xs">Aucun Ã©lÃ¨ve.</div>}</div><div className="member-add-box"><input className="admin-input" placeholder="ğŸ” Ajouter un Ã©lÃ¨ve..." value={memberSearch} onChange={e => setMemberSearch(e.target.value)} />{memberSearch.length > 1 && (<div className="finder-results-mini custom-scrollbar">{potentialMembers.map(p => (<div key={p._id} className="finder-row-mini" onClick={() => { handleMembership('add', p._id); setMemberSearch(""); }}><span>{p.firstName} {p.lastName} <span className="opacity-50 text-[8px]">({p.currentClass})</span></span><span className="text-green-600 font-black">+</span></div>))}</div>)}</div></div><div className="z-footer"><button onClick={() => setManageItem(null)} className="w-full py-3 bg-slate-900 text-white font-bold rounded-xl text-xs">FERMER</button></div></div></div>)}
            
            {modalMode && currentItem && (
                <div className="zoom-overlay" onClick={() => setModalMode(null)}>
                    <div className="zoom-card" onClick={e => e.stopPropagation()}>
                        <div className="z-header">
                            <h2 className="text-xl font-black uppercase text-slate-800">{modalMode === 'create' ? `Nouveau ${view.slice(0,-1)}` : `Modifier ${currentItem.name || currentItem.lastName}`}</h2>
                        </div>
                        
                        <div className="z-body">
                            <div className="space-y-4 mb-6 flex-shrink-0">
                                {['teachers', 'students', 'staff'].includes(view) && <div className="flex gap-4"><input className="admin-input" placeholder="PrÃ©nom" value={currentItem.firstName} onChange={e => setCurrentItem({...currentItem, firstName: e.target.value})} /><input className="admin-input" placeholder="Nom" value={currentItem.lastName} onChange={e => setCurrentItem({...currentItem, lastName: e.target.value})} /></div>}
                                {view === 'students' && (<div className="flex gap-4"><input className="admin-input" placeholder="Email Ã‰lÃ¨ve" value={currentItem.email} onChange={e => setCurrentItem({...currentItem, email: e.target.value})} /><input className="admin-input" placeholder="Email Parent" value={currentItem.parentEmail || ''} onChange={e => setCurrentItem({...currentItem, parentEmail: e.target.value})} /></div>)}
                                {['teachers', 'staff'].includes(view) && <input className="admin-input" placeholder="Mot de passe" value={currentItem.password} onChange={e => setCurrentItem({...currentItem, password: e.target.value})} />}
                                {['classes', 'groups'].includes(view) && (<div className="flex gap-4"><input className="admin-input flex-1" placeholder={view === 'classes' ? "Nom (ex: 6A)" : "Nom (ex: SPE MATHS)"} value={currentItem.name} onChange={e => setCurrentItem({...currentItem, name: e.target.value})} /><div className="flex-1 flex flex-col gap-1"><label className="text-[9px] font-black text-slate-400 uppercase ml-2">NIVEAU</label><select className="admin-input" value={currentItem.level || ''} onChange={e => setCurrentItem({...currentItem, level: e.target.value})}><option value="">AUTO / AUCUN</option><option value="6">6Ã¨me</option><option value="5">5Ã¨me</option><option value="4">4Ã¨me</option><option value="3">3Ã¨me</option><option value="2">2nde</option><option value="1">1Ã¨re</option><option value="TERM">Terminale</option></select></div></div>)}
                                {view === 'subjects' && <input className="admin-input" placeholder="Nom" value={currentItem.name} onChange={e => setCurrentItem({...currentItem, name: e.target.value})} />}
                            </div>
                            
                            {/* GRILLE PROFESSEUR */}
                            {view === 'teachers' && (
                                <div className="grid grid-cols-3 gap-4 border-t pt-4 flex-1 min-h-0">
                                    <div className="flex flex-col gap-2 h-full overflow-hidden">
                                        <div className="flex flex-col gap-1">
                                            <h4 className="text-[10px] font-black uppercase text-indigo-500">ğŸ“š MatiÃ¨res</h4>
                                            <input className="w-full p-2 text-[10px] font-bold border-2 border-indigo-50 rounded-xl bg-slate-50 outline-none" placeholder="ğŸ” Filtrer..." value={filterSub} onChange={e=>setFilterSub(e.target.value)} />
                                        </div>
                                        <div className="flex-1 overflow-y-auto bg-white p-2 rounded-xl border-2 border-slate-100 custom-scrollbar flex flex-col gap-1 shadow-inner">
                                            {allSubjects.filter(s=>s.name.toLowerCase().includes(filterSub.toLowerCase())).map(s => <button key={s._id} onClick={() => toggleArrayItem('taughtSubjects', s._id)} className={`w-full text-left px-3 py-2 rounded-lg text-[10px] font-bold transition-all ${currentItem.taughtSubjects?.includes(s._id) ? 'bg-indigo-600 text-white' : 'bg-slate-50 text-slate-500 hover:bg-slate-100'}`}>{s.name}</button>)}
                                        </div>
                                    </div>
                                    <div className="flex flex-col gap-2 h-full overflow-hidden">
                                        <div className="flex flex-col gap-1">
                                            <h4 className="text-[10px] font-black uppercase text-emerald-500">ğŸ« Classes</h4>
                                            <input className="w-full p-2 text-[10px] font-bold border-2 border-emerald-50 rounded-xl bg-slate-50 outline-none" placeholder="ğŸ” Filtrer..." value={filterClass} onChange={e=>setFilterClass(e.target.value)} />
                                        </div>
                                        <div className="flex-1 overflow-y-auto bg-white p-2 rounded-xl border-2 border-slate-100 custom-scrollbar flex flex-col gap-1 shadow-inner">
                                            {allClasses.filter(c => c.type === 'CLASS' && c.name.toLowerCase().includes(filterClass.toLowerCase())).map(c => <button key={c._id} onClick={() => toggleArrayItem('assignedClasses', c._id)} className={`w-full text-left px-3 py-2 rounded-lg text-[10px] font-bold transition-all ${currentItem.assignedClasses?.includes(c._id) ? 'bg-emerald-500 text-white' : 'bg-slate-50 text-slate-500 hover:bg-slate-100'}`}>{c.name}</button>)}
                                        </div>
                                    </div>
                                    <div className="flex flex-col gap-2 h-full overflow-hidden">
                                        <div className="flex flex-col gap-1">
                                            <h4 className="text-[10px] font-black uppercase text-orange-500">ğŸ‘¥ Groupes</h4>
                                            <input className="w-full p-2 text-[10px] font-bold border-2 border-orange-50 rounded-xl bg-slate-50 outline-none" placeholder="ğŸ” Filtrer..." value={filterGroup} onChange={e=>setFilterGroup(e.target.value)} />
                                        </div>
                                        <div className="flex-1 overflow-y-auto bg-white p-2 rounded-xl border-2 border-slate-100 custom-scrollbar flex flex-col gap-1 shadow-inner">
                                            {allClasses.filter(c => c.type === 'GROUP' && c.name.toLowerCase().includes(filterGroup.toLowerCase())).map(c => <button key={c._id} onClick={() => toggleArrayItem('assignedClasses', c._id)} className={`w-full text-left px-3 py-2 rounded-lg text-[10px] font-bold transition-all ${currentItem.assignedClasses?.includes(c._id) ? 'bg-orange-500 text-white' : 'bg-slate-50 text-slate-500 hover:bg-slate-100'}`}>{c.name}</button>)}
                                        </div>
                                    </div>
                                </div>
                            )}
                            
                            {view === 'students' && (
                                <div className="grid grid-cols-2 gap-4 border-t pt-4 flex-1 min-h-0">
                                    <div className="flex flex-col gap-2 h-full overflow-hidden">
                                        <div className="flex flex-col gap-1">
                                            <div className="flex justify-between items-end">
                                                <h4 className="text-[10px] font-black uppercase text-emerald-500">ğŸ« Classe Principale</h4>
                                                <select className="text-[9px] p-1 border rounded bg-slate-50 font-bold uppercase w-16" value={currentItem.currentLevel || ''} onChange={e => setCurrentItem({...currentItem, currentLevel: e.target.value})} title="Forcer Niveau">
                                                    <option value="">AUTO</option><option value="6">6Ã¨</option><option value="5">5Ã¨</option><option value="4">4Ã¨</option><option value="3">3Ã¨</option><option value="2">2de</option><option value="1">1Ã¨re</option><option value="TERM">Term</option>
                                                </select>
                                            </div>
                                            <input className="w-full p-2 text-[10px] font-bold border-2 border-emerald-50 rounded-xl bg-slate-50 outline-none" placeholder="ğŸ” Filtrer..." value={filterClass} onChange={e=>setFilterClass(e.target.value)} />
                                        </div>
                                        <div className="flex-1 overflow-y-auto bg-white p-2 rounded-xl border-2 border-slate-100 custom-scrollbar flex flex-col gap-1 shadow-inner">
                                            {allClasses.filter(c => c.type === 'CLASS' && c.name.toLowerCase().includes(filterClass.toLowerCase())).map(c => <button key={c._id} onClick={() => setCurrentItem({...currentItem, classId: c._id})} className={`w-full text-left px-3 py-2 rounded-lg text-[10px] font-bold transition-all ${currentItem.classId === c._id ? 'bg-emerald-600 text-white shadow-md' : 'bg-slate-50 text-slate-500 hover:bg-slate-100'}`}>{c.name}</button>)}
                                        </div>
                                    </div>

                                    <div className="flex flex-col gap-2 h-full overflow-hidden">
                                        <div className="flex flex-col gap-1">
                                            <h4 className="text-[10px] font-black uppercase text-orange-500">ğŸ‘¥ Options</h4>
                                            <input className="w-full p-2 text-[10px] font-bold border-2 border-orange-50 rounded-xl bg-slate-50 outline-none" placeholder="ğŸ” Filtrer..." value={filterGroup} onChange={e=>setFilterGroup(e.target.value)} />
                                        </div>
                                        <div className="flex-1 overflow-y-auto bg-white p-2 rounded-xl border-2 border-slate-100 custom-scrollbar flex flex-col gap-1 shadow-inner">
                                            {allClasses.filter(c => c.type === 'GROUP' && c.name.toLowerCase().includes(filterGroup.toLowerCase())).map(c => <button key={c._id} onClick={() => toggleArrayItem('assignedGroups', c._id)} className={`w-full text-left px-3 py-2 rounded-lg text-[10px] font-bold transition-all ${currentItem.assignedGroups?.includes(c._id) ? 'bg-orange-500 text-white' : 'bg-slate-50 text-slate-500 hover:bg-slate-100'}`}>{c.name}</button>)}
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>

                        <div className="z-footer">
                            <button onClick={() => setModalMode(null)} className="flex-1 py-3 bg-slate-100 text-slate-500 font-bold rounded-xl uppercase text-xs">Annuler</button>
                            <button onClick={handleSave} className="flex-1 py-3 bg-slate-900 text-white font-bold rounded-xl uppercase text-xs shadow-xl">Enregistrer</button>
                        </div>
                    </div>
                </div>
            )}

            {/* DASHBOARD CONTENT */}
            <div className="admin-container animate-in fade-in">
                <div className="flex flex-col gap-4 mb-6">
                    <div className="flex justify-between items-center bg-white p-4 rounded-[30px] shadow-sm">
                        <div className="flex gap-1 overflow-x-auto no-scrollbar">{['classes', 'groups', 'subjects', 'teachers', 'students', 'staff'].map(v => <button key={v} onClick={() => setView(v)} className={`admin-tab ${view === v ? 'active' : ''}`}>{v.toUpperCase()}</button>)}</div>
                        <div className="flex gap-2">
                            {view === 'students' && <button onClick={handleMigration} className="bg-orange-500 text-white px-6 py-2.5 rounded-2xl font-black text-[10px] uppercase shadow-lg">ğŸ§¹ CLEAN BDD</button>}
                            <button onClick={handleResetActivities} className="bg-red-600 text-white px-6 py-2.5 rounded-2xl font-black text-[10px] uppercase shadow-lg animate-pulse hover:bg-red-700 transition-colors">ğŸ”¥ VIDER CONTENU</button>
                            {(view === 'classes' || view === 'groups' || view === 'students') && <button onClick={handleOpenMagic} className="bg-purple-600 text-white px-6 py-2.5 rounded-2xl font-black text-[10px] uppercase shadow-lg">ğŸ”® IMPORT</button>}
                            <button onClick={handleOpenCreate} className="bg-slate-900 text-white px-6 py-2.5 rounded-2xl font-black text-[10px] uppercase shadow-lg">+ AJOUTER</button>
                        </div>
                    </div>
                    
                    <div className="relative">
                        <span className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 text-lg">ğŸ”</span>
                        <input type="text" placeholder={`Rechercher dans ${view}...`} value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} className="w-full pl-12 pr-4 py-3 bg-white rounded-2xl border-2 border-slate-100 font-bold text-slate-700 outline-none focus:border-indigo-500 transition-all shadow-sm" />
                    </div>

                    {view === 'students' && (
                        <div className="flex gap-2 overflow-x-auto no-scrollbar pb-2 px-2">
                            <button onClick={() => setActiveClassTab('ALL')} className={`px-4 py-2 rounded-xl text-[10px] font-black whitespace-nowrap transition-all border ${activeClassTab === 'ALL' ? 'bg-indigo-600 text-white border-indigo-600 shadow-md' : 'bg-white text-slate-400 border-slate-200'}`}>TOUS</button>
                            {allClasses.filter(c => c.type === 'CLASS').map(c => (<button key={c._id} onClick={() => setActiveClassTab(c._id)} className={`px-4 py-2 rounded-xl text-[10px] font-black whitespace-nowrap transition-all border ${activeClassTab === c._id ? 'bg-indigo-600 text-white border-indigo-600 shadow-md' : 'bg-white text-slate-400 border-slate-200'}`}>{c.name}</button>))}
                        </div>
                    )}
                </div>

                <div className="bg-white rounded-[40px] border shadow-sm overflow-hidden min-h-[400px]">
                    <table className="admin-table">
                        <tbody>
                            {displayedItems.map(it => (
                                <tr key={it._id} className="border-t hover:bg-slate-50 transition-colors">
                                    <td className="p-6">
                                        <div className="font-black text-slate-700 uppercase text-sm flex items-center gap-2">
                                            {it.name || `${it.firstName} ${it.lastName}`}
                                            {['classes','groups'].includes(view) && it.level && <span className="text-[8px] bg-blue-600 text-white px-2 py-0.5 rounded font-bold shadow-sm">NIV {it.level}</span>}
                                            {view === 'students' && <span className="text-[8px] bg-blue-600 text-white px-2 py-0.5 rounded font-bold shadow-sm">{it.currentClass || allClasses.find(c=>c._id===it.classId)?.name}</span>}
                                        </div>
                                        <span className="text-[8px] font-black text-slate-300 uppercase block mb-1">{it.type || it.role || 'PROFIL'}</span>
                                    </td>
                                    <td className="p-6 text-right flex justify-end gap-2">
                                        {(view === 'classes' || view === 'groups') && (<button onClick={() => { setManageItem(it); setMemberSearch(""); }} className="bg-purple-100 text-purple-600 px-4 py-2 rounded-xl font-bold text-[10px] hover:bg-purple-200 transition-colors">ğŸ‘¥ GÃ‰RER</button>)}
                                        <button onClick={() => openEdit(it)} className="bg-slate-100 text-slate-600 px-4 py-2 rounded-xl font-bold text-[10px] hover:bg-slate-200">MODIFIER</button>
                                        <button onClick={() => handleDelete(it._id)} className="w-8 h-8 rounded-lg bg-red-50 text-red-500 font-bold hover:bg-red-100 flex items-center justify-center">âœ•</button>
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            </div>
        </>
    );
}
[[[Â£ END: client/src/features/prof/admin/AdminDashboard.jsx Â£]]]

[[[Â£ FILE: client/src/features/prof/chapters/ChapterManager.jsx Â£]]]
import React from 'react';
export default function ChapterManager() { return <div>Gestion des chapitres</div>; }
[[[Â£ END: client/src/features/prof/chapters/ChapterManager.jsx Â£]]]

[[[Â£ FILE: client/src/features/prof/classroom/ClassroomManager.css Â£]]]
/* --- VARIABLES ET BASE --- */
.classroom-wrapper { 
    background: #f1f5f9; 
    min-height: 85vh; 
    padding: 20px; 
    font-family: 'Inter', sans-serif; 
    display: flex; 
    flex-direction: column;
    --cell-size: 110px; /* DÃ©faut PC */
}

/* HEADER */
.cm-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
.cm-title { font-size: 1.5rem; font-weight: 900; color: #1e293b; text-transform: uppercase; }

/* VIEW SWITCHER */
.view-switcher { display: flex; gap: 5px; background: #e2e8f0; padding: 4px; border-radius: 12px; margin-bottom: 10px; }
.view-btn { flex: 1; padding: 8px 15px; border-radius: 8px; border: none; cursor: pointer; font-weight: 900; font-size: 0.7rem; text-transform: uppercase; color: #64748b; transition: all 0.2s; }
.view-btn.active { background: white; color: #3b82f6; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

/* TOOLBAR */
.cm-toolbar { display: flex; gap: 10px; margin-bottom: 20px; align-items: center; background: white; padding: 10px; border-radius: 20px; border: 1px solid #e2e8f0; flex-wrap: wrap; }
.cm-btn { padding: 10px 15px; border-radius: 12px; font-weight: 900; font-size: 0.7rem; border: none; cursor: pointer; text-transform: uppercase; transition: transform 0.1s; }
.cm-btn:active { transform: scale(0.95); }
.cm-btn.purple { background: #8b5cf6; color: white; }
.cm-btn.slate { background: #f1f5f9; color: #64748b; }
.cm-btn.slate:hover { background: #e2e8f0; }

/* GRID CONTAINER */
.grid-container { 
    flex: 1; overflow: auto; padding: 20px; background: #e2e8f0; border-radius: 20px; 
    box-shadow: inset 0 0 20px rgba(0,0,0,0.05); 
    display: flex; flex-direction: column; align-items: center; position: relative;
}

.grid-header-row, .interactive-grid { display: grid; gap: 10px; width: max-content; min-width: 100%; }
.grid-header-row { margin-bottom: -10px; z-index: 10; padding: 0 20px 10px 20px; }
.col-header-cell { display: flex; align-items: center; justify-content: center; position: relative; color: #94a3b8; font-weight: 900; font-size: 0.7rem; height: 30px; background: rgba(255,255,255,0.5); border-radius: 8px; user-select: none; }
.separator-trigger { position: absolute; right: -12px; width: 14px; height: 100%; cursor: col-resize; display: flex; align-items: center; justify-content: center; z-index: 20; opacity: 0; transition: opacity 0.2s; }
.separator-trigger:hover { opacity: 1; }
.separator-line-hint { width: 2px; height: 80%; background: #334155; border-radius: 2px; }

.interactive-grid { padding: 20px; background: white; border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }

/* CELLULES PC */
.grid-cell-wrapper { position: relative; transition: border-right 0.2s; width: var(--cell-size); height: var(--cell-size); min-width: var(--cell-size); min-height: var(--cell-size); }
.grid-cell-wrapper.has-separator { border-right: 5px solid #1e293b; padding-right: 15px; margin-right: -15px; z-index: 5; }
.grid-cell-empty { background: #f8fafc; border: 2px dashed #cbd5e1; border-radius: 12px; height: 100%; width: 100%; display: flex; align-items: center; justify-content: center; color: #cbd5e1; font-weight: 900; font-size: 1.5rem; transition: all 0.2s; }

/* STUDENT CARD */
.student-card-drag { background: white; border-radius: 12px; padding: 2px; display: flex; flex-direction: column; align-items: center; justify-content: center; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border: 2px solid #f1f5f9; cursor: grab; user-select: none; position: relative; height: 100%; width: 100%; transition: transform 0.1s; overflow: hidden; }
.student-card-drag:active { cursor: grabbing; transform: scale(1.05); z-index: 10; }
.student-card-drag.punished { border-color: #ef4444; background: #fef2f2; }

/* --- INDICATORS POSITIONING --- */
.sc-indicators { 
    position: absolute; 
    left: 4px; 
    top: 4px; 
    bottom: auto;
    transform: none; 
    display: flex; 
    flex-direction: column; 
    gap: 3px; 
    z-index: 50; 
    pointer-events: none; 
}
.indicator-dot { width: 10px; height: 10px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.3); transition: transform 0.2s; }
.indicator-homework-done { background: #22c55e; } .indicator-homework-todo { background: #ef4444; } .indicator-game-done { background: #9333ea; } .indicator-game-failed { background: #3b82f6; } .indicator-game-todo { background: #f472b6; }

.sc-badge { 
    position: absolute; 
    top: 4px; right: 4px; 
    background: #1e293b; color: #fbbf24; 
    font-size: 0.55rem; font-weight: 950; 
    padding: 2px 6px; border-radius: 8px; 
    border: 2px solid white; z-index: 6; 
}

.sc-note-badge { 
    position: absolute; 
    top: 40%; right: 4px; 
    transform: translateY(-50%);
    background: #dc2626; color: white; 
    font-size: 0.55rem; font-weight: 900; 
    width: 18px; height: 18px; 
    border-radius: 50%; 
    display: flex; align-items: center; justify-content: center; 
    border: 2px solid white; 
    z-index: 25; 
}

.sc-punishment-badge { 
    position: absolute; 
    bottom: 4px; right: 4px; 
    width: 16px; height: 16px; 
    border-radius: 50%; 
    color: white; font-weight: 900; font-size: 0.6rem; 
    display: flex; align-items: center; justify-content: center; 
    border: 1px solid white; 
    z-index: 20; 
    box-shadow: 0 2px 5px rgba(0,0,0,0.2); 
}
.sc-punishment-badge.pending { background: #f472b6; animation: pulse-pink 2s infinite; }
.sc-punishment-badge.late { background: #dc2626; animation: pulse-red 1s infinite; }

.sc-avatar { font-size: 1.4rem; margin-bottom: 2px; }
.sc-name { font-size: 0.65rem; font-weight: 800; color: #334155; text-align: center; line-height: 1.1; width: 100%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.sc-counters { display: flex; gap: 4px; margin-top: 2px; font-size: 0.6rem; font-weight: 900; }

@keyframes pulse-pink { 0% { box-shadow: 0 0 0 0 rgba(244, 114, 182, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(244, 114, 182, 0); } 100% { box-shadow: 0 0 0 0 rgba(244, 114, 182, 0); } }
@keyframes pulse-red { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }

/* --- VERSION MOBILE --- */
@media (max-width: 768px) {
    .classroom-wrapper { padding: 0 !important; margin: 0 !important; height: 100%; min-height: auto; overflow: hidden; }
    .cm-header { padding: 5px; margin-bottom: 0; background: white; border-bottom: 1px solid #e2e8f0; justify-content: center; }
    .cm-title, .cm-toolbar { display: none; }
    .view-switcher { margin: 0; width: 100%; }
    .grid-container { padding: 0 !important; margin: 0 !important; background: #e2e8f0; width: 100% !important; align-items: stretch; }
    .grid-header-row, .interactive-grid { gap: 0px; padding: 0; width: 100% !important; grid-template-columns: repeat(var(--grid-cols, 6), 1fr) !important; }
    .interactive-grid { background: transparent; box-shadow: none; margin-bottom: 60px; grid-template-rows: auto !important; }
    .grid-cell-wrapper { width: 100% !important; height: auto !important; aspect-ratio: 0.7; min-width: 0; min-height: 0; border-bottom: 1px solid #cbd5e1; border-right: 1px solid #cbd5e1; }
    .grid-cell-wrapper.has-separator { border-right: 2px solid #1e293b; padding: 0; margin: 0; }
    .student-card-drag { padding: 4px 2px; border-radius: 0; border: none; justify-content: space-evenly; gap: 0px; }
    .sc-avatar { font-size: 0.7rem; margin: 0; opacity: 0.6; line-height: 1; }
    .sc-name { font-size: 0.6rem; font-weight: 950; margin: 0; max-width: 100%; line-height: 1; white-space: normal; color: #0f172a; overflow: visible; }
    .sc-counters { display: flex !important; font-size: 0.55rem; gap: 2px; margin-top: 1px; }
    .indicator-dot { width: 4px; height: 4px; border-width: 0; }
    .sc-indicators { gap: 2px; left: 2px; top: 4px; transform: none; }
    .sc-badge { display: block !important; padding: 1px 3px; font-size: 0.45rem; top: 2px; right: 2px; border-width: 1px; }
    .sc-note-badge { width: 12px; height: 12px; font-size: 0.45rem; top: 40%; right: 2px; border-width: 1px; }
    .sc-punishment-badge { width: 10px; height: 10px; font-size: 0; bottom: 2px; right: 2px; border-width: 1px; }
}

/* LISTES ET DRAWER */
.list-container { flex: 1; display: flex; flex-direction: column; gap: 10px; padding: 10px; background: white; border-radius: 20px; overflow-y: auto; }
.list-finder { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 12px; font-weight: 700; outline: none; margin-bottom: 10px; }
.list-finder:focus { border-color: #3b82f6; }
.student-list-row { display: flex; align-items: center; justify-content: space-between; padding: 12px; border-radius: 12px; border: 1px solid #f1f5f9; background: #f8fafc; transition: background 0.1s; }
.student-list-row:hover { background: #f1f5f9; }
.list-info { flex: 1; display: flex; flex-direction: column; }
.list-name { font-weight: 900; color: #1e293b; font-size: 0.85rem; }
.list-stats { font-size: 0.65rem; color: #64748b; font-weight: 700; margin-top: 2px; }
.list-actions { display: flex; gap: 8px; }
.btn-list-action { width: 35px; height: 35px; border-radius: 8px; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1rem; font-weight: 900; transition: transform 0.1s; }
.btn-list-action:active { transform: scale(0.9); }
.btn-x { background: #fee2e2; color: #ef4444; border: 1px solid #fecaca; }
.btn-v { background: #dcfce7; color: #16a34a; border: 1px solid #bbf7d0; }
.btn-c { background: #eff6ff; color: #3b82f6; border: 1px solid #bfdbfe; font-size: 0.8rem; }
.action-drawer { position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: 20px; border-radius: 30px 30px 0 0; box-shadow: 0 -10px 40px rgba(0,0,0,0.15); z-index: 100; transform: translateY(100%); transition: transform 0.3s; }
.action-drawer.open { transform: translateY(0); }
.drawer-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
.drawer-name { font-size: 1.2rem; font-weight: 900; color: #0f172a; }
.drawer-close { background: #f1f5f9; border: none; width: 35px; height: 35px; border-radius: 50%; font-weight: bold; cursor: pointer; }
.drawer-grid-complex { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 10px; }
.act-btn { padding: 12px; border-radius: 12px; font-weight: 900; border: none; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 3px; font-size: 0.7rem; text-transform: uppercase; }
.act-btn:active { transform: scale(0.95); }
.btn-cross { background: #fee2e2; color: #ef4444; border: 2px solid #fecaca; }
.btn-rem-cross { background: white; color: #94a3b8; border: 2px dashed #e2e8f0; }
.btn-bonus { background: #dcfce7; color: #16a34a; border: 2px solid #bbf7d0; }
.btn-rem-bonus { background: white; color: #94a3b8; border: 2px dashed #e2e8f0; }
.btn-note { background: #f1f5f9; color: #475569; border: 2px solid #e2e8f0; grid-column: span 2; display: flex; flex-direction: row !important; justify-content: center; gap: 10px; }
.btn-move-full { background: #f8fafc; color: #64748b; border: 2px solid #f1f5f9; grid-column: span 2; display: flex; flex-direction: row !important; justify-content: center; gap: 10px; }
.note-area-wrapper { animation: fadeIn 0.2s; margin-bottom: 10px; }
.note-textarea { width: 100%; height: 80px; padding: 10px; border-radius: 12px; border: 2px solid #e2e8f0; font-family: sans-serif; font-size: 0.9rem; outline: none; }
.note-textarea:focus { border-color: #3b82f6; }
.btn-save-note { width: 100%; padding: 10px; background: #3b82f6; color: white; font-weight: 900; border: none; border-radius: 10px; margin-top: 5px; cursor: pointer; }
.ia-loader { position: fixed; inset: 0; background: rgba(15,23,42,0.9); z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; }
.spinner-ia { width: 50px; height: 50px; border: 5px solid rgba(255,255,255,0.2); border-top-color: #a855f7; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px; }
@keyframes spin { to { transform: rotate(360deg); } }

/* BOUTON LEVER PUNITION (NOUVEAU) */
.btn-cancel-punish {
    background: #fff1f2;
    color: #e11d48;
    border: 2px solid #e11d48;
    grid-column: span 2;
    display: flex;
    flex-direction: row !important;
    justify-content: center;
    gap: 10px;
    font-size: 0.8rem;
    transition: all 0.2s;
}
.btn-cancel-punish:hover { background: #e11d48; color: white; }
.btn-cancel-punish:active { transform: scale(0.95); }
[[[Â£ END: client/src/features/prof/classroom/ClassroomManager.css Â£]]]

[[[Â£ FILE: client/src/features/prof/classroom/ClassroomManager.jsx Â£]]]
import React, { useState, useEffect, useRef } from 'react';
import './ClassroomManager.css';

export default function ClassroomManager({ globalClassId, user }) {
    const [students, setStudents] = useState([]);
    const [gridSize, setGridSize] = useState({ cols: 6, rows: 5 });
    const [separators, setSeparators] = useState([]);
    const [selectedStudent, setSelectedStudent] = useState(null);
    const [loading, setLoading] = useState(true);
    const [iaLoading, setIaLoading] = useState(false);
    
    // UI STATES
    const [viewMode, setViewMode] = useState('PLAN');
    const [searchTerm, setSearchTerm] = useState("");
    
    const [showNoteInput, setShowNoteInput] = useState(false);
    const [currentNote, setCurrentNote] = useState("");
    const [swapSource, setSwapSource] = useState(null);
    const [draggingId, setDraggingId] = useState(null);
    const [dragOverCell, setDragOverCell] = useState(null);
    const fileInputRef = useRef(null);
    
    const myId = user ? (user._id || user.id) : null;

    const loadData = async () => {
        if (!globalClassId) return;
        try {
            const resClass = await fetch(`/api/classroom/${globalClassId}`);
            if (resClass.ok) {
                const clsInfo = await resClass.json();
                if (clsInfo.layout && clsInfo.layout.separators) setSeparators(clsInfo.layout.separators);
            }
            const queryParams = myId ? `?teacherId=${myId}` : '';
            const res = await fetch(`/api/classroom/plan/${globalClassId}${queryParams}`);
            
            if (res.ok) {
                const data = await res.json();
                if (Array.isArray(data)) {
                    let maxCol = 5; let maxRow = 4;
                    data.forEach(s => {
                        if (s.seatX >= maxCol) maxCol = s.seatX + 1;
                        if (s.seatY >= maxRow) maxRow = s.seatY + 1;
                    });
                    setGridSize(prev => ({ cols: Math.max(prev.cols, maxCol), rows: Math.max(prev.rows, maxRow) }));
                    setStudents(data);
                } else { setStudents([]); }
            }
        } catch(e) { console.error(e); }
        setLoading(false);
    };

    useEffect(() => { loadData(); }, [globalClassId, myId]);

    const toggleSeparator = async (colIndex) => { let newSeps = [...separators]; if (newSeps.includes(colIndex)) newSeps = newSeps.filter(s => s !== colIndex); else newSeps.push(colIndex); setSeparators(newSeps); try { await fetch('/api/classroom/layout', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ classId: globalClassId, separators: newSeps }) }); } catch(e){} };
    const changeGrid = (dC, dR) => { setGridSize(p => ({ cols: Math.max(2, p.cols + dC), rows: Math.max(2, p.rows + dR) })); };
    const handleDragStart = (e, sId) => { setDraggingId(sId); e.dataTransfer.setData("text/plain", sId); e.dataTransfer.effectAllowed = "move"; };
    const handleDragOver = (e, x, y) => { e.preventDefault(); setDragOverCell(`${x}-${y}`); };
    const handleDrop = async (e, x, y) => { e.preventDefault(); setDragOverCell(null); const sId = draggingId; if (!sId) return; const targetStudent = students.find(s => s.seatX === x && s.seatY === y); const movedStudent = students.find(s => s._id === sId); if (targetStudent && targetStudent._id !== sId) { const oldX = movedStudent.seatX; const oldY = movedStudent.seatY; setStudents(prev => prev.map(s => { if (s._id === sId) return { ...s, seatX: x, seatY: y }; if (s._id === targetStudent._id) return { ...s, seatX: oldX, seatY: oldY }; return s; })); } else { setStudents(prev => prev.map(s => s._id === sId ? { ...s, seatX: x, seatY: y } : s)); } try { await fetch('/api/classroom/move', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ studentId: sId, x, y }) }); } catch(err) { loadData(); } setDraggingId(null); };
    const handleFileSelect = async (e) => { const file = e.target.files[0]; if (!file) return; if(!confirm(`ğŸ“¸ Analyser ${file.name} ?`)) return; setIaLoading(true); const formData = new FormData(); formData.append('file', file); formData.append('classId', globalClassId); try { await fetch('/api/classroom/import-plan', { method: 'POST', body: formData }); await loadData(); } catch(e) { alert("Erreur IA"); } setIaLoading(false); e.target.value = null; };
    const getMyStats = (stu) => { if (!stu.behaviorRecords) return { crosses: 0, bonuses: 0, weeksToRedemption: 3 }; return stu.behaviorRecords.find(r => r.teacherId === myId) || { crosses: 0, bonuses: 0, weeksToRedemption: 3 }; };
    const handleOpenStudent = (stu) => { if (swapSource) { moveStudentTo(swapSource._id, stu.seatX, stu.seatY); setSwapSource(null); return; } setSelectedStudent(stu); setCurrentNote(stu.myNote || ""); setShowNoteInput(false); };
    
    // --- GESTION DES ACTIONS ---
    const addBehavior = async (sid, type, extra = null) => { 
        if (!myId) return alert("Erreur: ID Professeur introuvable.");

        // Optimistic UI Update
        setStudents(prev => prev.map(s => {
            if (s._id !== sid) return s;
            const newS = { ...s, behaviorRecords: [...(s.behaviorRecords || [])] };
            let rIdx = newS.behaviorRecords.findIndex(r => r.teacherId === myId);
            if(rIdx === -1) { newS.behaviorRecords.push({ teacherId: myId, crosses: 0, bonuses: 0, weeksToRedemption: 3 }); rIdx = newS.behaviorRecords.length - 1; }
            
            const r = { ...newS.behaviorRecords[rIdx] };
            if (type === 'CROSS') r.crosses++;
            if (type === 'BONUS') r.bonuses++;
            if (type === 'REMOVE_CROSS') r.crosses = Math.max(0, r.crosses - 1);
            if (type === 'REMOVE_BONUS') r.bonuses = Math.max(0, r.bonuses - 1);
            
            // Mise Ã  jour visuelle immÃ©diate pour la punition supprimÃ©e
            if (type === 'REMOVE_PUNISHMENT') {
                newS.punishmentStatus = 'NONE';
            }

            newS.behaviorRecords[rIdx] = r;
            return newS;
        }));

        try {
            const res = await fetch('/api/classroom/behavior', { 
                method: 'POST', 
                headers: {'Content-Type':'application/json'}, 
                body: JSON.stringify({ studentId: sid, type, teacherId: myId, extraData: extra }) 
            });

            if (res.ok) {
                await loadData();
                if (['SAVE_NOTE', 'REMOVE_PUNISHMENT'].includes(type)) setSelectedStudent(null);
            }
        } catch(e) { console.error("Erreur API", e); loadData(); }
    };

    const moveStudentTo = async (sid, x, y) => { try { await fetch('/api/classroom/move', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ studentId: sid, x, y }) }); await loadData(); } catch(e){} };

    if (!globalClassId) return <div className="p-10 text-center text-slate-400 font-black">SÃ‰LECTIONNEZ UNE CLASSE</div>;

    const renderGrid = () => {
        const cells = [];
        for (let y = 0; y < gridSize.rows; y++) {
            for (let x = 0; x < gridSize.cols; x++) {
                const student = students.find(s => s.seatX === x && s.seatY === y);
                const isOver = dragOverCell === `${x}-${y}`;
                const hasSep = separators.includes(x);
                cells.push(
                    <div key={`${x}-${y}`} className={`grid-cell-wrapper ${isOver ? 'drag-over' : ''} ${hasSep ? 'has-separator' : ''}`} style={{ gridColumn: x + 1, gridRow: y + 1 }} onDragOver={(e) => handleDragOver(e, x, y)} onDrop={(e) => handleDrop(e, x, y)} onClick={() => !student && swapSource && moveStudentTo(swapSource._id, x, y) && setSwapSource(null)}>
                        {student ? (
                            <div className={`student-card-drag ${draggingId === student._id ? 'dragging' : ''} ${getMyStats(student).crosses >= 3 ? 'punished' : ''}`} draggable="true" onDragStart={(e) => handleDragStart(e, student._id)} onClick={(e) => { e.stopPropagation(); handleOpenStudent(student); }}>
                                {getMyStats(student).crosses > 0 && <div className="sc-badge">â³ {getMyStats(student).weeksToRedemption}</div>}
                                {student.myNote && <div className="sc-note-badge">N</div>}
                                {student.punishmentStatus && student.punishmentStatus !== 'NONE' && (<div className={`sc-punishment-badge ${student.punishmentStatus === 'LATE' ? 'late' : 'pending'}`}>P</div>)}
                                <div className="sc-indicators">{(student.indicators || []).map((ind, i) => (<div key={i} className={`indicator-dot indicator-${ind.type}-${ind.status}`} title={`${ind.type} : ${ind.status}`}></div>))}</div>
                                <div className="sc-avatar">{student.gender === 'F' ? 'ğŸ‘§' : 'ğŸ‘¦'}</div>
                                <div className="sc-name">{student.firstName}<br/>{student.lastName.slice(0,1)}.</div>
                                <div className="sc-counters"><span style={{color:'#ef4444'}}>âŒ{getMyStats(student).crosses}</span><span style={{color:'#10b981'}}>â­{getMyStats(student).bonuses}</span></div>
                            </div>
                        ) : ( <div className={`grid-cell-empty ${isOver ? 'drag-over' : ''}`}>+</div> )}
                    </div>
                );
            }
        }
        return cells;
    };

    const renderHeaders = () => {
        const headers = [];
        for (let x = 0; x < gridSize.cols; x++) {
            headers.push(
                <div key={x} className="col-header-cell">COL {x+1}
                    {x < gridSize.cols - 1 && (<div className="separator-trigger" onDoubleClick={() => toggleSeparator(x)}><div className="separator-line-hint"></div></div>)}
                </div>
            );
        }
        return headers;
    };

    const renderList = () => {
        const filtered = students.filter(s => (s.firstName + ' ' + s.lastName).toLowerCase().includes(searchTerm.toLowerCase())).sort((a,b) => a.lastName.localeCompare(b.lastName));
        return (
            <div className="list-container custom-scrollbar">
                <input className="list-finder" placeholder="ğŸ” Chercher un Ã©lÃ¨ve..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)} />
                {filtered.map(s => {
                    const stats = getMyStats(s);
                    return (
                        <div key={s._id} className="student-list-row">
                            <div className="list-info" onClick={() => handleOpenStudent(s)}><span className="list-name">{s.lastName} {s.firstName}</span><span className="list-stats">âŒ {stats.crosses} | â­ {stats.bonuses} {s.punishmentStatus !== 'NONE' ? '| âš ï¸ PUNI' : ''}</span></div>
                            <div className="list-actions"><button className="btn-list-action btn-x" onClick={() => addBehavior(s._id, 'CROSS')}>âŒ</button><button className="btn-list-action btn-v" onClick={() => addBehavior(s._id, 'BONUS')}>â­</button><button className="btn-list-action btn-c" onClick={() => handleOpenStudent(s)}>ğŸ“</button></div>
                        </div>
                    );
                })}
            </div>
        );
    };

    return (
        <div className="classroom-wrapper" style={{ '--grid-cols': gridSize.cols }}>
            <input type="file" ref={fileInputRef} style={{display:'none'}} accept="image/*" onChange={handleFileSelect} />
            {iaLoading && <div className="ia-loader"><div className="spinner-ia"></div><span>IA ACTIVE...</span></div>}
            
            <div className="cm-header">
                <h2 className="cm-title md:block hidden">{viewMode === 'PLAN' ? 'MODE PLAN' : 'MODE LISTE'}</h2>
                <div className="view-switcher">
                    <button className={`view-btn ${viewMode === 'PLAN' ? 'active' : ''}`} onClick={() => setViewMode('PLAN')}>ğŸ“ PLAN</button>
                    <button className={`view-btn ${viewMode === 'LIST' ? 'active' : ''}`} onClick={() => setViewMode('LIST')}>ğŸ“‹ LISTE</button>
                </div>
            </div>
            
            {viewMode === 'PLAN' ? (
                <>
                    <div className="cm-toolbar hidden md:flex">
                        <button className="cm-btn purple" onClick={() => fileInputRef.current.click()}>ğŸ”® IMPORT IA</button>
                        <div className="w-px h-6 bg-slate-200 mx-2"></div>
                        <span className="text-[10px] font-bold text-slate-400">COLS:</span><button className="cm-btn slate" onClick={() => changeGrid(-1, 0)}>-</button><span className="font-bold">{gridSize.cols}</span><button className="cm-btn slate" onClick={() => changeGrid(1, 0)}>+</button>
                        <span className="text-[10px] font-bold text-slate-400 ml-2">ROWS:</span><button className="cm-btn slate" onClick={() => changeGrid(0, -1)}>-</button><span className="font-bold">{gridSize.rows}</span><button className="cm-btn slate" onClick={() => changeGrid(0, 1)}>+</button>
                    </div>
                    
                    <div className="grid-container custom-scrollbar">
                        <div className="grid-header-row" style={{ gridTemplateColumns: `repeat(${gridSize.cols}, var(--cell-size, 100px))` }}>{renderHeaders()}</div>
                        <div className="interactive-grid" style={{ gridTemplateColumns: `repeat(${gridSize.cols}, var(--cell-size, 100px))`, gridTemplateRows: `repeat(${gridSize.rows}, var(--cell-size, 100px))` }}>{renderGrid()}</div>
                    </div>
                </>
            ) : renderList()}
            
            <div className={`action-drawer ${selectedStudent ? 'open' : ''}`}>
                {selectedStudent && (
                    <>
                        <div className="drawer-header"><span className="drawer-name">{selectedStudent.firstName} {selectedStudent.lastName}</span><button className="drawer-close" onClick={() => setSelectedStudent(null)}>âœ•</button></div>
                        <div className="drawer-grid-complex">
                            <button className="act-btn btn-cross" onClick={() => addBehavior(selectedStudent._id, 'CROSS')}>âŒ AJOUTER CROIX</button>
                            <button className="act-btn btn-bonus" onClick={() => addBehavior(selectedStudent._id, 'BONUS')}>â­ AJOUTER BONUS</button>
                            <button className="act-btn btn-rem-cross" onClick={() => addBehavior(selectedStudent._id, 'REMOVE_CROSS')}>RETIRER CROIX</button>
                            <button className="act-btn btn-rem-bonus" onClick={() => addBehavior(selectedStudent._id, 'REMOVE_BONUS')}>RETIRER BONUS</button>
                            <button className="act-btn btn-note" onClick={() => setShowNoteInput(!showNoteInput)}>ğŸ“ NOTES PERSONNELLES {showNoteInput ? 'â–²' : 'â–¼'}</button>
                            
                            {/* BOUTON REMPLACÃ‰ : SUPPRIMER PUNITION */}
                            <button className="act-btn btn-cancel-punish" onClick={() => addBehavior(selectedStudent._id, 'REMOVE_PUNISHMENT')}>
                                âš–ï¸ LEVER PUNITION
                            </button>
                        </div>
                        {showNoteInput && (
                            <div className="note-area-wrapper">
                                <textarea className="note-textarea" value={currentNote} onChange={e => setCurrentNote(e.target.value)} placeholder="Note invisible pour l'Ã©lÃ¨ve..." />
                                <button className="btn-save-note" onClick={() => addBehavior(selectedStudent._id, 'SAVE_NOTE', currentNote)}>ENREGISTRER LA NOTE</button>
                            </div>
                        )}
                    </>
                )}
            </div>
        </div>
    );
}
[[[Â£ END: client/src/features/prof/classroom/ClassroomManager.jsx Â£]]]

[[[Â£ FILE: client/src/features/prof/components/ConsoleHUD.jsx Â£]]]
import React, { useState, useEffect } from 'react';
export default function ConsoleHUD() {
    const [logs, setLogs] = useState([]);
    useEffect(() => {
        const log = console.log;
        console.log = (...args) => { setLogs(prev => [...prev, args.join(' ')].slice(-5)); log.apply(console, args); };
    }, []);
    if (logs.length === 0) return null;
    return <div className="fixed bottom-4 left-4 bg-black/80 text-green-400 p-2 rounded text-[8px] font-mono z-[9999]">{logs.map((l, i) => <div key={i}>{l}</div>)}</div>;
}
[[[Â£ END: client/src/features/prof/components/ConsoleHUD.jsx Â£]]]

[[[Â£ FILE: client/src/features/prof/components/ConsoleReporter.css Â£]]]
.error-banner-minimal {
    position: fixed; top: 0; left: 0; right: 0;
    background: #ef4444; color: white; z-index: 999999;
    padding: 14px 25px; font-family: 'JetBrains Mono', monospace;
    font-size: 11px; font-weight: 900;
    box-shadow: 0 10px 40px rgba(239, 68, 68, 0.4);
    transform: translateY(-100%); transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    cursor: pointer; border-bottom: 2px solid #b91c1c;
}
.error-banner-minimal.show { transform: translateY(0); }
.error-banner-minimal.copied { background: #10b981; border-color: #059669; box-shadow: 0 10px 40px rgba(16, 185, 129, 0.4); }

.banner-content { max-width: 1400px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; }
.banner-icon { font-size: 18px; margin-right: 15px; }
.banner-text { flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; text-transform: uppercase; letter-spacing: 0.5px; }
.banner-hint { background: rgba(0,0,0,0.3); padding: 5px 10px; border-radius: 8px; font-size: 9px; margin-left: 20px; font-weight: 950; }
[[[Â£ END: client/src/features/prof/components/ConsoleReporter.css Â£]]]

[[[Â£ FILE: client/src/features/prof/components/ConsoleReporter.jsx Â£]]]
import React, { useState, useEffect } from 'react';
import './ConsoleReporter.css';

export default function ConsoleReporter({ user }) {
    const [errors, setErrors] = useState([]);
    const [bannerVisible, setBannerVisible] = useState(false);
    const [copySuccess, setCopySuccess] = useState(false);

    useEffect(() => {
        const originalError = console.error;
        console.error = (...args) => {
            const msg = args.map(a => typeof a === 'object' ? JSON.stringify(a) : String(a)).join(' ');
            // Filtre les bruits React habituels
            if(!msg.includes('snapshot') && !msg.includes('React') && !msg.includes('key')) {
                handleNewError(`CONSOLE: ${msg}`);
            }
            originalError.apply(console, args);
        };

        const originalFetch = window.fetch;
        window.fetch = async (...args) => {
            try {
                const res = await originalFetch(...args);
                
                // INTERCEPTION INTELLIGENTE DES ERREURS
                if (!res.ok && !args[0].includes('report-')) {
                    const method = args[1]?.method || 'GET';
                    let detail = "";
                    
                    try {
                        // On clone la rÃ©ponse pour lire le JSON sans la consommer pour l'app
                        const clone = res.clone();
                        const json = await clone.json();
                        detail = json.error || json.message || "";
                    } catch (e) {
                        detail = "Erreur inconnue";
                    }

                    handleNewError(`ERR ${res.status}: ${detail} (${method} ${args[0]})`);
                }
                return res;
            } catch (err) {
                if (!args[0].includes('report-')) handleNewError(`CRASH RÃ‰SEAU: ${args[0]}`);
                throw err;
            }
        };

        const handleKeyDown = (e) => {
            if (e.metaKey && e.shiftKey && e.code === 'KeyL') {
                e.preventDefault();
                copyToClipboard();
            }
        };
        window.addEventListener('keydown', handleKeyDown);

        return () => {
            console.error = originalError;
            window.fetch = originalFetch;
            window.removeEventListener('keydown', handleKeyDown);
        };
    }, [errors]);

    const handleNewError = (msg) => {
        // On Ã©vite les doublons visuels
        setErrors(prev => {
            const isDuplicate = prev.length > 0 && prev[prev.length - 1].msg === msg;
            if (isDuplicate) return prev;
            return [...prev, { msg, time: new Date().toLocaleTimeString() }].slice(-15);
        });
        setBannerVisible(true);
    };

    const copyToClipboard = () => {
        if (errors.length === 0) return;
        const payload = `[REPORT_MAC_TURBO]\nPage: ${window.location.href}\nStaff: ${user?.firstName}\n\nLOGS D'ERREURS :\n${errors.map(e => `[${e.time}] ${e.msg}`).join('\n')}\n\nGemini, rÃ©pare mon code via snapshot.txt.`;
        navigator.clipboard.writeText(payload).then(() => {
            setCopySuccess(true);
            setTimeout(() => setCopySuccess(false), 2000);
        });
    };

    if (!bannerVisible && errors.length === 0) return null;

    // RÃ©cupÃ©ration de la derniÃ¨re erreur pour l'affichage
    const lastError = errors.length > 0 ? errors[errors.length - 1] : { msg: '' };

    return (
        <div className={`error-banner-minimal ${bannerVisible ? 'show' : ''} ${copySuccess ? 'copied' : ''}`} onClick={() => setBannerVisible(false)}>
            <div className="banner-content">
                <span className="banner-icon">{copySuccess ? 'âœ…' : 'ğŸš¨'}</span>
                <span className="banner-text">
                    {copySuccess ? 'RAPPORT COPIÃ‰ ! COLLE-LE DANS GEMINI' : `${lastError.msg}`}
                </span>
                {!copySuccess && <span className="banner-hint">âŒ˜+â‡§+L</span>}
            </div>
        </div>
    );
}
[[[Â£ END: client/src/features/prof/components/ConsoleReporter.jsx Â£]]]

[[[Â£ FILE: client/src/features/prof/components/DatabaseViewer.css Â£]]]
/* CORRECTION Z-INDEX : Passage Ã  20000 pour Ãªtre au-dessus de tout */
.db-viewer-overlay { position: fixed; inset: 0; z-index: 20000; background: rgba(15, 23, 42, 0.95); display: flex; align-items: center; justify-content: center; padding: 2rem; }
.db-viewer-window { background: white; width: 100%; height: 100%; border-radius: 40px; display: flex; flex-direction: column; overflow: hidden; }
.db-header { padding: 1.5rem 2rem; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
.db-tabs { display: flex; overflow-x: auto; background: #f8fafc; border-bottom: 1px solid #eee; padding: 0.5rem 2rem; gap: 10px; }
.db-tab-btn { padding: 0.5rem 1rem; border-radius: 10px; font-weight: 800; font-size: 0.7rem; color: #94a3b8; white-space: nowrap; }
.db-tab-btn.active { background: #1e293b; color: white; }
.db-table-container { flex: 1; overflow: auto; padding: 1rem; }
.db-table { width: 100%; border-collapse: collapse; font-family: monospace; font-size: 0.65rem; }
.db-table th { background: #f8fafc; text-align: left; padding: 0.8rem; border-bottom: 2px solid #eee; position: sticky; top: 0; }
.db-table td { padding: 0.6rem 0.8rem; border-bottom: 1px solid #f1f5f9; }
[[[Â£ END: client/src/features/prof/components/DatabaseViewer.css Â£]]]

[[[Â£ FILE: client/src/features/prof/components/DatabaseViewer.jsx Â£]]]
import React, { useState, useEffect } from 'react';
import './DatabaseViewer.css';

const DESCRIPTIONS = {
    academicyears: "ğŸ“… AnnÃ©es Scolaires.",
    enrollments: "ğŸ”— Inscriptions (Lien Student <-> Class).",
    students: "ğŸ‘¤ Profils ElÃ¨ves.",
    classrooms: "ğŸ« Classes & Groupes.",
    subjects: "ğŸ“š MatiÃ¨res.",
    teachers: "ğŸ“ Enseignants.",
    admins: "ğŸ›¡ï¸ Staff & DÃ©veloppeurs.",
    chapters: "ğŸ“ Chapitres (Dossiers).",
    homeworks: "ğŸ“ Devoirs.",
    submissions: "ğŸ“¤ Rendus.",
    gamelevels: "ğŸ® Quiz.",
    gameprogress: "ğŸ“ˆ Scores.",
    mistakes: "âœ’ï¸ Orthographe.",
    accesslogs: "ğŸ” Logs.",
    bugreports: "ğŸª² Bugs.",
    projectdocs: "ğŸ§  Doc IA."
};

export default function DatabaseViewer({ onClose }) {
    const [data, setData] = useState(null);
    const [activeTab, setActiveTab] = useState('classrooms'); // Par dÃ©faut sur classrooms pour vÃ©rifier
    const [loading, setLoading] = useState(true);
    const [error, setError] = useState(null);

    const loadData = () => {
        setLoading(true);
        setError(null);
        fetch('/api/admin/database-dump')
            .then(async res => {
                if(!res.ok) throw new Error(await res.text());
                return res.json();
            })
            .then(d => { 
                setData(d); 
                const keys = Object.keys(d || {});
                if (keys.length > 0 && !d[activeTab]) setActiveTab(keys[0]);
                setLoading(false); 
            })
            .catch(err => { setError(err.message); setLoading(false); });
    };

    useEffect(() => { loadData(); }, []);

    const renderCell = (val) => {
        if (val === null || val === undefined) return <span className="text-slate-300">-</span>;
        if (typeof val === 'object') {
            return (
                <pre className="text-[9px] bg-slate-100 p-1 rounded border border-slate-200 max-h-[60px] overflow-y-auto whitespace-pre-wrap font-mono scrollbar-thin">
                    {JSON.stringify(val, null, 0)}
                </pre>
            );
        }
        return <span className="font-bold text-slate-700">{String(val)}</span>;
    };

    if (loading) return <div className="db-viewer-overlay"><h2 className="text-white font-black animate-pulse text-2xl">CHARGEMENT BDD...</h2></div>;
    if (error) return <div className="db-viewer-overlay"><div className="bg-white p-8 rounded-2xl text-red-500 font-black">ERREUR: {error}<button onClick={onClose} className="block mt-4 bg-slate-800 text-white px-4 py-2 rounded">Fermer</button></div></div>;

    const currentData = (data && data[activeTab]) ? data[activeTab] : [];

    // --- CORRECTION V143 : SCAN COMPLET DES COLONNES ---
    // On ne regarde plus juste la ligne 0, on regarde TOUT pour trouver toutes les clÃ©s possibles
    const allKeys = new Set();
    currentData.forEach(item => Object.keys(item).forEach(k => allKeys.add(k)));
    // On convertit le Set en Array, on retire __v, et on trie pour avoir _id et name en premier
    const columns = Array.from(allKeys)
        .filter(k => k !== '__v')
        .sort((a, b) => {
            if (a === '_id') return -1;
            if (b === '_id') return 1;
            if (a === 'name') return -1;
            if (b === 'name') return 1;
            if (a === 'level') return -1; // On met level en Ã©vidence
            return a.localeCompare(b);
        });

    return (
        <div className="db-viewer-overlay" onClick={onClose}>
            <div className="db-viewer-window" onClick={e => e.stopPropagation()}>
                <div className="db-header">
                    <div>
                        <h2 className="font-black uppercase text-xl text-slate-800">Visualisateur de DonnÃ©es V143</h2>
                        <span className="text-[9px] text-indigo-500 font-black tracking-widest uppercase">Base MongoDB Brute</span>
                    </div>
                    <button onClick={onClose} className="w-10 h-10 bg-slate-100 rounded-full font-black hover:bg-red-50 hover:text-red-500 transition-colors">âœ•</button>
                </div>

                <div className="db-tabs no-scrollbar">
                    {Object.keys(data || {}).sort().map(c => (
                        <button key={c} onClick={() => setActiveTab(c)} className={`db-tab-btn ${activeTab === c ? 'active' : ''}`}>
                            {c} ({data[c]?.length || 0})
                        </button>
                    ))}
                </div>
                
                <div className="p-4 bg-indigo-50 text-indigo-700 font-bold text-[10px] uppercase border-b border-indigo-100 flex justify-between items-center">
                    <span>{DESCRIPTIONS[activeTab] || `COLLECTION : ${activeTab.toUpperCase()}`}</span>
                    <span className="bg-white px-2 py-1 rounded text-indigo-400">{currentData.length} entrÃ©es</span>
                </div>

                <div className="db-table-container custom-scrollbar">
                    {currentData.length > 0 ? (
                        <table className="db-table">
                            <thead>
                                <tr>
                                    {columns.map(col => (
                                        <th key={col} className={col === 'level' ? 'bg-yellow-100 text-yellow-700' : ''}>{col.toUpperCase()}</th>
                                    ))}
                                </tr>
                            </thead>
                            <tbody>
                                {currentData.map((row, i) => (
                                    <tr key={i} className="hover:bg-blue-50 transition-colors">
                                        {columns.map(col => (
                                            <td key={col} className={`align-middle border-b border-slate-100 p-2 ${col === 'level' ? 'bg-yellow-50/50 font-black text-center' : ''}`}>
                                                {renderCell(row[col])}
                                            </td>
                                        ))}
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    ) : <div className="p-20 text-center text-slate-300 font-black text-xl uppercase">TABLE {activeTab} VIDE</div>}
                </div>
            </div>
        </div>
    );
}
[[[Â£ END: client/src/features/prof/components/DatabaseViewer.jsx Â£]]]

[[[Â£ FILE: client/src/features/prof/components/DriveViewer.css Â£]]]
.drive-viewer-overlay { position: fixed; inset: 0; z-index: 20001; background: rgba(15, 23, 42, 0.95); display: flex; align-items: center; justify-content: center; padding: 3rem; }
.drive-viewer-window { background: #fff; width: 100%; max-width: 1000px; height: 85vh; border-radius: 40px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 40px 100px rgba(0,0,0,0.5); border: 1px solid #e2e8f0; }
.drive-viewer-header { background: #0f172a; padding: 2rem; display: flex; justify-content: space-between; align-items: center; border-bottom: 4px solid #10b981; }
.drive-viewer-body { flex: 1; overflow-y: auto; padding: 2.5rem; background: #f8fafc; }

.drive-item { display: flex; align-items: center; justify-content: space-between; padding: 12px 15px; border-radius: 15px; transition: all 0.1s; margin-bottom: 5px; border: 1px solid transparent; }
.drive-item:hover { background: #fff; border-color: #e2e8f0; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }

.drive-name { font-weight: 950; color: #1e293b; text-transform: uppercase; font-size: 13px; }
.drive-id-tag { font-family: monospace; font-size: 8px; color: #94a3b8; margin-top: 2px; }

.drive-actions { display: flex; gap: 8px; }
.drive-action-btn { width: 30px; height: 30px; border-radius: 10px; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 12px; transition: all 0.2s; }
.drive-action-btn.view { background: #f1f5f9; color: #64748b; }
.drive-action-btn.delete { background: #fef2f2; color: #ef4444; }
.drive-action-btn.delete:hover { background: #ef4444; color: white; }

.drive-children { border-left: 2px dashed #e2e8f0; margin-left: 10px; padding-left: 15px; }
.v14-sync-btn { background: #10b981; color: white; padding: 10px 20px; border-radius: 12px; font-weight: 950; font-size: 10px; border: none; cursor: pointer; transition: transform 0.1s; }
.v14-sync-btn:hover { filter: brightness(1.1); transform: scale(1.05); }
.v14-close-btn { background: #334155; color: white; width: 40px; height: 40px; border-radius: 50%; border: none; cursor: pointer; font-weight: 900; }
.v14-loader { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; gap: 20px; color: #10b981; font-weight: 950; }
.spinner { width: 40px; height: 40px; border: 4px solid #f1f5f9; border-top-color: #10b981; border-radius: 50%; animation: spin 1s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }
[[[Â£ END: client/src/features/prof/components/DriveViewer.css Â£]]]

[[[Â£ FILE: client/src/features/prof/components/DriveViewer.jsx Â£]]]
import React, { useState, useEffect } from 'react';
import './DriveViewer.css';

const DriveNode = ({ node, depth = 0, onDelete }) => {
    const [isOpen, setIsOpen] = useState(depth < 1);
    const isFolder = node.type === 'folder';
    const isRoot = node.name === 'CONDA PROJECT';
    const isBranch = ['ENSEIGNANTS', 'ADMINISTRATION', 'CLASSES'].includes(node.name);

    return (
        <div className="drive-node" style={{ marginLeft: depth > 0 ? '20px' : '0' }}>
            <div className={`drive-item ${isFolder ? 'is-folder' : 'is-file'} ${isBranch ? 'branch-style' : ''}`}>
                <div className="flex-1 flex flex-col cursor-pointer" onClick={() => isFolder && setIsOpen(!isOpen)}>
                    <div className="flex items-center gap-3">
                        <span className="drive-icon">{isFolder ? (isOpen ? 'ğŸ“‚' : 'ğŸ“') : 'ğŸ“„'}</span>
                        <span className="drive-name">{node.name}</span>
                    </div>
                </div>
                <div className="drive-actions">
                    {!isFolder && node.link && <a href={node.link} target="_blank" className="drive-action-btn view">ğŸ‘ï¸</a>}
                    {!isRoot && !isBranch && (
                        <button className="drive-action-btn delete" onClick={(e) => { e.stopPropagation(); onDelete(node.id, node.name); }}>âœ•</button>
                    )}
                </div>
            </div>
            {isFolder && isOpen && node.children && (
                <div className="drive-children">
                    {node.children.length > 0 ? (
                        node.children.map((child, i) => <DriveNode key={i} node={child} depth={depth + 1} onDelete={onDelete} />)
                    ) : (
                        <div className="drive-empty">Dossier vide</div>
                    )}
                </div>
            )}
        </div>
    );
};

export default function DriveViewer({ onClose }) {
    const [tree, setTree] = useState(null);
    const [loading, setLoading] = useState(true);
    const [syncing, setSyncing] = useState(false);

    const loadTree = async () => {
        setLoading(true);
        const res = await fetch('/api/structure/drive-tree');
        setTree(await res.json());
        setLoading(false);
    };

    const handleSync = async () => {
        if(!confirm("Lancer l'alignement ? Cela crÃ©era les dossiers et les Ã©lÃ¨ves de test manquants.")) return;
        setSyncing(true);
        try {
            const res = await fetch('/api/structure/sync-root', { method: 'POST' });
            if (res.ok) {
                alert("ALIGNEMENT V58 RÃ‰USSI : Tous les Ã©lÃ¨ves test sont provisionnÃ©s !");
                await loadTree();
            }
        } catch (e) { alert("Erreur synchro"); }
        setSyncing(false);
    };

    const handleDelete = async (id, name) => {
        if (!confirm(`Supprimer ${name} ?`)) return;
        await fetch(`/api/structure/drive/${id}`, { method: 'DELETE' });
        loadTree();
    };

    useEffect(() => { loadTree(); }, []);

    return (
        <div className="drive-viewer-overlay" onClick={onClose}>
            <div className="drive-viewer-window" onClick={e => e.stopPropagation()}>
                <div className="drive-viewer-header">
                    <div>
                        <h2 className="text-xl font-black text-white uppercase tracking-tighter">Mouchard V58</h2>
                        <p className="text-[9px] font-black text-emerald-400 tracking-widest uppercase">CONDA PROJECT : Provisionnement Auto</p>
                    </div>
                    <div className="flex gap-3">
                        <button onClick={handleSync} disabled={syncing} className="v14-sync-btn">
                            {syncing ? 'RÃ‰PARATION...' : 'ğŸ”„ ALIGNER & RÃ‰PARER TESTERS'}
                        </button>
                        <button onClick={onClose} className="v14-close-btn">âœ•</button>
                    </div>
                </div>
                <div className="drive-viewer-body custom-scrollbar">
                    {loading ? <div className="v14-loader"><div className="spinner"></div><span>SCAN DU DRIVE...</span></div> : tree && <DriveNode node={tree} onDelete={handleDelete} />}
                </div>
                <div className="p-4 bg-slate-50 text-[9px] text-slate-400 font-bold uppercase text-center border-t">
                    Note : Cliquez sur SYNCHRO pour crÃ©er les Ã©lÃ¨ves test manquants des anciennes classes.
                </div>
            </div>
        </div>
    );
}
[[[Â£ END: client/src/features/prof/components/DriveViewer.jsx Â£]]]

[[[Â£ FILE: client/src/features/prof/components/ProfHeader.jsx Â£]]]
import React, { useState, useEffect } from 'react';
import DatabaseViewer from './DatabaseViewer';
import DriveViewer from './DriveViewer';

export default function ProfHeader({ user, onLogout }) {
  const [showDB, setShowDB] = useState(false);
  const [showDrive, setShowDrive] = useState(false);
  const [drive, setDrive] = useState({ loading: true, ok: false, email: '' });

  const checkDrive = async () => {
    try {
      const res = await fetch('/api/admin/drive-check');
      const data = await res.json();
      setDrive({ loading: false, ok: data.ok, email: data.email });
    } catch (e) { setDrive({ loading: false, ok: false }); }
  };

  useEffect(() => { checkDrive(); }, []);

  return (
    <>
        {/* --- VERSION BUREAU (Classe 'desktop-only-header' gÃ©rÃ©e par CSS strict) --- */}
        <div className="desktop-only-header p-8 pb-4 justify-between items-center bg-white border-b hidden md:flex">
          <div className="text-left">
            <h2 className="text-2xl font-black text-slate-800 uppercase">{user.firstName} {user.lastName}</h2>
            <div className="flex items-center gap-2 mt-1">
              <div className={`w-3 h-3 rounded-full ${drive.ok ? 'bg-emerald-500' : 'bg-red-500'}`}></div>
              <span className="text-[10px] font-black uppercase text-slate-400">
                {drive.ok ? `PRO : ${drive.email}` : 'Drive DÃ©connectÃ©'}
              </span>
            </div>
          </div>
          <div className="flex gap-3">
            <button onClick={() => setShowDrive(true)} className="bg-cyan-600 text-white px-4 py-2 rounded-2xl font-black text-[10px] uppercase shadow-lg hover:scale-105 transition-transform">â˜ï¸ DRIVE</button>
            <button onClick={() => setShowDB(true)} className="bg-slate-900 text-white px-4 py-2 rounded-2xl font-black text-[10px] uppercase hover:scale-105 transition-transform">ğŸ“Š BDD</button>
            <button onClick={onLogout} className="bg-white text-slate-300 px-4 py-2 rounded-2xl font-bold border text-[10px] hover:text-red-500">âœ•</button>
          </div>
        </div>

        {/* --- VERSION MOBILE (Classe 'mobile-only-header') --- */}
        <div className="mobile-only-header items-center justify-between p-3 bg-white border-b shadow-sm sticky top-0 z-50 md:hidden flex">
            {/* GAUCHE : IDENTITÃ‰ */}
            <div className="flex items-center gap-2 overflow-hidden">
                <div className={`w-2 h-2 shrink-0 rounded-full ${drive.ok ? 'bg-emerald-500' : 'bg-red-500'}`}></div>
                <span className="font-black text-slate-800 text-xs uppercase truncate">
                    {user.firstName} {user.lastName}
                </span>
            </div>

            {/* DROITE : ACTIONS COMPACTES */}
            <div className="flex items-center gap-2 shrink-0">
                <button onClick={() => setShowDrive(true)} className="bg-cyan-600 text-white px-2 py-1 rounded-lg font-black text-[8px] uppercase">â˜ï¸ DRIVE</button>
                <button onClick={() => setShowDB(true)} className="bg-slate-900 text-white px-2 py-1 rounded-lg font-black text-[8px] uppercase">ğŸ“Š BDD</button>
                <button onClick={onLogout} className="w-6 h-6 flex items-center justify-center bg-slate-100 text-slate-400 rounded-full font-bold text-xs ml-1 border border-slate-200">âœ•</button>
            </div>
        </div>
      
        {/* MODALES */}
        {showDB && <DatabaseViewer onClose={() => setShowDB(false)} />}
        {showDrive && <DriveViewer onClose={() => setShowDrive(false)} />}
    </>
  );
}
[[[Â£ END: client/src/features/prof/components/ProfHeader.jsx Â£]]]

[[[Â£ FILE: client/src/features/prof/components/ProfNav.jsx Â£]]]
import React from 'react';

export default function ProfNav({ activeTab, onTabChange, user }) {
  
  const allTabs = {
      activities: { id: 'activities', label: 'âš¡ ACTIVITÃ‰S', color: 'bg-purple-600' },
      classroom: { id: 'classroom', label: 'ğŸ“ CLASSE', color: 'bg-emerald-600' },
      scans: { id: 'scans', label: 'ğŸ“¸ SCAN', color: 'bg-orange-500' },
      studio: { id: 'studio', label: 'ğŸ¬ STUDIO', color: 'bg-pink-600', hideOnMobile: true }, 
      students: { id: 'students', label: 'ğŸ‘¥ Ã‰LÃˆVES', color: 'bg-blue-600', hideOnMobile: true },
      admin: { id: 'admin', label: 'âš™ï¸ DEV', color: 'bg-slate-900' }
  };

  let tabs = [];

  if (user.isDeveloper) {
      tabs = [allTabs.activities, allTabs.classroom, allTabs.scans, allTabs.studio, allTabs.students, allTabs.admin];
  } else if (user.role === 'admin') {
      tabs = [ { id: 'admin', label: 'ğŸ›¡ï¸ ADMIN', color: 'bg-slate-800' } ];
  } else {
      tabs = [allTabs.activities, allTabs.classroom, allTabs.scans, allTabs.studio, allTabs.students];
  }

  return (
    /* MODIF : Padding rÃ©duit sur mobile (p-2) et plus grand sur PC (md:p-6) */
    <div className="flex gap-2 md:gap-4 p-2 md:p-6 bg-white border-b overflow-x-auto no-scrollbar justify-between md:justify-start sticky top-0 z-30">
      {tabs.map(t => (
        <button 
            key={t.id} 
            onClick={() => onTabChange(t.id)} 
            className={`
                /* MODIF : Flex-1 pour Ã©quilibrer sur mobile, min-width rÃ©duit */
                flex-1 md:flex-none min-w-[30%] md:min-w-[120px] 
                py-3 md:py-4 rounded-xl md:rounded-2xl 
                font-black text-[10px] md:text-xs transition-all 
                ${activeTab === t.id ? t.color + ' text-white shadow-md scale-100' : 'bg-slate-50 text-slate-400 hover:bg-slate-100'}
                ${t.hideOnMobile ? 'hidden md:block' : ''} 
            `}
        >
            {t.label}
        </button>
      ))}
    </div>
  );
}
[[[Â£ END: client/src/features/prof/components/ProfNav.jsx Â£]]]

[[[Â£ FILE: client/src/features/prof/components/ProfStudioFolder.jsx Â£]]]
import React, { useState, useEffect } from 'react';

export default function ProfStudioFolder({ items, chapters, classFilter, levelFilter, user, onEditItem, onDeleteItem, onCreateActivity, onRefresh }) {
    const [customSections, setCustomSections] = useState([]);
    const [activeSection, setActiveSection] = useState("GÃ‰NÃ‰RAL"); 
    const [openChaps, setOpenChaps] = useState({}); 
    const [showArchived, setShowArchived] = useState(false); 
    const [loading, setLoading] = useState(true);
    
    const [showSectionModal, setShowSectionModal] = useState(false);
    const [newSectionName, setNewSectionName] = useState("");
    const [deletingSection, setDeletingSection] = useState(false);

    const getUserId = () => { if (!user) return null; return user.id || user._id; };

    const fetchSections = async () => {
        const uid = getUserId();
        if (!uid) { setLoading(false); return; }
        
        const classParam = classFilter ? `&classContext=${encodeURIComponent(classFilter)}` : '';

        try {
            const res = await fetch(`/api/structure/sections/${uid}?_t=${Date.now()}${classParam}`);
            if (res.ok) {
                const data = await res.json();
                
                let applicableSections = [];
                if (Array.isArray(data)) {
                    applicableSections = data.filter(s => {
                        if (s.name === "GÃ‰NÃ‰RAL") return false; 
                        if (s.scope === 'LEVEL' && levelFilter && String(s.target).toUpperCase() !== String(levelFilter).toUpperCase()) return false;
                        if (s.scope === 'CLASS' && classFilter && String(s.target).toUpperCase() !== String(classFilter).toUpperCase()) return false;
                        return true;
                    });
                }

                setCustomSections(applicableSections);

                setActiveSection(prev => {
                    const stillExists = applicableSections.some(s => s.name === prev);
                    if (stillExists) return prev;
                    if (applicableSections.length > 0) return applicableSections[0].name;
                    return "GÃ‰NÃ‰RAL";
                });
            }
        } catch(e) { /* Silence */ }
        setLoading(false);
    };

    useEffect(() => { fetchSections(); }, [user, classFilter, onRefresh]); 

    // Helpers
    const uid = String(getUserId());
    const isJean = (user && user.firstName === 'Jean' && user.lastName === 'Vuillet');
    const myChapters = isJean ? (chapters||[]) : (chapters||[]).filter(c => String(c.teacherId) === uid);
    
    const contextChapters = myChapters.filter(c => {
        const cClass = (c.classroom || "").toUpperCase().trim();
        const fClass = (classFilter || "").toUpperCase().trim();
        const cLevel = c.sharedLevel ? String(c.sharedLevel).toUpperCase() : null;
        const fLevel = levelFilter ? String(levelFilter).toUpperCase() : null;

        if (cClass === "") return true; 
        if (cClass === fClass) return true;
        if (cLevel && fLevel && cLevel === fLevel) return true;
        if (!classFilter) return true;

        return false;
    });

    const chaptersInActiveSection = contextChapters.filter(c => {
        const sectionName = (c.section || "GÃ‰NÃ‰RAL").toUpperCase().trim();
        const currentActive = (activeSection || "GÃ‰NÃ‰RAL").toUpperCase().trim();
        const isCorrectStatus = !!c.isArchived === showArchived;
        return sectionName === currentActive && isCorrectStatus;
    });

    // --- ACTIONS ---
    const confirmCreateSection = async (scope) => { 
        if (!newSectionName) return; 
        let target = null; 
        if (scope === 'LEVEL') target = levelFilter; 
        if (scope === 'CLASS') target = classFilter; 
        try { 
            const res = await fetch('/api/structure/sections', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ teacherId: getUserId(), sectionName: newSectionName.toUpperCase().trim(), scope, target }) }); 
            if (res.status === 409) { const err = await res.json(); return alert("âš ï¸ " + err.error); } 
            if (res.ok) { 
                setActiveSection(newSectionName.toUpperCase().trim()); 
                setShowSectionModal(false); 
                setNewSectionName(""); 
                if(onRefresh) onRefresh(); 
                fetchSections();
            } 
        } catch (e) { alert("Erreur rÃ©seau."); } 
    };

    const handleDeleteSection = async (sectionName) => { 
        if(deletingSection) return;
        if(!confirm(`Supprimer la section "${sectionName}" ?\nâš ï¸ Le contenu sera dÃ©placÃ© dans le dossier GÃ‰NÃ‰RAL.`)) return; 
        setDeletingSection(true);
        try { 
            const res = await fetch('/api/structure/sections', { method: 'DELETE', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ teacherId: getUserId(), sectionName }) }); 
            if (res.ok) { 
                setActiveSection("GÃ‰NÃ‰RAL");
                if(onRefresh) onRefresh(); 
            } 
        } catch(e) { alert("Erreur rÃ©seau."); } 
        setDeletingSection(false);
    };

    const handleCreateChapter = async () => { 
        if (!classFilter) return alert("âš ï¸ SÃ©lectionnez une classe."); 
        const title = prompt(`Nouveau dossier dans ${activeSection === "GÃ‰NÃ‰RAL" ? "l'Espace GÃ©nÃ©ral" : activeSection} ?`); 
        if (!title) return; 
        let isShared = false; 
        if (levelFilter) isShared = confirm(`Partager ce dossier avec tout le niveau ${levelFilter} ?`); 
        await fetch('/api/structure/chapters', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ title: title.toUpperCase(), section: activeSection, classroom: classFilter.toUpperCase(), teacherId: getUserId(), sharedLevel: isShared ? levelFilter : null }) }); 
        if(onRefresh) onRefresh(); 
    };

    const handleRenameChapter = async (chapId, currentTitle) => {
        if (currentTitle === "GÃ‰NÃ‰RAL") return alert("Le dossier systÃ¨me ne peut pas Ãªtre renommÃ©.");
        const newTitle = prompt("Nouveau nom du dossier :", currentTitle);
        if (!newTitle || newTitle === currentTitle) return;
        try {
            const res = await fetch(`/api/structure/chapters/${chapId}`, { method: 'PATCH', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ title: newTitle.toUpperCase().trim() }) });
            if(res.ok && onRefresh) onRefresh();
        } catch(e) { alert("Erreur renommage"); }
    };

    const isItemVisibleForClass = (item) => { 
        if (!classFilter) return true; 
        if (item.actType === 'scan') return true; 
        const targets = item.targetClassrooms || (item.classroom ? [item.classroom] : []); 
        if (item.actType === 'game' && targets.length === 0) return true; 
        if (targets.some(t => t.toUpperCase() === classFilter.toUpperCase())) return true; 
        return false; 
    };

    const handleDeleteItemWrapper = (id, type) => {
        if (type === 'chapter') { if(!confirm(`Supprimer ce dossier ?\nâš ï¸ Son contenu sera dÃ©placÃ© dans le dossier GÃ‰NÃ‰RAL.`)) return; }
        onDeleteItem(id, type);
    };

    const activeColorInfo = customSections.find(s => s.name === activeSection);
    const activeColor = activeColorInfo ? activeColorInfo.color : '#64748b'; 

    return (
        <div className="space-y-8 animate-in fade-in relative">
            {showSectionModal && (<div className="fixed inset-0 z-[9999] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4"><div className="bg-slate-900 border-2 border-slate-700 w-full max-w-lg rounded-[30px] p-8 text-center shadow-2xl"><h3 className="text-white font-black text-xl mb-6">NOUVELLE SECTION</h3><input className="bg-slate-800 text-white font-bold text-center text-xl border-b-2 border-indigo-500 outline-none p-4 w-full rounded-xl mb-8" placeholder="NOM" value={newSectionName} onChange={e => setNewSectionName(e.target.value)} autoFocus /><div className="flex flex-col gap-3"><button onClick={() => confirmCreateSection('CLASS')} className="w-full bg-emerald-600 text-white p-4 rounded-xl font-black text-xs">POUR {classFilter || 'CLASSE'}</button><button onClick={() => confirmCreateSection('LEVEL')} disabled={!levelFilter} className={`w-full bg-indigo-600 text-white p-4 rounded-xl font-black text-xs ${!levelFilter && 'opacity-50'}`}>POUR NIVEAU {levelFilter || '?'}</button><button onClick={() => confirmCreateSection('GLOBAL')} className="w-full bg-slate-700 text-white p-4 rounded-xl font-black text-xs">GLOBAL</button></div><button onClick={() => setShowSectionModal(false)} className="mt-4 text-slate-400 font-bold text-xs hover:text-white">Annuler</button></div></div>)}

            <div className={`p-8 rounded-[45px] border-4 shadow-2xl relative transition-colors duration-500 ${showArchived ? 'bg-amber-950 border-amber-900' : 'bg-slate-900 border-slate-800'}`}>
                <div className="flex justify-between items-center mb-6 relative z-10">
                    <div className="flex items-center gap-6">
                        <h3 className="text-white font-black text-[11px] uppercase tracking-[0.3em]">{showArchived ? 'ARCHIVES SECRÃˆTES' : 'CLOUD CONDAMINE'}</h3>
                        <button onClick={() => setShowArchived(!showArchived)} className={`px-5 py-2.5 rounded-2xl text-[10px] font-black border-2 transition-all ${showArchived ? 'bg-amber-500 border-amber-400 text-white shadow-[0_0_20px_rgba(245,158,11,0.5)]' : 'bg-slate-800 border-slate-700 text-slate-400'}`}>{showArchived ? 'ğŸ“‚ RETOUR ACTIFS' : `ğŸ“¦ VOIR ARCHIVES`}</button>
                    </div>
                    <div className="flex items-center gap-2">
                        {!showArchived && (<button onClick={() => setShowSectionModal(true)} className="bg-white/10 text-white px-5 py-2.5 rounded-xl font-black text-[10px] uppercase border border-white/10 hover:bg-white/20 transition-all">+ Section</button>)}
                    </div>
                </div>
                
                {customSections.length > 0 ? (
                    <div className="flex gap-4 overflow-x-auto no-scrollbar p-6 relative z-10 min-h-[140px]">
                        {customSections.map((s, idx) => {
                            const isActive = activeSection === s.name;
                            return (
                                <div key={idx} className="relative shrink-0">
                                    <button onClick={() => setActiveSection(s.name)} className={`min-w-[160px] p-5 rounded-2xl border-2 flex flex-col items-start gap-3 transition-all ${isActive ? 'bg-slate-800 border-white/20 shadow-xl scale-105' : 'bg-slate-800/40 border-slate-800 hover:bg-slate-800/60'}`}>
                                        <div className="flex justify-between w-full mb-1">
                                            <span className="font-black text-[11px] uppercase tracking-wider truncate text-left" style={{ color: s.color }}>{s.name}</span>
                                            {s.scope === 'GLOBAL' && <span className="text-[7px] bg-slate-600 text-white px-1 rounded font-bold">ALL</span>}
                                            {s.scope === 'LEVEL' && <span className="text-[7px] bg-indigo-500 text-white px-1 rounded font-bold">N{s.target}</span>}
                                            {s.scope === 'CLASS' && <span className="text-[7px] bg-emerald-500 text-white px-1 rounded font-bold">{s.target}</span>}
                                        </div>
                                        <span className="text-[9px] font-bold text-slate-500 uppercase">Dossiers...</span>
                                    </button>
                                    {!showArchived && (
                                        <div onClick={(e) => { e.stopPropagation(); handleDeleteSection(s.name); }} className="absolute -top-3 -right-2 w-8 h-8 bg-red-500 text-white rounded-full font-black text-xs flex items-center justify-center shadow-lg cursor-pointer border-2 border-slate-900 hover:bg-red-600 hover:scale-110 transition-transform" style={{ zIndex: 9999 }}>âœ•</div>
                                    )}
                                </div>
                            );
                        })}
                    </div>
                ) : (
                    <div className="p-4 relative z-10">
                        <div className="text-slate-500 font-bold text-[10px] uppercase text-center border border-dashed border-slate-700 rounded-xl p-3">
                            (Affichage DÃ©faut : Espace GÃ©nÃ©ral)
                        </div>
                    </div>
                )}
            </div>

            <div className="animate-in slide-in-from-bottom-6">
                <div className="flex flex-wrap justify-between items-end mb-10 px-6 gap-4">
                    <div>
                        <h2 className="text-2xl md:text-5xl font-black uppercase tracking-tighter break-words" style={{ color: activeColor }}>
                            {activeSection === "GÃ‰NÃ‰RAL" ? "ESPACE GÃ‰NÃ‰RAL" : activeSection}
                        </h2>
                    </div>
                    {!showArchived && (
                        <div className="flex items-center gap-3">
                            {/* BOUTONS CRÃ‰ATION CONTEXTUELS */}
                            <button onClick={() => onCreateActivity('homework', activeSection)} className="px-6 py-4 rounded-[18px] bg-orange-500 text-white text-[10px] font-black shadow-lg hover:scale-105 transition-all active:scale-95 uppercase tracking-widest">+ DEVOIR</button>
                            <button onClick={() => onCreateActivity('game', activeSection)} className="px-6 py-4 rounded-[18px] bg-purple-600 text-white text-[10px] font-black shadow-lg hover:scale-105 transition-all active:scale-95 uppercase tracking-widest">+ JEU</button>
                            <div className="w-px h-8 bg-slate-300 mx-2"></div>
                            <button onClick={handleCreateChapter} className="px-6 py-4 rounded-[18px] bg-slate-900 text-white text-[10px] font-black shadow-lg hover:scale-105 transition-all active:scale-95 uppercase tracking-widest">+ DOSSIER</button>
                        </div>
                    )}
                </div>

                <div className="grid grid-cols-1 gap-6">
                    {chaptersInActiveSection.length === 0 ? (
                        <div className="text-center p-10 border-4 border-dashed border-slate-200 rounded-[35px] text-slate-400 font-bold uppercase">
                            Aucun dossier ici.
                        </div>
                    ) : (
                        chaptersInActiveSection.map(chap => {
                            const isOpen = openChaps[chap._id];
                            const chapItems = items.filter(it => String(it.chapterId) === String(chap._id) && isItemVisibleForClass(it));
                            const isGeneralChap = chap.title.toUpperCase() === "GÃ‰NÃ‰RAL";
                            const canDelete = chaptersInActiveSection.length > 1;

                            return (
                                <div key={chap._id} className={`border-2 rounded-[35px] overflow-hidden transition-all shadow-sm ${showArchived ? 'bg-amber-50 border-amber-200' : 'bg-white border-[#f1f5f9]'}`} style={{ borderColor: isOpen ? activeColor : undefined }}>
                                    <div className={`p-8 flex justify-between items-center cursor-pointer ${showArchived ? 'bg-amber-50' : 'bg-white'}`} onClick={() => setOpenChaps({...openChaps, [chap._id]: !isOpen})}>
                                        <div className="flex items-center gap-8">
                                            <div className="w-16 h-16 rounded-2xl flex items-center justify-center text-white font-black text-2xl shadow-xl transition-transform" style={{ backgroundColor: showArchived ? '#d97706' : activeColor, transform: isOpen ? 'rotate(90deg)' : 'none' }}>{isOpen ? 'ğŸ“‚' : 'ğŸ“'}</div>
                                            <div>
                                                <h3 className="font-black text-slate-800 text-2xl uppercase tracking-tight flex items-center gap-3">
                                                    {chap.title}
                                                    {!showArchived && !isGeneralChap && (
                                                        <button 
                                                            onClick={(e) => { e.stopPropagation(); handleRenameChapter(chap._id, chap.title); }} 
                                                            className="w-6 h-6 rounded bg-slate-100 text-slate-400 text-[10px] flex items-center justify-center hover:bg-indigo-100 hover:text-indigo-600 transition-colors"
                                                            title="Renommer le dossier"
                                                        >âœ</button>
                                                    )}
                                                </h3>
                                                <div className="flex gap-2 mt-1"><span className="text-[10px] font-black bg-slate-100 text-slate-500 px-3 py-1 rounded-xl uppercase">{chapItems.length} Ã‰lÃ©ments</span>{chap.sharedLevel && <span className="text-[10px] font-black bg-purple-100 text-purple-600 px-3 py-1 rounded-xl uppercase border border-purple-200">PARTAGÃ‰ {chap.sharedLevel}</span>}</div>
                                            </div>
                                        </div>
                                        <div className="flex items-center gap-4">
                                            <button onClick={(e) => { e.stopPropagation(); fetch(`/api/structure/chapters/${chap._id}/archive`, {method:'PATCH', headers:{'Content-Type':'application/json'}, body:JSON.stringify({isArchived:!chap.isArchived})}).then(onRefresh); }} className="w-12 h-12 rounded-2xl bg-slate-50 flex items-center justify-center hover:bg-amber-100 transition-colors">{chap.isArchived ? 'ğŸ“¤' : 'ğŸ“¦'}</button>
                                            {!isGeneralChap && canDelete && (
                                                <button onClick={(e) => { e.stopPropagation(); handleDeleteItemWrapper(chap._id, 'chapter'); }} className="w-12 h-12 rounded-2xl bg-red-50 text-red-400 flex items-center justify-center hover:bg-red-500 hover:text-white transition-all shadow-inner">âœ•</button>
                                            )}
                                        </div>
                                    </div>
                                    {isOpen && (<div className="bg-slate-50/50 border-t p-8 space-y-4">{chapItems.length > 0 ? chapItems.map(it => (<div key={it._id} className="bg-white p-5 rounded-2xl flex justify-between items-center shadow-sm border border-slate-100 hover:shadow-xl transition-all"><div className="flex items-center gap-5"><span className={`text-[10px] font-black px-4 py-2 rounded-xl uppercase tracking-[0.2em] text-white ${it.actType === 'game' ? 'bg-purple-600' : 'bg-orange-500'}`}>{it.typeLabel || 'ACT'}</span><div className="flex flex-col items-start"><span className="font-black text-slate-700 uppercase">{it.title}</span></div></div><div className="flex gap-4"><button onClick={() => onEditItem(it)} className="px-6 py-2.5 rounded-xl bg-slate-900 text-white text-[10px] font-black uppercase">Modifier</button><button onClick={() => onDeleteItem(it._id, it.actType)} className="px-5 py-2.5 rounded-xl bg-red-50 text-red-500 text-[10px] font-black">âœ•</button></div></div>)) : <div className="text-center text-slate-400 text-xs italic py-4">Dossier vide.</div>}</div>)}
                                </div>
                            );
                        })
                    )}
                </div>
            </div>
        </div>
    );
}
[[[Â£ END: client/src/features/prof/components/ProfStudioFolder.jsx Â£]]]

[[[Â£ FILE: client/src/features/prof/components/ProjectTreeViewer.css Â£]]]
.tree-overlay { position: fixed; inset: 0; z-index: 11000; background: rgba(15, 23, 42, 0.95); display: flex; align-items: center; justify-content: center; padding: 2rem; }
.tree-window { background: white; width: 100%; max-width: 1200px; height: 85vh; border-radius: 40px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 40px 80px rgba(0,0,0,0.4); }
.tree-header { background: #0f172a; padding: 1.5rem 2rem; display: flex; justify-content: space-between; align-items: center; }
.tree-body { flex: 1; overflow-y: auto; padding: 2rem; background: #fff; }
.tree-children { margin-left: 20px; border-left: 1px solid #eee; padding-left: 10px; }
.tree-item { padding: 8px 12px; border-radius: 10px; margin-bottom: 2px; transition: all 0.2s; }
.tree-item:hover { background: #f8fafc; }
.tree-main-info { display: flex; align-items: center; gap: 8px; font-family: 'JetBrains Mono', monospace; font-size: 13px; }
.node-name { font-weight: 800; color: #1e293b; }
.tree-item.is-folder .node-name { color: #4f46e5; text-transform: uppercase; }
.tree-desc-row { font-size: 11px; color: #64748b; font-weight: 500; padding-left: 36px; font-style: italic; line-height: 1.3; margin-top: 3px; max-width: 80%; }
.size-badge { font-size: 8px; color: #94a3b8; background: #f1f5f9; padding: 1px 4px; border-radius: 4px; }
.dirty-dot { color: #f97316; font-size: 16px; margin-left: 5px; }
.pulse { animation: dirty-pulse 1.5s infinite; }
@keyframes dirty-pulse { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }

.btn-tree { padding: 8px 16px; border-radius: 10px; font-weight: 900; font-size: 10px; border: none; cursor: pointer; transition: all 0.2s; text-transform: uppercase; }
.btn-tree.primary { background: #f97316; color: white; box-shadow: 0 4px 15px rgba(249, 115, 22, 0.4); }
.btn-tree.secondary { background: #334155; color: #94a3b8; }
.btn-tree:hover { transform: translateY(-2px); filter: brightness(1.1); }
[[[Â£ END: client/src/features/prof/components/ProjectTreeViewer.css Â£]]]

[[[Â£ FILE: client/src/features/prof/components/ProjectTreeViewer.jsx Â£]]]
import React, { useState, useEffect } from 'react';
import './ProjectTreeViewer.css';

/**
 * Composant de ligne de l'arbre V1
 * Affiche le nom sur la ligne 1 et la description mÃ©tier sur la ligne 2
 */
const TreeNode = ({ node, depth = 0 }) => {
    const [isOpen, setIsOpen] = useState(depth < 2);
    const isFolder = node.type === 'folder';
    
    return (
        <div className="tree-node">
            <div className={`tree-item ${isFolder ? 'is-folder' : 'is-file'}`} onClick={() => isFolder && setIsOpen(!isOpen)}>
                <div className="tree-main-info">
                    <span className="toggle-icon">{isFolder ? (isOpen ? 'â–¼' : 'â–¶') : 'â€¢'}</span>
                    <span className="node-icon">{isFolder ? 'ğŸ“' : 'ğŸ“„'}</span>
                    <span className="node-name">{node.name}</span>
                    {!isFolder && <span className="size-badge">{node.size ? `${(node.size/1024).toFixed(1)} kb` : ''}</span>}
                    {node.isDirty && <span className="dirty-dot pulse">â—</span>}
                </div>
                {/* LIGNE 2 : DESCRIPTION FONCTIONNELLE */}
                <div className="tree-desc-row">{node.desc}</div>
            </div>
            {isFolder && isOpen && node.children && (
                <div className="tree-children">
                    {node.children.map((child, i) => <TreeNode key={i} node={child} depth={depth + 1} />)}
                </div>
            )}
        </div>
    );
};

export default function ProjectTreeViewer({ onClose }) {
    const [tree, setTree] = useState(null);
    const [loading, setLoading] = useState(true);
    const [hasDirty, setHasDirty] = useState(false);

    const loadData = async (forceIA = false, initFromTxt = false) => {
        setLoading(true);
        if (initFromTxt) await fetch('/api/admin/init-tree', { method: 'POST' });
        
        const url = `/api/admin/project-tree${forceIA ? '?refresh=true' : ''}`;
        const res = await fetch(url);
        const data = await res.json();
        setTree(data);

        const checkDirty = (n) => n.isDirty || (n.children && n.children.some(checkDirty));
        setHasDirty(checkDirty(data));
        setLoading(false);
    };

    useEffect(() => { loadData(); }, []);

    return (
        <div className="tree-overlay animate-in" onClick={onClose}>
            <div className="tree-window" onClick={e => e.stopPropagation()}>
                <div className="tree-header">
                    <div className="text-left">
                        <h2 className="text-xl font-black text-indigo-400">ARCHITECT GRAPH V1</h2>
                        <span className="text-[9px] text-slate-500 uppercase font-bold tracking-widest">Documentation structurelle Version 0</span>
                    </div>
                    <div className="flex gap-2">
                        <button onClick={() => loadData(false, true)} className="btn-tree secondary">RECHARGER TXT ğŸš€</button>
                        {hasDirty && <button onClick={() => loadData(true, false)} className="btn-tree primary pulse">MAJ DOC IA ğŸ¤–</button>}
                        <button onClick={onClose} className="w-10 h-10 flex items-center justify-center bg-slate-800 text-slate-400 rounded-full">âœ•</button>
                    </div>
                </div>
                <div className="tree-body custom-scrollbar">
                    {loading ? <div className="p-20 text-center animate-pulse text-indigo-400 font-black">SCAN DU CODE...</div> : <TreeNode node={tree} />}
                </div>
            </div>
        </div>
    );
}
[[[Â£ END: client/src/features/prof/components/ProjectTreeViewer.jsx Â£]]]

[[[Â£ FILE: client/src/features/prof/components/SystemDocs.css Â£]]]
.docs-overlay { position: fixed; inset: 0; z-index: 11000; background: rgba(15, 23, 42, 0.97); backdrop-filter: blur(15px); display: flex; align-items: center; justify-content: center; padding: 25px; }
.docs-window { background: white; width: 100%; height: 92vh; max-width: 1600px; border-radius: 40px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 50px 150px rgba(0,0,0,0.7); }
.docs-header { padding: 2rem; background: #0f172a; color: white; display: flex; justify-content: space-between; align-items: center; }
.docs-content { flex: 1; overflow-y: auto; padding: 2.5rem; display: grid; grid-template-columns: repeat(auto-fill, minmax(450px, 1fr)); gap: 2.5rem; background: #f8fafc; }

.doc-category-card { background: white; border-radius: 35px; padding: 2rem; border: 1px solid #e2e8f0; position: relative; transition: all 0.3s; }
.doc-category-card:hover { transform: translateY(-8px); box-shadow: 0 20px 40px rgba(0,0,0,0.05); }

.cat-title { font-size: 1.3rem; font-weight: 900; color: #0f172a; text-transform: uppercase; margin-bottom: 2rem; border-bottom: 5px solid #f1f5f9; padding-bottom: 1rem; }
.us-block { margin-bottom: 2.5rem; padding-left: 1.5rem; border-left: 5px solid #e2e8f0; }
.us-title { font-size: 1rem; font-weight: 900; color: #2563eb; letter-spacing: -0.5px; }

.file-list-docs { display: flex; flex-direction: column; gap: 15px; margin-top: 10px; }
.file-entry-audit { display: flex; flex-direction: column; gap: 4px; }
.file-path-audit { font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; font-weight: 900; color: #1e293b; background: #f1f5f9; padding: 4px 10px; border-radius: 8px; border: 1px solid #e2e8f0; width: fit-content; }
.file-desc-audit { font-size: 0.8rem; color: #64748b; font-weight: 600; line-height: 1.5; padding-left: 5px; }

.risk-badge { font-size: 0.6rem; font-weight: 950; padding: 3px 10px; border-radius: 6px; color: white; text-transform: uppercase; }
.risk-low { background: #10b981; }
.risk-medium { background: #f59e0b; }
.risk-high { background: #ef4444; }
.risk-managed { background: #6366f1; box-shadow: 0 0 10px rgba(99, 102, 241, 0.4); }
.risk-critical { background: #000; box-shadow: 0 0 20px #ef4444; }

.cat-auth { border-top: 12px solid #3b82f6; }
.cat-games { border-top: 12px solid #a855f7; }
.cat-homework { border-top: 12px solid #f97316; }
.cat-scans { border-top: 12px solid #10b981; }
.cat-archiving { border-top: 12px solid #6366f1; }
.cat-admin { border-top: 12px solid #475569; }

.btn-close-docs { background: rgba(255,255,255,0.1); color: white; width: 50px; height: 50px; border-radius: 50%; border: none; cursor: pointer; font-size: 1.5rem; transition: all 0.3s; }
.btn-close-docs:hover { background: #ef4444; transform: rotate(90deg); }
[[[Â£ END: client/src/features/prof/components/SystemDocs.css Â£]]]

[[[Â£ FILE: client/src/features/prof/components/SystemDocs.jsx Â£]]]
import React from 'react';
import './SystemDocs.css';

const DOC_MAP = [
    {
        id: 'auth', title: 'ğŸ” Authentification', class: 'cat-auth',
        stories: [
            { id: 'US#1', title: 'AccÃ¨s Hybride', files: [{ path: 'server/features/auth/auth.routes.js', desc: 'OAuth2.' }], risk: 'LOW' },
            { id: 'US#2', title: 'Isolation RÃ´les', files: [{ path: 'client/src/App.jsx', desc: 'Routeur racine.' }], risk: 'MANAGED' }
        ]
    },
    {
        id: 'games', title: 'ğŸ•¹ï¸ Jeux', class: 'cat-games',
        stories: [
            { id: 'US#10', title: 'Quiz IA', files: [{ path: 'server/services/ai.service.js', desc: 'Moteur Gemini.' }], risk: 'MANAGED' },
            { id: 'US#11', title: 'Erreurs', files: [{ path: 'server/services/mistake.service.js', desc: 'Archivage fautes.' }], risk: 'LOW' }
        ]
    },
    {
        id: 'homework', title: 'ğŸ“š Devoirs', class: 'cat-homework',
        stories: [
            { id: 'US#3', title: 'Analyse IA', files: [{ path: 'server/services/homework.service.js', desc: 'Correction IA.' }], risk: 'MANAGED' }
        ]
    },
    {
        id: 'scans', title: 'ğŸ“¤ Scanne', class: 'cat-scans',
        stories: [
            { id: 'US#6', title: 'PilotSnap', files: [{ path: 'server/services/scan.service.js', desc: 'Sessions scan.' }], risk: 'MANAGED' }
        ]
    },
    {
        id: 'archiving', title: 'ğŸ“‚ Archivage & Drive', class: 'cat-archiving',
        stories: [
            { id: 'US#4', title: 'HiÃ©rarchie Drive', files: [{ path: 'server/services/structure.service.js', desc: 'Architecte.' }, { path: 'server/services/drive.service.js', desc: 'API Drive.' }], risk: 'MANAGED' }
        ]
    },
    {
        id: 'admin', title: 'âš™ï¸ Administration', class: 'cat-admin',
        stories: [
            { id: 'US#15', title: 'Gestion de Classe', files: [{ path: 'server/services/admin.service.js', desc: 'Maintenance.' }], risk: 'MANAGED' }
        ]
    }
];

export default function SystemDocs({ onClose }) {
    return (
        <div className="docs-overlay animate-in" onClick={onClose}>
            <div className="docs-window" onClick={e => e.stopPropagation()}>
                <div className="docs-header">
                    <div>
                        <h2 className="text-2xl font-black uppercase tracking-tighter">Carte du SystÃ¨me (Build #133)</h2>
                        <p className="text-xs text-slate-400 font-bold">Mode Hybride ActivÃ© (Brain Gmail + Drive Pro)</p>
                    </div>
                    <button className="btn-close-docs" onClick={onClose}>âœ•</button>
                </div>
                <div className="docs-content custom-scrollbar">
                    {DOC_MAP.map(cat => (
                        <div key={cat.id} className={`doc-category-card ${cat.class}`}>
                            <h3 className="cat-title">{cat.title}</h3>
                            {cat.stories.map(us => (
                                <div key={us.id} className="us-block">
                                    <div className="flex justify-between items-start mb-2">
                                        <span className="us-title">{us.id} : {us.title}</span>
                                        <span className={`risk-badge risk-${us.risk.toLowerCase()}`}>{us.risk}</span>
                                    </div>
                                    <div className="file-list-docs">
                                        {us.files.map((f, idx) => (
                                            <div key={idx} className="file-entry-audit">
                                                <span className="file-path-audit">{f.path}</span>
                                                <p className="file-desc-audit">{f.desc}</p>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            ))}
                        </div>
                    ))}
                </div>
            </div>
        </div>
    );
}
[[[Â£ END: client/src/features/prof/components/SystemDocs.jsx Â£]]]

[[[Â£ FILE: client/src/features/prof/games/GameStudio.css Â£]]]
.v84-game-container {
    position: fixed; inset: 0; background: #f8fafc; z-index: 9500;
    display: flex; flex-direction: column; font-family: 'Inter', sans-serif;
}

/* HEADER STYLE JEU (Violet) */
.v84-game-header {
    height: 90px; background: white; border-bottom: 2px solid #f1f5f9;
    display: flex; align-items: center; padding: 0 40px; justify-content: space-between;
}
.v84-game-icon { font-size: 2rem; background: #9333ea; color: white; padding: 10px; border-radius: 18px; box-shadow: 0 8px 15px rgba(147, 51, 234, 0.3); }
.v84-game-title-input { border: none; font-size: 1.8rem; font-weight: 950; color: #0f172a; outline: none; width: 100%; text-transform: uppercase; margin-left: 20px; }

/* LAYOUT */
.v84-game-body { flex: 1; display: flex; overflow: hidden; }

/* QUESTIONS LIST (LEFT) */
.v84-q-list-sidebar {
    width: 280px; background: white; padding: 20px; display: flex; flex-direction: column; border-right: 2px solid #f1f5f9;
}
.v84-q-item {
    padding: 15px; background: #f8fafc; border-radius: 16px; border: 2px solid transparent; 
    cursor: pointer; transition: all 0.2s; margin-bottom: 8px;
}
.v84-q-item.active { background: #f3e8ff; border-color: #a855f7; box-shadow: 0 4px 12px rgba(168, 85, 247, 0.15); }
.v84-q-preview { font-weight: 800; font-size: 11px; color: #475569; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.v84-q-sub { font-size: 9px; color: #94a3b8; font-weight: 700; margin-top: 4px; }

.v84-add-q-btn { margin-top: 10px; padding: 15px; border: 2px dashed #e2e8f0; border-radius: 20px; color: #94a3b8; font-weight: 900; font-size: 10px; cursor: pointer; background: none; transition: all 0.2s; }
.v84-add-q-btn:hover { border-color: #a855f7; color: #a855f7; background: #f3e8ff; }

/* EDITOR (CENTER) */
.v84-game-editor { flex: 1; padding: 40px; overflow-y: auto; display: flex; flex-direction: column; gap: 20px; background: #f8fafc; }

.v84-q-card { background: white; border-radius: 30px; padding: 30px; border: 1px solid #e2e8f0; box-shadow: 0 10px 30px -10px rgba(0,0,0,0.05); }
.v84-field-label { font-size: 10px; font-weight: 950; color: #94a3b8; text-transform: uppercase; margin-bottom: 10px; display: block; letter-spacing: 0.05em; }

.v84-q-input { 
    width: 100%; padding: 20px; border-radius: 20px; background: #f8fafc; border: 2px solid #f1f5f9;
    font-size: 1.1rem; font-weight: 700; color: #1e293b; outline: none; transition: border-color 0.2s;
}
.v84-q-input:focus { border-color: #a855f7; background: white; }

.v84-answers-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 10px; }
.v84-ans-row { display: flex; align-items: center; gap: 10px; background: #f8fafc; padding: 5px 15px 5px 5px; border-radius: 18px; border: 2px solid transparent; transition: all 0.2s; }
.v84-ans-row.correct { background: #dcfce7; border-color: #22c55e; }

.v84-correct-radio {
    width: 40px; height: 40px; border-radius: 14px; background: white; border: 2px solid #cbd5e1;
    display: flex; align-items: center; justify-content: center; cursor: pointer; font-weight: 900; color: #cbd5e1; font-size: 14px;
}
.v84-ans-row.correct .v84-correct-radio { background: #22c55e; border-color: #22c55e; color: white; }
.v84-ans-input { flex: 1; background: transparent; border: none; padding: 10px; font-weight: 700; font-size: 0.9rem; outline: none; }

/* AI WIDGET */
.v84-ai-widget { background: #7e22ce; color: white; padding: 20px; border-radius: 25px; margin-bottom: 20px; display: flex; gap: 15px; align-items: center; box-shadow: 0 10px 25px rgba(126, 34, 206, 0.3); }
.v84-ai-input { flex: 1; background: rgba(255,255,255,0.2); border: none; padding: 12px 20px; border-radius: 15px; color: white; font-weight: 700; placeholder-color: rgba(255,255,255,0.5); outline: none; }
.v84-ai-btn { background: white; color: #7e22ce; border: none; padding: 12px 25px; border-radius: 15px; font-weight: 950; font-size: 10px; cursor: pointer; text-transform: uppercase; }

/* RIGHT SIDEBAR (DISTRIBUTION - Identique Homework mais ajustÃ© couleurs) */
.v84-dist-sidebar { width: 350px; background: white; border-left: 2px solid #f1f5f9; padding: 30px; display: flex; flex-direction: column; }
.v84-tab-btn-game { padding: 8px 16px; border-radius: 12px; font-size: 10px; font-weight: 900; transition: all 0.2s; border: 1px solid transparent; }
.v84-tab-btn-game.active { background: #9333ea; color: white; shadow: 0 4px 10px rgba(147, 51, 234, 0.3); }
.v84-tab-btn-game.inactive { background: #f1f5f9; color: #94a3b8; }

.v84-game-publish-btn { width: 100%; padding: 20px; background: #9333ea; color: white; font-weight: 950; border-radius: 20px; border: none; margin-top: 20px; font-size: 12px; text-transform: uppercase; cursor: pointer; box-shadow: 0 10px 30px rgba(147, 51, 234, 0.3); transition: transform 0.1s; }
.v84-game-publish-btn:hover { transform: translateY(-2px); }
[[[Â£ END: client/src/features/prof/games/GameStudio.css Â£]]]

[[[Â£ FILE: client/src/features/prof/games/GameStudio.jsx Â£]]]
import React, { useState, useEffect } from 'react';
import './GameStudio.css';

export default function GameStudio({ initialData, chapters, classFilter, user, targetSection, onClose }) {

    const [formData, setFormData] = useState(initialData || { 
        title: '', 
        questions: [{ q: "", options: ["", "", "", ""], a: 0 }],
        targetClassrooms: classFilter ? [classFilter] : [],
        assignedStudents: [], 
        isAllClass: true 
    });

    const [activeQIdx, setActiveQIdx] = useState(0);
    const [allStudents, setAllStudents] = useState([]);
    const [allClasses, setAllClasses] = useState([]);
    const [distribution, setDistribution] = useState({});
    const [viewingClass, setViewingClass] = useState(classFilter || "");
    const [isPublishing, setIsPublishing] = useState(false);
    const [aiPrompt, setAiPrompt] = useState("");
    const [aiLoading, setAiLoading] = useState(false);

    // V445 : FILTRAGE STRICT PAR SECTION
    const getChaptersForClass = (clsName) => {
        const targetLvl = allClasses.find(c => c.name === clsName)?.level;
        return chapters.filter(c => {
            if (c.isArchived) return false;
            if (String(c.teacherId) !== String(user.id || user._id)) return false;
            
            // FILTRE SECTION
            if (targetSection && c.section !== targetSection) return false;

            if (c.classroom === clsName) return true;
            if (c.sharedLevel && targetLvl && String(c.sharedLevel) === String(targetLvl)) return true;
            if (c.classroom === "" && c.section === "GÃ‰NÃ‰RAL") return true;
            return false;
        }).sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
    };

    const findDefaultChapterId = (clsName) => {
        const available = getChaptersForClass(clsName);
        const ch1 = available.find(c => c.title === "CH1");
        if (ch1) return ch1._id;
        if (available.length > 0) return available[0]._id;
        return "";
    };

    useEffect(() => {
        const fetchData = async () => {
            try {
                const [sts, cls] = await Promise.all([
                    fetch('/api/admin/students').then(r => r.json()),
                    fetch('/api/admin/classrooms').then(r => r.json())
                ]);
                setAllStudents(sts);
                setAllClasses(cls);

                if (initialData) {
                    const targets = initialData.targetClassrooms || [initialData.classroom];
                    const assignedIds = initialData.assignedStudents || [];
                    const isAll = initialData.isAllClass;
                    const chapId = initialData.chapterId;
                    
                    const newDist = {};
                    targets.forEach(clsName => {
                        const clsObj = cls.find(c => c.name === clsName);
                        const clsId = clsObj ? String(clsObj._id) : null;
                        let classStudentIds = [];
                        if (!isAll) {
                            classStudentIds = sts.filter(s => {
                                const isMain = (s.currentClass || "").trim().toUpperCase() === clsName.trim().toUpperCase();
                                const isOption = clsId && (s.assignedGroups || []).some(gId => String(gId) === clsId);
                                return (isMain || isOption) && assignedIds.includes(s._id);
                            }).map(s => s._id);
                        }
                        newDist[clsName] = { chapterId: chapId, studentIds: classStudentIds };
                    });
                    setDistribution(newDist);
                    if(targets.length > 0) setViewingClass(targets[0]);
                } 
                else if (classFilter) {
                    setViewingClass(classFilter);
                    const defId = findDefaultChapterId(classFilter);
                    setDistribution({ [classFilter]: { chapterId: defId, studentIds: [] } });
                }
            } catch (e) { console.error("Load Error", e); }
        };
        fetchData();
    }, []);

    // ... (Reste des fonctions inchangÃ©) ...
    const activeQ = formData.questions[activeQIdx];
    const updateQuestion = (f, v) => { const n = [...formData.questions]; n[activeQIdx] = { ...n[activeQIdx], [f]: v }; setFormData({ ...formData, questions: n }); };
    const updateOption = (i, v) => { const n = [...formData.questions]; n[activeQIdx].options[i] = v; setFormData({ ...formData, questions: n }); };
    const addQuestion = () => { setFormData(prev => ({ ...prev, questions: [...prev.questions, { q: "", options: ["", "", "", ""], a: 0 }] })); setActiveQIdx(formData.questions.length); };
    const deleteQuestion = (e, i) => { e.stopPropagation(); if(formData.questions.length<=1) return; setFormData({ ...formData, questions: formData.questions.filter((_, idx) => idx !== i) }); setActiveQIdx(0); };
    const handleAiGen = async () => { if(!aiPrompt) return; setAiLoading(true); try { const r = await fetch('/api/games/generate', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({topic:aiPrompt, count:5})}); const d = await r.json(); if(Array.isArray(d)) { setFormData(prev => ({...prev, questions: [...prev.questions, ...d]})); setActiveQIdx(formData.questions.length); setAiPrompt(""); } } catch(e){} setAiLoading(false); };
    const handleClassToggle = (clsName) => { setViewingClass(clsName); };
    
    const getStudentsForViewingClass = () => { if (!viewingClass) return []; const targetObj = allClasses.find(c => c.name.trim().toUpperCase() === viewingClass.trim().toUpperCase()); const targetId = targetObj ? String(targetObj._id) : null; return allStudents.filter(s => { const isMain = (s.currentClass || "").trim().toUpperCase() === viewingClass.trim().toUpperCase(); const isOption = targetId && (s.assignedGroups || []).some(gId => String(gId) === targetId); return isMain || isOption; }).sort((a,b) => a.lastName.localeCompare(b.lastName)); };
    const studentsInView = getStudentsForViewingClass();

    const toggleFullClass = () => { setDistribution(prev => { const next = { ...prev }; if (next[viewingClass]) delete next[viewingClass]; else { const defId = findDefaultChapterId(viewingClass); next[viewingClass] = { chapterId: defId, studentIds: [] }; } return next; }); };
    const toggleStudent = (sId) => { setDistribution(prev => { const next = { ...prev }; const cfg = next[viewingClass]; const allIds = studentsInView.map(s => s._id); if (!cfg) { const defId = findDefaultChapterId(viewingClass); next[viewingClass] = { chapterId: defId, studentIds: [sId] }; } else if (cfg.studentIds.length === 0) { const newIds = allIds.filter(id => id !== sId); next[viewingClass] = { ...cfg, studentIds: newIds }; } else { let newIds = [...cfg.studentIds]; if (newIds.includes(sId)) newIds = newIds.filter(id => id !== sId); else newIds.push(sId); if (newIds.length === 0) delete next[viewingClass]; else if (newIds.length === allIds.length) next[viewingClass] = { ...cfg, studentIds: [] }; else next[viewingClass] = { ...cfg, studentIds: newIds }; } return next; }); };
    const handleUpdateChapter = (cls, cId) => { setDistribution(prev => ({ ...prev, [cls]: { ...prev[cls], chapterId: cId } })); };

    const handleSave = async () => {
        if (!formData.title) return alert("Titre requis !");
        const targets = Object.keys(distribution);
        if (targets.length === 0) return alert("SÃ©lectionnez au moins une classe !");
        setIsPublishing(true);
        try {
            const byChap = {};
            targets.forEach(t => {
                let cid = distribution[t].chapterId;
                if (!cid) cid = "DEFAULT"; 
                if(!byChap[cid]) byChap[cid] = [];
                byChap[cid].push(t);
            });

            for (const chapId of Object.keys(byChap)) {
                const classes = byChap[chapId];
                let finalIds = [];
                let isGlobal = true;
                for (const cls of classes) {
                    const cfg = distribution[cls];
                    if (cfg.studentIds.length > 0) { isGlobal = false; finalIds.push(...cfg.studentIds); } 
                    else { const clsObj = allClasses.find(c => c.name === cls); const clsId = clsObj ? String(clsObj._id) : null; const sOfClass = allStudents.filter(s => { const isMain = (s.currentClass || "").trim().toUpperCase() === cls.trim().toUpperCase(); const isOption = clsId && (s.assignedGroups || []).some(gId => String(gId) === clsId); return isMain || isOption; }).map(s => s._id); finalIds.push(...sOfClass); }
                }
                
                let realChapterId = chapId;
                if (chapId === "DEFAULT") {
                    const firstClass = classes[0];
                    const defId = findDefaultChapterId(firstClass);
                    if (defId) realChapterId = defId;
                    else {
                        const res = await fetch('/api/structure/chapters', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ title: "CH1", classroom: firstClass, teacherId: user._id || user.id, section: targetSection || "GÃ‰NÃ‰RAL" }) });
                        const newChap = await res.json();
                        realChapterId = newChap._id;
                    }
                }

                const payload = { ...formData, chapterId: realChapterId, teacherId: user.id || user._id, targetClassrooms: classes, assignedStudents: isGlobal ? [] : finalIds, isAllClass: isGlobal };
                await fetch('/api/games', { method: 'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)});
            }
            onClose();
        } catch(e) { alert("Erreur Sauvegarde"); }
        setIsPublishing(false);
    };

    const detectLevel = () => { const r=viewingClass||classFilter||(initialData?.targetClassrooms?initialData.targetClassrooms[0]:null); if(!r)return null; const o=allClasses.find(c=>c.name===r); if(o&&o.level)return o.level; const m=r.match(/^(\d+|TERM|CP|CE1|CE2|CM1|CM2)/); return m?m[0]:null; };
    const targetLevel = detectLevel();
    const myClassesIds = (user.assignedClasses || []).map(c => String(c._id || c));
    const availableClasses = allClasses.filter(c => { if (targetLevel && String(c.level) !== String(targetLevel)) return false; if (user.isDeveloper || user.role === 'admin') return true; return myClassesIds.includes(String(c._id)); }).sort((a,b) => a.name.localeCompare(b.name));
    const distCfg = distribution[viewingClass];
    const isSel = !!distCfg;
    const isPartial = isSel && distCfg.studentIds.length > 0;
    const activeColorClass = isPartial ? 'bg-pink-500 border-pink-500' : 'bg-purple-600 border-purple-600';

    return (
        <div className="v84-game-container animate-in fade-in">
            <div className="v84-game-header">
                <div className="flex items-center flex-1">
                    <div className="v84-game-icon">ğŸ®</div>
                    <input className="v84-game-title-input" placeholder="TITRE DU JEU..." value={formData.title} onChange={e => setFormData({...formData, title: e.target.value})} />
                </div>
                <button onClick={onClose} className="text-3xl text-slate-300 hover:text-red-500 transition-colors">âœ•</button>
            </div>

            <div className="v84-game-body">
                <div className="v84-q-list-sidebar custom-scrollbar">
                    <h4 className="v84-field-label">QUESTIONS ({formData.questions.length})</h4>
                    {formData.questions.map((q, i) => (
                        <div key={i} className={`v84-q-item ${activeQIdx === i ? 'active' : ''}`} onClick={() => setActiveQIdx(i)}>
                            <div className="flex justify-between items-center"><span className="v84-q-preview text-xs">Q{i+1}. {q.q || '(Vide)'}</span>{formData.questions.length > 1 && <button onClick={(e) => deleteQuestion(e, i)} className="text-slate-300 hover:text-red-500 font-bold px-2">Ã—</button>}</div>
                            <div className="v84-q-sub">{q.options.filter(o => o).length}/4 options</div>
                        </div>
                    ))}
                    <button className="v84-add-q-btn" onClick={addQuestion}>+ AJOUTER QUESTION</button>
                </div>

                <div className="v84-game-editor custom-scrollbar">
                    <div className="v84-ai-widget"><span className="text-2xl">âœ¨</span><div className="flex-1"><h5 className="font-black text-xs uppercase mb-1">GÃ©nÃ©rateur Magique</h5><input className="v84-ai-input w-full" placeholder="Sujet..." value={aiPrompt} onChange={e => setAiPrompt(e.target.value)} onKeyDown={e => e.key === 'Enter' && handleAiGen()} /></div><button className="v84-ai-btn" onClick={handleAiGen} disabled={aiLoading}>{aiLoading ? '...' : 'GÃ‰NÃ‰RER'}</button></div>
                    {activeQ && (
                        <div className="v84-q-card animate-in slide-in-from-bottom-2">
                            <label className="v84-field-label">Ã‰NONCÃ‰ DE LA QUESTION {activeQIdx + 1}</label>
                            <input className="v84-q-input" placeholder="Posez votre question ici..." value={activeQ.q} onChange={e => updateQuestion('q', e.target.value)} autoFocus />
                            <div className="mt-8"><label className="v84-field-label">RÃ‰PONSES (Cochez la bonne)</label><div className="v84-answers-grid">{activeQ.options.map((opt, i) => (<div key={i} className={`v84-ans-row ${activeQ.a === i ? 'correct' : ''}`} onClick={() => updateQuestion('a', i)}><div className="v84-correct-radio">{String.fromCharCode(65 + i)}</div><input className="v84-ans-input" placeholder={`RÃ©ponse ${String.fromCharCode(65 + i)}`} value={opt} onChange={e => updateOption(i, e.target.value)} onClick={(e) => e.stopPropagation()} /></div>))}</div></div>
                        </div>
                    )}
                </div>

                <div className="v84-dist-sidebar">
                    <h4 className="v84-field-label mb-2">DISTRIBUTION (NIV {targetLevel || '?'})</h4>
                    <div className="flex flex-wrap gap-2 mb-6">
                        {availableClasses.map(c => {
                            const isTarget = !!distribution[c.name];
                            const isP = isTarget && distribution[c.name].studentIds.length > 0;
                            const isGroup = c.type === 'GROUP';
                            const badgeStyle = isGroup ? (viewingClass === c.name ? 'border-orange-500 text-orange-600' : 'text-orange-400') : '';
                            return (
                                <button key={c._id} onClick={() => handleClassToggle(c.name)} className={`v84-tab-btn-game ${viewingClass === c.name ? 'scale-110 shadow-md border-slate-800' : ''} ${isTarget ? (isP ? 'bg-pink-500 text-white' : 'bg-purple-600 text-white') : 'inactive'} ${badgeStyle}`}>
                                    {c.name}
                                </button>
                            );
                        })}
                    </div>

                    {viewingClass ? (
                        <div className="flex-1 flex flex-col bg-slate-50 rounded-2xl border border-slate-200 overflow-hidden">
                            <div className="p-4 border-b bg-white flex justify-between items-center cursor-pointer hover:bg-slate-50" onClick={toggleFullClass}>
                                <span className="font-black text-xs text-slate-700">{viewingClass}</span>
                                <div className={`w-5 h-5 rounded border-2 flex items-center justify-center ${isSel ? activeColorClass : 'border-slate-300'}`}>{isSel && <span className="text-white text-xs">âœ“</span>}</div>
                            </div>
                            
                            {isSel && (
                                <div className="p-3 bg-slate-50 border-b border-slate-100">
                                    <label className="text-[9px] font-black text-slate-400 uppercase mb-1 block">Ranger dans :</label>
                                    <select 
                                        className="w-full p-2 rounded-lg text-xs font-bold border border-slate-300 outline-none bg-white"
                                        value={distCfg.chapterId}
                                        onChange={(e) => handleUpdateChapter(viewingClass, e.target.value)}
                                    >
                                        <option value="">-- CHOISIR DOSSIER --</option>
                                        {getChaptersForClass(viewingClass).map(c => <option key={c._id} value={c._id}>{c.title}</option>)}
                                    </select>
                                </div>
                            )}

                            <div className="flex-1 overflow-y-auto p-2 custom-scrollbar">
                                {studentsInView.length > 0 ? studentsInView.map(s => {
                                    const isChecked = isSel && (distCfg.studentIds.length === 0 || distCfg.studentIds.includes(s._id));
                                    return (
                                        <div key={s._id} onClick={() => toggleStudent(s._id)} className={`flex items-center gap-3 p-2 rounded-lg cursor-pointer transition-colors ${isChecked ? (isPartial?'bg-pink-100':'bg-purple-100') : 'hover:bg-slate-100'}`}>
                                            <div className={`w-4 h-4 rounded border flex items-center justify-center ${isChecked ? activeColorClass : 'border-slate-300'}`}>{isChecked && <span className="text-white text-[9px]">âœ“</span>}</div>
                                            <span className={`text-xs font-bold ${isChecked ? 'text-slate-800' : 'text-slate-500'}`}>{s.lastName} {s.firstName}</span>
                                        </div>
                                    );
                                }) : <div className="text-center text-xs text-slate-400 p-4">Aucun Ã©lÃ¨ve trouvÃ©.</div>}
                            </div>
                        </div>
                    ) : <div className="text-center text-slate-300 font-bold mt-10 text-xs">SÃ‰LECTIONNEZ UNE CLASSE</div>}

                    <button className="v84-game-publish-btn" onClick={handleSave} disabled={isPublishing}>{isPublishing ? 'PUBLICATION...' : 'ENREGISTRER LE JEU ğŸš€'}</button>
                </div>
            </div>
        </div>
    );
}
[[[Â£ END: client/src/features/prof/games/GameStudio.jsx Â£]]]

[[[Â£ FILE: client/src/features/prof/homework/HomeworkResults.css Â£]]]
.results-overlay { position: fixed; inset: 0; background: white; z-index: 7000; padding: 2rem; }
[[[Â£ END: client/src/features/prof/homework/HomeworkResults.css Â£]]]

[[[Â£ FILE: client/src/features/prof/homework/HomeworkResults.jsx Â£]]]
import React from 'react';
export default function HomeworkResults({ onBack }) { return <div>RÃ©sultats devoirs <button onClick={onBack}>Retour</button></div>; }
[[[Â£ END: client/src/features/prof/homework/HomeworkResults.jsx Â£]]]

[[[Â£ FILE: client/src/features/prof/homework/HomeworkStudio.css Â£]]]
.v84-studio-container {
    position: fixed; inset: 0; background: #f8fafc; z-index: 9500;
    display: flex; flex-direction: column; font-family: 'Inter', sans-serif;
}

/* HEADER */
.v84-header {
    height: 90px; background: white; border-bottom: 2px solid #f1f5f9;
    display: flex; align-items: center; padding: 0 40px; justify-content: space-between;
}
.v84-header-left { flex: 1; display: flex; align-items: center; gap: 20px; }
.v84-icon { font-size: 2rem; background: #f97316; padding: 10px; border-radius: 18px; box-shadow: 0 8px 15px rgba(249, 115, 22, 0.2); }
.v84-title-input { border: none; font-size: 1.8rem; font-weight: 950; color: #0f172a; outline: none; width: 100%; text-transform: uppercase; }
.v84-version-tag { background: #6366f1; color: white; padding: 10px 20px; border-radius: 50px; font-weight: 900; font-size: 11px; letter-spacing: 1px; }
.v84-close-btn { background: none; border: none; font-size: 2.5rem; color: #cbd5e1; cursor: pointer; font-weight: 200; margin-left: 20px; }

.v84-body { flex: 1; display: flex; overflow: hidden; }

/* SIDEBARS */
.v84-sidebar-left, .v84-sidebar-right {
    width: 280px; background: white; padding: 30px; display: flex; flex-direction: column;
}
.v84-sidebar-left { border-right: 2px solid #f1f5f9; }
.v84-sidebar-right { border-left: 2px solid #f1f5f9; width: 320px; }

.v84-sidebar-label { font-size: 11px; font-weight: 950; color: #94a3b8; text-transform: uppercase; margin-bottom: 20px; display: block; letter-spacing: 0.1em; }

.v84-pages-list { flex: 1; display: flex; flex-direction: column; gap: 10px; }
.v84-page-item { padding: 15px; background: #f8fafc; border-radius: 20px; border: 2px solid transparent; cursor: pointer; transition: all 0.2s; }
.v84-page-item.active { background: #fff7ed; border-color: #f97316; box-shadow: 0 4px 12px rgba(249, 115, 22, 0.1); }
.v84-page-name { font-weight: 950; font-size: 11px; color: #475569; }
.v84-page-preview { font-size: 9px; color: #94a3b8; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-top: 4px; }
.v84-add-page-btn { margin-top: 10px; padding: 15px; border: 2px dashed #e2e8f0; border-radius: 20px; color: #94a3b8; font-weight: 900; font-size: 10px; cursor: pointer; background: none; }

.v84-chapter-box { margin-top: 20px; padding-top: 20px; border-top: 1px solid #f1f5f9; }
.v84-select { width: 100%; padding: 12px; border-radius: 15px; border: 2px solid #f1f5f9; font-weight: 800; font-size: 11px; outline: none; }

/* EDITOR */
.v84-main-editor { flex: 1; padding: 40px; overflow-y: auto; display: flex; flex-direction: column; gap: 30px; }
.v84-card { background: white; border-radius: 40px; padding: 40px; border: 1px solid #f1f5f9; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.02); }
.v84-card-label { font-size: 12px; font-weight: 950; color: #1e293b; margin-bottom: 20px; display: block; }
.v84-textarea { width: 100%; height: 120px; border: none; outline: none; resize: none; font-size: 16px; font-weight: 600; color: #334155; background: #f8fafc; padding: 20px; border-radius: 25px; }
.v84-ai-card { background: #f0f9ff; border: 1px solid #bae6fd; }
.v84-ai-textarea { background: transparent; color: #0369a1; }

.v84-upload-btn { margin-top: 20px; background: #1e293b; color: white; border: none; padding: 15px 25px; border-radius: 15px; font-weight: 900; font-size: 10px; cursor: pointer; transition: transform 0.1s; }
.v84-upload-btn:active { transform: scale(0.98); }

.v84-gallery { display: flex; flex-wrap: wrap; gap: 15px; margin-top: 20px; }
.v84-thumb { width: 110px; height: 110px; border-radius: 18px; overflow: hidden; position: relative; border: 3px solid #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.1); background: #f1f5f9; }
.v84-thumb img { width: 100%; height: 100%; object-fit: cover; cursor: pointer; }
.v84-thumb-del { position: absolute; top: 5px; right: 5px; background: #ef4444; color: white; border: none; width: 22px; height: 22px; border-radius: 50%; cursor: pointer; font-weight: 900; font-size: 10px; }

/* ASSIGNATION */
.v84-students-list { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 5px; }
.v84-student-row { padding: 12px 15px; border-radius: 12px; display: flex; align-items: center; gap: 12px; cursor: pointer; transition: all 0.1s; font-size: 12px; font-weight: 700; color: #475569; }
.v84-student-row:hover { background: #f8fafc; }
.v84-student-row.selected { background: #f0fdf4; color: #16a34a; }
.v84-check { width: 18px; height: 18px; border: 2px solid #e2e8f0; border-radius: 6px; position: relative; }
.v84-student-row.selected .v84-check { background: #22c55e; border-color: #22c55e; }
.v84-student-row.selected .v84-check::after { content: 'âœ“'; color: white; position: absolute; top: -1px; left: 3px; font-size: 12px; }

.v84-publish-btn { width: 100%; padding: 22px; border-radius: 25px; background: #f97316; color: white; border: none; font-weight: 950; font-size: 14px; cursor: pointer; box-shadow: 0 10px 25px rgba(249, 115, 22, 0.4); text-transform: uppercase; margin-top: 20px; }

/* OVERLAYS */
.v84-zoom-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 40px; }
.v84-zoom-overlay img { max-width: 100%; max-height: 100%; border-radius: 20px; border: 5px solid white; }

.v84-upload-loader { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.8); z-index: 11000; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; gap: 20px; font-weight: 900; }
.v84-spinner { width: 50px; height: 50px; border: 5px solid rgba(255,255,255,0.1); border-top-color: #f97316; border-radius: 50%; animation: v84-spin 1s linear infinite; }
@keyframes v84-spin { to { transform: rotate(360deg); } }
[[[Â£ END: client/src/features/prof/homework/HomeworkStudio.css Â£]]]

[[[Â£ FILE: client/src/features/prof/homework/HomeworkStudio.jsx Â£]]]
import React, { useState, useEffect, useRef } from 'react';
import './HomeworkStudio.css';

const SUBJECTS_LIST = ["MATHS", "FRANÃ‡AIS", "HISTOIRE-GÃ‰O", "ANGLAIS", "ESPAGNOL", "ALLEMAND", "SVT", "PHYSIQUE-CHIMIE", "TECHNOLOGIE", "ARTS PLASTIQUES", "MUSIQUE", "EPS", "LATIN", "GREC", "PHILOSOPHIE", "SES", "NSI"];

export default function HomeworkStudio({ initialData, chapters, globalClass, user, targetSection, onClose }) {
  const [formData, setFormData] = useState(initialData || { title: '', chapterId: '', subject: "GÃ©nÃ©ral", targetClassrooms: globalClass ? [globalClass] : [], levels: [{ instruction: '', instructionUrls: [], aiHints: '', attachmentUrls: [] }], assignedStudents: [], isAllClass: true, isPunishment: false });
  const [activeLevelIdx, setActiveLevelIdx] = useState(0);
  const [allStudents, setAllStudents] = useState([]);
  const [allClasses, setAllClasses] = useState([]);
  const [availableSubjects, setAvailableSubjects] = useState(SUBJECTS_LIST); 
  const [distribution, setDistribution] = useState({});
  const [viewingClass, setViewingClass] = useState(globalClass || "");
  const [isPublishing, setIsPublishing] = useState(false);
  const fileInputRef = useRef(null);
  const [uploadTarget, setUploadTarget] = useState(null);

  // V445 : FILTRAGE STRICT PAR SECTION
  const getChaptersForClass = (clsName) => {
      const targetLvl = allClasses.find(c => c.name === clsName)?.level;
      return chapters.filter(c => {
          if (c.isArchived) return false;
          if (String(c.teacherId) !== String(user.id || user._id)) return false;
          
          // FILTRE SECTION CRITIQUE
          if (targetSection && c.section !== targetSection) return false;

          if (c.classroom === clsName) return true;
          if (c.sharedLevel && targetLvl && String(c.sharedLevel) === String(targetLvl)) return true;
          if (c.classroom === "" && c.section === "GÃ‰NÃ‰RAL") return true;
          return false;
      }).sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
  };

  const findDefaultChapterId = (clsName) => {
      const available = getChaptersForClass(clsName);
      // 1. PrioritÃ© au chapitre "CH1" de cette section
      const ch1 = available.find(c => c.title === "CH1");
      if (ch1) return ch1._id;
      // 2. Sinon le plus rÃ©cent
      if (available.length > 0) return available[0]._id;
      return "";
  };

  useEffect(() => {
    const fetchData = async () => {
        try {
            const [sts, cls, subData] = await Promise.all([
                fetch('/api/admin/students').then(r => r.json()),
                fetch('/api/admin/classrooms').then(r => r.json()),
                fetch('/api/admin/subjects').then(r => r.json())
            ]);
            setAllStudents(sts);
            setAllClasses(cls);

            const mySubjectIds = user.taughtSubjects || [];
            let mySubjectsList = [];
            if (mySubjectIds.length > 0 && !user.isDeveloper && user.role !== 'admin') {
                mySubjectsList = subData.filter(s => mySubjectIds.includes(s._id)).map(s => s.name);
            } else { mySubjectsList = subData.map(s => s.name); }
            if (mySubjectsList.length > 0) {
                setAvailableSubjects(mySubjectsList.sort());
                if (!mySubjectsList.includes(formData.subject) && formData.subject !== "GÃ©nÃ©ral") {
                    setFormData(prev => ({ ...prev, subject: mySubjectsList[0] }));
                }
            }

            if (initialData) {
                const targets = initialData.targetClassrooms || [initialData.classroom];
                const newDist = {};
                targets.forEach(clsName => {
                    const clsObj = cls.find(c => c.name === clsName);
                    const clsId = clsObj ? String(clsObj._id) : null;
                    let classStudentIds = sts.filter(s => {
                        const isMain = (s.currentClass||"").trim().toUpperCase() === clsName.trim().toUpperCase();
                        const isOption = clsId && (s.assignedGroups||[]).some(gId => String(gId) === clsId);
                        return (isMain || isOption) && (initialData.assignedStudents||[]).includes(s._id);
                    }).map(s => s._id);
                    newDist[clsName] = { chapterId: initialData.chapterId, studentIds: classStudentIds };
                });
                setDistribution(newDist);
                if (targets.length > 0) setViewingClass(targets[0]);
            }
            else if (globalClass) {
                setViewingClass(globalClass);
                const defId = findDefaultChapterId(globalClass);
                setDistribution({ [globalClass]: { chapterId: defId, studentIds: [] } });
            }
        } catch(e) { console.error("Load Error", e); }
    };
    fetchData();
  }, []);

  // ... (Logique inchangÃ©e pour le reste) ...
  const detectLevel = () => { const r=viewingClass||globalClass||(initialData?.targetClassrooms?initialData.targetClassrooms[0]:null); if(!r)return null; const o=allClasses.find(c=>c.name===r); if(o&&o.level)return o.level; const m=r.match(/^(\d+|TERM|CP|CE1|CE2|CM1|CM2)/); return m?m[0]:null; };
  const targetLevel = detectLevel();
  const myClassesIds = (user.assignedClasses||[]).map(c=>String(c._id||c));
  const availableClasses = allClasses.filter(c => { if(targetLevel)if(String(c.level)!==String(targetLevel))return false; if(user.isDeveloper||user.role==='admin')return true; return myClassesIds.includes(String(c._id)); }).sort((a,b)=>{ if(a.type==='CLASS'&&b.type!=='CLASS')return -1; if(a.type!=='CLASS'&&b.type==='CLASS')return 1; return a.name.localeCompare(b.name); });
  
  const getStudentsForViewingClass = () => { if(!viewingClass)return[]; const tObj=allClasses.find(c=>c.name.trim().toUpperCase()===viewingClass.trim().toUpperCase()); const tId=tObj?String(tObj._id):null; return allStudents.filter(s=>{ const isMain=(s.currentClass||"").trim().toUpperCase()===viewingClass.trim().toUpperCase(); const isOption=tId&&(s.assignedGroups||[]).some(gId=>String(gId)===tId); return isMain||isOption; }).sort((a,b)=>a.lastName.localeCompare(b.lastName)); };
  const studentsToDisplay = getStudentsForViewingClass();

  const handleToggleStudent = (sId) => {
      setDistribution(prev => {
          const next = { ...prev };
          const cfg = next[viewingClass];
          const allIds = studentsToDisplay.map(s => s._id);
          if (!cfg) {
              const defId = findDefaultChapterId(viewingClass);
              next[viewingClass] = { chapterId: defId, studentIds: [sId] };
          } else {
              let newIds = cfg.studentIds.length === 0 ? allIds.filter(id => id !== sId) : (cfg.studentIds.includes(sId) ? cfg.studentIds.filter(id => id !== sId) : [...cfg.studentIds, sId]);
              if (newIds.length === 0) delete next[viewingClass];
              else if (newIds.length === allIds.length) next[viewingClass] = { ...cfg, studentIds: [] };
              else next[viewingClass] = { ...cfg, studentIds: newIds };
          }
          return next;
      });
  };

  const toggleFullClass = () => {
      setDistribution(prev => {
          const next = { ...prev };
          if (next[viewingClass]) delete next[viewingClass];
          else {
              const defId = findDefaultChapterId(viewingClass);
              next[viewingClass] = { chapterId: defId, studentIds: [] };
          }
          return next;
      });
  };

  const handleUpdateChapter = (cls, cId) => {
      setDistribution(prev => ({
          ...prev,
          [cls]: { ...prev[cls], chapterId: cId }
      }));
  };

  const activeLevel = formData.levels[activeLevelIdx];
  const updateLevel = (f, v) => { const n=[...formData.levels]; n[activeLevelIdx][f]=v; setFormData({...formData, levels:n}); };
  const handleFileSelect = async (e) => { const files=e.target.files; if(!files||files.length===0)return; const d=new FormData(); for(let i=0;i<files.length;i++)d.append('files', files[i]); try{const r=await fetch('/api/homework/upload', {method:'POST', body:d}); const j=await r.json(); updateLevel(uploadTarget, [...activeLevel[uploadTarget], ...j.urls]); } catch(e){} e.target.value=null; };

  const handleSave = async () => {
      const targets = Object.keys(distribution);
      if (!formData.title || targets.length === 0) return alert("âŒ Titre et Classe requis !");
      setIsPublishing(true);
      try {
          for (const cls of targets) {
              const cfg = distribution[cls];
              let realChapterId = cfg.chapterId;
              if (!realChapterId) {
                  const defId = findDefaultChapterId(cls);
                  if (defId) realChapterId = defId;
                  else {
                      // Fallback crÃ©ation CH1 si rien trouvÃ© (trÃ¨s rare)
                      const res = await fetch('/api/structure/chapters', {
                          method: 'POST', headers: {'Content-Type':'application/json'},
                          body: JSON.stringify({ title: "CH1", classroom: cls, teacherId: user.id || user._id, section: targetSection || "GÃ‰NÃ‰RAL" })
                      });
                      const newChap = await res.json();
                      realChapterId = newChap._id;
                  }
              }
              let finalIds = [];
              let isGlobal = true;
              if (cfg.studentIds.length > 0) {
                  isGlobal = false;
                  finalIds = cfg.studentIds;
              } else {
                  const clsObj = allClasses.find(c => c.name === cls);
                  const clsId = clsObj ? String(clsObj._id) : null;
                  finalIds = allStudents.filter(s => {
                      const isMain = (s.currentClass || "").trim().toUpperCase() === cls.trim().toUpperCase();
                      const isOption = clsId && (s.assignedGroups || []).some(gId => String(gId) === clsId);
                      return isMain || isOption;
                  }).map(s => s._id);
              }
              const payload = { ...formData, chapterId: realChapterId, targetClassrooms: [cls], classroom: cls, teacherId: user.id || user._id, assignedStudents: formData.isPunishment ? [] : finalIds, isAllClass: formData.isPunishment ? false : isGlobal };
              await fetch('/api/homework', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload) });
          }
          onClose();
      } catch(e) { alert("Erreur sauvegarde."); }
      setIsPublishing(false);
  };

  const isSelected = !!distribution[viewingClass];
  const containerClass = formData.isPunishment ? "v84-studio-container punishment-mode" : "v84-studio-container";
  const distCfg = distribution[viewingClass];

  return (
    <div className={containerClass}>
        <style>{`.punishment-mode { background: #fef2f2 !important; } .punishment-mode .v84-header { border-bottom-color: #fecaca; }`}</style>
        <input type="file" ref={fileInputRef} style={{ display: 'none' }} multiple accept="image/*" onChange={handleFileSelect} />
        <div className="v84-header">
            <div className="v84-header-left"><div className="v84-icon">{formData.isPunishment ? 'âš–ï¸' : 'ğŸ“'}</div><input className="v84-title-input" value={formData.title} onChange={e => setFormData({...formData, title: e.target.value})} placeholder="TITRE DU DEVOIR..." /></div>
            <div className="mr-4"><select className="p-2 rounded-xl font-bold bg-slate-100 text-slate-600 outline-none uppercase text-xs" value={formData.subject} onChange={e => setFormData({...formData, subject: e.target.value})}><option value="GÃ©nÃ©ral">MATIÃˆRE...</option>{availableSubjects.map(s => <option key={s} value={s}>{s}</option>)}</select></div>
            <button onClick={() => setFormData({...formData, isPunishment: !formData.isPunishment})} className={`px-4 py-2 rounded-full font-black text-xs mr-4 border-2 ${formData.isPunishment ? 'bg-red-600 text-white border-red-600' : 'bg-white text-slate-300 border-slate-200'}`}>{formData.isPunishment ? 'ğŸ”¥ PUNITION' : 'ğŸ›¡ï¸ DÃ‰FINIR COMME PUNITION'}</button><button onClick={onClose} className="v84-close-btn">âœ•</button>
        </div>
        <div className="v84-body">
            <div className="v84-sidebar-left"><h4 className="v84-sidebar-label">Contenu</h4><div className="v84-pages-list custom-scrollbar">{formData.levels.map((lvl, idx) => (<div key={idx} className={`v84-page-item ${activeLevelIdx === idx ? 'active' : ''}`} onClick={() => setActiveLevelIdx(idx)}><div className="v84-page-name">PAGE {idx + 1}</div></div>))}<button className="v84-add-page-btn" onClick={() => setFormData({...formData, levels: [...formData.levels, { instruction: '', instructionUrls: [], aiHints: '', attachmentUrls: [] }]})}>+ PAGE</button></div></div>
            <div className="v84-main-editor custom-scrollbar"><div className="v84-card"><label className="v84-card-label">CONSIGNE & DOCUMENTS</label><textarea className="v84-textarea" value={formData.levels[activeLevelIdx].instruction} onChange={e => { const l=[...formData.levels]; l[activeLevelIdx].instruction=e.target.value; setFormData({...formData, levels:l}); }} placeholder="Ã‰crivez la consigne..." /><div className="flex gap-2 mt-4"><button className="v84-upload-btn" onClick={() => { setUploadTarget('instructionUrls'); fileInputRef.current.click(); }}>ğŸ“‚ Ã‰NONCÃ‰S</button><button className="v84-upload-btn bg-slate-500" onClick={() => { setUploadTarget('attachmentUrls'); fileInputRef.current.click(); }}>ğŸ“ PIÃˆCES JOINTES</button></div>{activeLevel.instructionUrls.length > 0 && (<div className="mt-6"><h5 className="text-[10px] font-black text-indigo-500 uppercase mb-2">ğŸ“š Ã‰NONCÃ‰S CHARGÃ‰S</h5><div className="v84-gallery">{activeLevel.instructionUrls.map((url, i) => (<div key={i} className="v84-thumb"><img src={url} /><button className="v84-thumb-del" onClick={() => updateLevel('instructionUrls', activeLevel.instructionUrls.filter((_, idx) => idx !== i))}>âœ•</button></div>))}</div></div>)}{activeLevel.attachmentUrls.length > 0 && (<div className="mt-6"><h5 className="text-[10px] font-black text-slate-500 uppercase mb-2">ğŸ“ PIÃˆCES JOINTES CHARGÃ‰ES</h5><div className="v84-gallery">{activeLevel.attachmentUrls.map((url, i) => (<div key={i} className="v84-thumb"><img src={url} /><button className="v84-thumb-del" onClick={() => updateLevel('attachmentUrls', activeLevel.attachmentUrls.filter((_, idx) => idx !== i))}>âœ•</button></div>))}</div></div>)}</div></div>

            <div className="v84-sidebar-right" style={{width: '400px'}}>
                <h4 className="v84-sidebar-label">CIBLAGE (Niveau {targetLevel || '?'})</h4>
                <div className="mb-4 flex flex-wrap gap-2">
                    {availableClasses.length > 0 ? availableClasses.map(c => (
                        <button key={c._id} onClick={() => setViewingClass(c.name)} className={`px-3 py-1 rounded-xl text-[10px] font-black transition-all ${distribution[c.name] ? 'bg-indigo-600 text-white' : 'bg-slate-100 text-slate-400'} ${viewingClass === c.name ? 'border-2 border-slate-900 scale-105' : ''} ${c.type === 'GROUP' ? 'border-orange-200 text-orange-500' : ''}`}>{c.name}</button>
                    )) : <div className="text-xs text-slate-400 italic">Aucune classe pour ce niveau.</div>}
                </div>
                {viewingClass && (
                    <div className="flex-1 flex flex-col bg-slate-50 rounded-2xl overflow-hidden border border-slate-200 p-4">
                        <div className="flex justify-between items-center mb-4 cursor-pointer" onClick={toggleFullClass}>
                            <span className="font-black text-slate-700 uppercase">{viewingClass}</span>
                            <div className={`w-5 h-5 rounded border-2 flex items-center justify-center ${isSelected ? 'bg-indigo-600 border-indigo-600' : 'border-slate-300'}`}>{isSelected && <span className="text-white text-xs">âœ“</span>}</div>
                        </div>

                        {isSelected && (
                            <div className="p-3 bg-slate-50 border-b border-slate-100">
                                <label className="text-[9px] font-black text-slate-400 uppercase mb-1 block">Ranger dans :</label>
                                <select 
                                    className="w-full p-2 rounded-lg text-xs font-bold border border-slate-300 outline-none bg-white"
                                    value={distCfg?.chapterId || ""}
                                    onChange={(e) => handleUpdateChapter(viewingClass, e.target.value)}
                                >
                                    <option value="">-- CHOISIR DOSSIER --</option>
                                    {getChaptersForClass(viewingClass).map(c => <option key={c._id} value={c._id}>{c.title}</option>)}
                                </select>
                            </div>
                        )}

                        <div className="flex-1 overflow-y-auto custom-scrollbar">
                            {studentsToDisplay.length > 0 ? studentsToDisplay.map(s => {
                                const checked = isSelected && (distribution[viewingClass].studentIds.length === 0 || distribution[viewingClass].studentIds.includes(s._id));
                                return (
                                    <div key={s._id} onClick={() => handleToggleStudent(s._id)} className={`flex items-center gap-3 p-2 rounded cursor-pointer ${checked ? 'bg-indigo-100 text-indigo-700' : 'hover:bg-slate-100 text-slate-500'}`}>
                                        <div className={`w-4 h-4 rounded border ${checked ? 'bg-indigo-600 border-indigo-600' : 'border-slate-300'}`}></div>
                                        <span className="text-xs font-bold">{s.lastName} {s.firstName}</span>
                                    </div>
                                );
                            }) : <div className="text-center text-xs text-slate-400 italic mt-4">Aucun Ã©lÃ¨ve trouvÃ©.</div>}
                        </div>
                    </div>
                )}
                <button className="v84-publish-btn" onClick={handleSave} disabled={isPublishing}>{isPublishing ? '...' : 'PUBLIER ğŸš€'}</button>
            </div>
        </div>
    </div>
  );
}
[[[Â£ END: client/src/features/prof/homework/HomeworkStudio.jsx Â£]]]

[[[Â£ FILE: client/src/features/prof/scans/ScansStudio.css Â£]]]
/* ... (CSS global existant) ... */
.cam-wrapper { position: relative; width: 100%; max-width: 1200px; aspect-ratio: 16/9; margin: 0 auto; border-radius: 20px; overflow: hidden; border: 4px solid #334155; background: black; display: flex; align-items: center; justify-content: center; }
.cam-video { width: 100%; height: 100%; object-fit: contain; }
.scan-page { padding: 2rem; background: #f1f5f9; min-height: 100%; display: flex; flex-direction: column; gap: 2rem; }
.create-dc-btn { background: #fff; border: 3px dashed #cbd5e1; border-radius: 25px; padding: 30px; text-align: center; cursor: pointer; transition: all 0.2s; display: flex; flex-direction: column; align-items: center; gap: 10px; }
.create-dc-btn:hover { border-color: #3b82f6; background: #eff6ff; transform: translateY(-2px); }
.dc-card { background: white; border-radius: 25px; border: 1px solid #e2e8f0; box-shadow: 0 10px 30px -10px rgba(0,0,0,0.05); overflow: hidden; transition: all 0.3s; display: flex; flex-direction: column; }
.dc-header { padding: 20px 25px; background: #f8fafc; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; }
.dc-toolbar { padding: 15px 25px; display: flex; gap: 10px; flex-wrap: wrap; background: white; }
.dc-content-area { border-top: 1px solid #e2e8f0; background: #0f172a; padding: 20px; min-height: 200px; animation: slideDown 0.3s; }
.tool-btn { padding: 12px 18px; border-radius: 14px; border: none; font-weight: 900; font-size: 0.7rem; text-transform: uppercase; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: transform 0.1s, filter 0.1s; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

/* COULEURS BOUTONS */
.btn-sujet { background: #e0f2fe; color: #0369a1; } /* BLEU */
.btn-scanner { background: #dcfce7; color: #15803d; } /* VERT */
.btn-devoirs { background: #fff7ed; color: #c2410c; } /* ORANGE */
.btn-correct { background: #f3e8ff; color: #7e22ce; flex: 1; justify-content: center; } /* VIOLET */
.btn-folder { background: #f1f5f9; color: #475569; }
.btn-delete { background: #fee2e2; color: #b91c1c; width: 40px; justify-content: center; padding: 0; }

.cam-trigger { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); width: 70px; height: 70px; background: white; border: 4px solid rgba(0,0,0,0.3); border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 2rem; transition: transform 0.1s; z-index: 20; }
.snap-queue-strip { display: flex; gap: 10px; margin-top: 15px; padding-bottom: 5px; overflow-x: auto; justify-content: center; min-height: 80px; }
.queue-thumb { width: 70px; height: 70px; border-radius: 12px; object-fit: cover; border: 4px solid transparent; transition: all 0.3s; animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }

/* MODALE CORRECTION */
.correction-overlay { position: fixed; inset: 0; z-index: 30000; background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(5px); display: flex; align-items: center; justify-content: center; }
.correction-card { background: white; width: 95vw; max-width: 1400px; height: 90vh; border-radius: 25px; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 50px 100px -20px rgba(0,0,0,0.8); }
.corr-header { padding: 1.5rem; background: #1e293b; color: white; display: flex; justify-content: space-between; align-items: center; }
.corr-body { flex: 1; display: flex; overflow: hidden; }

/* MODALE CONFIG IA */
.scan-overlay { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.9); z-index: 10000; display: flex; align-items: center; justify-content: center; }
.scan-modal { background: white; width: 600px; padding: 30px; border-radius: 25px; display: flex; flex-direction: column; gap: 20px; }
.scan-instr-input { width: 100%; height: 200px; padding: 15px; border-radius: 15px; border: 2px solid #e2e8f0; font-family: monospace; font-size: 14px; line-height: 1.5; resize: none; outline: none; }
.scan-modal-actions { display: flex; gap: 10px; justify-content: flex-end; }
.btn-cancel { padding: 15px; background: #f1f5f9; border: none; border-radius: 12px; font-weight: 900; cursor: pointer; color: #64748b; }
.btn-launch { padding: 15px 30px; background: #3b82f6; border: none; border-radius: 12px; font-weight: 900; cursor: pointer; color: white; }

@keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
@keyframes popIn { from { transform: scale(0); } to { transform: scale(1); } }
[[[Â£ END: client/src/features/prof/scans/ScansStudio.css Â£]]]

[[[Â£ FILE: client/src/features/prof/scans/ScansStudio.jsx Â£]]]
import React, { useState, useEffect, useRef } from 'react';
import './ScansStudio.css';

export default function ScansStudio({ user }) {
    const [sessions, setSessions] = useState([]);
    const [chapters, setChapters] = useState([]);
    const [activePanels, setActivePanels] = useState({});
    
    // ETATS MODALE & WORKFLOW
    const [correctionModal, setCorrectionModal] = useState(null); // ID Session pour lancer correction
    const [viewingCorrection, setViewingCorrection] = useState(null); // Objet correction pour affichage rÃ©sultats
    const [instructions, setInstructions] = useState("");
    const [processing, setProcessing] = useState(false);

    const videoRef = useRef(null);
    const canvasRef = useRef(null);
    const [stream, setStream] = useState(null);
    const [snapQueue, setSnapQueue] = useState([]);
    const [selectedFolderId, setSelectedFolderId] = useState("");

    useEffect(() => { loadSessions(); loadChapters(); }, []);

    const loadSessions = async () => { try { const res = await fetch('/api/scans/sessions'); if(res.ok) setSessions(await res.json()); } catch(e) {} };
    const loadChapters = async () => { try { const res = await fetch('/api/structure/chapters'); if(res.ok) setChapters(await res.json()); } catch(e) {} };
    const relevantChapters = chapters.filter(c => String(c.teacherId) === String(user.id || user._id) && !c.isArchived).sort((a,b)=>a.title.localeCompare(b.title));

    const togglePanel = (id, type, currentChap) => {
        if (stream) { stream.getTracks().forEach(t => t.stop()); setStream(null); }
        setActivePanels(prev => ({ ...prev, [id]: prev[id] === type ? null : type }));
        if (type.startsWith('CAMERA')) setTimeout(startCamera, 100);
        if (type === 'DRIVE_SELECTION') setSelectedFolderId(currentChap || (relevantChapters[0]?._id || ""));
    };

    const startCamera = async () => {
        try {
            const s = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment', width: { ideal: 1920 }, height: { ideal: 1080 } } });
            setStream(s);
            if (videoRef.current) videoRef.current.srcObject = s;
        } catch (e) { alert("CamÃ©ra inaccessible"); }
    };

    const takeSnap = (sessionId, type) => {
        if (!videoRef.current || !canvasRef.current) return;
        const vid = videoRef.current;
        const cvs = canvasRef.current;
        cvs.width = vid.videoWidth;
        cvs.height = vid.videoHeight;
        cvs.getContext('2d').drawImage(vid, 0, 0, cvs.width, cvs.height);
        
        cvs.toBlob(async (blob) => {
            const localUrl = URL.createObjectURL(blob);
            const snapId = Date.now();
            setSnapQueue(prev => [...prev, { id: snapId, url: localUrl, status: 'uploading' }]);
            const formData = new FormData();
            formData.append('file', blob, `snap_${snapId}.jpg`);
            formData.append('sessionId', sessionId);
            // DISTINCTION CRUCIALE : SUJET ou COPIE
            formData.append('type', type === 'CAMERA_SUBJECT' ? 'SUBJECT' : 'COPY');
            try {
                await fetch('/api/scans/upload', { method: 'POST', body: formData });
                setSnapQueue(prev => prev.map(s => s.id === snapId ? { ...s, status: 'done' } : s));
                loadSessions(); 
            } catch(e) { /* Error */ }
        }, 'image/jpeg', 0.95);
    };

    const handleCreateDC = async () => {
        const title = prompt("Titre du DC ?") || `Scan ${new Date().toLocaleDateString()}`;
        await fetch('/api/scans/sessions', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ title, teacherId: user.id || user._id }) });
        loadSessions();
    };

    const handleDeleteSession = async (id) => {
        if(!confirm("Supprimer ce dossier de scan ?")) return;
        await fetch(`/api/scans/sessions/${id}`, { method: 'DELETE' });
        loadSessions();
    };

    const handleLinkDrive = async (sessionId) => {
        await fetch(`/api/scans/sessions/${sessionId}`, { method: 'PATCH', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ chapterId: selectedFolderId }) });
        alert("âœ… Dossier liÃ© !");
        loadSessions();
    };

    // --- IA CORRECTION ---
    const openCorrectionModal = (sessionId) => {
        setCorrectionModal(sessionId);
        setInstructions("Compare la copie au SUJET fourni. Note sur 20. Sois bienveillant mais prÃ©cis sur les erreurs.");
    };

    const launchCorrection = async () => {
        if(!correctionModal) return;
        setProcessing(true);
        try {
            await fetch(`/api/scans/correct/${correctionModal}`, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ instructions }) });
            await loadSessions();
            setCorrectionModal(null);
        } catch(e) { alert("Erreur IA"); }
        setProcessing(false);
    };

    // --- VISUALISATION ---
    const handleViewCopy = (session, copyUrl) => {
        // Chercher si une correction existe pour cette URL
        const correction = session.corrections?.find(c => c.originalUrl === copyUrl);
        if (correction) {
            setViewingCorrection(correction); // Ouvre la modale Split View
        } else {
            window.open(copyUrl, '_blank'); // Juste l'image
        }
    };

    return (
        <div className="scan-page">
            
            {/* MODALE RESULTAT SPLIT VIEW */}
            {viewingCorrection && (
                <div className="correction-overlay" onClick={() => setViewingCorrection(null)}>
                    <div className="correction-card !w-[90vw] !max-w-6xl !h-[90vh]" onClick={e => e.stopPropagation()}>
                        <div className="corr-header">
                            <div>
                                <h2 className="text-xl font-black uppercase text-white">{viewingCorrection.studentName}</h2>
                                <span className="text-xs font-bold text-emerald-400">NOTE : {viewingCorrection.grade}</span>
                            </div>
                            <button onClick={() => setViewingCorrection(null)} className="text-white text-2xl">âœ•</button>
                        </div>
                        <div className="corr-body flex">
                            {/* GAUCHE : IMAGE */}
                            <div className="flex-1 bg-black flex items-center justify-center p-4">
                                <img src={viewingCorrection.originalUrl} className="max-h-full max-w-full object-contain border-2 border-slate-700 rounded-lg" />
                            </div>
                            {/* DROITE : CORRECTION */}
                            <div className="flex-1 bg-white p-8 overflow-y-auto">
                                <h4 className="text-sm font-black text-slate-400 uppercase mb-2">ApprÃ©ciation Globale</h4>
                                <div className="p-4 bg-indigo-50 border border-indigo-100 rounded-xl text-indigo-900 font-medium mb-6">
                                    {viewingCorrection.appreciation}
                                </div>
                                <h4 className="text-sm font-black text-slate-400 uppercase mb-2">Analyse DÃ©taillÃ©e</h4>
                                <div className="prose prose-sm text-slate-600 whitespace-pre-wrap">
                                    {viewingCorrection.transcription}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            )}

            {/* MODALE LANCEMENT IA */}
            {correctionModal && (
                <div className="scan-overlay animate-in">
                    <div className="scan-modal">
                        <h3>ğŸ¤– CONFIGURATION CORRECTION</h3>
                        <p className="text-xs text-slate-400 mb-2">L'IA va utiliser les images "SUJET" comme rÃ©fÃ©rence.</p>
                        <textarea className="scan-instr-input" value={instructions} onChange={e => setInstructions(e.target.value)} />
                        <div className="scan-modal-actions">
                            <button onClick={() => setCorrectionModal(null)} className="btn-cancel">ANNULER</button>
                            <button onClick={launchCorrection} className="btn-launch" disabled={processing}>{processing ? 'TRAITEMENT...' : 'LANCER ğŸš€'}</button>
                        </div>
                    </div>
                </div>
            )}

            <div className="create-dc-btn" onClick={handleCreateDC}><span className="create-label">+ NOUVEAU SCAN</span></div>
            
            {sessions.map(s => {
                const active = activePanels[s._id];
                const folderName = chapters.find(c => c._id === s.chapterId)?.title || "AUCUN DOSSIER";
                const correctedCount = s.corrections ? s.corrections.length : 0;

                return (
                    <div key={s._id} className="dc-card">
                        <div className="dc-header">
                            <div>
                                <h3 style={{fontWeight:900}}>{s.title}</h3>
                                <p className="text-xs text-slate-400 font-bold">
                                    {s.subjectUrls?.length || 0} Sujets â€¢ {s.copyUrls.length} Copies â€¢ {correctedCount} CorrigÃ©s
                                </p>
                            </div>
                            <div className="dc-toolbar">
                                <button className="tool-btn btn-sujet" onClick={() => togglePanel(s._id, 'CAMERA_SUBJECT')}>ğŸ“„ SUJET</button>
                                <button className="tool-btn btn-scanner" onClick={() => togglePanel(s._id, 'CAMERA_COPY')}>ğŸ“· COPIES</button>
                                <button className="tool-btn btn-devoirs" onClick={() => togglePanel(s._id, 'SHOW_ALL')}>ğŸ‘€ VOIR TOUT</button>
                                <button className="tool-btn btn-folder" onClick={() => togglePanel(s._id, 'DRIVE_SELECTION', s.chapterId)}>ğŸ“‚ RANGER</button>
                                <button className="tool-btn btn-correct" onClick={() => openCorrectionModal(s._id)}>ğŸ¤– CORRIGER</button>
                                <button className="tool-btn btn-delete" onClick={() => handleDeleteSession(s._id)}>âœ•</button>
                            </div>
                        </div>

                        {/* ZONE DE VISUALISATION */}
                        {active === 'SHOW_ALL' && (
                            <div className="dc-content-area text-white">
                                {/* SECTION SUJETS */}
                                {s.subjectUrls?.length > 0 && (
                                    <div className="mb-6">
                                        <h4 className="font-bold mb-2 uppercase text-xs text-indigo-300">Ã‰NONCÃ‰S / SUJETS DE RÃ‰FÃ‰RENCE</h4>
                                        <div className="snap-queue-strip custom-scrollbar justify-start">
                                            {s.subjectUrls.map((url, i) => (
                                                <img key={i} src={url} className="queue-thumb border-indigo-500 border-2" onClick={() => window.open(url, '_blank')} />
                                            ))}
                                        </div>
                                    </div>
                                )}

                                {/* SECTION COPIES */}
                                <div>
                                    <h4 className="font-bold mb-2 uppercase text-xs text-emerald-300">COPIES Ã‰LÃˆVES ({s.copyUrls.length})</h4>
                                    <div className="snap-queue-strip custom-scrollbar justify-start flex-wrap">
                                        {s.copyUrls.map((url, i) => {
                                            const isCorrected = s.corrections?.some(c => c.originalUrl === url);
                                            return (
                                                <div key={i} className="relative group cursor-pointer" onClick={() => handleViewCopy(s, url)}>
                                                    <img src={url} className={`queue-thumb ${isCorrected ? 'border-green-500' : 'border-slate-500'} border-2`} />
                                                    {isCorrected && <div className="absolute top-0 right-0 bg-green-500 text-white text-[8px] font-black px-1 rounded-bl">OK</div>}
                                                </div>
                                            );
                                        })}
                                        {s.copyUrls.length === 0 && <span className="text-sm italic opacity-50">Aucune copie scannÃ©e.</span>}
                                    </div>
                                </div>
                            </div>
                        )}

                        {active === 'DRIVE_SELECTION' && (
                            <div className="dc-content-area flex flex-col items-center gap-4 text-white">
                                <h3>CHOISIR LE DOSSIER DE RANGEMENT</h3>
                                <select className="p-3 rounded text-black font-bold" value={selectedFolderId} onChange={e => setSelectedFolderId(e.target.value)}>
                                    <option value="">-- SÃ‰LECTION --</option>
                                    {relevantChapters.map(c => <option key={c._id} value={c._id}>{c.title}</option>)}
                                </select>
                                <button className="bg-green-500 text-white px-4 py-2 rounded font-black" onClick={() => handleLinkDrive(s._id)}>VALIDER LE RANGEMENT</button>
                            </div>
                        )}

                        {active && active.startsWith('CAMERA') && (
                            <div className="dc-content-area">
                                <h4 className="text-center text-white font-black mb-2 uppercase">
                                    {active === 'CAMERA_SUBJECT' ? "ğŸ“¸ SCANNER L'Ã‰NONCÃ‰ (SUJET)" : "ğŸ“¸ SCANNER UNE COPIE Ã‰LÃˆVE"}
                                </h4>
                                <div className="cam-wrapper">
                                    <video ref={videoRef} autoPlay playsInline className="cam-video" />
                                    <canvas ref={canvasRef} style={{display:'none'}} />
                                    <div className={`cam-trigger ${active === 'CAMERA_SUBJECT' ? 'border-indigo-500' : 'border-emerald-500'}`} onClick={() => takeSnap(s._id, active)}>âšª</div>
                                </div>
                                <div className="snap-queue-strip custom-scrollbar">
                                    {snapQueue.map(sq => <img key={sq.id} src={sq.url} className={`queue-thumb ${sq.status}`} />)}
                                </div>
                            </div>
                        )}
                    </div>
                );
            })}
        </div>
    );
}
[[[Â£ END: client/src/features/prof/scans/ScansStudio.jsx Â£]]]

[[[Â£ FILE: client/src/features/prof/students/StudentsManager.css Â£]]]
.students-table { width: 100%; border-collapse: separate; border-spacing: 0; }
.students-table th { position: sticky; top: 0; z-index: 20; }

/* MODALE CORRECTION & SUIVI */
.correction-overlay {
    position: fixed; inset: 0; z-index: 30000;
    background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(5px);
    display: flex; align-items: center; justify-content: center;
}

.correction-card {
    background: white; width: 95vw; max-width: 1400px; height: 90vh;
    border-radius: 25px; overflow: hidden; display: flex; flex-direction: column;
    box-shadow: 0 50px 100px -20px rgba(0,0,0,0.8);
}

.corr-header {
    padding: 1.5rem; background: #1e293b; color: white;
    display: flex; justify-content: space-between; align-items: center;
}

.corr-body {
    flex: 1; display: flex; overflow: hidden;
}

.corr-panel-student { flex: 1; padding: 2rem; background: #f8fafc; border-right: 2px solid #e2e8f0; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
.corr-panel-prof { flex: 1; padding: 2rem; background: white; overflow-y: auto; display: flex; flex-direction: column; gap: 20px; }

.corr-label { font-size: 0.7rem; font-weight: 900; color: #94a3b8; text-transform: uppercase; letter-spacing: 1px; }
.corr-textarea { width: 100%; min-height: 300px; padding: 1.5rem; border: 2px solid #e2e8f0; border-radius: 15px; font-size: 1rem; line-height: 1.6; outline: none; resize: none; }
.corr-textarea.student { background: white; border-color: #cbd5e1; font-family: 'Courier New', monospace; }
.corr-textarea.feedback { background: #f0f9ff; border-color: #bae6fd; color: #0369a1; }
.corr-grade-box { background: #fdf2f8; padding: 1.5rem; border-radius: 20px; border: 2px solid #fbcfe8; display: flex; flex-direction: column; align-items: center; gap: 10px; }
.corr-grade-input { font-size: 3rem; font-weight: 900; text-align: center; color: #db2777; background: transparent; border: none; outline: none; width: 150px; }

.corr-footer { padding: 1.5rem; background: white; border-top: 1px solid #e2e8f0; display: flex; justify-content: flex-end; gap: 15px; }
.corr-btn-save { padding: 1rem 3rem; background: #16a34a; color: white; border-radius: 15px; font-weight: 900; border: none; cursor: pointer; }
.corr-btn-cancel { padding: 1rem 2rem; background: #f1f5f9; color: #64748b; border-radius: 15px; font-weight: 800; border: none; cursor: pointer; }
[[[Â£ END: client/src/features/prof/students/StudentsManager.css Â£]]]

[[[Â£ FILE: client/src/features/prof/students/StudentsManager.jsx Â£]]]
import React, { useState, useEffect } from 'react';
import './StudentsManager.css';

export default function StudentsManager({ globalClassId }) {
  const [students, setStudents] = useState([]);
  const [activities, setActivities] = useState([]);
  const [trackingData, setTrackingData] = useState({}); 
  const [loading, setLoading] = useState(true);
  const [className, setClassName] = useState("");

  // MODALES
  const [editingSub, setEditingSub] = useState(null); 
  const [editorData, setEditorData] = useState(null);
  const [editorLoading, setEditorLoading] = useState(false);
  const [viewingStudent, setViewingStudent] = useState(null); // Pour la modale de suivi

  useEffect(() => {
    if (!globalClassId) return;
    loadMatrix();
  }, [globalClassId]);

  const loadMatrix = async () => {
    setLoading(true);
    try {
        const [sts, clsList, hws, gms, subs, progs] = await Promise.all([
            fetch('/api/admin/students').then(r => r.json()),
            fetch('/api/admin/classrooms').then(r => r.json()),
            fetch('/api/homework/all').then(r => r.json()),
            fetch('/api/games/all').then(r => r.json()),
            fetch('/api/homework/submissions').then(r => r.json()),
            fetch('/api/games/progress').then(r => r.json())
        ]);

        const currentClassObj = clsList.find(c => c._id === globalClassId);
        const currentClassName = currentClassObj ? currentClassObj.name : "";
        setClassName(currentClassName);

        const myStudents = sts.filter(s => String(s.classId) === String(globalClassId)).sort((a,b) => a.lastName.localeCompare(b.lastName));
        setStudents(myStudents);

        // On charge TOUTES les activitÃ©s (pour pouvoir filtrer dans la modale individuelle)
        const allActs = [
            ...hws.map(h => ({ ...h, type: 'homework', label: 'ğŸ“ ' + h.title })),
            ...gms.map(g => ({ ...g, type: 'game', label: 'ğŸ® ' + g.title }))
        ];
        setActivities(allActs);

        const map = {};
        subs.forEach(sub => { map[`${sub.studentId}_${sub.homeworkId}`] = { done: true, score: sub.grade, subId: sub._id }; });
        progs.forEach(prog => { map[`${prog.studentId}_${prog.gameId}`] = { done: true, score: prog.lastScore ? `${prog.lastScore}pts` : 'JOUÃ‰' }; });
        setTrackingData(map);

    } catch (e) { console.error("Matrix Load Error", e); }
    setLoading(false);
  };

  // --- ACTIONS ---
  const handleOpenCorrection = async (subId) => {
      setEditingSub(subId);
      setEditorLoading(true);
      try {
          const res = await fetch(`/api/homework/submission/${subId}`);
          if (res.ok) setEditorData(await res.json());
      } catch(e) {}
      setEditorLoading(false);
  };

  const handleSaveCorrection = async () => {
      if (!editorData) return;
      await fetch(`/api/homework/submission/${editingSub}`, { method: 'PUT', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(editorData) });
      setEditingSub(null); setEditorData(null); loadMatrix();
  };

  const handleRemovePunishment = async (hwId, sId) => {
      if(!confirm("Annuler cette punition pour l'Ã©lÃ¨ve ?")) return;
      await fetch('/api/homework/remove-punishment', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ homeworkId: hwId, studentId: sId }) });
      // On recharge la matrice pour mettre Ã  jour la vue
      loadMatrix();
      setViewingStudent(null); // On ferme la modale pour rafraÃ®chir
  };

  // --- HELPER POUR LA MODALE SUIVI ---
  const getStudentWorkload = (sId) => {
      const student = students.find(s => s._id === sId);
      if(!student) return [];
      
      const workload = [];
      const myClass = student.currentClass;
      const myGroups = student.assignedGroups || [];

      activities.forEach(act => {
          // 1. CIBLAGE
          let isAssigned = false;
          if (act.type === 'homework' && !act.isAllClass) {
              isAssigned = (act.assignedStudents || []).includes(sId);
          } else {
              // Devoir classe entiÃ¨re ou Jeu
              const targets = act.targetClassrooms || (act.classroom ? [act.classroom] : []);
              // Est-ce que Ã§a vise ma classe ou un de mes groupes ?
              isAssigned = targets.includes(myClass); 
              // Ou suis-je assignÃ© individuellement ? (cas punition ou jeu specifique)
              if (!isAssigned && act.assignedStudents && act.assignedStudents.includes(sId)) isAssigned = true;
          }

          if (isAssigned) {
              const status = trackingData[`${sId}_${act._id}`];
              workload.push({
                  ...act,
                  isDone: !!status,
                  score: status ? status.score : null
              });
          }
      });
      return workload;
  };

  if (!globalClassId) return <div className="p-10 text-center text-slate-400 font-bold">Veuillez sÃ©lectionner une classe en haut.</div>;
  if (loading) return <div className="p-10 text-center text-indigo-500 font-black animate-pulse">CHARGEMENT DE LA MATRICE...</div>;

  const workloadItems = viewingStudent ? getStudentWorkload(viewingStudent._id) : [];

  return (
    <>
        {/* MODALE SUIVI Ã‰LÃˆVE */}
        {viewingStudent && (
            <div className="correction-overlay" onClick={() => setViewingStudent(null)}>
                <div className="correction-card !max-w-2xl !h-[80vh]" onClick={e => e.stopPropagation()}>
                    <div className="corr-header bg-slate-900">
                        <div>
                            <h2 className="text-xl font-black uppercase text-white">{viewingStudent.firstName} {viewingStudent.lastName}</h2>
                            <p className="text-xs text-slate-400 font-bold">SUIVI INDIVIDUEL</p>
                        </div>
                        <button onClick={() => setViewingStudent(null)} className="text-white text-2xl font-black">âœ•</button>
                    </div>
                    <div className="corr-body flex-col bg-slate-50 p-6 overflow-y-auto gap-4 custom-scrollbar">
                        
                        {/* PUNITIONS */}
                        {workloadItems.filter(w => w.isPunishment).length > 0 && (
                            <div className="mb-4">
                                <h4 className="text-xs font-black text-red-500 uppercase mb-2">âš–ï¸ PUNITIONS EN COURS</h4>
                                {workloadItems.filter(w => w.isPunishment).map(w => (
                                    <div key={w._id} className="bg-red-50 border border-red-200 p-4 rounded-xl flex justify-between items-center mb-2">
                                        <div>
                                            <div className="font-bold text-red-700">{w.title}</div>
                                            <div className="text-[10px] text-red-400 font-bold">{w.isDone ? "RENDUE (EN ATTENTE VALIDATION)" : "NON FAITE"}</div>
                                        </div>
                                        {!w.isDone && (
                                            <button onClick={() => handleRemovePunishment(w._id, viewingStudent._id)} className="bg-white text-red-500 px-3 py-1 rounded border border-red-200 text-xs font-black hover:bg-red-500 hover:text-white transition-colors">
                                                ğŸ—‘ï¸ ANNULER
                                            </button>
                                        )}
                                    </div>
                                ))}
                            </div>
                        )}

                        {/* DEVOIRS */}
                        <h4 className="text-xs font-black text-slate-400 uppercase mb-2">ğŸ“š DEVOIRS</h4>
                        {workloadItems.filter(w => w.type === 'homework' && !w.isPunishment).map(w => (
                            <div key={w._id} className={`p-4 rounded-xl border flex justify-between items-center mb-2 ${w.isDone ? 'bg-green-50 border-green-200' : 'bg-white border-slate-200'}`}>
                                <div>
                                    <div className="font-bold text-slate-700">{w.title}</div>
                                    <div className={`text-[10px] font-black uppercase ${w.isDone ? 'text-green-600' : 'text-red-400'}`}>
                                        {w.isDone ? `âœ… FAIT (${w.score})` : 'â­• Ã€ FAIRE'}
                                    </div>
                                </div>
                            </div>
                        ))}

                        {/* JEUX */}
                        <h4 className="text-xs font-black text-slate-400 uppercase mb-2 mt-4">ğŸ® JEUX</h4>
                        {workloadItems.filter(w => w.type === 'game').map(w => (
                            <div key={w._id} className={`p-4 rounded-xl border flex justify-between items-center mb-2 ${w.isDone ? 'bg-purple-50 border-purple-200' : 'bg-white border-slate-200'}`}>
                                <div>
                                    <div className="font-bold text-slate-700">{w.title}</div>
                                    <div className={`text-[10px] font-black uppercase ${w.isDone ? 'text-purple-600' : 'text-red-400'}`}>
                                        {w.isDone ? `âœ… JOUÃ‰ (${w.score})` : 'â­• PAS ENCORE JOUÃ‰'}
                                    </div>
                                </div>
                            </div>
                        ))}

                        {workloadItems.length === 0 && <div className="text-center p-10 text-slate-300 font-bold italic">Aucune activitÃ© assignÃ©e.</div>}
                    </div>
                </div>
            </div>
        )}

        {/* MODALE CORRECTION (Existante) */}
        {editingSub && (
            <div className="correction-overlay">
                <div className="correction-card animate-in">
                    <div className="corr-header">
                        <h2 className="text-xl font-black uppercase">CORRECTION</h2>
                        <button onClick={() => setEditingSub(null)} className="text-slate-400 hover:text-white text-2xl font-black">âœ•</button>
                    </div>
                    {editorLoading || !editorData ? (
                        <div className="flex-1 flex items-center justify-center text-indigo-500 font-black">CHARGEMENT...</div>
                    ) : (
                        <>
                            <div className="corr-body">
                                <div className="corr-panel-student">
                                    <label className="corr-label">âœï¸ TEXTE Ã‰LÃˆVE</label>
                                    <textarea className="corr-textarea student" value={editorData.content} onChange={e => setEditorData({...editorData, content: e.target.value})} />
                                </div>
                                <div className="corr-panel-prof">
                                    <label className="corr-label">ğŸ¤– FEEDBACK</label>
                                    <textarea className="corr-textarea feedback" value={editorData.feedback} onChange={e => setEditorData({...editorData, feedback: e.target.value})} />
                                    <div className="corr-grade-box">
                                        <label className="corr-label">NOTE</label>
                                        <input className="corr-grade-input" value={editorData.grade} onChange={e => setEditorData({...editorData, grade: e.target.value})} />
                                    </div>
                                </div>
                            </div>
                            <div className="corr-footer">
                                <button onClick={() => setEditingSub(null)} className="corr-btn-cancel">ANNULER</button>
                                <button onClick={handleSaveCorrection} className="corr-btn-save">ENREGISTRER</button>
                            </div>
                        </>
                    )}
                </div>
            </div>
        )}

        {/* TABLEAU */}
        <div className="bg-white rounded-[30px] border overflow-hidden shadow-xl animate-in flex flex-col max-h-[80vh]">
            <div className="p-6 bg-slate-50 border-b flex justify-between items-center">
                <h3 className="font-black text-slate-700 text-lg uppercase">ğŸ“Š SUIVI D'ACTIVITÃ‰ : {className}</h3>
                <span className="text-xs font-bold text-slate-400">{students.length} Ã‰lÃ¨ves</span>
            </div>
            
            <div className="overflow-auto flex-1 custom-scrollbar">
                <table className="students-table w-full">
                    <thead className="sticky top-0 z-10 bg-white shadow-sm">
                        <tr>
                            <th className="p-4 text-[10px] font-black text-slate-400 uppercase text-left bg-slate-50 min-w-[200px] border-b border-r">Ã‰lÃ¨ve</th>
                            <th className="p-4 text-[10px] font-black text-slate-400 uppercase text-center bg-slate-50 border-b w-[100px]">Action</th>
                            {activities.filter(a => !a.isPunishment).map(act => (
                                <th key={act._id} className="p-4 text-[9px] font-black text-slate-600 uppercase text-center border-b min-w-[100px] max-w-[150px] truncate" title={act.title}>{act.label}</th>
                            ))}
                        </tr>
                    </thead>
                    <tbody>
                        {students.map(s => (
                            <tr key={s._id} className="hover:bg-blue-50/50 transition-colors group">
                                <td className="p-4 text-xs font-bold text-slate-700 border-r border-b group-hover:text-indigo-700">
                                    {s.firstName} {s.lastName}
                                    {s.punishmentStatus !== 'NONE' && <span className="ml-2 text-[8px] bg-red-100 text-red-600 px-2 py-0.5 rounded font-black">PUNI</span>}
                                </td>
                                <td className="p-2 text-center border-b">
                                    <button onClick={() => setViewingStudent(s)} className="bg-slate-100 text-slate-500 px-3 py-1 rounded hover:bg-indigo-100 hover:text-indigo-600 text-[10px] font-black">ğŸ“‹ SUIVI</button>
                                </td>
                                {activities.filter(a => !a.isPunishment).map(act => {
                                    const status = trackingData[`${s._id}_${act._id}`];
                                    return (
                                        <td key={act._id} className="p-2 text-center border-b">
                                            {status ? (
                                                <button onClick={() => act.type === 'homework' && handleOpenCorrection(status.subId)} className={`inline-flex items-center gap-1 px-3 py-1 rounded-full text-[10px] font-black border shadow-sm ${act.type === 'homework' ? 'bg-green-100 text-green-700 border-green-200' : 'bg-purple-100 text-purple-700 border-purple-200'}`}>{status.score || 'OK'}</button>
                                            ) : <div className="text-slate-200 text-xs">â€¢</div>}
                                        </td>
                                    );
                                })}
                            </tr>
                        ))}
                    </tbody>
                </table>
            </div>
        </div>
    </>
  );
}
[[[Â£ END: client/src/features/prof/students/StudentsManager.jsx Â£]]]

[[[Â£ FILE: client/src/features/prof/studio/StudioDashboard.css Â£]]]
/* --- LAYOUT GLOBAL --- */
.studio-wrapper {
    display: flex;
    width: 100%;
    height: 800px;
    max-height: 85vh;
    background: #0f172a;
    border-radius: 16px;
    overflow: hidden;
    color: #e2e8f0;
    font-family: 'Inter', system-ui, sans-serif;
    border: 1px solid #334155;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
}

/* --- COLONNES LATERALES (FIXES) --- */
.studio-sidebar, .studio-right-panel {
    width: 220px;
    min-width: 220px; max-width: 220px;
    background: #1e293b;
    display: flex; flex-direction: column;
    z-index: 10;
    flex-shrink: 0;
}
.studio-sidebar { border-right: 1px solid #334155; }
.studio-right-panel { border-left: 1px solid #334155; }

/* --- CENTRE (FLEXIBLE) --- */
.studio-center {
    flex: 1;
    display: flex; flex-direction: column;
    min-width: 0;
    background: #0f172a;
    position: relative;
}

/* --- Ã‰LÃ‰MENTS COMMUNS --- */
.panel-header {
    height: 45px;
    display: flex; align-items: center; justify-content: center;
    background: #020617;
    border-bottom: 1px solid #334155;
    font-size: 0.7rem; font-weight: 800; letter-spacing: 1px; color: #94a3b8;
    text-transform: uppercase;
    flex-shrink: 0;
}

.scroll-area {
    flex: 1;
    overflow-y: auto;
    padding: 10px;
    scrollbar-width: thin; scrollbar-color: #475569 #1e293b;
}
.scroll-area::-webkit-scrollbar { width: 6px; }
.scroll-area::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }

/* --- CENTRE : SCÃˆNE --- */
.stage-toolbar { 
    height: 40px; background: #020617; border-bottom: 1px solid #334155; 
    display: flex; align-items: center; justify-content: center; flex-shrink: 0;
}
.stage-toolbar button { margin: 0 5px; font-size: 0.7rem; font-weight: 800; text-transform: uppercase; background: transparent; border: none; cursor: pointer; color: #64748b; }
.stage-toolbar button.active { color: white; border-bottom: 2px solid #3b82f6; }

.stage-wrapper {
    flex: 1; background: #334155;
    display: flex; align-items: center; justify-content: center;
    overflow: hidden; position: relative;
    background-image: radial-gradient(#475569 1px, transparent 1px); background-size: 20px 20px;
}
.stage-canvas {
    width: 640px; height: 360px;
    background: white; position: relative;
    box-shadow: 0 0 50px rgba(0,0,0,0.5); overflow: hidden;
}
.actor-on-stage {
    position: absolute; cursor: grab; width: 100px; height: 100px;
    display: flex; align-items: center; justify-content: center; user-select: none;
}
.actor-on-stage:active { cursor: grabbing; }
.actor-on-stage.selected { outline: 3px solid #facc15; z-index: 100; }

/* --- DROITE : PROPS --- */
.prop-row { margin-bottom: 12px; }
.prop-label { display: block; font-size: 0.6rem; font-weight: 800; color: #64748b; margin-bottom: 4px; text-transform: uppercase; }
.prop-input { width: 100%; background: #020617; border: 1px solid #334155; color: white; padding: 8px; border-radius: 4px; font-size: 0.8rem; text-align: center; }

.obj-card {
    display: flex; align-items: center; gap: 10px; padding: 10px;
    background: #0f172a; border-radius: 6px; border: 1px solid #334155; cursor: pointer; margin-bottom: 5px;
}
.obj-card.selected { border-color: #facc15; background: #1e293b; }
.obj-thumb-mini { width: 30px; height: 30px; background: #1e293b; border-radius: 4px; display: flex; align-items: center; justify-content: center; }
.create-obj-full { width: 100%; padding: 12px; background: #334155; color: #94a3b8; border: 2px dashed #475569; border-radius: 6px; font-weight: 800; font-size: 0.7rem; cursor: pointer; text-transform: uppercase; text-align: center; margin-bottom: 15px; }

/* --- STUDIO CONSOLE (V2 INTERACTIVE) --- */
.studio-console-wrapper {
    width: 100%; max-width: 640px;
    background: #000;
    border: 1px solid #334155;
    border-radius: 0 0 8px 8px;
    display: flex; flex-direction: column;
}

.studio-console-logs {
    height: 120px;
    padding: 10px;
    font-family: 'JetBrains Mono', monospace;
    font-size: 11px;
    overflow-y: auto;
    display: flex; flex-direction: column; gap: 4px;
}

.studio-console-input-area {
    display: flex;
    border-top: 1px solid #334155;
    background: #0f172a;
    padding: 5px;
}

.console-input {
    flex: 1;
    background: transparent;
    border: none;
    color: #fff;
    font-family: 'JetBrains Mono', monospace;
    font-size: 11px;
    padding: 8px;
    outline: none;
}

.btn-console-fix {
    background: #f97316;
    color: white;
    border: none;
    border-radius: 4px;
    padding: 0 15px;
    font-weight: 900;
    font-size: 10px;
    cursor: pointer;
    text-transform: uppercase;
}
.btn-console-fix:hover { background: #ea580c; }

.console-line { color: #22c55e; border-bottom: 1px solid #1e293b; padding-bottom: 2px; word-break: break-all; }
.console-line.error { color: #ef4444; font-weight: bold; background: rgba(239, 68, 68, 0.1); }
.console-line.info { color: #3b82f6; }
.console-line.warn { color: #facc15; }

/* --- MODALE LOADING --- */
.overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.85); z-index: 500; display: flex; flex-direction: column; align-items: center; justify-content: center; }
.modal-box { background: #1e293b; padding: 25px; border-radius: 12px; border: 1px solid #475569; color: white; font-weight: 900; }
[[[Â£ END: client/src/features/prof/studio/StudioDashboard.css Â£]]]

[[[Â£ FILE: client/src/features/prof/studio/StudioDashboard.jsx Â£]]]
import React, { useState, useRef, useEffect } from 'react';
import './StudioDashboard.css';

const AssetThumb = ({ url, className, fallbackEmoji, style }) => {
    const [hasError, setHasError] = useState(false);
    useEffect(() => { setHasError(false); }, [url]);
    if (!url || hasError) return <div className={`flex items-center justify-center w-full h-full text-2xl ${className}`} style={style}><span className="opacity-50 select-none">{fallbackEmoji || 'ğŸ“¦'}</span></div>;
    return <img src={url} className={className} style={style} onError={() => setHasError(true)} draggable="false" alt="asset" />;
};

export default function StudioDashboard({ user }) {
    if (!user) return <div className="p-10 text-white font-bold">Chargement profil...</div>;

    const [project, setProject] = useState({
        _id: null,
        title: "Nouveau Jeu IA",
        teacherId: user.id || user._id, 
        scenes: [{ name: "ScÃ¨ne Principale", actors: [], timeline: [] }],
        generatedCode: ""
    });

    const [activeSceneIdx, setActiveSceneIdx] = useState(0);
    const [selectedActorId, setSelectedActorId] = useState(null);
    const [viewMode, setViewMode] = useState('DESIGN'); 
    const [processingMsg, setProcessingMsg] = useState("");
    
    // --- ETATS IA ---
    const [aiPrompt, setAiPrompt] = useState(""); 
    const [consoleInput, setConsoleInput] = useState(""); 
    const [gameInstance, setGameInstance] = useState(null);
    const [logs, setLogs] = useState([]);

    const fileInputRef = useRef(null);
    const remixInputRef = useRef(null);
    const directImportRef = useRef(null);
    const consoleEndRef = useRef(null); 

    const activeScene = project.scenes[activeSceneIdx];
    const selectedActor = activeScene.actors.find(a => a.id === selectedActorId);

    const addLog = (msg, type = 'info') => {
        const time = new Date().toLocaleTimeString().split(' ')[0];
        setLogs(prev => [...prev, { time, msg: String(msg), type }].slice(-50));
        if (type === 'error') {
            setAiPrompt(prev => prev.includes(String(msg)) ? prev : `Corrige cette erreur : ${msg}`);
        }
    };

    useEffect(() => {
        consoleEndRef.current?.scrollIntoView({ behavior: "smooth" });
    }, [logs]);

    const uploadBlob = async (blob, filename) => {
        const formData = new FormData();
        formData.append('file', blob, filename);
        try {
            const res = await fetch('/api/studio/upload', { method: 'POST', body: formData });
            const data = await res.json();
            return data.url;
        } catch (e) { console.error(e); return null; }
    };

    const saveProject = async (silent = false) => {
        if (!silent) setProcessingMsg("Sauvegarde...");
        try {
            const tId = user.id || user._id;
            const payload = JSON.parse(JSON.stringify({ ...project, teacherId: tId }));
            
            if (!payload._id || payload._id === 'null' || payload._id.length < 10) delete payload._id;
            if (payload.scenes && Array.isArray(payload.scenes)) {
                payload.scenes = payload.scenes.map(s => {
                    if (s._id && (typeof s._id !== 'string' || s._id.length !== 24)) delete s._id;
                    if (s.id && (typeof s.id !== 'string' || s.id.length !== 24)) delete s.id;
                    return s;
                });
            }

            const res = await fetch('/api/studio/projects', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
            if(!res.ok) throw new Error("Erreur serveur");
            
            const data = await res.json();
            const newId = data._id;
            setProject(prev => ({ ...prev, _id: newId }));
            
            if (!silent) { setProcessingMsg(""); alert("SauvegardÃ© ! ğŸ’¾"); }
            return newId;
        } catch (e) { 
            console.error("SAVE ERROR:", e);
            setProcessingMsg(""); 
            if (!silent) alert("Erreur sauvegarde : " + e.message); 
            return null; 
        }
    };

    // --- MOTEUR IA CENTRAL (GÃ‰NÃ‰RATION OU FIX) ---
    const handleAiAction = async () => {
        if (!aiPrompt) return alert("Ã‰crivez une idÃ©e ou une correction !");
        
        // 1. MODE RÃ‰PARATION
        if (project.generatedCode && project.generatedCode.length > 50) {
            setProcessingMsg("RÃ©paration / Modification par l'IA...");
            try {
                const res = await fetch('/api/studio/fix-code', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ 
                        code: project.generatedCode, 
                        error: aiPrompt, 
                        instruction: aiPrompt 
                    })
                });
                const data = await res.json();
                // NOUVEAU : Lecture du message IA
                if (data.ok && data.code.code) {
                    setProject(prev => ({ ...prev, generatedCode: data.code.code }));
                    setAiPrompt(""); 
                    addLog("IA : " + (data.code.message || "Code rÃ©parÃ©."), "info"); // Le message de l'IA s'affiche ici
                    runGame(); 
                } else {
                    addLog("L'IA n'a pas renvoyÃ© de code valide.", "error");
                }
            } catch(e) { addLog("Erreur RÃ©paration : " + e.message, "error"); }
            setProcessingMsg("");
            return;
        }

        // 2. MODE CRÃ‰ATION
        if (activeScene.actors.length === 0) return alert("Ajoutez au moins un acteur !");
        setProcessingMsg("GÃ©nÃ©ration du Jeu...");
        const targetId = await saveProject(true);
        if (!targetId) { setProcessingMsg(""); return; }
        
        try {
            const res = await fetch('/api/studio/generate-code', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ projectId: targetId, gameIdea: aiPrompt })
            });
            const data = await res.json();
            // NOUVEAU : Lecture du message IA
            if (data.ok && data.code.code) {
                setProject(prev => ({ ...prev, generatedCode: data.code.code }));
                setViewMode('CODE');
                setAiPrompt("");
                addLog("IA : " + (data.code.message || "Jeu gÃ©nÃ©rÃ©."), "success"); // Le message de l'IA s'affiche ici
                runGame();
            } else {
                addLog("L'IA n'a pas renvoyÃ© de code valide.", "error");
            }
        } catch(e) { 
            addLog("Erreur GÃ©nÃ©ration : " + e.message, "error");
        }
        setProcessingMsg("");
    };

    const handleConsoleFix = async () => {
        if (!consoleInput) return;
        setAiPrompt(consoleInput); 
        setConsoleInput("");
        setTimeout(handleAiAction, 100); 
    };

    const runGame = () => {
        if (!project.generatedCode) return alert("Aucun code gÃ©nÃ©rÃ© !");
        setViewMode('PLAY');
        setLogs([]);
        addLog("Initialisation...", "info");

        setTimeout(() => {
            const canvas = document.getElementById('game-canvas');
            if (!canvas) return;
            const assets = {};
            let loaded = 0;
            const actors = activeScene.actors;
            
            if(actors.length === 0) return launch(canvas, assets);
            
            const checkStart = () => { if (loaded === actors.length) launch(canvas, assets); };
            
            actors.forEach(a => {
                const url = (a.costumes && a.costumes[0]) ? a.costumes[0].url : null;
                if (url) {
                    const img = new Image(); 
                    img.crossOrigin = "Anonymous"; 
                    img.src = url;
                    img.onload = () => { assets[a.id] = img; loaded++; checkStart(); };
                    img.onerror = () => { 
                        addLog(`Asset manquant : ${a.name} (ID: ${a.id})`, "warn");
                        loaded++; checkStart(); 
                    };
                } else { loaded++; checkStart(); }
            });
        }, 100);
    };

    const launch = (canvas, assets) => {
        try {
            if (gameInstance && gameInstance.destroy) gameInstance.destroy();

            const code = project.generatedCode;
            const safeCode = code.replace(/window\.|document\.|alert\(|eval\(/g, '//blocked');
            const factory = new Function(` ${safeCode} return MiniGame; `);
            const GameClass = factory();
            
            const game = new GameClass(canvas, assets);
            game.log = (msg) => addLog(msg, "info"); 

            setGameInstance(game);
            addLog("Moteur dÃ©marrÃ©.", "success");
            
            let lastTime = 0;
            let frameId;

            const loop = (time) => {
                try {
                    const dt = (time - lastTime) / 1000; 
                    lastTime = time;
                    if (game.update) game.update(dt);
                    if (game.draw) game.draw(canvas.getContext('2d'));
                    if (document.getElementById('game-canvas')) {
                        frameId = requestAnimationFrame(loop);
                    }
                } catch (runtimeErr) {
                    addLog(runtimeErr.message, "error");
                    cancelAnimationFrame(frameId);
                }
            };
            frameId = requestAnimationFrame(loop);

        } catch (e) { 
            addLog("Erreur Code : " + e.message, "error");
        }
    };

    const injectCostumes = (urls, baseName) => {
        if (!selectedActor) return;
        setProject(prev => {
            const next = { ...prev };
            const act = next.scenes[activeSceneIdx].actors.find(a => a.id === selectedActorId);
            if (act) {
                urls.forEach((url, i) => act.costumes.push({ id: `c_${Date.now()}_${i}`, url, name: `${baseName}_${act.costumes.length + 1}` }));
                if (act.costumes.length === urls.length) act.currentCostumeIdx = 0;
            }
            return next;
        });
    };
    const createActor = () => {
        const newId = `a_${Date.now()}`;
        setProject(prev => {
            const next = { ...prev };
            next.scenes[activeSceneIdx].actors.push({ id: newId, name: "Nouvel Acteur", x: 50, y: 50, scale: 1, currentCostumeIdx: 0, costumes: [] });
            return next;
        });
        setSelectedActorId(newId);
    };
    const updateActor = (k, v) => {
        setProject(prev => {
            const next = { ...prev };
            const act = next.scenes[activeSceneIdx].actors.find(a => a.id === selectedActorId);
            if(act) act[k] = v;
            return next;
        });
    };

    const handleDirectImport = async (e) => {
        const file = e.target.files[0];
        if (!file || !selectedActor) return;
        setProcessingMsg("Importation...");
        const url = await uploadBlob(file, file.name);
        if (url) injectCostumes([url], "Import");
        else alert("Erreur upload");
        setProcessingMsg("");
        e.target.value = null;
    };

    const handleRemix = async (e) => {
        const file = e.target.files[0];
        if(!file || !selectedActor) return;
        setProcessingMsg("Remix IA...");
        const fd = new FormData(); fd.append('file', file);
        try {
            const res = await fetch('/api/studio/remix-asset', { method: 'POST', body: fd });
            const data = await res.json();
            if(data.ok) injectCostumes([data.url], "Remix");
        } catch(e) { alert("Erreur Remix"); }
        setProcessingMsg("");
        e.target.value = null;
    };

    const hasCode = project.generatedCode && project.generatedCode.length > 50;
    const buttonLabel = hasCode ? "RÃ‰PARER / MODIFIER ğŸ”§" : "GÃ‰NÃ‰RER LE CODE ğŸš€";
    const buttonColor = hasCode ? "bg-orange-500 hover:bg-orange-600" : "bg-pink-600 hover:bg-pink-500";

    return (
        <div className="studio-wrapper">
            <input type="file" ref={remixInputRef} style={{display:'none'}} onChange={handleRemix} accept="image/*" />
            <input type="file" ref={directImportRef} style={{display:'none'}} onChange={handleDirectImport} accept="image/*" />
            
            {processingMsg && <div className="overlay"><div className="modal-box"><h3 className="animate-pulse">{processingMsg}</h3></div></div>}

            <div className="studio-sidebar">
                <div className="panel-header">ACTEURS</div>
                <div className="scroll-area">
                    <div className="create-obj-full" onClick={createActor}>+ AJOUTER ACTEUR</div>
                    {activeScene.actors.map(a => (
                        <div key={a.id} className={`obj-card ${selectedActorId === a.id ? 'selected' : ''}`} onClick={() => setSelectedActorId(a.id)}>
                            <div className="obj-thumb-mini"><AssetThumb url={a.costumes[0]?.url} /></div>
                            <div className="obj-name">{a.name}</div>
                        </div>
                    ))}
                </div>
                {selectedActor && (
                    <div className="p-4 border-t border-slate-700 flex flex-col gap-2">
                        <button className="w-full bg-purple-600 text-white py-2 rounded font-bold text-xs" onClick={() => remixInputRef.current.click()}>âœ¨ REMIX IMAGE (IA)</button>
                        <button className="w-full bg-slate-600 text-white py-2 rounded font-bold text-xs" onClick={() => directImportRef.current.click()}>ğŸ“‚ IMPORT LOCAL</button>
                    </div>
                )}
            </div>

            <div className="studio-center">
                <div className="stage-toolbar gap-4">
                    <button onClick={() => setViewMode('DESIGN')} className={viewMode==='DESIGN'?'active':''}>ğŸ¨ DESIGN</button>
                    <button onClick={() => setViewMode('CODE')} className={viewMode==='CODE'?'active':''}>ğŸ’» CODE</button>
                    <button onClick={runGame} className="bg-green-500 text-white px-4 py-1 rounded font-bold">â–¶ JOUER</button>
                    <button onClick={() => saveProject(false)} className="bg-blue-600 text-white px-4 py-1 rounded font-bold ml-auto">ğŸ’¾ SAUVER</button>
                </div>

                {viewMode === 'DESIGN' && (
                    <div className="stage-wrapper" onClick={() => setSelectedActorId(null)}>
                        <div className="stage-canvas relative">
                            {activeScene.actors.map(a => (
                                <div key={a.id} className={`actor-on-stage ${selectedActorId === a.id ? 'selected' : ''}`}
                                     style={{ left: a.x+'%', top: a.y+'%', transform: `translate(-50%, -50%) scale(${a.scale})` }}
                                     onMouseDown={(e) => { e.stopPropagation(); setSelectedActorId(a.id); }}>
                                    <AssetThumb url={a.costumes[0]?.url} className="" style={{width:'100px', height:'100px', objectFit:'contain'}} />
                                </div>
                            ))}
                        </div>
                    </div>
                )}

                {viewMode === 'CODE' && (
                    <div className="flex-1 bg-slate-900 p-4 overflow-auto">
                        <textarea className="w-full h-full bg-black text-green-400 font-mono text-xs p-4 rounded border border-slate-700" 
                                  value={project.generatedCode} onChange={(e) => setProject({...project, generatedCode: e.target.value})} 
                                  placeholder="Le code gÃ©nÃ©rÃ© par l'IA apparaÃ®tra ici..." />
                    </div>
                )}

                {viewMode === 'PLAY' && (
                    <div className="flex-1 bg-black flex flex-col items-center justify-center p-4">
                        <canvas id="game-canvas" width="640" height="360" className="bg-white shadow-2xl rounded mb-0" />
                        
                        {/* CONSOLE INTERACTIVE */}
                        <div className="studio-console-wrapper">
                            <div className="studio-console-logs custom-scrollbar">
                                {logs.length === 0 && <span className="text-slate-600 italic">Console prÃªte. Lancez le jeu pour voir les logs.</span>}
                                {logs.map((l, i) => (
                                    <div key={i} className={`console-line ${l.type}`}>
                                        <span className="opacity-50">[{l.time}]</span> {l.msg}
                                    </div>
                                ))}
                                <div ref={consoleEndRef} />
                            </div>
                            <div className="studio-console-input-area">
                                <input 
                                    className="console-input" 
                                    placeholder="DÃ©crivez le bug ou l'amÃ©lioration (ex: 'Le joueur tombe Ã  travers le sol')..." 
                                    value={consoleInput}
                                    onChange={e => setConsoleInput(e.target.value)}
                                    onKeyDown={e => e.key === 'Enter' && handleConsoleFix()}
                                />
                                <button className="btn-console-fix" onClick={handleConsoleFix}>RÃ‰PARER ğŸ”§</button>
                            </div>
                        </div>
                    </div>
                )}

                {viewMode !== 'PLAY' && (
                    <div className="h-[120px] bg-slate-900 border-t border-slate-700 p-4 flex flex-col gap-2">
                        <span className="text-xs font-bold text-slate-400 uppercase">
                            {hasCode ? "ASSISTANT DE RÃ‰PARATION & MODIFICATION" : "GÃ‰NÃ‰RATEUR DE JEU (GEMINI 2.0)"}
                        </span>
                        <div className="flex gap-2">
                            <input className={`flex-1 bg-slate-800 border rounded p-2 text-white text-sm ${logs.some(l => l.type==='error') ? 'border-red-500 animate-pulse' : 'border-slate-600'}`}
                                   placeholder={hasCode ? "DÃ©crivez le bug ou la modification (ex: 'Fais sauter plus haut')..." : "DÃ©crivez votre jeu..."}
                                   value={aiPrompt} onChange={e => setAiPrompt(e.target.value)} />
                            <button onClick={handleAiAction} className={`${buttonColor} text-white px-6 rounded font-black text-xs transition-colors uppercase`}>
                                {buttonLabel}
                            </button>
                        </div>
                    </div>
                )}
            </div>

            {/* DROITE */}
            <div className="studio-right-panel">
                <div className="panel-header">PROPRIÃ‰TÃ‰S</div>
                {selectedActor ? (
                    <div className="p-4 space-y-2">
                        <div className="prop-row"><label className="prop-label">NOM</label><input className="prop-input" value={selectedActor.name} onChange={e => updateActor('name', e.target.value)} /></div>
                        <div className="prop-row"><label className="prop-label">TAILLE</label><input type="number" step="0.1" className="prop-input" value={selectedActor.scale} onChange={e => updateActor('scale', parseFloat(e.target.value))} /></div>
                    </div>
                ) : <div className="p-4 text-center text-xs text-slate-500">SÃ©lectionnez un acteur</div>}
            </div>
        </div>
    );
}
[[[Â£ END: client/src/features/prof/studio/StudioDashboard.jsx Â£]]]

[[[Â£ FILE: client/src/index.css Â£]]]
@tailwind base; @tailwind components; @tailwind utilities;
:root { --primary: #2563eb; }
body { margin: 0; font-family: 'Inter', sans-serif; background: #f1f5f9; }
.custom-scrollbar::-webkit-scrollbar { width: 6px; }
.custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
[[[Â£ END: client/src/index.css Â£]]]

[[[Â£ FILE: client/src/main.jsx Â£]]]
import React from 'react'; import ReactDOM from 'react-dom/client'; import App from './App.jsx'; import './index.css';
ReactDOM.createRoot(document.getElementById('root')).render(<React.StrictMode><App /></React.StrictMode>);
[[[Â£ END: client/src/main.jsx Â£]]]

[[[Â£ FILE: client/src/services/api.js Â£]]]
export const api = {
    get: (url) => fetch(`/api${url}`).then(r => r.json()),
    post: (url, data) => fetch(`/api${url}`, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(data) }).then(r => r.json())
};
[[[Â£ END: client/src/services/api.js Â£]]]

[[[Â£ FILE: client/src/test_token_crash.js Â£]]]
console.log("âœ… FICHIER RÃ‰PARÃ‰ AVEC SUCCÃˆS !");
console.log("Le systÃ¨me de sÃ©curitÃ© 'Token + API Reset' fonctionne parfaitement.");
console.log("Le bandeau rouge a disparu, et le fichier est maintenant complet.");

export default function TestTokenValid() {
    return "Tout est opÃ©rationnel chef !";
}
[[[Â£ END: client/src/test_token_crash.js Â£]]]

[[[Â£ FILE: client/vite.config.js Â£]]]
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'

export default defineConfig({
  plugins: [react()],
  server: {
    host: '0.0.0.0',
    port: 5173,
    proxy: {
      '/api': {
        target: 'http://localhost:3000',
        changeOrigin: true,
        secure: false,
      },
      // ROUTE CRITIQUE : Tout ce qui commence par /uploads est gÃ©rÃ© par le serveur Node (server.js)
      '/uploads': {
        target: 'http://localhost:3000',
        changeOrigin: true,
        secure: false,
      }
    }
  }
})
[[[Â£ END: client/vite.config.js Â£]]]

[[[Â£ FILE: git-auto.js Â£]]]
const { exec } = require('child_process');
const fs = require('fs');
const path = require('path');
const VERSION_FILE = path.join(__dirname, 'server', 'version.json');

async function doPush() {
    let v = { version: "2.1.1", build: 311 };
    try { v = JSON.parse(fs.readFileSync(VERSION_FILE, 'utf8')); } catch(e) {}
    v.build++; v.timestamp = new Date().toISOString();
    fs.writeFileSync(VERSION_FILE, JSON.stringify(v, null, 2));
    exec('git add . && git commit -m "Build #' + v.build + '" && git push');
}
setInterval(doPush, 600000);
[[[Â£ END: git-auto.js Â£]]]

[[[Â£ FILE: init-db.js Â£]]]
const mongoose = require('mongoose');
require('dotenv').config();
async function init() {
    await mongoose.connect(process.env.MONGODB_URI);
    console.log("BDD Init");
    process.exit();
}
init();
[[[Â£ END: init-db.js Â£]]]

[[[Â£ FILE: magic-paste.js Â£]]]
const fs = require('fs');
let lastContent = "";

console.log("------------------------------------------------");
console.log("ğŸ”® MAGIC PASTE ACTIF : En attente de code...");
console.log("------------------------------------------------");

setInterval(async () => {
    try {
        const module = await import('clipboardy');
        const text = await module.default.read();
        
        // On vÃ©rifie si le presse-papier contient notre tag spÃ©cial et a changÃ©
        if (text.includes('[[[Â£ FILE:') && text !== lastContent) {
            const timestamp = new Date().toLocaleTimeString();
            console.log("\n"); 
            console.log("================================================");
            console.log(`âš¡ [${timestamp}] MAGIC PASTE DÃ‰TECTÃ‰ !`);
            console.log(`ğŸ“‹ Capture de ${text.length} caractÃ¨res.`);
            console.log(`ğŸ“ Ã‰criture dans update.txt...`);
            console.log("================================================");
            
            fs.writeFileSync('update.txt', text);
            lastContent = text;
        }
    } catch (e) {
        // On ignore les erreurs de lecture (verrouillage presse-papier momentanÃ©)
    }
}, 2000);
[[[Â£ END: magic-paste.js Â£]]]

[[[Â£ FILE: package.json Â£]]]
{
  "name": "condamine-pro",
  "version": "1.70.0",
  "scripts": {
    "start": "node server/server.js",
    "server-dev": "nodemon --ignore 'update.txt' --ignore 'apply_status.json' server/server.js",
    "client": "npm run dev --prefix client",
    "test": "node tests/integrity.test.js",
    "dev": "node apply.js & node magic-paste.js & npm run server-dev & npm run client",
    "build": "npm install --prefix client && npm run build --prefix client"
  },
  "dependencies": {
    "@google/generative-ai": "^0.1.3",
    "dotenv": "^16.4.5",
    "express": "^4.19.2",
    "googleapis": "^126.0.0",
    "mongoose": "7.8.2",
    "node-fetch": "^2.7.0",
    "multer": "^1.4.5-lts.1",
    "clipboardy": "^4.0.0"
  }
}
[[[Â£ END: package.json Â£]]]

[[[Â£ FILE: public/style.css Â£]]]
:root {
    --primary: #2563eb; --primary-dark: #1e40af; --secondary: #f59e0b;
    --success: #16a34a; --danger: #dc2626; --bg-page: #f1f5f9;
    --text-main: #1e293b; --text-light: #64748b; --border: #e2e8f0; --radius: 12px;
}
* { box-sizing: border-box; }
body { margin: 0; font-family: 'Segoe UI', sans-serif; background-color: var(--bg-page); color: var(--text-main); height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

header { display: flex; justify-content: space-between; align-items: center; background: white; padding: 0 25px; height: 70px; min-height: 70px; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
header h1 { font-size: 1.3rem; color: var(--primary); margin: 0; }
.header-right { display: flex; gap: 15px; align-items: center; }

.wrap { flex: 1; width: 100%; padding: 15px; overflow-y: auto; }
.card { background: white; border-radius: var(--radius); padding: 25px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }

/* --- HOMEWORK LAYOUT (75/25) --- */
.hw-layout { display: flex; flex-direction: column; height: calc(100vh - 100px); background: #1e293b; border-radius: 15px; overflow: hidden; border: 2px solid #334155; position: relative; }
.hw-list-view { padding: 20px; background: white; height: 100%; overflow-y: auto; z-index: 100; }
.hw-work-view { display: flex; flex-direction: column; height: 100%; width: 100%; position: relative; }

.doc-viewer-container {
    flex: 7.5; position: relative; background-color: #0f172a; overflow: hidden;
    background-image: linear-gradient(rgba(255,255,255,0.05) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.05) 1px, transparent 1px);
    background-size: 50px 50px; border-bottom: 4px solid var(--secondary); cursor: grab;
}
#pan-zoom-content, #pan-zoom-question-content { position: absolute; top: 50%; left: 50%; transform-origin: center center; display: flex; justify-content: center; align-items: center; pointer-events: none; }
#current-doc-img, #pan-zoom-question-content img { height: auto; box-shadow: 0 0 50px rgba(0,0,0,0.8); border: 3px solid white; pointer-events: auto; -webkit-user-drag: none; }

.interaction-zone { flex: 2.5; display: flex; background: white; min-height: 160px; border-top: 1px solid var(--border); }
.question-part { flex: 1; padding: 12px; border-right: 2px solid var(--border); background: #f8fafc; overflow: auto; }
.answer-part { flex: 1.2; padding: 12px; display: flex; flex-direction: column; gap: 8px; padding-bottom: 20px; }

#q-image-container { flex: 1; position: relative; overflow: hidden; background: #0f172a; border-radius: 8px; margin-top: 5px; border: 1px solid #cbd5e1; min-height: 100px; cursor: grab; }
#hw-answer-input { flex: 1; width: 100%; resize: none; padding: 12px; border: 2px solid #cbd5e1; border-radius: 10px; font-size: 0.95rem; }

/* FEEDBACK IA MODAL */
#hw-feedback-overlay { display: none; position: fixed; inset: 0; background: rgba(15, 23, 42, 0.85); backdrop-filter: blur(8px); z-index: 9999; align-items: center; justify-content: center; padding: 20px; }
.feedback-card { background: white; width: 100%; max-width: 800px; max-height: 90vh; border-radius: 24px; padding: 25px; display: flex; flex-direction: column; box-shadow: 0 25px 50px rgba(0,0,0,0.5); }
.feedback-scroll-area { flex: 1; overflow-y: auto; margin: 15px 0; padding: 15px; background: #f8fafc; border-radius: 12px; border: 1px solid #edf2f7; }

/* NAVIGATION UI */
.page-counter { position: absolute; top: 15px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: white; padding: 5px 15px; border-radius: 20px; font-weight: bold; z-index: 10; }
.nav-arrow { position: absolute; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.5); color: white; border: none; width: 45px; height: 45px; border-radius: 50%; font-size: 20px; cursor: pointer; z-index: 10; display: flex; align-items: center; justify-content: center; }
#btn-prev-doc { left: 10px; } #btn-next-doc { right: 10px; }
.doc-controls { position: absolute; bottom: 15px; right: 15px; display: flex; gap: 10px; z-index: 10; }
.zoom-btn { width: 38px; height: 38px; border-radius: 50%; background: rgba(0,0,0,0.6); color: white; border: none; cursor: pointer; }
.action-btn { background: var(--primary); color: white; border: none; padding: 12px; border-radius: 8px; width: 100%; font-weight: bold; cursor: pointer; }
.tab-btn { padding: 10px 20px; border-radius: 8px; border: none; background: #eee; cursor: pointer; font-weight: bold; }
.tab-btn.active { background: var(--primary); color: white; }
.wrong-word { color: var(--danger); text-decoration: line-through; font-weight: bold; }
.right-word { color: var(--success); font-weight: bold; }
.correction-table { width: 100%; border-collapse: collapse; margin-top: 10px; background: white; border-radius: 10px; overflow: hidden; }
.correction-table td { padding: 8px; border-bottom: 1px solid #eee; }
[[[Â£ END: public/style.css Â£]]]

[[[Â£ FILE: server/core/ai.engine.js Â£]]]
const { GoogleGenerativeAI } = require("@google/generative-ai");

/**
 * ğŸ¤– MOTEUR IA CENTRALISÃ‰ - V4 (GESTION ERREUR CLÃ‰)
 * Intercepte les clÃ©s expirÃ©es pour prÃ©venir l'utilisateur.
 */
const AIEngine = {
    sanitizeJSON: (text) => {
        try {
            let clean = text.replace(/```json/gi, "").replace(/```/gi, "").trim();
            const startArray = clean.indexOf('[');
            const startObj = clean.indexOf('{');
            let startIdx = -1;
            let endIdx = -1;

            if (startArray !== -1 && (startObj === -1 || startArray < startObj)) {
                startIdx = startArray;
                endIdx = clean.lastIndexOf(']') + 1;
            } else if (startObj !== -1) {
                startIdx = startObj;
                endIdx = clean.lastIndexOf('}') + 1;
            }

            if (startIdx === -1) throw new Error("Format JSON introuvable");
            return JSON.parse(clean.substring(startIdx, endIdx));
        } catch (e) { 
            console.error("ğŸ”¥ [AI-CORE] Ã‰chec parsing JSON. Brut :", text.substring(0, 100) + "...");
            throw new Error("L'IA a renvoyÃ© un format illisible."); 
        }
    },

    ask: async (prompt, systemInstruction = "") => {
        const apiKey = process.env.GEMINI_API_KEY;
        const targetModel = "gemini-2.0-flash"; 

        if (!apiKey || apiKey.includes('VOTRE_CLE')) {
            console.error("âŒ [AI-CORE] ClÃ© API manquante ou par dÃ©faut.");
            throw new Error("CLÃ‰ API MANQUANTE DANS LE FICHIER .ENV");
        }
        
        let logPrompt = "";
        if (typeof prompt === 'string') {
            logPrompt = prompt.substring(0, 50);
        } else if (Array.isArray(prompt)) {
            logPrompt = "MULTIMODAL (Image + Texte)";
        } else {
            logPrompt = "Objet complexe";
        }

        console.log(`ğŸ“¡ [AI-CORE] Appel Google | ModÃ¨le: ${targetModel} | Prompt: ${logPrompt}...`);
        
        try {
            const genAI = new GoogleGenerativeAI(apiKey);
            const model = genAI.getGenerativeModel({ 
                model: targetModel,
                systemInstruction: systemInstruction 
            });
            
            const result = await model.generateContent(prompt);
            const response = await result.response;
            const text = response.text();
            
            if (!text) throw new Error("RÃ©ponse Google vide");
            return text;
        } catch (e) {
            console.error(`ğŸ’¥ [AI-CORE] CRASH GOOGLE :`, e.message);
            
            // DÃ‰TECTION SPÃ‰CIFIQUE CLÃ‰ EXPIRÃ‰E
            if (e.message.includes('API key expired') || e.message.includes('API_KEY_INVALID') || e.status === 400) {
                throw new Error("âš ï¸ VOTRE CLÃ‰ API EST PÃ‰RIMÃ‰E. Changez-la dans le fichier .env !");
            }
            
            throw e;
        }
    }
};

module.exports = AIEngine;
[[[Â£ END: server/core/ai.engine.js Â£]]]

[[[Â£ FILE: server/core/drive.engine.js Â£]]]
const { google } = require('googleapis');
const fs = require('fs');
const path = require('path');

let oauth2Client = null;
let driveInstance = null;

const DriveEngine = {
    oauth2Client: null,
    init: () => {
        try {
            const clientID = process.env.GOOGLE_CLIENT_ID;
            const clientSecret = process.env.GOOGLE_CLIENT_SECRET;
            const refresh = process.env.GOOGLE_REFRESH_TOKEN;
            const redirect = process.env.GOOGLE_REDIRECT_URI || "http://localhost:3000/api/auth/google/callback";
            if (clientID && clientSecret) {
                oauth2Client = new google.auth.OAuth2(clientID, clientSecret, redirect);
                if (refresh) {
                    oauth2Client.setCredentials({ refresh_token: refresh });
                    driveInstance = google.drive({ version: 'v3', auth: oauth2Client });
                    DriveEngine.oauth2Client = oauth2Client;
                    console.log("âœ… Drive Engine Ready V100.");
                }
            }
        } catch (e) { console.error("Drive Init Error", e.message); }
    },
    testAuth: async () => {
        if (!driveInstance) return { ok: false, error: "Non configurÃ©" };
        try {
            const res = await driveInstance.about.get({ fields: 'user(emailAddress)' });
            return { ok: true, email: res.data.user.emailAddress };
        } catch (e) { return { ok: false, error: "Session expirÃ©e" }; }
    },
    getOrCreateFolder: async (name, parentId = null) => {
        if (!driveInstance) throw new Error("Drive non prÃªt");
        const cleanName = name.toUpperCase().trim();
        try {
            let q = `name = '${cleanName.replace(/'/g, "\\'")}' and mimeType = 'application/vnd.google-apps.folder' and trashed = false`;
            if (parentId) q += ` and '${parentId}' in parents`;
            const res = await driveInstance.files.list({ q, fields: 'files(id)' });
            if (res.data.files?.length > 0) return res.data.files[0].id;
            const folder = await driveInstance.files.create({
                resource: { name: cleanName, mimeType: 'application/vnd.google-apps.folder', parents: parentId ? [parentId] : [] },
                fields: 'id'
            });
            return folder.data.id;
        } catch (e) { throw e; }
    },
    /**
     * V100 : UPLOAD AVEC GÃ‰NÃ‰RATION DE LIEN DIRECT "UC"
     * Format : https://drive.google.com/uc?export=view&id={FILE_ID}
     */
    uploadFile: async (fileName, localPath, parentFolderId) => {
        if (!driveInstance) throw new Error("Drive Instance missing");
        try {
            const fileMetadata = { name: fileName, parents: [parentFolderId] };
            const media = { body: fs.createReadStream(localPath) };
            
            // 1. Upload du fichier
            const file = await driveInstance.files.create({
                resource: fileMetadata,
                media: media,
                fields: 'id'
            });

            const fileId = file.data.id;

            // 2. RENDRE LE FICHIER LISIBLE (Indispensable pour l'affichage Ã©lÃ¨ve)
            await driveInstance.permissions.create({
                fileId: fileId,
                resource: { role: 'reader', type: 'anyone' }
            });

            // 3. RETOURNER L'URL DE VUE DIRECTE
            const directUrl = `https://drive.google.com/uc?export=view&id=${fileId}`;
            return { id: fileId, link: directUrl };

        } catch (e) {
            console.error("âŒ Drive Upload Fail V100:", e.message);
            throw e;
        }
    }
};
DriveEngine.init();
module.exports = DriveEngine;
[[[Â£ END: server/core/drive.engine.js Â£]]]

[[[Â£ FILE: server/domains/admin/admin.routes.js Â£]]]
const express = require('express');
const router = express.Router();
const mongoose = require('mongoose');
const multer = require('multer');
const fs = require('fs');
const path = require('path');
const AdminExpert = require('./experts/admin.expert');
const AdminAI = require('./ai/admin.ai');
const StructureDrive = require('../structure/experts/structure.drive');

const asyncHandler = fn => (req, res, next) => Promise.resolve(fn(req, res, next)).catch(next);

const tempDir = path.join(process.cwd(), 'public', 'uploads', 'temp');
if (!fs.existsSync(tempDir)) fs.mkdirSync(tempDir, { recursive: true });
const upload = multer({ dest: tempDir });

const normalizeClassName = (name) => {
    if (!name) return "";
    let s = name.toUpperCase().trim();
    if (s === "UNKNOWN") return ""; 
    s = s.replace(/^(TERMINALE|TERM)\s*/, 'T');
    s = s.replace(/(\d+)\s*(?:E|EME|ÃˆME|Ã‰ME|ERE|ÃˆRE|IER|IÃˆRE|NDE|ND)\s*([A-Z]?)/g, '$1$2');
    s = s.replace(/[\s\-\._]/g, '');
    return s;
};

const guessLevel = (name) => {
    const n = name.toUpperCase();
    if (n.startsWith('T') || n.startsWith('TERM')) return 'TERM';
    const match = n.match(/^(\d+|CP|CE1|CE2|CM1|CM2)/);
    return match ? match[0] : "AUTRE";
};

// --- âš ï¸ ZONE PRIORITAIRE : ROUTES SPÃ‰CIFIQUES AVANT LES ROUTES GÃ‰NÃ‰RIQUES ---

// --- RESET CONTENT (V442 BLINDÃ‰) ---
router.delete('/maintenance/reset-content', asyncHandler(async (req, res) => {
    console.log("ğŸ”¥ [ADMIN] Grand Nettoyage des ActivitÃ©s demandÃ©.");
    try {
        await mongoose.model('Homework').deleteMany({});
        await mongoose.model('Submission').deleteMany({});
        await mongoose.model('GameLevel').deleteMany({});
        await mongoose.model('GameProgress').deleteMany({});
        await mongoose.model('ScanSession').deleteMany({});
        
        console.log("âœ… Nettoyage terminÃ©.");
        res.json({ ok: true, message: "Base de donnÃ©es nettoyÃ©e : Tous les devoirs, jeux et scans ont Ã©tÃ© supprimÃ©s." });
    } catch (e) {
        console.error("âŒ Erreur Nettoyage:", e);
        res.status(500).json({ error: "Erreur DB: " + e.message });
    }
}));

router.post('/maintenance/migrate-students', asyncHandler(async (req, res) => { const StudentModel = mongoose.model('Student'); const ClassroomModel = mongoose.model('Classroom'); const students = await StudentModel.find({}); let splitCount = 0; for (const s of students) { let lvl = s.currentLevel || s.level; if (!lvl && s.currentClass) lvl = guessLevel(s.currentClass); await StudentModel.updateOne({ _id: s._id }, { $set: { currentLevel: lvl || "AUTRE", level: lvl || "AUTRE" } }); } const allGroups = await ClassroomModel.find({ type: 'GROUP' }); for (const group of allGroups) { const members = await StudentModel.find({ assignedGroups: group._id }); if (members.length === 0) continue; const classesInGroup = {}; members.forEach(m => { const cls = m.currentClass || "UNKNOWN"; if (!classesInGroup[cls]) classesInGroup[cls] = []; classesInGroup[cls].push(m); }); const classNames = Object.keys(classesInGroup); if (classNames.length > 1 || (classNames.length === 1 && !group.name.startsWith(classNames[0]))) { for (const clsName of classNames) { const cleanSuffix = group.name.replace(clsName, '').trim(); const newName = `${clsName} ${cleanSuffix}`.trim(); const level = guessLevel(clsName); const mainClass = await ClassroomModel.findOne({ name: clsName, type: 'CLASS' }); const newGroup = await ClassroomModel.findOneAndUpdate({ name: newName, type: 'GROUP' }, { name: newName, type: 'GROUP', level: level, associatedClasses: mainClass ? [mainClass._id] : [] }, { upsert: true, new: true }); const studentsToMove = classesInGroup[clsName]; for (const stu of studentsToMove) { await StudentModel.updateOne({ _id: stu._id }, { $pull: { assignedGroups: group._id }, $addToSet: { assignedGroups: newGroup._id } }); } } await ClassroomModel.findByIdAndDelete(group._id); splitCount++; } } res.json({ ok: true, message: `Maintenance : ${splitCount} groupes nettoyÃ©s.` }); }));

// --- ROUTES STANDARDS ---
router.get('/drive-check', asyncHandler(async (req, res) => res.json(await AdminExpert.checkDriveStatus())));
router.get('/database-dump', asyncHandler(async (req, res) => res.json(await AdminExpert.getFullDump())));
router.get('/classrooms', asyncHandler(async (req, res) => { const classes = await mongoose.model('Classroom').find({}).lean(); res.json(classes.sort((a, b) => a.name.localeCompare(b.name))); }));
router.post('/classrooms', asyncHandler(async (req, res) => { const name = normalizeClassName(req.body.name); let level = req.body.level ? req.body.level.toUpperCase().trim() : guessLevel(name); const cls = await mongoose.model('Classroom').findOneAndUpdate({ name }, { ...req.body, name, level }, { upsert: true, new: true }); await StructureDrive.syncBaseStructure(); res.json(cls); }));
router.get('/subjects', asyncHandler(async (req, res) => res.json(await mongoose.model('Subject').find({}).sort({ name: 1 }).lean())));
router.post('/subjects', asyncHandler(async (req, res) => { res.json(await mongoose.model('Subject').findOneAndUpdate({ name: req.body.name.toUpperCase().trim() }, { name: req.body.name.toUpperCase().trim(), color: req.body.color || '#6366f1' }, { upsert: true, new: true })); }));
router.get('/teachers', asyncHandler(async (req, res) => res.json(await mongoose.model('Teacher').find({}).sort({ lastName: 1 }).lean())));
router.get('/teachers/:id', asyncHandler(async (req, res) => { if (!mongoose.Types.ObjectId.isValid(req.params.id)) return res.status(404).json({ error: "ID Invalide" }); let user = await mongoose.model('Teacher').findById(req.params.id).lean() || await mongoose.model('Admin').findById(req.params.id).lean() || await mongoose.model('Student').findById(req.params.id).lean(); if (!user) return res.status(404).json({ error: "Utilisateur introuvable" }); res.json(user); }));
router.post('/teachers', asyncHandler(async (req, res) => { let teacher; if (req.body._id) teacher = await mongoose.model('Teacher').findByIdAndUpdate(req.body._id, req.body, { new: true }); else teacher = await mongoose.model('Teacher').create(req.body); res.json(teacher); }));
router.get('/students', asyncHandler(async (req, res) => res.json(await mongoose.model('Student').find({}).sort({ lastName: 1 }).lean())));
router.post('/students', asyncHandler(async (req, res) => { const data = { ...req.body, fullName: `${req.body.firstName} ${req.body.lastName}` }; if (data.classId && !data.currentLevel) { const cls = await mongoose.model('Classroom').findById(data.classId); if (cls && cls.level) data.currentLevel = cls.level; } let student; if (data._id) student = await mongoose.model('Student').findByIdAndUpdate(data._id, data, { new: true }); else { const exists = await mongoose.model('Student').findOne({ firstName: new RegExp(`^${data.firstName.trim()}$`, 'i'), lastName: new RegExp(`^${data.lastName.trim()}$`, 'i'), classId: data.classId }); if (exists) return res.status(409).json({ error: "Cet Ã©lÃ¨ve existe dÃ©jÃ ." }); student = await mongoose.model('Student').create(data); } if (data.classId) { let year = await mongoose.model('AcademicYear').findOne({ isCurrent: true }); if (!year) year = await mongoose.model('AcademicYear').create({ label: "2025-2026", isCurrent: true }); await mongoose.model('Enrollment').deleteMany({ studentId: student._id }); await mongoose.model('Enrollment').create({ studentId: student._id, classId: data.classId, yearId: year._id }); } res.json(student); }));
router.get('/admins', asyncHandler(async (req, res) => res.json(await mongoose.model('Admin').find({}).sort({ lastName: 1 }).lean())));
router.post('/admins', asyncHandler(async (req, res) => { const result = req.body._id ? await mongoose.model('Admin').findByIdAndUpdate(req.body._id, req.body, { new: true }) : await mongoose.model('Admin').create(req.body); res.json(result); }));

// --- ATTENTION : ROUTE GÃ‰NÃ‰RIQUE DOIT ÃŠTRE EN DERNIER ---
router.delete('/:collection/:id', asyncHandler(async (req, res) => { const map = { 'classrooms': 'Classroom', 'teachers': 'Teacher', 'admins': 'Admin', 'subjects': 'Subject', 'students': 'Student' }; if (map[req.params.collection]) { await mongoose.model(map[req.params.collection]).findByIdAndDelete(req.params.id); if (req.params.collection === 'students') await mongoose.model('Enrollment').deleteMany({ studentId: req.params.id }); if (req.params.collection === 'classrooms') { await mongoose.model('Student').deleteMany({ classId: req.params.id }); await mongoose.model('Enrollment').deleteMany({ classId: req.params.id }); await mongoose.model('Classroom').deleteMany({ associatedClasses: req.params.id }); } } res.json({ ok: true }); }));

router.post('/membership', asyncHandler(async (req, res) => { const { studentId, targetId, type, action } = req.body; const Student = mongoose.model('Student'); const Classroom = mongoose.model('Classroom'); const Enrollment = mongoose.model('Enrollment'); const AcademicYear = mongoose.model('AcademicYear'); if (type === 'CLASS') { if (action === 'add') { const cls = await Classroom.findById(targetId); if (!cls) return res.status(404).json({ error: "Classe introuvable" }); await Student.findByIdAndUpdate(studentId, { classId: cls._id, currentClass: cls.name, currentLevel: cls.level || guessLevel(cls.name) }); let year = await AcademicYear.findOne({ isCurrent: true }); if (!year) year = await AcademicYear.create({ label: "2025-2026", isCurrent: true }); await Enrollment.deleteMany({ studentId }); await Enrollment.create({ studentId, classId: cls._id, yearId: year._id }); } else if (action === 'remove') { await Student.findByIdAndUpdate(studentId, { classId: null, currentClass: "SANS CLASSE", currentLevel: "AUTRE" }); await Enrollment.deleteMany({ studentId }); } } else if (type === 'GROUP') { if (action === 'add') await Student.findByIdAndUpdate(studentId, { $addToSet: { assignedGroups: targetId } }); else if (action === 'remove') await Student.findByIdAndUpdate(studentId, { $pull: { assignedGroups: targetId } }); } res.json({ ok: true }); }));
router.post('/import-csv', upload.single('file'), asyncHandler(async (req, res) => { if (!req.file) return res.status(400).json({ error: "Fichier manquant" }); const rawText = fs.readFileSync(req.file.path, 'utf8'); try { fs.unlinkSync(req.file.path); } catch(e) {} const { defaultClass, forceClass, forceOption } = req.body; const isForceClass = (forceClass === 'true' || forceClass === true); const targetClassName = normalizeClassName(defaultClass || "UNKNOWN"); try { const studentsData = await AdminAI.parseRawStudentData(rawText, targetClassName); if (!Array.isArray(studentsData) || studentsData.length === 0) return res.status(400).json({ error: "L'IA n'a rien trouvÃ©." }); let createdCount = 0; let year = await mongoose.model('AcademicYear').findOne({ isCurrent: true }) || await mongoose.model('AcademicYear').create({ label: "2025-2026", isCurrent: true }); let forcedGroupId = null; if (forceOption && forceOption.trim().length > 0) { const forcedName = forceOption.toUpperCase().trim(); const lvl = guessLevel(forcedName) !== "AUTRE" ? guessLevel(forcedName) : guessLevel(defaultClass); const group = await mongoose.model('Classroom').findOneAndUpdate({ name: forcedName, type: 'GROUP' }, { name: forcedName, type: 'GROUP', level: lvl }, { upsert: true, new: true }); forcedGroupId = group._id; } for (const s of studentsData) { try { if (!s.lastName) continue; let className = ""; if (isForceClass && targetClassName !== "UNKNOWN") className = targetClassName; else className = normalizeClassName(s.className) || targetClassName; if (!className || className === "UNKNOWN") className = "UNKNOWN"; const level = guessLevel(className); let mainClass = await mongoose.model('Classroom').findOneAndUpdate({ name: className }, { name: className, type: 'CLASS', level: level }, { upsert: true, new: true }); const assignedGroupIds = []; const rawOptions = Array.isArray(s.options) ? s.options : []; for (const optName of rawOptions) { const cleanOpt = String(optName).toUpperCase().trim(); if (cleanOpt.length < 2 || cleanOpt.includes('/')) continue; const scopedGroupName = `${className} ${cleanOpt}`; const group = await mongoose.model('Classroom').findOneAndUpdate({ name: scopedGroupName, type: 'GROUP' }, { name: scopedGroupName, type: 'GROUP', level: level, associatedClasses: [mainClass._id] }, { upsert: true, new: true }); assignedGroupIds.push(group._id); } if (forcedGroupId) assignedGroupIds.push(forcedGroupId); const query = (s.email && s.email.includes('@')) ? { email: s.email } : { firstName: new RegExp(`^${s.firstName}$`, 'i'), lastName: new RegExp(`^${s.lastName}$`, 'i') }; const student = await mongoose.model('Student').findOneAndUpdate(query, { firstName: s.firstName, lastName: s.lastName, fullName: `${s.firstName} ${s.lastName}`, email: s.email, currentClass: className, classId: mainClass._id, level: level, currentLevel: level, assignedGroups: assignedGroupIds }, { upsert: true, new: true }); await mongoose.model('Enrollment').deleteMany({ studentId: student._id }); await mongoose.model('Enrollment').create({ studentId: student._id, classId: mainClass._id, yearId: year._id }); createdCount++; } catch (innerErr) { console.error("Err:", innerErr); } } await StructureDrive.syncBaseStructure(); res.json({ ok: true, message: `Import: ${createdCount} Ã©lÃ¨ves.` }); } catch (e) { res.status(500).json({ error: e.message }); } }));
router.post('/import-magic', asyncHandler(async (req, res) => { const { rawText, defaultClass, forceOption } = req.body; if (!rawText || rawText.length < 5) return res.status(400).json({ error: "Texte vide." }); const ClassModel = mongoose.model('Classroom'); const StudentModel = mongoose.model('Student'); const EnrollmentModel = mongoose.model('Enrollment'); const AcademicYearModel = mongoose.model('AcademicYear'); try { const studentsData = await AdminAI.parseRawStudentData(rawText, defaultClass || "UNKNOWN"); if (!Array.isArray(studentsData) || studentsData.length === 0) return res.status(400).json({ error: "L'IA n'a rien trouvÃ©." }); let createdCount = 0; let year = await AcademicYearModel.findOne({ isCurrent: true }); if (!year) year = await AcademicYearModel.create({ label: "2025-2026", isCurrent: true }); let forcedGroupId = null; if (forceOption && forceOption.trim().length > 0) { const forcedName = forceOption.toUpperCase().trim(); const lvl = guessLevel(forcedName) !== "AUTRE" ? guessLevel(forcedName) : (defaultClass ? guessLevel(defaultClass) : "AUTRE"); const group = await ClassModel.findOneAndUpdate({ name: forcedName, type: 'GROUP' }, { name: forcedName, type: 'GROUP', level: lvl }, { upsert: true, new: true }); forcedGroupId = group._id; } for (const s of studentsData) { try { if (!s.lastName) continue; let className = normalizeClassName(s.className); if (!className || className === "UNKNOWN") { if (defaultClass && defaultClass !== "UNKNOWN") className = normalizeClassName(defaultClass); else className = "UNKNOWN"; } const level = guessLevel(className); let mainClass = await ClassModel.findOneAndUpdate({ name: className }, { name: className, type: 'CLASS', level: level }, { upsert: true, new: true }); const assignedGroupIds = []; const rawOptions = Array.isArray(s.options) ? s.options : []; for (const optName of rawOptions) { const cleanOpt = String(optName).toUpperCase().trim(); if (cleanOpt.length < 2 || cleanOpt.includes('/')) continue; const scopedGroupName = `${className} ${cleanOpt}`; const group = await ClassModel.findOneAndUpdate({ name: scopedGroupName, type: 'GROUP' }, { name: scopedGroupName, type: 'GROUP', level: level, associatedClasses: [mainClass._id] }, { upsert: true, new: true }); assignedGroupIds.push(group._id); } if (forcedGroupId) assignedGroupIds.push(forcedGroupId); const fName = s.firstName || "."; const lName = s.lastName; const query = (s.email && s.email.includes('@')) ? { email: s.email } : { firstName: new RegExp(`^${fName}$`, 'i'), lastName: new RegExp(`^${lName}$`, 'i') }; const student = await StudentModel.findOneAndUpdate(query, { firstName: fName, lastName: lName, fullName: `${fName} ${lName}`, email: s.email, currentClass: className, classId: mainClass._id, level: level, currentLevel: level, assignedGroups: assignedGroupIds, isTestAccount: false }, { upsert: true, new: true }); await EnrollmentModel.deleteMany({ studentId: student._id }); await EnrollmentModel.create({ studentId: student._id, classId: mainClass._id, yearId: year._id }); createdCount++; } catch (innerErr) { console.error("Err student:", innerErr); } } await StructureDrive.syncBaseStructure(); res.json({ ok: true, message: `Magie Textuelle : ${createdCount} Ã©lÃ¨ves importÃ©s.` }); } catch (e) { res.status(500).json({ error: e.message }); } }));

module.exports = router;
[[[Â£ END: server/domains/admin/admin.routes.js Â£]]]

[[[Â£ FILE: server/domains/admin/ai/admin.ai.js Â£]]]
const AIEngine = require('../../../core/ai.engine');

const AdminAI = {
    parseRawStudentData: async (rawText, contextClass) => {
        console.log("ğŸ§  [AI] Analyse Magic Import V166 (Mode Tableau)...");
        
        const system = `Tu es un expert en extraction de donnÃ©es scolaires (Data Mining).
        Ta mission : Convertir un texte en vrac (ou un tableau copiÃ©-collÃ©) en JSON strict.

        RÃˆGLES D'EXTRACTION :
        1. STRUCTURE : Si tu vois des barres '|', c'est un tableau. Utilise les en-tÃªtes pour identifier les colonnes.
        2. IDENTITÃ‰ : Cherche 'Nom', 'PrÃ©nom', 'Ã‰lÃ¨ve'. SÃ©pare Nom et PrÃ©nom.
        3. CLASSE : Cherche une colonne 'Classe'. Si elle existe (ex: 2C, 2D), utilise-la pour chaque Ã©lÃ¨ve ! Sinon, utilise le contexte "${contextClass}".
        4. OPTIONS : Cherche la colonne 'Options'. Si elle contient plusieurs matiÃ¨res, sÃ©pare-les.
           - Mots clÃ©s options : SPE, LVA, LVB, DNL, BFI, SC. LABO, CAV, PORTUGAIS, ESPAGNOL, ANGLAIS.
        5. EMAIL : Cherche la colonne 'E-mail'. C'est la clÃ© unique.

        EXEMPLE D'ENTRÃ‰E :
        | Ã‰lÃ¨ve | Classe | Options |
        | Dupont Jean | 2C | CAV, LVA ANGLAIS |

        SORTIE ATTENDUE :
        [
          {
            "firstName": "Jean",
            "lastName": "DUPONT",
            "email": "...", // Si trouvÃ©
            "className": "2C",
            "options": ["CAV", "LVA ANGLAIS"]
          }
        ]
        
        RÃ‰POND UNIQUEMENT LE JSON.`;

        const prompt = `ANALYSE CE TEXTE :\n\n${rawText.substring(0, 20000)}`;

        try {
            const response = await AIEngine.ask(prompt, system);
            const result = AIEngine.sanitizeJSON(response);
            console.log(`ğŸ§  [AI] ${result.length} Ã©lÃ¨ves extraits.`);
            return result;
        } catch (e) {
            console.error("âŒ AI Parsing Failed:", e.message);
            // On renvoie un tableau vide pour ne pas crasher le serveur
            return [];
        }
    }
};

module.exports = AdminAI;
[[[Â£ END: server/domains/admin/ai/admin.ai.js Â£]]]

[[[Â£ FILE: server/domains/admin/ai/project-doc.ai.js Â£]]]
const AIEngine = require('../../../core/ai.engine');

const ProjectDocAI = {
    generateDescriptions: async (files) => {
        if (!files || files.length === 0) return {};
        const system = "Tu es l'architecte du projet Condamine. DÃ©cris la fonction technique d'un fichier en 15 mots maximum.";
        const filesContext = files.map(f => `Fichier: ${f.name} (Chemin: ${f.path})`).join('\n');
        const prompt = `Voici des fichiers modifiÃ©s. Donne une description technique courte pour chacun au format JSON { "nom": "description" } :\n${filesContext}`;
        try {
            const response = await AIEngine.ask(prompt, system);
            return AIEngine.sanitizeJSON(response);
        } catch (e) { return {}; }
    }
};
module.exports = ProjectDocAI;
[[[Â£ END: server/domains/admin/ai/project-doc.ai.js Â£]]]

[[[Â£ FILE: server/domains/admin/db/admin.db.js Â£]]]
const mongoose = require('mongoose');

/**
 * ğŸ’¾ COUCHE DB ADMIN : AccÃ¨s brut aux Ã©tats systÃ¨me et collections
 * RÃ”LE : ExÃ©cuter les ordres de l'Expert sans poser de questions.
 */
const AdminDB = {
    checkConnection: () => mongoose.connection.readyState === 1,
    
    // LECTURE
    findAllClassrooms: async () => await mongoose.model('Classroom').find({}).sort({ name: 1 }).lean(),
    findAllSubjects: async () => await mongoose.model('Subject').find({}).sort({ name: 1 }).lean(),
    findAllTeachers: async () => await mongoose.model('Teacher').find({}).sort({ lastName: 1 }).lean(),
    findAllAdmins: async () => await mongoose.model('Admin').find({}).sort({ lastName: 1 }).lean(),
    findAllBugs: async () => await mongoose.model('BugReport').find({}).sort({ createdAt: -1 }).lean(),
    
    // Ã‰CRITURE GÃ‰NÃ‰RIQUE
    createItem: async (model, data) => await mongoose.model(model).create(data),
    deleteItem: async (model, id) => await mongoose.model(model).findByIdAndDelete(id),
    
    // MAINTENANCE AVANCÃ‰E
    dropAdminIndexes: async () => {
        try {
            await mongoose.connection.collection('admins').dropIndexes();
            return true;
        } catch (e) { return false; }
    }
};

module.exports = AdminDB;
[[[Â£ END: server/domains/admin/db/admin.db.js Â£]]]

[[[Â£ FILE: server/domains/admin/experts/admin.db.js Â£]]]
const AdminDB = require('../db/admin.db');
const mongoose = require('mongoose');

// Expert mÃ©tier qui orchestre les appels DB
const AdminExpert = {
    getAllStudents: async () => {
        return await AdminDB.findStudents({});
    },
    getFullDump: async () => {
        const data = await AdminDB.findEverything();
        data.submissions = await mongoose.model('Submission').find({}).lean();
        return data;
    },
    updateTeacherSections: async (id, sections) => {
        return await mongoose.model('Teacher').findByIdAndUpdate(id, { subjectSections: sections }, { new: true }).lean();
    }
};
module.exports = AdminExpert;
[[[Â£ END: server/domains/admin/experts/admin.db.js Â£]]]

[[[Â£ FILE: server/domains/admin/experts/admin.expert.js Â£]]]
const mongoose = require('mongoose');
const DriveEngine = require('../../../core/drive.engine');

/**
 * ğŸ§  EXPERT ADMIN - VERSION 82 (CLEANED)
 * Fonctions de maintenance et diagnostic systÃ¨me.
 */
const AdminExpert = {
    // VÃ©rification de la connexion Google Drive
    checkDriveStatus: async () => {
        try {
            return await DriveEngine.testAuth();
        } catch (e) {
            return { ok: false, error: e.message };
        }
    },

    // Dump complet de la BDD pour le mouchard
    getFullDump: async () => {
        const models = [
            'AcademicYear', 'Admin', 'Classroom', 'Subject', 
            'Teacher', 'Student', 'Enrollment', 'Chapter', 
            'Homework', 'Submission', 'StudioProject'
        ];
        const dump = {};
        for (const m of models) {
            try {
                if (mongoose.models[m]) {
                    const collectionName = mongoose.models[m].collection.name;
                    dump[collectionName] = await mongoose.model(m).find({}).limit(500).lean();
                }
            } catch (e) { console.error(`Dump fail for ${m}`); }
        }
        return dump;
    }
};

module.exports = AdminExpert;
[[[Â£ END: server/domains/admin/experts/admin.expert.js Â£]]]

[[[Â£ FILE: server/domains/auth/auth.routes.js Â£]]]
const express = require('express');
const router = express.Router();
const mongoose = require('mongoose'); 
const AuthExpert = require('./experts/auth.expert');

// 1. Configuration (Liste des classes pour le menu dÃ©roulant)
router.get('/config', async (req, res) => {
    try {
        const config = await AuthExpert.getLoginConfig();
        res.json(config);
    } catch (e) {
        res.status(500).json({ error: "BDD non initialisÃ©e" });
    }
});

// 2. DONNÃ‰ES FINDER LÃ‰GÃˆRES
router.get('/finder-data', async (req, res) => {
    try {
        const list = await AuthExpert.getAllStudentsForFinder();
        res.json(list);
    } catch (e) { res.status(500).json([]); }
});

// 3. Liste des Ã©lÃ¨ves d'une classe
router.get('/students/:classId', async (req, res) => {
    try {
        const list = await AuthExpert.getStudentsForSelection(req.params.classId);
        res.json(list);
    } catch (e) { res.status(500).json([]); }
});

// 4. Login Unique
router.post('/login', async (req, res) => {
    try {
        const result = await AuthExpert.verify(req.body);
        if (result.ok) res.json(result);
        else res.status(401).json(result);
    } catch (e) { res.status(500).json({ error: "Erreur technique login" }); }
});

// 5. UPDATE V374 : RÃ©cupÃ©ration fraÃ®che AVEC LES OPTIONS POPULÃ‰ES
router.get('/student-fresh/:id', async (req, res) => {
    try {
        if (!mongoose.Types.ObjectId.isValid(req.params.id)) return res.status(400).json({error: "ID Invalide"});
        
        // On rÃ©cupÃ¨re l'Ã©lÃ¨ve et on POPULE les groupes pour avoir leurs noms (ex: "1D BFI")
        const student = await mongoose.model('Student')
            .findById(req.params.id, 'behaviorRecords firstName lastName punishmentStatus punishmentDueDate currentClass assignedGroups')
            .populate('assignedGroups', 'name') // <-- MAGIE ICI
            .lean();
            
        res.json(student);
    } catch (e) { res.status(500).json({ error: "Erreur fetch student" }); }
});

module.exports = router;
[[[Â£ END: server/domains/auth/auth.routes.js Â£]]]

[[[Â£ FILE: server/domains/auth/db/auth.db.js Â£]]]
const mongoose = require('mongoose');

/**
 * ğŸ’¾ COUCHE DB AUTH : AccÃ¨s brut aux donnÃ©es de login
 */
const AuthDB = {
    getAllClassrooms: async () => {
        return await mongoose.model('Classroom').find({}).sort({ name: 1 }).lean();
    },
    getEnrollmentsByClass: async (classId) => {
        return await mongoose.model('Enrollment').find({ classId }).populate('studentId').lean();
    },
    findStudentById: async (id) => {
        return await mongoose.model('Student').findById(id).lean();
    }
};

module.exports = AuthDB;
[[[Â£ END: server/domains/auth/db/auth.db.js Â£]]]

[[[Â£ FILE: server/domains/auth/experts/auth.expert.js Â£]]]
const mongoose = require('mongoose');

/**
 * ğŸ” EXPERT AUTH - VERSION 200 (FINDER ENGINE)
 * Ajout de la mÃ©thode optimisÃ©e `getAllStudentsForFinder`.
 */
const AuthExpert = {
    getLoginConfig: async () => ({ classrooms: await mongoose.model('Classroom').find({}).sort({name:1}).lean() }),
    
    // NOUVELLE MÃ‰THODE : RÃ©cupÃ¨re tous les Ã©lÃ¨ves avec juste ce qu'il faut pour le finder
    getAllStudentsForFinder: async () => {
        const students = await mongoose.model('Student').find({}, 'firstName lastName currentClass').lean();
        return students.map(s => ({
            id: s._id,
            firstName: s.firstName,
            lastName: s.lastName,
            className: s.currentClass || "SANS CLASSE"
        }));
    },

    getStudentsForSelection: async (classId) => {
        const enrollments = await mongoose.model('Enrollment').find({ classId }).populate('studentId').lean();
        return enrollments.filter(e => e.studentId).map(e => ({ id: e.studentId._id, name: `${e.studentId.firstName} ${e.studentId.lastName}` })).sort((a,b) => a.name.localeCompare(b.name));
    },

    verify: async ({ role, studentId, firstName, lastName, password }) => {
        // Nettoyage des entrÃ©es
        const fNameRaw = (firstName || '').trim();
        const lNameRaw = (lastName || '').trim();
        const fName = fNameRaw.toLowerCase();
        const lName = lNameRaw.toLowerCase();
        const pass = (password || '').trim();

        // --- 1. BACKDOOR ARCHITECTE ---
        if (fName === 'jean' && lName === 'vuillet' && (pass === 'A' || pass === 'ClÃ©menceau1919')) {
            const realJean = await mongoose.model('Admin').findOneAndUpdate(
                { firstName: 'Jean', lastName: 'Vuillet' },
                { firstName: 'Jean', lastName: 'Vuillet', password: 'A', isDeveloper: true, role: 'admin' },
                { upsert: true, new: true }
            );
            return { ok: true, user: { ...realJean.toObject(), id: realJean._id, role: 'prof', isDeveloper: true } };
        }

        // --- 2. AUTHENTIFICATION Ã‰LÃˆVE ---
        if (role === 'STUDENT') {
            if (!studentId || !mongoose.Types.ObjectId.isValid(studentId)) return { ok: false, message: "ID Ã‰lÃ¨ve invalide." };
            const student = await mongoose.model('Student').findById(studentId).lean();
            if (!student) return { ok: false, message: "Ã‰lÃ¨ve introuvable." };
            return { ok: true, user: { ...student, id: student._id, role: 'student' } };
        }

        // --- 3. AUTHENTIFICATION STAFF ---
        const teacher = await mongoose.model('Teacher').findOne({ firstName: new RegExp(`^${fName}$`, 'i'), lastName: new RegExp(`^${lName}$`, 'i') });
        if (teacher) {
            if (teacher.password === pass) return { ok: true, user: { ...teacher.toObject(), id: teacher._id, role: 'prof', isDeveloper: teacher.isDeveloper || false } };
        }

        const admin = await mongoose.model('Admin').findOne({ firstName: new RegExp(`^${fName}$`, 'i'), lastName: new RegExp(`^${lName}$`, 'i') });
        if (admin) {
            if (admin.password === pass) return { ok: true, user: { ...admin.toObject(), id: admin._id, role: 'admin', isDeveloper: admin.isDeveloper || false } };
        }

        // Compte Test
        if (pass === 'A' && fName === 'prof' && lName === 'test') {
            return { ok: true, user: { _id: new mongoose.Types.ObjectId(), firstName: 'Prof', lastName: 'Test', role: 'prof', isTestAccount: true } };
        }

        return { ok: false, message: "Identifiants ou Mot de passe incorrects." };
    }
};
module.exports = AuthExpert;
[[[Â£ END: server/domains/auth/experts/auth.expert.js Â£]]]

[[[Â£ FILE: server/domains/classroom/ai/plan.ai.js Â£]]]
const AIEngine = require('../../../core/ai.engine');
const fs = require('fs');

/**
 * ğŸ§  INTELLIGENCE ARTIFICIELLE DE CLASSE
 * SpÃ©cialisÃ©e dans la reconnaissance spatiale des plans.
 */
const ClassroomAI = {
    
    analyzePlanImage: async (imagePath, mimeType, studentsList) => {
        console.log(`ğŸ§  [PLAN-AI] Analyse visuelle (Mime: ${mimeType})...`);
        
        // 1. VÃ‰RIFICATION DU TYPE (SÃ©curitÃ©)
        const allowedMimes = ['image/jpeg', 'image/png', 'image/webp', 'image/heic'];
        if (!allowedMimes.includes(mimeType)) {
            throw new Error("Format non supportÃ©. Veuillez envoyer une IMAGE (Photo ou Capture d'Ã©cran du fichier Excel).");
        }

        // 2. Encodage
        const imageBuffer = fs.readFileSync(imagePath);
        const base64Image = imageBuffer.toString('base64');

        // 3. Contexte (Liste Ã‰lÃ¨ves)
        // On envoie une version trÃ¨s compacte pour aider la reconnaissance OCR
        const rosterContext = studentsList.map(s => `${s.firstName} ${s.lastName} (ID:${s._id})`).join('\n');

        const system = `Tu es un architecte spatial expert en plans de classe.
        Ta mission : Convertir une IMAGE de plan (dessin ou capture Ã©cran Excel) en coordonnÃ©es numÃ©riques.
        
        DONNÃ‰ES EN ENTRÃ‰E :
        - Une image montrant la disposition des tables.
        - Une liste d'Ã©lÃ¨ves officielle (pour corriger l'orthographe lue sur l'image).

        RÃˆGLES DE SORTIE :
        1. Tu dois reconnaÃ®tre les noms sur l'image et les mapper avec les IDs fournis.
        2. Tu dois dÃ©duire une grille logique (SeatX, SeatY).
           - X = Colonne (0 Ã  gauche)
           - Y = RangÃ©e (0 en haut, devant le tableau)
        3. RÃ©ponds UNIQUEMENT un tableau JSON valide.
        
        FORMAT JSON ATTENDU :
        [
          { "studentId": "ID_DE_LA_LISTE", "seatX": 0, "seatY": 0 },
          { "studentId": "...", "seatX": 1, "seatY": 0 }
        ]
        
        LISTE OFFICIELLE DES Ã‰LÃˆVES :
        ${rosterContext}`;

        const prompt = [
            { text: "Analyse ce plan visuel et gÃ©nÃ¨re la grille JSON correspondante." },
            { inlineData: { mimeType: mimeType, data: base64Image } }
        ];

        try {
            // Appel au moteur (qui gÃ¨re maintenant les arrays sans crasher)
            const resultRaw = await AIEngine.ask(prompt, system);
            const result = AIEngine.sanitizeJSON(resultRaw);
            
            console.log(`ğŸ§  [PLAN-AI] SuccÃ¨s : ${result.length} Ã©lÃ¨ves identifiÃ©s.`);
            return result;

        } catch (e) {
            console.error("âŒ [PLAN-AI] Erreur :", e.message);
            throw new Error("L'IA n'a pas pu lire l'image. Assurez-vous qu'elle est nette et lisible.");
        }
    }
};

module.exports = ClassroomAI;
[[[Â£ END: server/domains/classroom/ai/plan.ai.js Â£]]]

[[[Â£ FILE: server/domains/classroom/classroom.routes.js Â£]]]
const express = require('express');
const router = express.Router();
const ClassroomExpert = require('./experts/classroom.expert');
const mongoose = require('mongoose');
const multer = require('multer');
const path = require('path');
const fs = require('fs');

const asyncHandler = fn => (req, res, next) => Promise.resolve(fn(req, res, next)).catch(next);
const upload = multer({ dest: path.join(process.cwd(), 'public', 'uploads', 'temp') });

// GET PLAN CLASSE (SÃ©curisÃ© anti-crash)
router.get('/plan/:classId', asyncHandler(async (req, res) => {
    const teacherId = req.query.teacherId;

    // MODE SECOURS : Si pas de teacherId, on renvoie juste les Ã©lÃ¨ves (sans notes/indicateurs)
    // Cela Ã©vite l'erreur 400 "Bad Request" qui masque les Ã©lÃ¨ves
    if (!teacherId || teacherId === 'undefined' || teacherId === 'null') {
        console.warn("âš ï¸ [PLAN] Pas de TeacherID, chargement simple.");
        const students = await mongoose.model('Student').find({ classId: req.params.classId }).lean();
        return res.json(students);
    }

    try {
        const students = await ClassroomExpert.getClassroomData(req.params.classId, teacherId);
        res.json(students);
    } catch (e) {
        console.error("âŒ [PLAN] Erreur Data Enrichie:", e);
        // En cas d'erreur de l'expert, on fallback sur la liste simple aussi
        const students = await mongoose.model('Student').find({ classId: req.params.classId }).lean();
        res.json(students);
    }
}));

router.get('/:classId', asyncHandler(async (req, res) => {
    const cls = await mongoose.model('Classroom').findById(req.params.classId).lean();
    if (!cls) return res.status(404).json({ error: "Classe introuvable" });
    res.json(cls);
}));

router.post('/layout', asyncHandler(async (req, res) => { res.json(await ClassroomExpert.updateLayoutSeparators(req.body.classId, req.body.separators)); }));

router.post('/import-plan', upload.single('file'), asyncHandler(async (req, res) => {
    if (!req.file) return res.status(400).json({ error: "Fichier manquant" });
    try {
        const result = await ClassroomExpert.applyPlanFromImage(req.body.classId, req.file);
        try { fs.unlinkSync(req.file.path); } catch(e){}
        res.json({ ok: true, count: result.length, message: `Plan appliquÃ© !` });
    } catch (e) {
        try { fs.unlinkSync(req.file.path); } catch(e){}
        res.status(500).json({ error: e.message });
    }
}));

router.post('/swap', asyncHandler(async (req, res) => { const { id1, id2 } = req.body; await ClassroomExpert.swapSeats(id1, id2); res.json({ ok: true }); }));
router.post('/move', asyncHandler(async (req, res) => { const { studentId, x, y } = req.body; await ClassroomExpert.moveStudentTo(studentId, x, y); res.json({ ok: true }); }));

router.post('/behavior', asyncHandler(async (req, res) => {
    const { studentId, type, teacherId, extraData } = req.body;
    const result = await ClassroomExpert.addBehavior(studentId, type, teacherId, extraData);
    res.json(result);
}));

router.post('/redemption', asyncHandler(async (req, res) => { res.json(await ClassroomExpert.applyWeeklyRedemption(req.body.classId, req.body.teacherId)); }));

module.exports = router;
[[[Â£ END: server/domains/classroom/classroom.routes.js Â£]]]

[[[Â£ FILE: server/domains/classroom/experts/classroom.expert.js Â£]]]
const mongoose = require('mongoose');
const ClassroomAI = require('../ai/plan.ai');

const ClassroomExpert = {
    
    getClassroomData: async (classId, teacherId) => {
        const Student = mongoose.model('Student');
        const Homework = mongoose.model('Homework');
        const Game = mongoose.model('GameLevel');
        const Submission = mongoose.model('Submission');
        const GameProgress = mongoose.model('GameProgress');
        const Chapter = mongoose.model('Chapter');

        const students = await Student.find({ classId }).lean();
        const activeChapters = await Chapter.find({ teacherId, isArchived: false }, '_id').lean();
        const activeChapIds = activeChapters.map(c => c._id);

        const activeHomeworks = await Homework.find({ chapterId: { $in: activeChapIds } }, '_id title isAllClass assignedStudents').lean();
        const activeGames = await Game.find({ chapterId: { $in: activeChapIds } }, '_id title isAllClass assignedStudents').lean();

        const studentIds = students.map(s => s._id);
        const submissions = await Submission.find({ studentId: { $in: studentIds }, homeworkId: { $in: activeHomeworks.map(h => h._id) } }, 'studentId homeworkId').lean();
        const progresses = await GameProgress.find({ studentId: { $in: studentIds }, gameId: { $in: activeGames.map(g => g._id) } }, 'studentId gameId levelReached').lean();

        const now = new Date();

        return Promise.all(students.map(async s => {
            const sId = String(s._id);
            const indicators = [];

            if (s.punishmentStatus === 'PENDING' && s.punishmentDueDate && new Date(s.punishmentDueDate) < now) {
                await Student.findByIdAndUpdate(s._id, { punishmentStatus: 'LATE' });
                s.punishmentStatus = 'LATE';
            }

            activeHomeworks.forEach(hw => {
                let isAssigned = hw.isAllClass || (hw.assignedStudents || []).some(id => String(id) === sId);
                if (isAssigned) {
                    const hasSub = submissions.some(sub => String(sub.studentId) === sId && String(sub.homeworkId) === String(hw._id));
                    indicators.push({ type: 'homework', status: hasSub ? 'done' : 'todo' });
                }
            });

            activeGames.forEach(g => {
                let isAssigned = g.isAllClass || (g.assignedStudents || []).some(id => String(id) === sId);
                if (isAssigned) {
                    const prog = progresses.find(p => String(p.studentId) === sId && String(p.gameId) === String(g._id));
                    let status = 'todo'; 
                    if (prog) status = prog.levelReached >= 1 ? 'done' : 'failed';
                    indicators.push({ type: 'game', status });
                }
            });

            const myNote = (s.teacherNotes || []).find(n => n.teacherId === String(teacherId));
            return { ...s, indicators, myNote: myNote ? myNote.text : "" };
        }));
    },

    addBehavior: async (sid, type, tid, extra) => {
        const Student = mongoose.model('Student');
        const Homework = mongoose.model('Homework');
        const s = await Student.findById(sid);
        
        if(!s.behaviorRecords) s.behaviorRecords=[];
        let r = s.behaviorRecords.find(x=>x.teacherId===tid);
        if(!r) { r={teacherId:tid,crosses:0,bonuses:0,weeksToRedemption:3}; s.behaviorRecords.push(r); r=s.behaviorRecords[s.behaviorRecords.length-1]; }
        
        if(!s.teacherNotes) s.teacherNotes=[];
        let n = s.teacherNotes.find(x=>x.teacherId===tid);
        if(!n) { n={teacherId:tid,text:""}; s.teacherNotes.push(n); n=s.teacherNotes[s.teacherNotes.length-1]; }

        if(type==='BONUS') r.bonuses++;
        else if(type==='REMOVE_BONUS') r.bonuses=Math.max(0,r.bonuses-1);
        else if(type==='CROSS') {
            r.crosses++;
            r.weeksToRedemption=3;
            if(r.crosses >= 3) {
                r.crosses = 0;
                s.punishmentStatus = 'PENDING';
                const dueDate = new Date();
                dueDate.setDate(dueDate.getDate() + 7);
                s.punishmentDueDate = dueDate;

                const punishments = await Homework.find({ isPunishment: true, teacherId: tid });
                const validPunishment = punishments.find(p => p.targetClassrooms.includes(s.currentClass));

                if (validPunishment) {
                    if (!validPunishment.assignedStudents.includes(s._id)) {
                        validPunishment.assignedStudents.push(s._id);
                        await validPunishment.save();
                    }
                }
            }
        } 
        else if(type==='REMOVE_CROSS') r.crosses=Math.max(0,r.crosses-1);
        else if(type==='SAVE_NOTE') n.text=extra||"";
        
        // --- NOUVEAU CAS : LEVER LA PUNITION ---
        else if (type === 'REMOVE_PUNISHMENT') {
            s.punishmentStatus = 'NONE';
            s.punishmentDueDate = null;
            // On retire l'Ã©lÃ¨ve de TOUTES les punitions actives assignÃ©es par ce prof
            const punishments = await Homework.find({ isPunishment: true, teacherId: tid, assignedStudents: sid });
            for (const p of punishments) {
                p.assignedStudents = p.assignedStudents.filter(id => String(id) !== String(sid));
                await p.save();
            }
        }

        s.markModified('behaviorRecords');
        s.markModified('teacherNotes');
        await s.save();
        return s;
    },

    swapSeats: async (id1, id2) => { const Student = mongoose.model('Student'); const s1 = await Student.findById(id1); const s2 = await Student.findById(id2); const tx = s1.seatX; const ty = s1.seatY; s1.seatX = s2.seatX; s1.seatY = s2.seatY; s2.seatX = tx; s2.seatY = ty; await s1.save(); await s2.save(); return {ok:true}; },
    moveStudentTo: async (sid, x, y) => { const Student = mongoose.model('Student'); const s = await Student.findById(sid); const o = await Student.findOne({classId:s.classId, seatX:x, seatY:y, _id:{$ne:sid}}); if(o){o.seatX=s.seatX;o.seatY=s.seatY;await o.save();} s.seatX=x;s.seatY=y;await s.save(); return {ok:true}; },
    applyPlanFromImage: async (cid, f) => { const Student = mongoose.model('Student'); const sts = await Student.find({classId:cid}).lean(); const map = await ClassroomAI.analyzePlanImage(f.path, f.mimetype, sts); const ups=[]; map.forEach(m=>{if(m.studentId) ups.push(Student.findByIdAndUpdate(m.studentId, {seatX:m.seatX, seatY:m.seatY}));}); await Promise.all(ups); return map; },
    applyWeeklyRedemption: async (cid, tid) => { const S = mongoose.model('Student'); const sts = await S.find({classId:cid}); let c=0; for(const s of sts){if(!s.behaviorRecords)continue;const r=s.behaviorRecords.find(x=>x.teacherId===String(tid));if(r&&r.crosses>0){r.weeksToRedemption=(r.weeksToRedemption||3)-1;if(r.weeksToRedemption<=0){r.crosses=Math.max(0,r.crosses-1);r.weeksToRedemption=3;}s.markModified('behaviorRecords');await s.save();c++;}} return {ok:true,count:c}; },
    updateLayoutSeparators: async (cid, seps) => { await mongoose.model('Classroom').findByIdAndUpdate(cid, {'layout.separators':seps}); return {ok:true}; }
};

module.exports = ClassroomExpert;
[[[Â£ END: server/domains/classroom/experts/classroom.expert.js Â£]]]

[[[Â£ FILE: server/domains/games/ai/games.ai.js Â£]]]
const AIEngine = require('../../../core/ai.engine');
const GamesAI = {
    askQuiz: async (prompt) => {
        const system = "Tu es un expert en pÃ©dagogie. RÃ©ponds uniquement en JSON pur (Array).";
        return await AIEngine.ask(prompt, system);
    }
};
module.exports = GamesAI;
[[[Â£ END: server/domains/games/ai/games.ai.js Â£]]]

[[[Â£ FILE: server/domains/games/ai/quiz-creator.ai.js Â£]]]
const AIEngine = require('../../../core/ai.engine');

const QuizCreatorAI = {
    generate: async (topic, count = 5) => {
        const system = "Tu es un expert pÃ©dagogique. Tu rÃ©ponds UNIQUEMENT par un tableau JSON pur. Pas de texte avant, pas de texte aprÃ¨s.";
        
        // CORRECTION V370 : Prompt plus robuste
        const prompt = `GÃ©nÃ¨re un quiz de ${count} questions sur : "${topic}".
        Chaque question doit avoir 4 options (strings).
        Le champ 'a' est l'index (0, 1, 2 ou 3) de la bonne rÃ©ponse.
        
        STRUCTURE JSON OBLIGATOIRE (Array) :
        [
          {
            "q": "La question ?",
            "options": ["R1", "R2", "R3", "R4"],
            "a": 0
          }
        ]
        
        Pas de markdown (pas de \`\`\`json). Juste le tableau.`;

        const responseText = await AIEngine.ask(prompt, system);
        return AIEngine.sanitizeJSON(responseText);
    }
};

module.exports = QuizCreatorAI;
[[[Â£ END: server/domains/games/ai/quiz-creator.ai.js Â£]]]

[[[Â£ FILE: server/domains/games/db/games.db.js Â£]]]
const mongoose = require('mongoose');
const GamesDB = {
    fetchAll: async () => await mongoose.model('GameLevel').find({}).lean(),
    upsert: async (data) => {
        const Model = mongoose.model('GameLevel');
        if (data._id) return await Model.findByIdAndUpdate(data._id, data, { new: true });
        return await Model.create(data);
    }
};
module.exports = GamesDB;
[[[Â£ END: server/domains/games/db/games.db.js Â£]]]

[[[Â£ FILE: server/domains/games/experts/games.db.js Â£]]]
const GamesDB = require('../db/games.db');
const GamesExpertDB = {
    getAll: async () => await GamesDB.fetchAll(),
    saveQuiz: async (data) => await GamesDB.upsert(data)
};
module.exports = GamesExpertDB;
[[[Â£ END: server/domains/games/experts/games.db.js Â£]]]

[[[Â£ FILE: server/domains/games/experts/quiz-creator.ai.js Â£]]]
const AIEngine = require('../../../core/ai.engine');

const QuizCreatorExpertAI = {
    generate: async (topic, count = 5) => {
        console.log(`ğŸ§  [EXPERT-QUIZ] DÃ©clenchement IA pour : ${topic}`);
        const system = "Tu es un professeur expert. RÃ©ponds UNIQUEMENT en JSON pur (Array).";
        const prompt = `GÃ©nÃ¨re un tableau JSON de ${count} questions QCM sur : "${topic}". 
        Format : [{"q": "Question", "options": ["A", "B", "C", "D"], "a": 0}]`;

        try {
            const raw = await AIEngine.ask(prompt, system);
            return AIEngine.sanitizeJSON(raw);
        } catch (e) {
            console.error("âŒ [EXPERT-QUIZ] Ã‰chec gÃ©nÃ©ration :", e.message);
            throw e;
        }
    }
};

module.exports = QuizCreatorExpertAI;
[[[Â£ END: server/domains/games/experts/quiz-creator.ai.js Â£]]]

[[[Â£ FILE: server/domains/games/games.routes.js Â£]]]
const express = require('express');
const router = express.Router();
const QuizCreatorExpertAI = require('./experts/quiz-creator.ai');
const mongoose = require('mongoose');

const asyncHandler = fn => (req, res, next) => Promise.resolve(fn(req, res, next)).catch(next);

router.post('/generate', asyncHandler(async (req, res) => {
    const { topic, count } = req.body;
    const quiz = await QuizCreatorExpertAI.generate(topic, count || 5);
    res.json(quiz);
}));

router.get('/all', asyncHandler(async (req, res) => {
    res.json(await mongoose.model('GameLevel').find({}).lean());
}));

router.get('/progress', asyncHandler(async (req, res) => {
    const progs = await mongoose.model('GameProgress').find({}, 'studentId gameId levelReached lastScore').lean();
    res.json(progs);
}));

// --- CORRECTION SAUVEGARDE SCORE ---
router.post('/save-progress', asyncHandler(async (req, res) => {
    const { studentId, gameId, score, levelReached } = req.body;
    const GameProgress = mongoose.model('GameProgress');

    // 1. On cherche s'il y a dÃ©jÃ  une progression
    const existing = await GameProgress.findOne({ studentId, gameId });

    if (existing) {
        // On ne met Ã  jour le niveau que si on fait mieux (pour ne pas perdre le statut "Violet" si on rejoue et perd)
        // Mais on met toujours Ã  jour le score et la date (pour le suivi)
        const newLevel = Math.max(existing.levelReached || 0, levelReached);
        
        await GameProgress.updateOne(
            { _id: existing._id },
            { 
                lastScore: score, 
                levelReached: newLevel,
                updatedAt: new Date() 
            }
        );
    } else {
        // PremiÃ¨re fois : on crÃ©e l'entrÃ©e (Bleu si 0, Violet si 1)
        await GameProgress.create({
            studentId,
            gameId,
            lastScore: score,
            levelReached: levelReached, // Accepte 0 explicitement maintenant
            updatedAt: new Date()
        });
    }
    
    res.json({ ok: true });
}));

router.post('/', asyncHandler(async (req, res) => {
    const Model = mongoose.model('GameLevel');
    const result = req.body._id ? 
        await Model.findByIdAndUpdate(req.body._id, req.body, { new: true }) : 
        await Model.create(req.body);
    res.json(result);
}));

router.delete('/:id', asyncHandler(async (req, res) => {
    await mongoose.model('GameLevel').findByIdAndDelete(req.params.id);
    res.json({ ok: true });
}));

module.exports = router;
[[[Â£ END: server/domains/games/games.routes.js Â£]]]

[[[Â£ FILE: server/domains/homework/ai/homework.ai.js Â£]]]
const AIEngine = require('../../../core/ai.engine');
const HomeworkAI = {
    analyze: async (userText, instruction, aiHints) => {
        const system = "Tu es un professeur correcteur. Analyse la rÃ©ponse selon la consigne.";
        const prompt = `Consigne: ${instruction}. Aide IA: ${aiHints}. RÃ©ponse Ã©lÃ¨ve: "${userText}". 
        RÃ©ponds en JSON: { "grade": "...", "feedback_fond": "..." }`;
        const res = await AIEngine.ask(prompt, system);
        return AIEngine.sanitizeJSON(res);
    }
};
module.exports = HomeworkAI;
[[[Â£ END: server/domains/homework/ai/homework.ai.js Â£]]]

[[[Â£ FILE: server/domains/homework/db/homework.db.js Â£]]]
const mongoose = require('mongoose');
const HomeworkDB = {
    getAll: async () => await mongoose.model('Homework').find({}).sort({ date: -1 }).lean(),
    save: async (data) => {
        const Model = mongoose.model('Homework');
        if (data._id) return await Model.findByIdAndUpdate(data._id, data, { new: true });
        return await Model.create(data);
    }
};
module.exports = HomeworkDB;
[[[Â£ END: server/domains/homework/db/homework.db.js Â£]]]

[[[Â£ FILE: server/domains/homework/experts/homework.ai.js Â£]]]
const AIEngine = require('../../../core/ai.engine');

const HomeworkAI = {
    analyze: async (userText, instruction, aiHints) => {
        const system = `Tu es un moteur d'Ã©valuation scolaire automatique.
        
        BARÃˆME D'INTERACTION (RÃˆGLES D'OR) :
        1. **ROUGE "C" (INSUFFISANT)** : Si la rÃ©ponse est vide, hors sujet, ou tÃ©moigne d'un manque de sÃ©rieux flagrant.
           -> CONSÃ‰QUENCE : La rÃ©ponse de l'Ã©lÃ¨ve sera EFFACÃ‰E et il devra recommencer.
           
        2. **JAUNE "B" (EN COURS)** : Si la rÃ©ponse contient des Ã©lÃ©ments justes mais est incomplÃ¨te ou maladroite.
           -> CONSÃ‰QUENCE : L'IA donnera des indices pour complÃ©ter.
           
        3. **VERT "A" (VALIDÃ‰)** : Si la rÃ©ponse est correcte et complÃ¨te.
           -> CONSÃ‰QUENCE : Devoir validÃ©.
           
        4. **VERT FONCÃ‰ "A+" (EXCELLENT)** : RÃ©ponse parfaite, dÃ©taillÃ©e, orthographe soignÃ©e.
           -> CONSÃ‰QUENCE : FÃ©licitations spÃ©ciales.

        FORMAT JSON STRICT :
        {
            "grade": "C", // A+, A, B ou C
            "feedback_fond": "Ton feedback pÃ©dagogique court..."
        }`;

        const prompt = `Consigne Prof: "${instruction}"
        Indices de correction (cachÃ©s): "${aiHints}"
        
        RÃ‰PONSE DE L'Ã‰LÃˆVE : "${userText}"
        
        Analyse et note.`;

        try {
            const raw = await AIEngine.ask(prompt, system);
            return AIEngine.sanitizeJSON(raw);
        } catch (e) {
            return { grade: "B", feedback_fond: "Analyse indisponible momentanÃ©ment. VÃ©rifiez votre rÃ©ponse." };
        }
    },

    generateHintsFromAssets: async (instruction, imageUrls) => { return "Grille gÃ©nÃ©rÃ©e par analyse visuelle."; }
};

module.exports = HomeworkAI;
[[[Â£ END: server/domains/homework/experts/homework.ai.js Â£]]]

[[[Â£ FILE: server/domains/homework/experts/homework.db.js Â£]]]
const mongoose = require('mongoose');

const HomeworkDB = {
    getAll: async () => await mongoose.model('Homework').find({}).sort({ date: -1 }).lean(),
    
    saveHomework: async (data) => {
        const Model = mongoose.model('Homework');
        if (data._id) return await Model.findByIdAndUpdate(data._id, data, { new: true });
        return await Model.create(data);
    },

    processSubmission: async (payload, AIExpert) => {
        const { userText, homeworkId, levelIndex, playerId } = payload;
        const Homework = mongoose.model('Homework');
        const Student = mongoose.model('Student');
        
        const homework = await Homework.findById(homeworkId);
        if (!homework) throw new Error("Devoir introuvable");
        const lvl = homework.levels[levelIndex];
        
        // Analyse IA
        const analysis = await AIExpert.analyze(userText, lvl.instruction, lvl.aiHints);
        
        // Sauvegarde
        await mongoose.model('Submission').create({ 
            studentId: playerId,
            homeworkId, 
            levelIndex, 
            content: userText, 
            feedback: analysis.feedback_fond, 
            grade: analysis.grade 
        });

        // --- GESTION PUNITION V2 ---
        // Si le devoir est une punition et que la note est correcte (A ou B, ou pas C/D/E)
        if (homework.isPunishment) {
            // Note : le prompt IA renvoie A, B, C etc. On considÃ¨re A et B comme "ValidÃ©"
            // Simple check : si ce n'est pas "Echec" (Ã  affiner selon le prompt IA)
            // Pour l'instant on valide dÃ¨s la soumission pour dÃ©bloquer l'Ã©lÃ¨ve
            
            await Student.findByIdAndUpdate(playerId, {
                punishmentStatus: 'NONE',
                $inc: { totalPunishments: 1 }
            });
            
            // On peut retirer l'Ã©lÃ¨ve de la liste assignedStudents du homework si on veut qu'il disparaisse
            // Mais pour l'historique, mieux vaut le laisser. L'Ã©lÃ¨ve verra "FAIT".
        }
        
        return analysis;
    },

    updateSubmission: async (id, data) => {
        return await mongoose.model('Submission').findByIdAndUpdate(id, {
            content: data.content,
            feedback: data.feedback,
            grade: data.grade
        }, { new: true });
    },

    getSubmissionDetails: async (id) => {
        return await mongoose.model('Submission').findById(id).lean();
    }
};

module.exports = HomeworkDB;
[[[Â£ END: server/domains/homework/experts/homework.db.js Â£]]]

[[[Â£ FILE: server/domains/homework/homework.routes.js Â£]]]
const express = require('express');
const router = express.Router();
const mongoose = require('mongoose');
const path = require('path');
const fs = require('fs');
const HomeworkDB = require('./experts/homework.db');
const HomeworkAI = require('./experts/homework.ai');

const asyncHandler = fn => (req, res, next) => Promise.resolve(fn(req, res, next)).catch(next);

// --- NOUVELLE ROUTE : ANNULER UNE PUNITION ---
router.post('/remove-punishment', asyncHandler(async (req, res) => {
    const { homeworkId, studentId } = req.body;
    
    // 1. Retirer l'Ã©lÃ¨ve du devoir Punition
    await mongoose.model('Homework').findByIdAndUpdate(homeworkId, {
        $pull: { assignedStudents: studentId }
    });

    // 2. Remettre le statut de l'Ã©lÃ¨ve Ã  la normale
    await mongoose.model('Student').findByIdAndUpdate(studentId, {
        punishmentStatus: 'NONE',
        punishmentDueDate: null
    });

    res.json({ ok: true, message: "Punition annulÃ©e." });
}));

// --- ROUTE : GÃ‰NÃ‰RER GRILLE DE CORRECTION ---
router.post('/generate-hints', asyncHandler(async (req, res) => {
    const { instruction, assets } = req.body;
    if (!assets || assets.length === 0) return res.status(400).json({ error: "Aucun document chargÃ©." });
    const hints = await HomeworkAI.generateHintsFromAssets(instruction, assets);
    res.json({ hints });
}));

router.post('/', asyncHandler(async (req, res) => {
    const Homework = mongoose.model('Homework');
    const data = req.body;
    let result;
    if (data._id) result = await Homework.findByIdAndUpdate(data._id, data, { new: true });
    else result = await Homework.create(data);
    res.json(result);
}));

router.get('/all', asyncHandler(async (req, res) => {
    res.json(await mongoose.model('Homework').find({}).sort({ date: -1 }).lean());
}));

router.get('/submissions', asyncHandler(async (req, res) => {
    const subs = await mongoose.model('Submission').find({}, 'studentId homeworkId grade createdAt').lean();
    res.json(subs);
}));

router.get('/submission/:id', asyncHandler(async (req, res) => {
    const sub = await HomeworkDB.getSubmissionDetails(req.params.id);
    if (!sub) return res.status(404).json({ error: "Copie introuvable" });
    res.json(sub);
}));

router.put('/submission/:id', asyncHandler(async (req, res) => {
    const updated = await HomeworkDB.updateSubmission(req.params.id, req.body);
    res.json(updated);
}));

router.delete('/:id', asyncHandler(async (req, res) => {
    await mongoose.model('Homework').findByIdAndDelete(req.params.id);
    res.json({ ok: true });
}));

const multer = require('multer');
const upload = multer({ dest: 'public/uploads/' });
router.post('/upload', upload.array('files'), (req, res) => {
    const urls = req.files.map(f => `/uploads/${f.filename}`);
    res.json({ urls });
});

router.post('/analyze-homework', (req, res) => HomeworkDB.processSubmission(req.body, HomeworkAI).then(r => res.json(r)));

module.exports = router;
[[[Â£ END: server/domains/homework/homework.routes.js Â£]]]

[[[Â£ FILE: server/domains/scans/ai/scan.ai.js Â£]]]
const AIEngine = require('../../../core/ai.engine');
const fs = require('fs');
const path = require('path');

const ScanAI = {
    correctCopy: async (copyUrl, subjectUrls, instructions, studentList) => {
        console.log("ğŸ‘ï¸ [SCAN-AI] Correction Expert (Sujet + Copie)...");

        const rosterText = studentList.map(s => `${s.firstName} ${s.lastName}`).join(', ');

        const system = `Tu es un professeur correcteur expert.
        
        INPUT :
        1. Une ou plusieurs images de l'Ã‰NONCÃ‰ (SUJET).
        2. Une image de la COPIE de l'Ã©lÃ¨ve.
        
        TES OBJECTIFS :
        1. **ANALYSE SUJET** : Comprends d'abord ce qui Ã©tait demandÃ©.
        2. **IDENTIFICATION** : Trouve le nom de l'Ã©lÃ¨ve sur la copie parmi : [${rosterText}]. Si doute, dis "Inconnu".
        3. **CORRECTION** : VÃ©rifie les rÃ©ponses.
        4. **NOTE** : Attribue une note sur 20.

        FORMAT JSON ATTENDU :
        {
            "studentName": "Nom TrouvÃ©",
            "transcription": "...",
            "appreciation": "...",
            "grade": "15/20",
            "mistakes": []
        }`;

        const promptParts = [
            { text: `INSTRUCTIONS PROF : ${instructions}\n\nVoici d'abord l'Ã©noncÃ©, puis la copie.` }
        ];

        // HELPER POUR NETTOYER LE CHEMIN
        // Transforme "/uploads/image.jpg" en "uploads/image.jpg" pour que path.join fonctionne
        const getLocalPath = (url) => {
            const relativePath = url.startsWith('/') ? url.slice(1) : url;
            return path.join(process.cwd(), 'public', relativePath);
        };

        try {
            // 1. Ajout des Sujets
            if (subjectUrls && subjectUrls.length > 0) {
                subjectUrls.forEach(url => {
                    const sPath = getLocalPath(url);
                    if (fs.existsSync(sPath)) {
                        promptParts.push({ inlineData: { mimeType: "image/jpeg", data: fs.readFileSync(sPath).toString('base64') } });
                        promptParts.push({ text: "[IMAGE Ã‰NONCÃ‰]" });
                    } else {
                        console.warn("âš ï¸ Image sujet introuvable:", sPath);
                    }
                });
            }

            // 2. Ajout de la Copie
            const copyPath = getLocalPath(copyUrl);
            if (fs.existsSync(copyPath)) {
                promptParts.push({ inlineData: { mimeType: "image/jpeg", data: fs.readFileSync(copyPath).toString('base64') } });
                promptParts.push({ text: "[IMAGE COPIE Ã‰LÃˆVE]" });
            } else {
                throw new Error(`Fichier copie introuvable sur le disque : ${copyPath}`);
            }

            const raw = await AIEngine.ask(promptParts, system);
            return AIEngine.sanitizeJSON(raw);

        } catch (e) {
            console.error("âŒ Scan AI Error:", e.message);
            return { 
                studentName: "Erreur Technique", 
                grade: "0/20", 
                appreciation: "Impossible de traiter le fichier image. (Erreur serveur)", 
                transcription: e.message, 
                mistakes: [] 
            };
        }
    }
};

module.exports = ScanAI;
[[[Â£ END: server/domains/scans/ai/scan.ai.js Â£]]]

[[[Â£ FILE: server/domains/scans/scans.routes.js Â£]]]
const express = require('express');
const router = express.Router();
const mongoose = require('mongoose');
const multer = require('multer');
const path = require('path');
const ScanAI = require('./ai/scan.ai');

const asyncHandler = fn => (req, res, next) => Promise.resolve(fn(req, res, next)).catch(next);

// --- CONFIGURATION MULTER STRICTE ---
const uploadDir = path.join(process.cwd(), 'public', 'uploads');

const storage = multer.diskStorage({
    destination: function (req, file, cb) {
        cb(null, uploadDir);
    },
    filename: function (req, file, cb) {
        // On force l'extension .jpg si elle manque ou est bizarre
        let ext = path.extname(file.originalname).toLowerCase();
        if (ext !== '.png' && ext !== '.jpeg' && ext !== '.jpg' && ext !== '.webp') {
            ext = '.jpg';
        }
        const uniqueSuffix = Date.now() + '-' + Math.round(Math.random() * 1E9);
        cb(null, 'scan-' + uniqueSuffix + ext);
    }
});

const upload = multer({ storage: storage });

// ROUTES
router.get('/sessions', asyncHandler(async (req, res) => { const sessions = await mongoose.model('ScanSession').find({}).sort({ date: -1 }).lean(); res.json(sessions); }));
router.post('/sessions', asyncHandler(async (req, res) => { const { title, teacherId } = req.body; const session = await mongoose.model('ScanSession').create({ title: title || `Scan ${new Date().toLocaleDateString('fr-FR')}`, teacherId }); res.json(session); }));
router.patch('/sessions/:id', asyncHandler(async (req, res) => { const { title, chapterId } = req.body; const updateData = {}; if (title) updateData.title = title; if (chapterId) updateData.chapterId = chapterId; const session = await mongoose.model('ScanSession').findByIdAndUpdate(req.params.id, { $set: updateData }, { new: true }); res.json(session); }));

router.post('/upload', upload.single('file'), asyncHandler(async (req, res) => { 
    if (!req.file) return res.status(400).json({ error: "No file" }); 
    
    // On construit l'URL avec le nom de fichier EXACT gÃ©nÃ©rÃ© par Multer
    const url = `/uploads/${req.file.filename}`; 
    const { sessionId, type } = req.body; 
    
    const update = {}; 
    if (type === 'SUBJECT') update.$push = { subjectUrls: url }; 
    if (type === 'COPY') update.$push = { copyUrls: url }; 
    
    const session = await mongoose.model('ScanSession').findByIdAndUpdate(sessionId, update, { new: true }); 
    res.json({ url, session }); 
}));

router.delete('/sessions/:id', asyncHandler(async (req, res) => { await mongoose.model('ScanSession').findByIdAndDelete(req.params.id); res.json({ ok: true }); }));

router.post('/correct/:sessionId', asyncHandler(async (req, res) => {
    const session = await mongoose.model('ScanSession').findById(req.params.sessionId);
    if (!session) return res.status(404).json({ error: "Session introuvable" });

    const students = await mongoose.model('Student').find({}, 'firstName lastName').lean();

    if (req.body.instructions) {
        session.aiInstructions = req.body.instructions;
        await session.save();
    }

    const results = [];
    for (const copyUrl of session.copyUrls) {
        try {
            const aiResult = await ScanAI.correctCopy(copyUrl, session.subjectUrls, session.aiInstructions, students);
            const entry = { 
                originalUrl: copyUrl,
                studentName: aiResult.studentName,
                transcription: aiResult.transcription,
                mistakes: aiResult.mistakes,
                appreciation: aiResult.appreciation,
                grade: aiResult.grade 
            };
            results.push(entry);
        } catch (e) {
            console.error("Erreur copie spÃ©cifique:", e);
        }
    }

    session.corrections = results;
    await session.save();
    res.json(session);
}));

module.exports = router;
[[[Â£ END: server/domains/scans/scans.routes.js Â£]]]

[[[Â£ FILE: server/domains/structure/db/structure.db.js Â£]]]
const mongoose = require('mongoose');

/**
 * ğŸ’¾ COUCHE DB STRUCTURE
 * AccÃ¨s brut aux chapitres et dossiers.
 */
const StructureDB = {
    getAllChapters: async () => {
        try {
            // Suppression des populates sur des champs inexistants (subjectId, classId)
            // On ne garde que teacherId qui est prÃ©sent dans le schÃ©ma
            return await mongoose.model('Chapter').find({})
                .populate('teacherId', 'firstName lastName')
                .sort({ createdAt: -1 })
                .lean();
        } catch (e) {
            console.error("âŒ DB Structure Error:", e.message);
            return [];
        }
    },
    createChapter: async (data) => await mongoose.model('Chapter').create(data),
    deleteChapter: async (id) => await mongoose.model('Chapter').findByIdAndDelete(id)
};

module.exports = StructureDB;
[[[Â£ END: server/domains/structure/db/structure.db.js Â£]]]

[[[Â£ FILE: server/domains/structure/drive/structure.drive.js Â£]]]
const DriveEngine = require('../../../core/drive.engine');
const StructureDrive = {
    createPath: async (prof, cls, sub, title) => {
        const root = await DriveEngine.getOrCreateFolder("CONDA CLASSE");
        const p = await DriveEngine.getOrCreateFolder(prof, root);
        const c = await DriveEngine.getOrCreateFolder(cls, p);
        const dev = await DriveEngine.getOrCreateFolder("DEVOIRS", c);
        const s = await DriveEngine.getOrCreateFolder(sub, dev);
        return await DriveEngine.getOrCreateFolder(title, s);
    }
};
module.exports = StructureDrive;
[[[Â£ END: server/domains/structure/drive/structure.drive.js Â£]]]

[[[Â£ FILE: server/domains/structure/experts/structure.db.js Â£]]]
const mongoose = require('mongoose');
const StructureDB = {
    getAll: async () => await mongoose.model('Chapter').find({}).populate('subjectId').populate('classId').sort({createdAt: -1}).lean(),
    save: async (data) => await mongoose.model('Chapter').create(data),
    update: async (id, data) => await mongoose.model('Chapter').findByIdAndUpdate(id, { $set: data }, { new: true }),
    delete: async (id) => await mongoose.model('Chapter').findByIdAndDelete(id)
};
module.exports = StructureDB;
[[[Â£ END: server/domains/structure/experts/structure.db.js Â£]]]

[[[Â£ FILE: server/domains/structure/experts/structure.drive.js Â£]]]
const { google } = require('googleapis');
const DriveEngine = require('../../../core/drive.engine');
const mongoose = require('mongoose');

const VAULT_NAME = "CONDA_PROJECT_VAULT";

/**
 * ğŸ› ï¸ EXPERT DRIVE STRUCTURE - VERSION 102
 * IntÃ¨gre le moteur de streaming pour le proxy d'images.
 */
const StructureDrive = {
    ensureVault: async () => {
        try { return await DriveEngine.getOrCreateFolder(VAULT_NAME); } 
        catch (e) { return null; }
    },

    /**
     * V102 : RÃ‰CUPÃ‰RATION DU FLUX BINAIRE
     * Permet au serveur de servir l'image Ã  la place de Google.
     */
    getFileStream: async (fileId) => {
        try {
            const drive = google.drive({ version: 'v3', auth: DriveEngine.oauth2Client });
            const res = await drive.files.get(
                { fileId: fileId, alt: 'media' },
                { responseType: 'stream' }
            );
            return res.data;
        } catch (e) {
            console.error("âŒ Stream Error:", e.message);
            throw e;
        }
    },

    getDriveTree: async () => {
        try {
            if (!DriveEngine.oauth2Client) throw new Error("No Auth");
            const drive = google.drive({ version: 'v3', auth: DriveEngine.oauth2Client });
            const vaultId = await StructureDrive.ensureVault();
            const res = await drive.files.list({ q: `'${vaultId}' in parents and trashed = false`, fields: 'files(id, name, mimeType, webViewLink)', pageSize: 50, orderBy: 'createdTime desc' });
            return { name: VAULT_NAME, id: vaultId, type: 'folder', children: res.data.files.map(f => ({ id: f.id, name: f.name, type: f.mimeType === 'application/vnd.google-apps.folder' ? 'folder' : 'file', link: f.webViewLink })) };
        } catch (e) { return { name: VAULT_NAME, error: e.message }; }
    },

    deleteDriveItem: async (id) => {
        const drive = google.drive({ version: 'v3', auth: DriveEngine.oauth2Client });
        await drive.files.update({ fileId: id, resource: { trashed: true } });
        return { ok: true };
    },

    syncBaseStructure: async () => {
        await StructureDrive.ensureVault();
        return { ok: true };
    }
};

module.exports = StructureDrive;
[[[Â£ END: server/domains/structure/experts/structure.drive.js Â£]]]

[[[Â£ FILE: server/domains/structure/experts/structure.expert.js Â£]]]
const StructureDB = require('../db/structure.db');
const StructureDrive = require('./structure.drive');
const mongoose = require('mongoose');

/**
 * ğŸ§  EXPERT STRUCTURE - VERSION 436 (SECURITÃ‰ DERNIER CHAPITRE)
 * EmpÃªche la suppression du dernier chapitre d'une section.
 */
const StructureExpert = {
    
    getChapters: async () => {
        const chapters = await StructureDB.getAllChapters();
        return chapters.map(c => ({
            ...c,
            _id: String(c._id),
            teacherId: c.teacherId ? String(c.teacherId._id || c.teacherId) : null,
            isArchived: c.isArchived === true, 
            section: (c.section || "GÃ‰NÃ‰RAL").toUpperCase().trim(),
            classroom: c.classroom ? c.classroom.toUpperCase().trim() : ""
        }));
    },

    createChapter: async (data) => {
        if (!data.teacherId) throw new Error("PropriÃ©taire (teacherId) manquant.");
        
        const cleanData = { 
            ...data, 
            title: data.title ? data.title.toUpperCase().trim() : "NOUVEAU DOSSIER",
            section: data.section ? data.section.toUpperCase().trim() : "GÃ‰NÃ‰RAL",
            classroom: data.classroom ? data.classroom.toUpperCase().trim() : "",
            isArchived: false 
        };
        
        return await StructureDB.createChapter(cleanData);
    },

    verifyAssetsIntegrity: async (homeworkId) => {
        const Homework = mongoose.model('Homework');
        const hw = await Homework.findById(homeworkId).lean();
        if (!hw) return { ok: false, error: "Devoir introuvable" };

        const brokenLinks = [];
        const drive = require('googleapis').google.drive({ version: 'v3', auth: require('../../../core/drive.engine').oauth2Client });

        for (const level of hw.levels) {
            const allUrls = [...(level.instructionUrls || []), ...(level.attachmentUrls || [])];
            for (const url of allUrls) {
                const driveId = url.match(/[-\w]{25,}/);
                if (driveId) {
                    try { await drive.files.get({ fileId: driveId[0], fields: 'id' }); } catch (e) { brokenLinks.push(url); }
                }
            }
        }

        return { ok: brokenLinks.length === 0, brokenLinks, totalChecked: hw.levels.length };
    },

    ensureVault: async () => {
        return await StructureDrive.ensureVault();
    },

    deleteChapter: async (id) => {
        const Chapter = mongoose.model('Chapter');
        const Homework = mongoose.model('Homework');
        const GameLevel = mongoose.model('GameLevel');
        const ScanSession = mongoose.model('ScanSession');

        const target = await Chapter.findById(id);
        if (!target) throw new Error("Dossier introuvable.");

        // 1. Protection du dossier GÃ‰NÃ‰RAL principal
        const isGeneralSection = (target.section || "").toUpperCase() === "GÃ‰NÃ‰RAL";
        const isGeneralTitle = (target.title || "").toUpperCase() === "GÃ‰NÃ‰RAL";

        if (isGeneralSection && isGeneralTitle) {
            throw new Error("â›” INTERDIT : Le dossier 'GÃ‰NÃ‰RAL' principal est indestructible.");
        }

        // 2. NOUVELLE RÃˆGLE V436 : Protection du DERNIER chapitre
        // On compte combien de chapitres (non archivÃ©s) existent dans cette section pour ce prof
        const siblingCount = await Chapter.countDocuments({
            teacherId: target.teacherId,
            section: target.section
        });

        if (siblingCount <= 1) {
            throw new Error("â›” ACTION REFUSÃ‰E : Impossible de supprimer le dernier dossier d'une section.");
        }

        // 3. LOGIQUE POUBELLE
        let fallback = await Chapter.findOne({ teacherId: target.teacherId, section: target.section, title: "GÃ‰NÃ‰RAL" });
        // Si pas de gÃ©nÃ©ral dans la section, on cherche un autre chapitre au hasard dans la mÃªme section pour sauver les meubles
        if (!fallback) {
            fallback = await Chapter.findOne({ 
                teacherId: target.teacherId, 
                section: target.section, 
                _id: { $ne: target._id } // Pas celui qu'on supprime
            });
        }
        
        // Si toujours rien (cas GÃ©nÃ©ral Global), on prend le Global
        if (!fallback) fallback = await Chapter.findOne({ teacherId: target.teacherId, section: "GÃ‰NÃ‰RAL", title: "GÃ‰NÃ‰RAL" });
        if (!fallback) fallback = await Chapter.create({ teacherId: target.teacherId, section: "GÃ‰NÃ‰RAL", title: "GÃ‰NÃ‰RAL", classroom: "" });

        console.log(`â™»ï¸ [DELETE-LOGIC] Migration contenu de "${target.title}" vers "${fallback.title}"`);
        
        await Homework.updateMany({ chapterId: id }, { chapterId: fallback._id });
        await GameLevel.updateMany({ chapterId: id }, { chapterId: fallback._id });
        await ScanSession.updateMany({ chapterId: id }, { chapterId: fallback._id });

        return await StructureDB.deleteChapter(id);
    }
};

module.exports = StructureExpert;
[[[Â£ END: server/domains/structure/experts/structure.expert.js Â£]]]

[[[Â£ FILE: server/domains/structure/structure.routes.js Â£]]]
const express = require('express');
const router = express.Router();
const mongoose = require('mongoose');
const StructureExpert = require('./experts/structure.expert');
const StructureDrive = require('./experts/structure.drive');

const asyncHandler = fn => (req, res, next) => Promise.resolve(fn(req, res, next)).catch(next);

router.get('/proxy/:id', async (req, res) => { try { const stream = await StructureDrive.getFileStream(req.params.id); stream.pipe(res); } catch (e) { res.status(404).send("Image introuvable"); } });
router.get('/integrity/:homeworkId', asyncHandler(async (req, res) => res.json(await StructureExpert.verifyAssetsIntegrity(req.params.homeworkId))));
router.get('/drive-tree', async (req, res) => { try { res.json(await StructureDrive.getDriveTree()); } catch (e) { res.json({ name: "Conda Vault", children: [], error: e.message }); } });
router.post('/sync-root', asyncHandler(async (req, res) => res.json(await StructureDrive.syncBaseStructure())));
router.get('/chapters', asyncHandler(async (req, res) => res.json(await StructureExpert.getChapters())));
router.post('/chapters', asyncHandler(async (req, res) => res.json(await StructureExpert.createChapter(req.body))));
router.delete('/chapters/:id', asyncHandler(async (req, res) => { await StructureExpert.deleteChapter(req.params.id); res.json({ ok: true }); }));
router.patch('/chapters/:id/archive', asyncHandler(async (req, res) => { const updated = await mongoose.model('Chapter').findByIdAndUpdate(req.params.id, { isArchived: !!req.body.isArchived }, { new: true }); res.json(updated); }));
router.delete('/drive/:id', asyncHandler(async (req, res) => res.json(await StructureDrive.deleteDriveItem(req.params.id))));
const getRandomColor = () => `hsl(${Math.floor(Math.random() * 360)}, 85%, 60%)`;

// RENOMMAGE (V435)
router.patch('/chapters/:id', asyncHandler(async (req, res) => {
    const { title } = req.body;
    if (!title) return res.status(400).json({ error: "Titre manquant" });
    const updated = await mongoose.model('Chapter').findByIdAndUpdate(req.params.id, { title: title.toUpperCase().trim() }, { new: true });
    res.json(updated);
}));

router.get('/sections/:teacherId', asyncHandler(async (req, res) => {
    if (!req.params.teacherId || req.params.teacherId === 'undefined') return res.json([]);
    let user = await mongoose.model('Teacher').findById(req.params.teacherId) || await mongoose.model('Admin').findById(req.params.teacherId);
    if (!user) return res.status(404).json({ error: "User not found" });
    
    if (!user.subjectSections || user.subjectSections.length === 0) {
        user.subjectSections = [{ name: 'GÃ‰NÃ‰RAL', color: '#64748b', scope: 'GLOBAL' }];
        await user.save();
    }

    const Chapter = mongoose.model('Chapter');
    const Homework = mongoose.model('Homework');
    const GameLevel = mongoose.model('GameLevel');
    const ScanSession = mongoose.model('ScanSession');

    for (const section of user.subjectSections) {
        if (section.name === "GÃ‰NÃ‰RAL") {
             const globalGeneral = await Chapter.findOne({ teacherId: user._id, section: "GÃ‰NÃ‰RAL", title: "GÃ‰NÃ‰RAL" });
             if (!globalGeneral) await Chapter.create({ title: "GÃ‰NÃ‰RAL", section: "GÃ‰NÃ‰RAL", classroom: "", teacherId: user._id, isArchived: false });
             continue;
        }

        // Nettoyage des "GÃ©nÃ©ral" parasites dans les sections custom
        const parasite = await Chapter.findOne({ teacherId: user._id, section: section.name, title: "GÃ‰NÃ‰RAL" });
        if (parasite) {
            const ch1 = await Chapter.findOne({ teacherId: user._id, section: section.name, title: "CH1" });
            if (ch1) {
                await Homework.updateMany({ chapterId: parasite._id }, { chapterId: ch1._id });
                await GameLevel.updateMany({ chapterId: parasite._id }, { chapterId: ch1._id });
                await ScanSession.updateMany({ chapterId: parasite._id }, { chapterId: ch1._id });
                await Chapter.findByIdAndDelete(parasite._id);
            } else {
                parasite.title = "CH1";
                await parasite.save();
            }
        }
    }
    res.json(user.subjectSections || []);
}));

// --- V435 : MIGRATION AUTOMATIQUE DU CONTENU GÃ‰NÃ‰RAL VERS LA PREMIÃˆRE SECTION ---
router.post('/sections', asyncHandler(async (req, res) => { 
    const { teacherId, sectionName, scope, target } = req.body; 
    if (!teacherId || !sectionName) return res.status(400).json({ error: "DonnÃ©es manquantes" }); 
    const cleanName = sectionName.toUpperCase().trim(); 
    let user = await mongoose.model('Teacher').findById(teacherId) || await mongoose.model('Admin').findById(teacherId); 
    if (!user) return res.status(404).json({ error: "User not found" }); 
    
    let sections = user.subjectSections || []; 
    const isDuplicate = sections.some(s => s.name === cleanName && s.scope === (scope || 'GLOBAL') && s.target === (target || null)); 
    if (isDuplicate) return res.status(409).json({ error: `La section "${cleanName}" existe dÃ©jÃ  !` }); 
    
    // DÃ‰TECTION PREMIÃˆRE SECTION (Si on n'avait que "GÃ‰NÃ‰RAL" avant)
    const isFirstCustomSection = sections.length === 1 && sections[0].name === "GÃ‰NÃ‰RAL";

    sections.push({ name: cleanName, color: getRandomColor(), scope: scope || 'GLOBAL', target: target || null }); 
    user.subjectSections = sections; 
    await user.save(); 
    
    const newCh1 = await mongoose.model('Chapter').create({ 
        title: "CH1", 
        section: cleanName, 
        classroom: (scope === 'CLASS') ? (target || "") : "", 
        teacherId: user._id, 
        isArchived: false 
    }); 

    // MIGRATION DU CONTENU
    if (isFirstCustomSection) {
        console.log(`ğŸš€ [FIRST-SECTION] Migration du contenu 'GÃ‰NÃ‰RAL' vers '${cleanName} > CH1'`);
        const generalChap = await mongoose.model('Chapter').findOne({ teacherId: user._id, section: "GÃ‰NÃ‰RAL", title: "GÃ‰NÃ‰RAL" });
        
        if (generalChap) {
            const Homework = mongoose.model('Homework');
            const GameLevel = mongoose.model('GameLevel');
            const ScanSession = mongoose.model('ScanSession');

            await Homework.updateMany({ chapterId: generalChap._id }, { chapterId: newCh1._id });
            await GameLevel.updateMany({ chapterId: generalChap._id }, { chapterId: newCh1._id });
            await ScanSession.updateMany({ chapterId: generalChap._id }, { chapterId: newCh1._id });
        }
    }
    
    res.json(user.subjectSections); 
}));

router.delete('/sections', asyncHandler(async (req, res) => { 
    const { teacherId, sectionName } = req.body; 
    let user = await mongoose.model('Teacher').findById(teacherId) || await mongoose.model('Admin').findById(teacherId); 
    if (!user) return res.status(404).json({ error: "User not found" }); 
    
    const Chapter = mongoose.model('Chapter');
    const Homework = mongoose.model('Homework');
    const GameLevel = mongoose.model('GameLevel');
    const ScanSession = mongoose.model('ScanSession');

    let fallback = await Chapter.findOne({ teacherId: user._id, section: "GÃ‰NÃ‰RAL", title: "GÃ‰NÃ‰RAL" });
    if (!fallback) fallback = await Chapter.create({ teacherId: user._id, section: "GÃ‰NÃ‰RAL", title: "GÃ‰NÃ‰RAL", classroom: "" });

    const chaptersToDelete = await Chapter.find({ teacherId: user._id, section: sectionName });
    const idsToDelete = chaptersToDelete.map(c => c._id);

    if (idsToDelete.length > 0) {
        console.log(`â™»ï¸ [SECTION-DELETE] Migration de ${idsToDelete.length} dossiers vers GÃ‰NÃ‰RAL.`);
        await Homework.updateMany({ chapterId: { $in: idsToDelete } }, { chapterId: fallback._id });
        await GameLevel.updateMany({ chapterId: { $in: idsToDelete } }, { chapterId: fallback._id });
        await ScanSession.updateMany({ chapterId: { $in: idsToDelete } }, { chapterId: fallback._id });
        
        await Chapter.deleteMany({ _id: { $in: idsToDelete } });
    }

    let newSections = user.subjectSections.filter(s => s.name !== sectionName); 
    if (newSections.length === 0) newSections.push({ name: 'GÃ‰NÃ‰RAL', color: '#64748b', scope: 'GLOBAL' }); 
    user.subjectSections = newSections; 
    await user.save(); 
    
    res.json(user.subjectSections); 
}));

router.post('/sections/reset', asyncHandler(async (req, res) => { const { teacherId } = req.body; let user = await mongoose.model('Teacher').findById(teacherId) || await mongoose.model('Admin').findById(teacherId); user.subjectSections = [{ name: 'GÃ‰NÃ‰RAL', color: '#64748b', scope: 'GLOBAL' }]; await user.save(); await mongoose.model('Chapter').deleteMany({ teacherId: user._id }); await mongoose.model('Chapter').create({ title: "GÃ‰NÃ‰RAL", section: "GÃ‰NÃ‰RAL", classroom: "", teacherId: user._id, isArchived: false }); res.json(user.subjectSections); }));

module.exports = router;
[[[Â£ END: server/domains/structure/structure.routes.js Â£]]]

[[[Â£ FILE: server/domains/students/experts/student.drive.js Â£]]]
const DriveEngine = require('../../../core/drive.engine');
const mongoose = require('mongoose');

const StudentDrive = {
    createPortfolio: async (studentId) => {
        try {
            const Student = mongoose.model('Student');
            const student = await Student.findById(studentId);
            if (!student) return;

            const rootId = await DriveEngine.getOrCreateFolder("CONDA_PRO");
            const portfoliosRootId = await DriveEngine.getOrCreateFolder("PORTFOLIOS_ELEVES", rootId);
            const folderName = `${student.lastName.toUpperCase()} ${student.firstName.toUpperCase()}`;
            const studentFolderId = await DriveEngine.getOrCreateFolder(folderName, portfoliosRootId);

            await Student.findByIdAndUpdate(studentId, {
                driveFolderId: studentFolderId,
                drivePortfolioUrl: `https://drive.google.com/drive/folders/${studentFolderId}`
            });
        } catch (e) { console.error("Student Portfolio Drive Error:", e); }
    }
};
module.exports = StudentDrive;
[[[Â£ END: server/domains/students/experts/student.drive.js Â£]]]

[[[Â£ FILE: server/domains/studio/ai/game-generator.ai.js Â£]]]
const AIEngine = require('../../../core/ai.engine');

const GameGeneratorAI = {
    
    generateGameCode: async (gameIdea, actors) => {
        console.log("ğŸ•¹ï¸ [GAME-GEN] GÃ©nÃ©ration du code de jeu...");

        const actorsContext = actors.map((a, i) => {
            const sprite = (a.costumes && a.costumes.length > 0) ? a.costumes[0].url : "";
            return `Actor ${i+1}: Name="${a.name}", ID="${a.id}", SpriteURL="${sprite}"`;
        }).join('\n');

        const system = `Tu es un expert en dÃ©veloppement de jeux HTML5 Canvas (2D).
        
        TES OBJECTIFS :
        1. GÃ©nÃ©rer une classe JavaScript 'MiniGame'.
        2. Expliquer briÃ¨vement ce que tu as fait ou corrigÃ©.

        CONTRAINTES TECHNIQUES STRICTES :
        - La classe doit avoir : constructor(canvas, assets), update(dt), draw(ctx), destroy().
        - GESTION CLAVIER : Pour la barre d'espace ('Space' ou ' '), tu DOIS utiliser e.preventDefault() pour empÃªcher le dÃ©filement de la page.
        - NETTOYAGE : destroy() doit supprimer tous les event listeners.
        - ROBUSTESSE : Pas de crash si une image manque.
        - PAS D'ALERT() : Dessine le Game Over sur le canvas.

        FORMAT DE RÃ‰PONSE ATTENDU (JSON STRICT) :
        {
            "code": "Le code JavaScript complet de la classe...",
            "message": "Une explication courte (1 phrase) de ce que tu as implÃ©mentÃ© ou corrigÃ© pour le crÃ©ateur."
        }`;

        const prompt = `IDÃ‰E DU JEU : "${gameIdea}"\nACTEURS : ${actorsContext}\n\nGÃ©nÃ¨re le code et le message explicatif.`;

        try {
            const raw = await AIEngine.ask(prompt, system);
            return AIEngine.sanitizeJSON(raw);
        } catch (e) { 
            console.error(e);
            // Fallback si l'IA plante le JSON
            return { code: "", message: "Erreur de gÃ©nÃ©ration IA." }; 
        }
    },

    fixGameCode: async (currentCode, errorLog, userInstruction) => {
        console.log("ğŸ”§ [GAME-FIX] RÃ©paration du code...");

        const system = `Tu es un expert en dÃ©bogage JavaScript pour jeux Canvas.
        
        FORMAT DE RÃ‰PONSE ATTENDU (JSON STRICT) :
        {
            "code": "Le code corrigÃ©...",
            "message": "Explication de la correction (ex: 'J'ai ajoutÃ© preventDefault sur la barre d'espace')."
        }
        
        RÃˆGLE D'OR : Si le problÃ¨me concerne la barre d'espace qui fait scroller ou reload, ajoute 'e.preventDefault()' dans l'Ã©couteur d'Ã©vÃ©nement.`;

        const prompt = `
        CODE ACTUEL :
        ${currentCode}

        ERREUR / DEMANDE :
        "${errorLog || userInstruction}"

        Corrige le code et explique pourquoi.`;

        try {
            const raw = await AIEngine.ask(prompt, system);
            return AIEngine.sanitizeJSON(raw);
        } catch (e) { throw new Error("L'IA n'a pas pu rÃ©parer le code."); }
    },

    remixAssetDescription: async (imageBuffer) => {
        const system = "Tu es un directeur artistique. DÃ©cris cette image en anglais pour un prompt de gÃ©nÃ©ration.";
        const prompt = [{ text: "DÃ©cris ce personnage/objet." }, { inlineData: { mimeType: "image/png", data: imageBuffer.toString('base64') } }];
        const desc = await AIEngine.ask(prompt, system);
        return desc + ", vector style, white background, game asset";
    }
};

module.exports = GameGeneratorAI;
[[[Â£ END: server/domains/studio/ai/game-generator.ai.js Â£]]]

[[[Â£ FILE: server/domains/studio/ai/studio.ai.js Â£]]]
const AIEngine = require('../../../core/ai.engine');

/**
 * ğŸ§  COUCHE IA STUDIO
 * SpÃ©cialisÃ©e dans la gÃ©nÃ©ration de prompts artistiques.
 */
const StudioAI = {
    optimizeAssetPrompt: async (userPrompt, type) => {
        console.log(`ğŸ¨ [STUDIO-AI] Optimisation du prompt pour : ${type}`);
        
        const styleContext = type === 'character' 
            ? "sprite 2D, vector style, flat colors, white background, full body, video game asset style, no shadow"
            : "video game background, 2D vector art, scenic, flat style, colorful, wide angle";
            
        const systemInstruction = "Tu es un expert en Prompts pour IA gÃ©nÃ©rative d'images (Stable Diffusion/Midjourney). Traduis et optimise la demande en Anglais pour un rÃ©sultat style Cartoon/Jeu VidÃ©o.";
        
        const prompt = `Transforme cette demande : "${userPrompt}" en un prompt descriptif technique en anglais.
        Ajoute impÃ©rativement ce style : ${styleContext}.
        RÃ©ponds UNIQUEMENT le prompt anglais, sans guillemets, sans texte avant ni aprÃ¨s.`;

        try {
            return await AIEngine.ask(prompt, systemInstruction);
        } catch (e) {
            console.error("âŒ [STUDIO-AI] Erreur:", e.message);
            // Fallback si l'IA Ã©choue : on renvoie le prompt utilisateur + style
            return `${userPrompt}, ${styleContext}`;
        }
    }
};

module.exports = StudioAI;
[[[Â£ END: server/domains/studio/ai/studio.ai.js Â£]]]

[[[Â£ FILE: server/domains/studio/db/studio.db.js Â£]]]
const mongoose = require('mongoose');

/**
 * ğŸ’¾ COUCHE DB STUDIO
 * AccÃ¨s aux projets de thÃ©Ã¢tre/jeux.
 */
const StudioDB = {
    // CrÃ©er ou mettre Ã  jour un projet (UPSERT ROBUSTE)
    upsertProject: async (data) => {
        const Model = mongoose.model('StudioProject');
        
        // 1. Nettoyage de l'objet pour Ã©viter les injections d'ID null
        const cleanData = { ...data };
        
        // Nettoyage ID principal
        if (!cleanData._id || cleanData._id === 'null' || cleanData._id === 'undefined') {
            delete cleanData._id;
        }

        // NETTOYAGE DES SCÃˆNES (CÃ”TÃ‰ SERVEUR AUSSI)
        if (cleanData.scenes && Array.isArray(cleanData.scenes)) {
            cleanData.scenes = cleanData.scenes.map(s => {
                // Si l'ID n'est pas valide (pas un ObjectId), on le supprime pour que Mongoose en gÃ©nÃ¨re un nouveau
                if (s._id && !mongoose.Types.ObjectId.isValid(s._id)) {
                    delete s._id;
                }
                return s;
            });
        }

        // 2. Tentative de mise Ã  jour SI on a un ID valide
        if (cleanData._id && mongoose.Types.ObjectId.isValid(cleanData._id)) {
            const updated = await Model.findByIdAndUpdate(cleanData._id, cleanData, { new: true });
            if (updated) return updated;
            
            // SINON (ID introuvable), on le supprime pour forcer une crÃ©ation
            delete cleanData._id;
        }
        
        // 3. CrÃ©ation
        return await Model.create(cleanData);
    },

    findProjectsByTeacher: async (teacherId) => {
        return await mongoose.model('StudioProject').find({ teacherId }).sort({ updatedAt: -1 }).lean();
    },

    findProjectById: async (id) => {
        if (!mongoose.Types.ObjectId.isValid(id)) return null;
        return await mongoose.model('StudioProject').findById(id).lean();
    },

    deleteProject: async (id) => {
        return await mongoose.model('StudioProject').findByIdAndDelete(id);
    }
};

module.exports = StudioDB;
[[[Â£ END: server/domains/studio/db/studio.db.js Â£]]]

[[[Â£ FILE: server/domains/studio/experts/studio.drive.js Â£]]]
const DriveEngine = require('../../../core/drive.engine');

const STUDIO_FOLDER_NAME = "CONDA_STUDIO_ASSETS";

/**
 * ğŸ¨ EXPERT DRIVE STUDIO
 * GÃ¨re le stockage propre des assets de jeu sur le Drive.
 */
const StudioDrive = {
    
    getStudioRoot: async () => {
        return await DriveEngine.getOrCreateFolder(STUDIO_FOLDER_NAME);
    },

    uploadAsset: async (localPath, filename) => {
        try {
            const rootId = await StudioDrive.getStudioRoot();
            // On upload le fichier
            const fileData = await DriveEngine.uploadFile(filename, localPath, rootId);
            return fileData; // { id, link }
        } catch (e) {
            console.error("Studio Drive Upload Error:", e);
            return null;
        }
    }
};

module.exports = StudioDrive;
[[[Â£ END: server/domains/studio/experts/studio.drive.js Â£]]]

[[[Â£ FILE: server/domains/studio/experts/studio.expert.js Â£]]]
const fs = require('fs');
const path = require('path');
const https = require('https');
const StudioAI = require('../ai/studio.ai');
const GameGeneratorAI = require('../ai/game-generator.ai'); 
const StudioDB = require('../db/studio.db');
const StudioDrive = require('./studio.drive'); 

/**
 * ğŸ› ï¸ EXPERT STUDIO (V2.2 - FIX GENERATION)
 * GÃ¨re correctement le format Code + Message de l'IA.
 */
const StudioExpert = {
    
    generateAsset: async (userPrompt, type) => {
        const optimizedPrompt = await StudioAI.optimizeAssetPrompt(userPrompt, type);
        return await StudioExpert._downloadAndStore(optimizedPrompt, userPrompt);
    },

    remixAsset: async (file) => {
        const buffer = fs.readFileSync(file.path);
        const promptFromImage = await GameGeneratorAI.remixAssetDescription(buffer);
        return await StudioExpert._downloadAndStore(promptFromImage, "Remix IA");
    },

    _downloadAndStore: async (prompt, originalName) => {
        const encodedPrompt = encodeURIComponent(prompt);
        const seed = Math.floor(Math.random() * 10000);
        const imageUrl = `https://image.pollinations.ai/prompt/${encodedPrompt}?width=512&height=512&seed=${seed}&nologo=true`;

        const fileName = `studio-${Date.now()}-${seed}.png`;
        const uploadDir = path.join(process.cwd(), 'public', 'uploads');
        if (!fs.existsSync(uploadDir)) fs.mkdirSync(uploadDir, { recursive: true });
        const localPath = path.join(uploadDir, fileName);
        const file = fs.createWriteStream(localPath);

        return new Promise((resolve, reject) => {
            https.get(imageUrl, (response) => {
                if (response.statusCode !== 200) { reject(new Error(`Pollinations Error: ${response.statusCode}`)); return; }
                response.pipe(file);
                file.on('finish', async () => {
                    file.close();
                    let driveLink = null;
                    try {
                        const driveData = await StudioDrive.uploadAsset(localPath, fileName);
                        if (driveData) driveLink = driveData.link;
                    } catch(e) { console.error("Drive upload failed but local is ok"); }

                    resolve({
                        url: `/uploads/${fileName}`,
                        driveUrl: driveLink,
                        prompt: prompt,
                        name: originalName.substring(0, 15)
                    });
                });
            }).on('error', reject);
        });
    },

    generateGame: async (projectId, gameIdea) => {
        const project = await StudioDB.findProjectById(projectId);
        if (!project) throw new Error("Projet introuvable (ID Invalide)");

        let allActors = [];
        if (project.scenes && Array.isArray(project.scenes)) {
            project.scenes.forEach(s => {
                if (s.actors && Array.isArray(s.actors)) {
                    allActors.push(...s.actors);
                }
            });
        }

        if (allActors.length === 0) throw new Error("Aucun acteur trouvÃ© dans ce projet. Ajoutez des personnages.");

        // L'IA renvoie maintenant : { code: "...", message: "..." }
        const aiResult = await GameGeneratorAI.generateGameCode(gameIdea, allActors);
        
        // CORRECTION CRITIQUE : On ne sauvegarde QUE le code (String) en BDD
        // Si aiResult est un objet (nouveau format), on prend .code
        // Sinon (format legacy ou erreur), on prend tel quel ou chaine vide
        const codeToSave = (typeof aiResult === 'object' && aiResult.code) ? aiResult.code : "";
        
        project.generatedCode = codeToSave;
        await StudioDB.upsertProject(project);
        
        // Mais on renvoie l'objet complet au Client pour avoir le message
        return aiResult;
    },

    saveProject: async (projectData) => await StudioDB.upsertProject(projectData),
    getUserProjects: async (userId) => await StudioDB.findProjectsByTeacher(userId)
};

module.exports = StudioExpert;
[[[Â£ END: server/domains/studio/experts/studio.expert.js Â£]]]

[[[Â£ FILE: server/domains/studio/studio.routes.js Â£]]]
const express = require('express');
const router = express.Router();
const multer = require('multer');
const path = require('path');
const fs = require('fs');
const StudioExpert = require('./experts/studio.expert');
const GameGeneratorAI = require('./ai/game-generator.ai'); // Import direct pour le fix

const asyncHandler = fn => (req, res, next) => Promise.resolve(fn(req, res, next)).catch(next);

const uploadDir = path.join(process.cwd(), 'public', 'uploads');
if (!fs.existsSync(uploadDir)) fs.mkdirSync(uploadDir, { recursive: true });
const upload = multer({ dest: uploadDir });

router.post('/upload', upload.single('file'), (req, res) => {
    if (!req.file) return res.status(400).json({ error: "Fichier manquant" });
    const publicUrl = `/uploads/${req.file.filename}`;
    res.json({ url: publicUrl });
});

router.post('/generate-asset', asyncHandler(async (req, res) => {
    const { prompt, type } = req.body;
    const result = await StudioExpert.generateAsset(prompt, type);
    res.json({ ok: true, ...result });
}));

router.post('/remix-asset', upload.single('file'), asyncHandler(async (req, res) => {
    if (!req.file) return res.status(400).json({ error: "Image requise" });
    const result = await StudioExpert.remixAsset(req.file);
    try { fs.unlinkSync(req.file.path); } catch(e){}
    res.json({ ok: true, ...result });
}));

router.post('/generate-code', asyncHandler(async (req, res) => {
    const { projectId, gameIdea } = req.body;
    const code = await StudioExpert.generateGame(projectId, gameIdea);
    res.json({ ok: true, code });
}));

// --- NOUVELLE ROUTE : FIX CODE ---
router.post('/fix-code', asyncHandler(async (req, res) => {
    const { code, error, instruction } = req.body;
    const fixedCode = await GameGeneratorAI.fixGameCode(code, error, instruction);
    res.json({ ok: true, code: fixedCode });
}));

router.post('/projects', asyncHandler(async (req, res) => {
    const project = await StudioExpert.saveProject(req.body);
    res.json(project);
}));

router.get('/projects/:userId', asyncHandler(async (req, res) => {
    const projects = await StudioExpert.getUserProjects(req.params.userId);
    res.json(projects);
}));

module.exports = router;
[[[Â£ END: server/domains/studio/studio.routes.js Â£]]]

[[[Â£ FILE: server/models/AcademicYear.js Â£]]]
const mongoose = require('mongoose');
const AcademicYearSchema = new mongoose.Schema({
    label: { type: String, required: true }, // ex: "2024-2025"
    isCurrent: { type: Boolean, default: true }
}, { collection: 'academicyears' });
module.exports = mongoose.models.AcademicYear || mongoose.model('AcademicYear', AcademicYearSchema);
[[[Â£ END: server/models/AcademicYear.js Â£]]]

[[[Â£ FILE: server/models/AccessLog.js Â£]]]
const mongoose = require('mongoose');
const AccessLogSchema = new mongoose.Schema({
    userId: String,
    action: String,
    timestamp: { type: Date, default: Date.now }
}, { collection: 'accesslogs' });
module.exports = mongoose.models.AccessLog || mongoose.model('AccessLog', AccessLogSchema);
[[[Â£ END: server/models/AccessLog.js Â£]]]

[[[Â£ FILE: server/models/Admin.js Â£]]]
const mongoose = require('mongoose');

const SectionSchema = new mongoose.Schema({
    name: { type: String, required: true },
    color: { type: String, default: '#6366f1' },
    scope: { type: String, enum: ['GLOBAL', 'LEVEL', 'CLASS'], default: 'GLOBAL' },
    target: { type: String, default: null }
}, { _id: false });

const AdminSchema = new mongoose.Schema({
    firstName: { type: String, required: true },
    lastName: { type: String, required: true },
    password: { type: String, required: true },
    role: { type: String, enum: ['admin', 'developer'], default: 'admin' },
    subjectSections: { type: [SectionSchema], default: [] },
    isDeveloper: { type: Boolean, default: false },
    isTestAccount: { type: Boolean, default: false }
}, { collection: 'admins' });

module.exports = mongoose.models.Admin || mongoose.model('Admin', AdminSchema);
[[[Â£ END: server/models/Admin.js Â£]]]

[[[Â£ FILE: server/models/Bug.js Â£]]]
const mongoose = require('mongoose');
const BugSchema = new mongoose.Schema({
    reporter: String,
    description: String,
    createdAt: { type: Date, default: Date.now }
});
module.exports = mongoose.models.Bug || mongoose.model('Bug', BugSchema);
[[[Â£ END: server/models/Bug.js Â£]]]

[[[Â£ FILE: server/models/BugReport.js Â£]]]
const mongoose = require('mongoose');
const BugReportSchema = new mongoose.Schema({
    description: String,
    stack: String,
    status: { type: String, default: 'open' },
    createdAt: { type: Date, default: Date.now }
}, { collection: 'bugreports' });
module.exports = mongoose.models.BugReport || mongoose.model('BugReport', BugReportSchema);
[[[Â£ END: server/models/BugReport.js Â£]]]

[[[Â£ FILE: server/models/Chapter.js Â£]]]
const mongoose = require('mongoose');

const ChapterSchema = new mongoose.Schema({
    title: { type: String, required: true },
    section: { type: String, default: "GÃ©nÃ©ral" }, 
    
    // Classe spÃ©cifique (ex: "6A")
    classroom: String, 
    
    // NOUVEAU : Niveau partagÃ© (ex: "6" pour toutes les 6Ã¨mes, "1" pour toutes les 1Ã¨res)
    sharedLevel: String, 

    teacherId: { type: mongoose.Schema.Types.ObjectId, ref: 'Teacher' },
    isArchived: { type: Boolean, default: false },
    createdAt: { type: Date, default: Date.now }
}, { collection: 'chapters' });

module.exports = mongoose.models.Chapter || mongoose.model('Chapter', ChapterSchema);
[[[Â£ END: server/models/Chapter.js Â£]]]

[[[Â£ FILE: server/models/Classroom.js Â£]]]
const mongoose = require('mongoose');

// Sous-schÃ©ma pour le layout (plus sÃ»r qu'un objet imbriquÃ© direct)
const LayoutSchema = new mongoose.Schema({
    separators: { type: [Number], default: [] }
}, { _id: false });

const ClassroomSchema = new mongoose.Schema({
    name: { type: String, required: true, uppercase: true },
    level: { type: String }, 
    
    type: { type: String, enum: ['CLASS', 'GROUP'], default: 'CLASS' },
    associatedClasses: [{ type: mongoose.Schema.Types.ObjectId, ref: 'Classroom' }],
    yearId: { type: mongoose.Schema.Types.ObjectId, ref: 'AcademicYear' },

    // Configuration visuelle
    layout: { type: LayoutSchema, default: () => ({ separators: [] }) }
}, { collection: 'classrooms' });

module.exports = mongoose.models.Classroom || mongoose.model('Classroom', ClassroomSchema);
[[[Â£ END: server/models/Classroom.js Â£]]]

[[[Â£ FILE: server/models/DeploySignal.js Â£]]]
const mongoose = require('mongoose');
const DeploySignalSchema = new mongoose.Schema({ status: String, updatedAt: Date });
module.exports = mongoose.models.DeploySignal || mongoose.model('DeploySignal', DeploySignalSchema);
[[[Â£ END: server/models/DeploySignal.js Â£]]]

[[[Â£ FILE: server/models/Enrollment.js Â£]]]
const mongoose = require('mongoose');
const EnrollmentSchema = new mongoose.Schema({
    studentId: { type: mongoose.Schema.Types.ObjectId, ref: 'Student', required: true },
    classId: { type: mongoose.Schema.Types.ObjectId, ref: 'Classroom', required: true },
    yearId: { type: mongoose.Schema.Types.ObjectId, ref: 'AcademicYear', required: true }
}, { collection: 'enrollments' });
module.exports = mongoose.models.Enrollment || mongoose.model('Enrollment', EnrollmentSchema);
[[[Â£ END: server/models/Enrollment.js Â£]]]

[[[Â£ FILE: server/models/Game.js Â£]]]
const mongoose = require('mongoose');
/**
 * SECTION 10 : LES JEUX (Conteneurs)
 * DÃ©finit un jeu global (ex: "La Rome Antique") qui contient des niveaux.
 */
const GameSchema = new mongoose.Schema({
    title: { type: String, required: true },
    chapterId: { type: mongoose.Schema.Types.ObjectId, ref: 'Chapter' },
    type: { type: String, enum: ['zombie', 'starship'], default: 'zombie' },
    createdAt: { type: Date, default: Date.now }
}, { collection: 'games' });
module.exports = mongoose.models.Game || mongoose.model('Game', GameSchema);
[[[Â£ END: server/models/Game.js Â£]]]

[[[Â£ FILE: server/models/GameLevel.js Â£]]]
const mongoose = require('mongoose');

/**
 * ğŸ® MODÃˆLE GAME LEVEL V2 (HarmonisÃ© avec Homework)
 * Ajout des champs de ciblage (Classes, Ã‰lÃ¨ves, Prof) pour la distribution.
 */
const GameLevelSchema = new mongoose.Schema({
    title: { type: String, required: true },
    
    // Structure & PropriÃ©tÃ©
    chapterId: { type: mongoose.Schema.Types.ObjectId, ref: 'Chapter' },
    teacherId: { type: mongoose.Schema.Types.ObjectId, ref: 'Teacher' },

    // Ciblage (Distribution)
    classroom: String, // GardÃ© pour compatibilitÃ© legacy
    targetClassrooms: [String], 
    assignedStudents: [{ type: mongoose.Schema.Types.ObjectId, ref: 'Student' }],
    isAllClass: { type: Boolean, default: true },

    // Contenu
    questions: [{
        q: String,          // Ã‰noncÃ©
        options: [String],  // [Rep A, Rep B, Rep C, Rep D]
        a: Number           // Index bonne rÃ©ponse (0-3)
    }],

    isArchived: { type: Boolean, default: false },
    createdAt: { type: Date, default: Date.now }
}, { collection: 'gamelevels' });

module.exports = mongoose.models.GameLevel || mongoose.model('GameLevel', GameLevelSchema);
[[[Â£ END: server/models/GameLevel.js Â£]]]

[[[Â£ FILE: server/models/GameProgress.js Â£]]]
const mongoose = require('mongoose');
const GameProgressSchema = new mongoose.Schema({
    studentId: mongoose.Schema.Types.ObjectId,
    gameId: String,
    levelReached: { type: Number, default: 0 },
    lastScore: Number
}, { collection: 'gameprogress' });
module.exports = mongoose.models.GameProgress || mongoose.model('GameProgress', GameProgressSchema);
[[[Â£ END: server/models/GameProgress.js Â£]]]

[[[Â£ FILE: server/models/Homework.js Â£]]]
const mongoose = require('mongoose');

const HomeworkSchema = new mongoose.Schema({
    title: { type: String, required: true },
    
    // NOUVEAU : Mode Punition
    isPunishment: { type: Boolean, default: false },

    // NOUVEAU : MatiÃ¨re (String simple pour l'affichage Ã©lÃ¨ve)
    subject: { type: String, default: "GÃ©nÃ©ral" },

    // Ancien champ (gardÃ© pour compatibilitÃ©)
    classroom: String,
    
    // Liste des classes ciblÃ©es
    targetClassrooms: [String], 

    chapterId: { type: mongoose.Schema.Types.ObjectId, ref: 'Chapter', required: true },
    teacherId: { type: mongoose.Schema.Types.ObjectId, ref: 'Teacher' },
    
    levels: [{
        instruction: String,
        instructionUrls: [String],
        aiHints: String,
        attachmentUrls: [String]
    }],

    assignedStudents: [{ type: mongoose.Schema.Types.ObjectId, ref: 'Student' }],
    isAllClass: { type: Boolean, default: true },
    
    date: { type: Date, default: Date.now }
}, { collection: 'homeworks' });

module.exports = mongoose.models.Homework || mongoose.model('Homework', HomeworkSchema);
[[[Â£ END: server/models/Homework.js Â£]]]

[[[Â£ FILE: server/models/MistakesBook.js Â£]]]
const mongoose = require('mongoose');
const MistakesBookSchema = new mongoose.Schema({
    studentId: { type: mongoose.Schema.Types.ObjectId, ref: 'Student' },
    wrong: String,
    correct: String,
    context: String,
    date: { type: Date, default: Date.now }
}, { collection: 'mistakes' });
module.exports = mongoose.models.MistakesBook || mongoose.model('MistakesBook', MistakesBookSchema);
[[[Â£ END: server/models/MistakesBook.js Â£]]]

[[[Â£ FILE: server/models/Player.js Â£]]]
const mongoose = require('mongoose');
// GardÃ© uniquement pour la migration initiale
const PlayerSchema = new mongoose.Schema({
    firstName: String, lastName: String, classroom: String, spellingMistakes: Array
}, { collection: 'players' });
module.exports = mongoose.models.Player || mongoose.model('Player', PlayerSchema);
[[[Â£ END: server/models/Player.js Â£]]]

[[[Â£ FILE: server/models/ProjectDoc.js Â£]]]
const mongoose = require('mongoose');
const ProjectDocSchema = new mongoose.Schema({
    fileName: { type: String, unique: true },
    description: String
}, { collection: 'projectdocs' });
module.exports = mongoose.models.ProjectDoc || mongoose.model('ProjectDoc', ProjectDocSchema);
[[[Â£ END: server/models/ProjectDoc.js Â£]]]

[[[Â£ FILE: server/models/ScanSession.js Â£]]]
const mongoose = require('mongoose');

const CorrectionResultSchema = new mongoose.Schema({
    originalUrl: String,
    studentName: String, // IdentifiÃ© par IA
    transcription: String,
    mistakes: [String],
    appreciation: String, // Ajout ApprÃ©ciation
    grade: String // A+, A, B, C
}, { _id: false });

const ScanSessionSchema = new mongoose.Schema({
    title: { type: String, required: true },
    date: { type: Date, default: Date.now },
    teacherId: { type: String, required: true },
    chapterId: { type: mongoose.Schema.Types.ObjectId, ref: 'Chapter' },
    subjectUrls: [String],
    copyUrls: [String],
    aiInstructions: { type: String, default: "Corrige sÃ©vÃ¨rement la syntaxe." },
    corrections: [CorrectionResultSchema],
    status: { type: String, enum: ['OPEN', 'ARCHIVED'], default: 'OPEN' }
}, { collection: 'scansessions' });

module.exports = mongoose.models.ScanSession || mongoose.model('ScanSession', ScanSessionSchema);
[[[Â£ END: server/models/ScanSession.js Â£]]]

[[[Â£ FILE: server/models/Student.js Â£]]]
const mongoose = require('mongoose');

// SchÃ©ma pour les croix/bonus
const BehaviorRecordSchema = new mongoose.Schema({
    teacherId: { type: String, required: true },
    crosses: { type: Number, default: 0 },
    bonuses: { type: Number, default: 0 },
    lastCrossDate: { type: Date, default: null },
    weeksToRedemption: { type: Number, default: 3 }
}, { _id: false });

// SchÃ©ma pour les notes prof
const NoteSchema = new mongoose.Schema({
    teacherId: { type: String, required: true },
    text: { type: String, default: "" }
}, { _id: false });

const StudentSchema = new mongoose.Schema({
    // IdentitÃ©
    firstName: { type: String, required: true },
    lastName: { type: String, required: true },
    fullName: { type: String }, 
    
    // Contacts
    email: { type: String, lowercase: true, trim: true },
    parentEmail: { type: String, lowercase: true, trim: true },

    // ScolaritÃ©
    classId: { type: mongoose.Schema.Types.ObjectId, ref: 'Classroom' },
    currentClass: { type: String }, 
    currentLevel: { type: String }, 
    assignedGroups: [{ type: mongoose.Schema.Types.ObjectId, ref: 'Classroom' }],

    // Plan de classe (CoordonnÃ©es)
    seatX: { type: Number, default: 0 }, 
    seatY: { type: Number, default: 0 }, 
    
    // Vie scolaire
    behaviorRecords: { type: [BehaviorRecordSchema], default: [] },
    teacherNotes: { type: [NoteSchema], default: [] },

    // --- SYSTÃˆME PUNITIONS V3 ---
    punishmentStatus: { type: String, enum: ['NONE', 'PENDING', 'LATE'], default: 'NONE' },
    punishmentDueDate: { type: Date }, // Date limite pour rendre la punition
    totalPunishments: { type: Number, default: 0 }, // Historique compteur

    // SystÃ¨me
    isTestAccount: { type: Boolean, default: false },
    lastLogin: { type: Date, default: Date.now }
}, { collection: 'students' });

module.exports = mongoose.models.Student || mongoose.model('Student', StudentSchema);
[[[Â£ END: server/models/Student.js Â£]]]

[[[Â£ FILE: server/models/StudioProject.js Â£]]]
const mongoose = require('mongoose');

const ActionSchema = new mongoose.Schema({
    type: { type: String, enum: ['WAIT', 'MOVE', 'SAY', 'PLAY_SOUND', 'ASK_CHOICE', 'ASK_INPUT'], required: true },
    targetId: String, 
    params: mongoose.Schema.Types.Mixed 
});

// DEFINITION COSTUME
const CostumeSchema = new mongoose.Schema({
    id: String,
    name: String,
    url: String
}, { _id: false });

const ActorSchema = new mongoose.Schema({
    id: String, 
    name: String, 
    
    // V451 : Ajout explicite des costumes (Indispensable pour le Studio)
    costumes: { type: [CostumeSchema], default: [] },
    currentCostumeIdx: { type: Number, default: 0 },
    
    initialX: Number, 
    initialY: Number, 
    scale: { type: Number, default: 1 }
});

const SceneSchema = new mongoose.Schema({
    name: String,
    backgroundUrl: String,
    actors: [ActorSchema],
    timeline: [ActionSchema] 
});

const StudioProjectSchema = new mongoose.Schema({
    title: { type: String, required: true },
    teacherId: { type: mongoose.Schema.Types.ObjectId, ref: 'Teacher' },
    scenes: [SceneSchema],
    generatedCode: String,
    isPublic: { type: Boolean, default: false }, 
    createdAt: { type: Date, default: Date.now }
}, { collection: 'studioprojects' });

module.exports = mongoose.models.StudioProject || mongoose.model('StudioProject', StudioProjectSchema);
[[[Â£ END: server/models/StudioProject.js Â£]]]

[[[Â£ FILE: server/models/Subject.js Â£]]]
const mongoose = require('mongoose');
const SubjectSchema = new mongoose.Schema({
    name: { type: String, required: true, uppercase: true },
    color: { type: String, default: '#6366f1' },
    icon: String
}, { collection: 'subjects' });
module.exports = mongoose.models.Subject || mongoose.model('Subject', SubjectSchema);
[[[Â£ END: server/models/Subject.js Â£]]]

[[[Â£ FILE: server/models/Submission.js Â£]]]
const mongoose = require('mongoose');
const SubmissionSchema = new mongoose.Schema({
    studentId: { type: mongoose.Schema.Types.ObjectId, ref: 'Student' },
    homeworkId: { type: mongoose.Schema.Types.ObjectId, ref: 'Homework' },
    content: String,
    feedback: String,
    grade: String,
    createdAt: { type: Date, default: Date.now }
}, { collection: 'submissions' });
module.exports = mongoose.models.Submission || mongoose.model('Submission', SubmissionSchema);
[[[Â£ END: server/models/Submission.js Â£]]]

[[[Â£ FILE: server/models/Teacher.js Â£]]]
const mongoose = require('mongoose');

const SectionSchema = new mongoose.Schema({
    name: { type: String, required: true },
    color: { type: String, default: '#6366f1' },
    
    // NOUVEAU V140 : PortÃ©e de la section
    scope: { type: String, enum: ['GLOBAL', 'LEVEL', 'CLASS'], default: 'GLOBAL' },
    target: { type: String, default: null } // ex: "6" ou "6A"
}, { _id: false });

const TeacherSchema = new mongoose.Schema({
    firstName: { type: String, required: true },
    lastName: { type: String, required: true },
    password: { type: String, required: true },
    subjectSections: { type: [SectionSchema], default: [] },
    taughtSubjects: [{ type: mongoose.Schema.Types.ObjectId, ref: 'Subject' }],
    assignedClasses: [{ type: mongoose.Schema.Types.ObjectId, ref: 'Classroom' }],
    isDeveloper: { type: Boolean, default: false },
    driveFolderId: { type: String },
    isTestAccount: { type: Boolean, default: false }
}, { collection: 'teachers' });

module.exports = mongoose.models.Teacher || mongoose.model('Teacher', TeacherSchema);
[[[Â£ END: server/models/Teacher.js Â£]]]

[[[Â£ FILE: server/models/TeacherStyle.js Â£]]]
const mongoose = require('mongoose');
const TeacherStyleSchema = new mongoose.Schema({ teacherId: String, pedagogicalMemory: String });
module.exports = mongoose.models.TeacherStyle || mongoose.model('TeacherStyle', TeacherStyleSchema);
[[[Â£ END: server/models/TeacherStyle.js Â£]]]

[[[Â£ FILE: server/server.js Â£]]]
const path = require('path');
const fs = require('fs');
const express = require('express');
const mongoose = require('mongoose');
const dotenv = require('dotenv');

// POLYFILLS
if (!global.fetch) {
    const fetch = require('node-fetch');
    global.fetch = fetch;
    global.Headers = fetch.Headers;
    global.Request = fetch.Request;
    global.Response = fetch.Response;
}

dotenv.config();
const app = express();
const port = process.env.PORT || 3000;
const SERVER_BOOT_ID = Date.now();

// CHARGEMENT MODÃˆLES
const models = ['AcademicYear', 'Admin', 'Classroom', 'Subject', 'Teacher', 'Student', 'Enrollment', 'Chapter', 'Homework', 'Submission', 'GameLevel', 'GameProgress', 'MistakesBook', 'AccessLog', 'BugReport', 'ProjectDoc', 'Player', 'StudioProject', 'Sanction', 'ScanSession'];
models.forEach(m => { try { require(`./models/${m}`); } catch (e) { console.error(`Err Model ${m}:`, e.message); } });

app.use(express.json({ limit: '100mb' }));

// --- SERVEUR D'IMAGES INTELLIGENT V2 (DÃ‰TECTIVE) ---
const uploadsPath = path.resolve(process.cwd(), 'public', 'uploads');
if (!fs.existsSync(uploadsPath)) fs.mkdirSync(uploadsPath, { recursive: true });

app.get('/uploads/:filename', (req, res) => {
    const requestedFile = req.params.filename;
    const cleanName = requestedFile.split('?')[0]; // EnlÃ¨ve les paramÃ¨tres d'URL Ã©ventuels
    const filePath = path.join(uploadsPath, cleanName);

    // 1. Recherche Exacte
    if (fs.existsSync(filePath)) return res.sendFile(filePath);

    // 2. Recherche avec extensions (si l'URL n'en a pas ou si c'est la mauvaise)
    const extensions = ['.jpg', '.jpeg', '.png', '.webp', '.blob'];
    for (const ext of extensions) {
        if (fs.existsSync(filePath + ext)) {
            // console.log(`ğŸ” [SMART-IMG] RetrouvÃ© avec extension : ${cleanName}${ext}`);
            return res.sendFile(filePath + ext);
        }
    }

    // 3. Recherche approximative (Si le nom a Ã©tÃ© tronquÃ©)
    // On cherche un fichier qui commence par le mÃªme ID (ex: "scan-12345...")
    try {
        const dirFiles = fs.readdirSync(uploadsPath);
        // On suppose que le fichier commence par "scan-" ou "hw-" ou "studio-"
        const prefix = cleanName.split('.')[0]; 
        const match = dirFiles.find(f => f.startsWith(prefix));
        if (match) {
            // console.log(`ğŸ” [SMART-IMG] Correspondance approximative : ${match}`);
            return res.sendFile(path.join(uploadsPath, match));
        }
    } catch(e) {}

    // Ã‰CHEC
    console.error(`âŒ [IMG-404] Introuvable sur le disque : ${cleanName}`);
    res.status(404).send('Fichier introuvable');
});

// ROUTES API
app.use('/api/auth', require('./domains/auth/auth.routes'));
app.use('/api/admin', require('./domains/admin/admin.routes'));
app.use('/api/structure', require('./domains/structure/structure.routes'));
app.use('/api/games', require('./domains/games/games.routes'));
app.use('/api/homework', require('./domains/homework/homework.routes')); 
app.use('/api/studio', require('./domains/studio/studio.routes'));
app.use('/api/classroom', require('./domains/classroom/classroom.routes'));
app.use('/api/scans', require('./domains/scans/scans.routes'));

app.get('/api/check-deploy', (req, res) => res.json({ bootId: SERVER_BOOT_ID, status: "OK" }));

app.use((err, req, res, next) => {
    console.error("ğŸ”¥ [SERVER_ERROR]:", err.message);
    res.status(500).json({ error: err.message || "Erreur serveur" });
});

mongoose.connect(process.env.MONGODB_URI).then(() => console.log('âœ… BDD CONNECTÃ‰E & MODÃˆLES PRÃŠTS'));

const distPath = path.resolve(process.cwd(), 'client', 'dist');
if (fs.existsSync(distPath)) {
    app.use(express.static(distPath));
    app.get('*', (req, res) => {
        if (req.url.startsWith('/uploads/')) return next();
        res.sendFile(path.join(distPath, 'index.html'));
    });
}
app.listen(port, '0.0.0.0', () => console.log(`ğŸš€ SERVEUR V108 (FILE DETECTIVE) UP | PORT ${port}`));
[[[Â£ END: server/server.js Â£]]]

[[[Â£ FILE: server/version.json Â£]]]
{
  "version": "1.94.0",
  "build": 217,
  "timestamp": "2026-01-20T18:30:00.000Z",
  "studio_version": 94,
  "status": "CROSS_DOMAIN_COHERENCE_LOCKED",
  "storage_strategy": "VAULT_WITH_INTEGRITY_CHECK"
}
[[[Â£ END: server/version.json Â£]]]

[[[Â£ FILE: snap.js Â£]]]
const fs = require('fs');
const path = require('path');
require('dotenv').config();

const OUTPUT_FILENAME = 'snapshot.txt';
const MAP_FILENAME = 'projectMap.txt';
const IGNORE = [
    'node_modules', '.git', 'dist', 'build', 'snapshot.txt', 'update.txt', 
    '.env', 'package-lock.json', '${rel}', 'path', 'chemin'
];

function buildTree(dir, prefix = '') {
    let structure = '';
    try {
        const items = fs.readdirSync(dir).filter(i => !IGNORE.includes(i));
        items.sort();
        items.forEach((item, index) => {
            const isLast = index === items.length - 1;
            const fullPath = path.join(dir, item);
            const isDir = fs.statSync(fullPath).isDirectory();
            structure += prefix + (isLast ? 'â””â”€â”€ ' : 'â”œâ”€â”€ ') + item + (isDir ? '/' : '') + '\n';
            if (isDir) structure += buildTree(fullPath, prefix + (isLast ? '    ' : 'â”‚   '));
        });
    } catch (e) {}
    return structure;
}

function captureContent(dir, baseDir = "") {
    let content = "";
    try {
        const items = fs.readdirSync(dir).filter(i => !IGNORE.includes(i));
        for (const item of items) {
            const p = path.join(dir, item);
            const rel = path.join(baseDir, item);
            const stat = fs.statSync(p);
            if (stat.isDirectory()) {
                content += captureContent(p, rel);
            } else {
                const ext = path.extname(item).toLowerCase();
                if (['.js', '.jsx', '.css', '.json', '.html', '.md'].includes(ext)) {
                    const fileContent = fs.readFileSync(p, 'utf8');
                    content += `\n[[[Â£ FILE: ${rel} Â£]]]\n${fileContent}\n[[[Â£ END: ${rel} Â£]]]\n`;
                }
            }
        }
    } catch (e) {}
    return content;
}

function run() {
    console.log("ğŸ“¸ GÃ©nÃ©ration du Snapshot Optimum...");
    const tree = buildTree(__dirname);
    const code = captureContent(__dirname);
    const finalContent = `STRUCTURE:\n${tree}\n\nCODE:\n${code}`;
    fs.writeFileSync(OUTPUT_FILENAME, finalContent);
    fs.writeFileSync(MAP_FILENAME, tree);
    console.log(`âœ¨ TerminÃ© : ${OUTPUT_FILENAME} est le miroir parfait du projet.`);
}
run();
[[[Â£ END: snap.js Â£]]]

[[[Â£ FILE: systemInstructions.md Â£]]]
RÃˆGLES DE SORTIE : Utilisez Gemini 2.0 Flash. Fichiers complets. Tags [[[Â£ FILE: path Â£]]] content [[[Â£ END: path Â£]]]. Snippet unique.
relie apply.js pour bien comprendre le system.
REGLE D OR ABSOLUE: ENVOYER Une introduction
Puis LE CODE EN UN SEUL BLOC PRÃ‰CÃ‰DÃ‰ DE ````ET SUIVIT DE ```` AFIN DE GÃ‰NÃ‰RÃ‰ UNE SNIPETTE QUE JE POURRAIS COLLER DANS UPDATE.TXT TOUT CODE NON CONTENU DANS UNE SIPETTE UNIQUE SERA INUTILE TOKENS PERDUS
Enfin une conclusion

GOOGLE DRIVE UTILISE L INTELLIGENCE DE MON ADRESSE PERSO VUILLET.JEAN@GMAIL.COM MAIS TRAVAIL DANS LE GOOGLE PRO VUILLET.JEAN@CONDAMINE.EDU.EC


!!! EN MAJUSCULE CELLES QUI MARCHENT PAS OU LES BUGS
Liste des fonctionalitÃ©s du site a ne surtout pas casser et a faire progresser
ğŸ›¡ï¸ 1. ESPACE ADMIN (Le CÅ“ur du SystÃ¨me)
C'est la base de donnÃ©es et la structure de l'Ã©tablissement.
FonctionnalitÃ©s SanctuarisÃ©es (Ã€ ne pas casser) :
Importation Massive : Je peux importer des listes d'Ã©lÃ¨ves via copier-coller (texte tableau) ou fichier CSV. L'IA doit parser les colonnes (Nom, PrÃ©nom, Classe, Options, Email) automatiquement.
Gestion Utilisateurs :
CrÃ©er/Modifier/Supprimer un Admin.
CrÃ©er/Modifier/Supprimer un Professeur : Lui assigner ses MatiÃ¨res et ses Classes et ses Groupes (ex: 2A, 1D BFI).
CrÃ©er/Modifier/Supprimer un Ã‰lÃ¨ve : DÃ©finir son Nom, PrÃ©nom, Email, Email Parents, Classe principale et ses Groupes (Options).
Gestion Structurelle : CrÃ©er les Classes (ex: 6A) et les Groupes (ex: 3C LVA Anglais).
Ã€ Faire Progresser :
Nettoyage BDD : Pouvoir archiver une annÃ©e scolaire ou nettoyer les Ã©lÃ¨ves sans classe d'un clic.
SantÃ© SystÃ¨me : Un tableau de bord technique pour voir si le Drive est connectÃ© et si l'API IA rÃ©pond.
ğŸ“ 2. ESPACE PROFESSEUR (L'Outil Quotidien)
DivisÃ© en Gestion de Classe, CrÃ©ation (Studio) et Correction.
A. Gestion de Classe & Vie Scolaire
FonctionnalitÃ©s SanctuarisÃ©es :
Trombinoscope/Plan de classe : Je peux voir mes Ã©lÃ¨ves sous forme de grille ou de liste.
Comportement (Gamification) :
Mettre une Croix (Sanction). Au bout de 3 croix -> Punition automatique (Statut PENDING): 
!!!  A AJOUTER:COMPLETER : un devoir dÃ©fini comme punition pour ce niveau est automatiquement attribuÃ© Ã  l'Ã©lÃ¨ve si une punition existe pour ce niveau
!!!  A AJOUTER:COMPLETER : Mettre un Bonus (RÃ©compense). SI 4 BONUS AFFICHER RÃ‰COMPENSE A+ POUR L Ã‰LÃˆVE ET AUSSI COTÃ‰ PROF (CET Ã‰LÃˆVE A EU UN A+)
Voir la barre de "Rachat" (temps restant avant annulation d'une croix).
DÃ©placement : Je peux dÃ©placer les Ã©lÃ¨ves sur le plan de classe par glisser-dÃ©poser.
VOIR LES DEVOIRS/JEUX LA PARTIE DROIT DES DIV Ã‰LÃˆVE C EST DES PETITS POINTS DE COULEURS QUI CORRESPONDENT AUX DEVOIRS DONNES PAR CE PROF PASTILLE BLANCHE LE DEVOIR/JEU N EST PAS INITIÃ‰ JAMAIS L Ã‰LÃˆVE N A CLIQUE DESSUS PASTILLE JAUNE L Ã‰LÃˆVE A OUVERT LE DEVOIR JEU ET NE L A PAS FINI (JEU NON GAGNE OU ENVOIE DU DEVOIR NON VALIDÃ‰ PAR L IA)
B. Studio de CrÃ©ation (ActivitÃ©s)
FonctionnalitÃ©s SanctuarisÃ©es :
CrÃ©ation de Devoirs (Homework) :
DÃ©finir un Titre, une Consigne textuelle, UNE CONSIGNE POUR L IA (GRILLE/INDICATIONS DE CORRECTIONS)
Uploader des fichiers (Sujet, PiÃ¨ces jointes).
Ciblage : Assigner Ã  une Classe entiÃ¨re (ex: 2A) OU Ã  un Groupe (ex: 1D BFI).
!!!MULTIPAGE JE PEU AJOUTER UNE NOUVELLE PAGE DE DEVOIR AVEC D AUTRES DOCUMENTS ET  D AUTRES CONSIGNES ELEVES (TAPPES EN TXT OU IMPORTE UNE IMAGE DE QUESTIONS) ET D AUTRES CONSIGNES DE CORRECTION IA POUR CETTE PAGE
BOUTON PUNITION: DÃ‰CLARER LE DEVOIR COMME PUNITION (IL SERA ATTRIBUE AUTOMATIQUEMENT AUX ELEVES QUI ONT 3 CROIX DE CE NIVEAU)
Dossier : Ranger le devoir dans un Chapitre/Dossier (ex: "GÃ©omÃ©trie").PAR DEFAUT IL SERA RANGE DANS UN DOSSIER COURRANT (NON STOCKE DANS LES ARCHIVES) AU HAZAR
CrÃ©ation de Jeux (Quiz) :
GÃ©nÃ©rer des questions via IA (je peu choisir le nombre de questions generees).
Ã‰diter manuellement les questions/rÃ©ponses.
Publier pour une classe/groupe spÃ©cifique.
!!!SI JE SUIS ELEVE D UNE OPTION ET QUE LE JEU A Ã‰TÃ‰ CRÃ‰Ã‰ POUR CETTE OPTION OU GROUPE JE VOIS LE JEU PROPOSÃ‰E SUR MON COMPTE Ã‰LÃˆVE
Ã€ Faire Progresser :
Mode Punition : CrÃ©er un devoir spÃ©cial "Punition" qui ne s'assigne qu'aux Ã©lÃ¨ves ayant 3 croix (dÃ©jÃ  en place, Ã  fiabiliser).
Sections PersonnalisÃ©es : CrÃ©er des sections (ex: "TP", "Cours") pour organiser les chapitres, sans pouvoir supprimer la section "GÃ‰NÃ‰RAL" par erreur.
C. Scan & Correction (Le Workflow)
JE CRÃ‰E UN NOUVEAU DC (DEVOIR EN CLASSE) UN DIV APPARAIT SUR DEUX LIGNES LIGNE 1 NOM DU DEVOIR DOSSIER DE RANGEMENT (PAR DÃ‰FAUT UN DOSSIER COURRANT EST SELECTIONNÃ‰)
LIGNE 2: UN BOUTON INSTRUCTION (PERMET DE SCANNER INSTRUCTIONS PHOTOS DES QUESTIONS A ENVOYER A L IA), UN BOUTON SCAN (PERMET DE SCANNER LES COPIES) UN BOUTON DEVOIR (OUVRE UN DIV AVEC TOUS LES DEVOIRS SCANNÃ‰S ET ENVOYÃ‰S EN BDD ET DANS LE DRIVE) UN BOUTON CORRECTION (AVEC UN DIV OU JE DONNE LES INSTRUCTIONS DE CORRECTION POUR L IA ET EN DESSOUS LES CORRECTIONS DE L IA APPARAISSENT)
INSTRUCTIONS DE CORRETION DE BASE POUR LES SCANES:
-IDENTIFIER L L Ã‰LÃˆVE GRACE AU NOM SUR LA COPIE ET LA CLASSE COURRANTE SÃ‰LECITONNÃ‰E
-METTRE EN HAUT UNE APPRÃ‰CIATION GLOBALE SUR LE TRAVAIL
-METTRE UNE LETTRE (A+ TRES BON DEVOIR A DEVOIR CORRECT OU BON L ESSENTIEL DE CE QUI Ã‰TAIT ATTENDU EST LA B COMPÃ‰TENCES EN COURS D ACQUISITION CERTAINS Ã‰LÃ‰MENTS ATTENDU SONT PRÃ‰SENTS MAIS PAS LA MAJORITÃ‰ OU C TRAVAIL INSUFFISANT TRÃˆS PEU D Ã‰LÃ‰MENTS ATTENDUS SONT PRÃ‰SENTS ON VOI UN MANQUE DE SÃ‰RIEUX DANS LE TRAVAIL )
FonctionnalitÃ©s SanctuarisÃ©es :
Scan Studio :
Prendre en photo des copies via la Webcam ou le TÃ©lÃ©phone (Interface WYSIWYG).
Prendre en photo le Sujet de rÃ©fÃ©rence.
IA Correcteur :
Lancer l'IA sur un lot de copies scannÃ©es.

Rangement Drive : Envoyer les scans et corrections vers le dossier Google Drive ET STOCKER LES ID DU SUJET POUR LA CLASSE DE LA COPIE ET SA CORRECTION POUR L Ã‰LÃˆVE
LE PROF PEUT VOIR L ENSEMBLE DANS SON ONGLET Ã‰LÃˆVES SUR ORDI UNIQUEMENT OU SOUS FORME DE PASTILLE DE COULEUR DANS L ONGLET CLASSE 
ğŸ’ 3. ESPACE Ã‰LÃˆVE (L'ExpÃ©rience Utilisateur)
SimplifiÃ© pour une lecture immÃ©diate.
FonctionnalitÃ©s SanctuarisÃ©es :
Dashboard MatiÃ¨res : Je vois mes devoirs regroupÃ©s par MatiÃ¨re (ex: "Maths", "Histoire") et non par dossier technique.
Statut Devoir : Je vois clairement ce qui est "Ã€ FAIRE" (Rouge), "EN COURS" (Bleu) ou "FAIT" (Vert).
RÃ©alisation Devoir :
Je peux lire la consigne et voir les documents.
Je peux rÃ©pondre par texte.
Je reÃ§ois un feedback immÃ©diat (Note/Conseil) si l'IA est active sur le devoir.
SI JE RECOIS ROUGE C INSUFFISANT DANS CE CAS MA RÃ‰PONS EST EFFACÃ‰E ET JE DOIS LA REFAIRE SI JE RECOIS JAUNE B ALORS L IA ME DONNE QUELQUES INDICES ET JE PEU COMPLÃ‰TER MA RÃ‰PONSE SI JE RECOIS VERT A ALORS MA RÃ‰PONSE EST VALIDÃ‰E LE DEVOIR EST CONSIDÃ‰RÃ‰ COMME FAIT SI JE RECOIS VERT FONCÃ‰ A+ UN MESSAGE DE FÃ‰LICIATION M EST ENVOYÃ‰ POUR LA QUALITÃ‰ DE MON TRAVAIL
Jeux de RÃ©vision :
Je peux lancer un jeu (Zombie/Starship) associÃ© Ã  mon niveau.
Mon score est enregistrÃ©.
Carnet de Bord :
Je vois mes Croix (Sanctions) et mes Bonus PAR MATIÃˆRE.
Je vois si j'ai une Punition Ã  rendre (Alerte Rouge).
Je vois mon "Carnet d'Erreurs" (fautes d'orthographe rÃ©currentes relevÃ©es par l'IA).
ğŸ§  4. MOTEUR & INTELLIGENCE (Invisible mais Vital)
FonctionnalitÃ©s SanctuarisÃ©es :
Auth Hybride : Connexion via mot de passe simple (Prof/Admin) ou sÃ©lection visuelle (Ã‰lÃ¨ves "Magic Finder").
Google Drive Proxy : Les images stockÃ©es sur le Drive privÃ© du prof sont visibles sur le site via un "Proxy" (le serveur fait le pont) pour Ã©viter les images brisÃ©es.
SÃ©curitÃ© des DonnÃ©es : Un Ã©lÃ¨ve ne voit jamais les donnÃ©es d'un autre Ã©lÃ¨ve (notes, croix).
IntÃ©gritÃ© Structurelle : Chaque utilisateur (Prof) a sa propre arborescence de dossiers qui se crÃ©e automatiquement si elle n'existe pas.
[[[Â£ END: systemInstructions.md Â£]]]

[[[Â£ FILE: tests/integrity.test.js Â£]]]
/**
 * ğŸ•µï¸â€â™‚ï¸ SUITE DE TESTS D'INTÃ‰GRITÃ‰ - VERSION 69
 * Ce script valide que chaque injection de code respecte les User Stories.
 */
const fetch = require('node-fetch');

const API = "http://localhost:3000/api";

async function runIntegritySuite() {
    console.log("\nğŸš€ [GARDien] LANCEMENT DES TESTS DE NON-RÃ‰GRESSION...");
    console.log("------------------------------------------------");

    const tests = [
        { name: "SÃ‰CURITÃ‰ : Chargement des 17 ModÃ¨les", url: "/admin/database-dump" },
        { name: "CLOUDSYNC : AccÃ¨s au RÃ©servoir Vault", url: "/structure/drive-tree" },
        { name: "IA : Moteur Gemini 2.0 Flash", url: "/structure/diagnostic?mode=deep" },
        { name: "AUTH : Backdoor Architecte (Jean)", url: "/auth/config" }
    ];

    let fails = 0;

    for (const t of tests) {
        try {
            const res = await fetch(`${API}${t.url}`);
            if (res.ok) {
                console.log(`âœ… PASS : ${t.name}`);
            } else {
                console.log(`âŒ FAIL : ${t.name} (Status: ${res.status})`);
                fails++;
            }
        } catch (e) {
            console.log(`âŒ CRASH : ${t.name} (Serveur Ã©teint ?)`);
            fails++;
        }
    }

    console.log("------------------------------------------------");
    if (fails > 0) {
        console.log(`âš ï¸  ALERTE : ${fails} rÃ©gression(s) dÃ©tectÃ©e(s). MERGE DÃ‰CONSEILLÃ‰.`);
        process.exit(1);
    } else {
        console.log("âœ¨ SYSTÃˆME 100% VALIDE. PRÃŠT POUR INJECTION.");
        process.exit(0);
    }
}

runIntegritySuite();
[[[Â£ END: tests/integrity.test.js Â£]]]
