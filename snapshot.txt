STRUCTURE:
â”œâ”€â”€ ...
â”œâ”€â”€ .gitignore
â”œâ”€â”€ INSTRUCTIONS_OAUTH.md
â”œâ”€â”€ LOCKED_FILES.md
â”œâ”€â”€ apply.js
â”œâ”€â”€ apply_status.json
â”œâ”€â”€ cleanup.js
â”œâ”€â”€ client/
â”‚   â”œâ”€â”€ .eslintrc.cjs
â”‚   â”œâ”€â”€ .gitignore
â”‚   â”œâ”€â”€ README.md
â”‚   â”œâ”€â”€ index.html
â”‚   â”œâ”€â”€ package.json
â”‚   â”œâ”€â”€ postcss.config.cjs
â”‚   â”œâ”€â”€ public/
â”‚   â”‚   â””â”€â”€ vite.svg
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ App.css
â”‚   â”‚   â”œâ”€â”€ App.jsx
â”‚   â”‚   â”œâ”€â”€ assets/
â”‚   â”‚   â”‚   â””â”€â”€ react.svg
â”‚   â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”‚   â””â”€â”€ SystemStatus/
â”‚   â”‚   â”‚       â”œâ”€â”€ SystemStatus.css
â”‚   â”‚   â”‚       â””â”€â”€ SystemStatus.jsx
â”‚   â”‚   â”œâ”€â”€ features/
â”‚   â”‚   â”‚   â”œâ”€â”€ admin/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ AdminDashboard.css
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ AdminDashboard.jsx
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ AdminPage.css
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ AdminPage.jsx
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ components/
â”‚   â”‚   â”‚   â”‚       â”œâ”€â”€ DatabaseViewer.css
â”‚   â”‚   â”‚   â”‚       â”œâ”€â”€ DatabaseViewer.jsx
â”‚   â”‚   â”‚   â”‚       â”œâ”€â”€ DriveViewer.css
â”‚   â”‚   â”‚   â”‚       â””â”€â”€ DriveViewer.jsx
â”‚   â”‚   â”‚   â””â”€â”€ auth/
â”‚   â”‚   â”‚       â”œâ”€â”€ Login.css
â”‚   â”‚   â”‚       â””â”€â”€ Login.jsx
â”‚   â”‚   â”œâ”€â”€ index.css
â”‚   â”‚   â”œâ”€â”€ main.jsx
â”‚   â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”‚   â””â”€â”€ api.js
â”‚   â”‚   â”œâ”€â”€ test_ok.txt
â”‚   â”‚   â”œâ”€â”€ test_token_crash.js
â”‚   â”‚   â””â”€â”€ test_token_valid.txt
â”‚   â”œâ”€â”€ tailwind.config.cjs
â”‚   â””â”€â”€ vite.config.js
â”œâ”€â”€ git-auto.js
â”œâ”€â”€ history.txt
â”œâ”€â”€ init-db.js
â”œâ”€â”€ magic-paste.js
â”œâ”€â”€ package.json
â”œâ”€â”€ projectMap.txt
â”œâ”€â”€ public/
â”‚   â”œâ”€â”€ images/
â”‚   â”‚   â”œâ”€â”€ Fiche_Croissance_Demographique_5e.docx
â”‚   â”‚   â”œâ”€â”€ jetpack.png
â”‚   â”‚   â”œâ”€â”€ jumper.png
â”‚   â”‚   â””â”€â”€ ~$che_Croissance_Demographique_5e.docx
â”‚   â”œâ”€â”€ style.css
â”‚   â””â”€â”€ uploads/
â”œâ”€â”€ server/
â”‚   â”œâ”€â”€ core/
â”‚   â”‚   â”œâ”€â”€ ai.engine.js
â”‚   â”‚   â”œâ”€â”€ drive.engine.js
â”‚   â”‚   â””â”€â”€ ocr.engine.js
â”‚   â”œâ”€â”€ domains/
â”‚   â”‚   â”œâ”€â”€ admin/
â”‚   â”‚   â”‚   â”œâ”€â”€ admin.routes.js
â”‚   â”‚   â”‚   â”œâ”€â”€ ai/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ admin.ai.js
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ project-doc.ai.js
â”‚   â”‚   â”‚   â”œâ”€â”€ db/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ admin.db.js
â”‚   â”‚   â”‚   â””â”€â”€ experts/
â”‚   â”‚   â”‚       â”œâ”€â”€ admin.db.js
â”‚   â”‚   â”‚       â””â”€â”€ admin.expert.js
â”‚   â”‚   â””â”€â”€ auth/
â”‚   â”‚       â”œâ”€â”€ auth.routes.js
â”‚   â”‚       â”œâ”€â”€ db/
â”‚   â”‚       â”‚   â””â”€â”€ auth.db.js
â”‚   â”‚       â””â”€â”€ experts/
â”‚   â”‚           â””â”€â”€ auth.expert.js
â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â”œâ”€â”€ AcademicYear.js
â”‚   â”‚   â”œâ”€â”€ AccessLog.js
â”‚   â”‚   â”œâ”€â”€ Admin.js
â”‚   â”‚   â”œâ”€â”€ BugReport.js
â”‚   â”‚   â”œâ”€â”€ Classroom.js
â”‚   â”‚   â”œâ”€â”€ DeploySignal.js
â”‚   â”‚   â”œâ”€â”€ Enrollment.js
â”‚   â”‚   â”œâ”€â”€ ProjectDoc.js
â”‚   â”‚   â”œâ”€â”€ Student.js
â”‚   â”‚   â”œâ”€â”€ Subject.js
â”‚   â”‚   â””â”€â”€ Teacher.js
â”‚   â”œâ”€â”€ server.js
â”‚   â””â”€â”€ version.json
â”œâ”€â”€ snap.js
â”œâ”€â”€ systemInstructions.md
â”œâ”€â”€ tests/
â”‚   â””â”€â”€ integrity.test.js
â”œâ”€â”€ tree.txt
â””â”€â”€ verificatons.txt


CODE:

[[[Â£ FILE: INSTRUCTIONS_OAUTH.md Â£]]]
# ğŸ” RÃ‰PARER L'ERREUR INVALID_GRANT
Si ton token expire, lance : http://localhost:3000/api/auth/google/login
Puis colle le code dans ton .env (GOOGLE_REFRESH_TOKEN).
[[[Â£ END: INSTRUCTIONS_OAUTH.md Â£]]]

[[[Â£ FILE: LOCKED_FILES.md Â£]]]
# ğŸ”’ FICHIERS SANCTUARISÃ‰S
- server/server.js (Enregistrement ModÃ¨les)
- client/src/App.jsx (Logiciel de synchronisation)
[[[Â£ END: LOCKED_FILES.md Â£]]]

[[[Â£ FILE: apply.js Â£]]]
const fs = require('fs');
const path = require('path');
const inputFile = 'update.txt';
const statusFile = 'apply_status.json';

console.log("------------------------------------------------");
console.log("ğŸ¤– [CONSTITUTION] apply.js v32 actif.");
console.log("ğŸš€ Correction Boucle Sync - Build #369");
console.log("------------------------------------------------");

function setStatus(status, file = null) {
    try { fs.writeFileSync(statusFile, JSON.stringify({ status, file, timestamp: Date.now() }, null, 2)); } catch (e) {}
}

function applyUpdate() {
    if (!fs.existsSync(inputFile)) return;
    let rawContent = "";
    try { rawContent = fs.readFileSync(inputFile, 'utf8'); } catch (e) { return; }
    if (rawContent.trim().length < 10) return;

    let processed = false;
    const startRegex = /\[\[\[Â£\s*FILE\s*:\s*([^Â£\]\s]+)\s*Â£\]\]\]/g;
    let startMatch;

    while ((startMatch = startRegex.exec(rawContent)) !== null) {
        const filePath = startMatch[1].trim();
        const contentStartIndex = startMatch.index + startMatch[0].length;
        const endTag = `[[[Â£ END: ${filePath} Â£]]]`;
        const endIdx = rawContent.indexOf(endTag);

        if (endIdx !== -1) {
            const fileContent = rawContent.substring(contentStartIndex, endIdx).trim();
            const fullPath = path.join(__dirname, filePath);
            if (!fs.existsSync(path.dirname(fullPath))) fs.mkdirSync(path.dirname(fullPath), { recursive: true });
            fs.writeFileSync(fullPath, fileContent);
            console.log(`   âœ… ALIGNÃ‰ : ${filePath}`);
            processed = true;
        }
    }
    if (processed) {
        fs.writeFileSync(inputFile, '');
        setStatus('OK');
        console.log("âœ¨ SYNC TERMINÃ‰E.");
    }
}
setStatus('OK');
setInterval(applyUpdate, 1000);
[[[Â£ END: apply.js Â£]]]

[[[Â£ FILE: apply_status.json Â£]]]
{
  "status": "OK",
  "file": null,
  "timestamp": 1769739142577
}
[[[Â£ END: apply_status.json Â£]]]

[[[Â£ FILE: cleanup.js Â£]]]
const fs = require('fs');
const path = require('path');

const DIRS_TO_CLEAN = [
    'public/uploads',
    'public/uploads/temp'
];

console.log("ğŸ§¹ NETTOYAGE DES FICHIERS TEMPORAIRES...");

function cleanDir(directory) {
    const fullPath = path.join(__dirname, directory);
    if (fs.existsSync(fullPath)) {
        const files = fs.readdirSync(fullPath);
        for (const file of files) {
            if (file === '.gitkeep') continue;
            try {
                fs.unlinkSync(path.join(fullPath, file));
                console.log(`   ğŸ—‘ï¸ SupprimÃ© : ${file}`);
            } catch (e) {
                console.error(`   âŒ Erreur suppression ${file}`);
            }
        }
    } else {
        // CrÃ©ation si inexistant pour Ã©viter crash
        fs.mkdirSync(fullPath, { recursive: true });
    }
}

DIRS_TO_CLEAN.forEach(dir => cleanDir(dir));

console.log("âœ¨ DOSSIER UPLOADS VIDÃ‰ (Fichiers inutiles supprimÃ©s).");
[[[Â£ END: cleanup.js Â£]]]

[[[Â£ FILE: client/README.md Â£]]]
# React + Vite

This template provides a minimal setup to get React working in Vite with HMR and some ESLint rules.

Currently, two official plugins are available:

- [@vitejs/plugin-react](https://github.com/vitejs/vite-plugin-react/blob/main/packages/plugin-react/README.md) uses [Babel](https://babeljs.io/) for Fast Refresh
- [@vitejs/plugin-react-swc](https://github.com/vitejs/vite-plugin-react-swc) uses [SWC](https://swc.rs/) for Fast Refresh
[[[Â£ END: client/README.md Â£]]]

[[[Â£ FILE: client/index.html Â£]]]
<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Condamine Pro</title>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.jsx"></script>
  </body>
</html>
[[[Â£ END: client/index.html Â£]]]

[[[Â£ FILE: client/package.json Â£]]]
{
  "name": "client",
  "private": true,
  "version": "0.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite --host",
    "build": "vite build",
    "preview": "vite preview"
  },
  "dependencies": {
    "react": "^18.2.0",
    "react-dom": "^18.2.0",
    "react-router-dom": "^7.11.0",
    "@vitejs/plugin-basic-ssl": "1.1.0"
  },
  "devDependencies": {
    "@vitejs/plugin-react": "^4.0.3",
    "autoprefixer": "^10.4.16",
    "postcss": "^8.4.31",
    "tailwindcss": "^3.4.1",
    "vite": "^4.4.5"
  }
}
[[[Â£ END: client/package.json Â£]]]

[[[Â£ FILE: client/src/App.css Â£]]]
.app-wrapper {
    min-height: 100vh;
    background-color: #f8fafc;
    position: relative;
    display: flex;
    flex-direction: column;
}

/* BANDEAU DE SÃ‰CURITÃ‰ V99 : INTÃ‰GRÃ‰ AU FLUX (NE POLLUE PLUS) */
.v99-test-header {
    background: #dc2626;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 15px;
    color: white;
    font-family: 'JetBrains Mono', monospace;
    font-weight: 900;
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 1px;
    z-index: 11000;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
}

.btn-back-dev-mini {
    background: white;
    color: #dc2626;
    border: none;
    padding: 4px 12px;
    border-radius: 6px;
    font-weight: 950;
    font-size: 0.6rem;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-back-dev-mini:hover {
    transform: scale(1.05);
    background: #fef2f2;
}

.sync-overlay {
    position: fixed; inset: 0; background: #0f172a;
    display: flex; align-items: center; justify-content: center;
    z-index: 9999999;
}
[[[Â£ END: client/src/App.css Â£]]]

[[[Â£ FILE: client/src/App.jsx Â£]]]
import React, { useState, useEffect, useRef } from 'react';
import Login from './features/auth/Login';
import AdminPage from './features/admin/AdminPage';
import SystemStatus from './components/SystemStatus/SystemStatus';
import './App.css';

export default function App() {
  const [user, setUser] = useState(null);
  const [isSyncing, setIsSyncing] = useState(false);
  const [isAppReady, setIsAppReady] = useState(false); 
  const bootIdRef = useRef(null);

  useEffect(() => {
    const checkUpdate = async () => {
      try {
        const res = await fetch('/api/check-deploy');
        if (!res.ok) return;
        const data = await res.json();
        
        if (!bootIdRef.current) {
            bootIdRef.current = data.bootId;
            setIsAppReady(true);
        } else if (data.bootId !== bootIdRef.current) {
            setIsSyncing(true);
            setIsAppReady(false);
            setTimeout(() => window.location.reload(), 1000);
        }
      } catch (e) {}
    };
    const timer = setInterval(checkUpdate, 5000);
    return () => clearInterval(timer);
  }, []);

  useEffect(() => {
    const saved = localStorage.getItem('player');
    if (saved) {
        try {
            const parsed = JSON.parse(saved);
            // FILTRE DE SÃ‰CURITÃ‰ : Uniquement Admin ou Dev
            if (parsed.role === 'admin' || parsed.isDeveloper) {
                setUser({ ...parsed, id: parsed._id || parsed.id });
            } else {
                localStorage.clear();
            }
        } catch(e) {
            localStorage.clear();
        }
    }
  }, []);

  const handleLogout = () => { 
      localStorage.clear(); 
      setUser(null); 
  };

  if (isSyncing) return (
    <div className="sync-overlay">
        <div className="text-center">
            <div className="w-12 h-12 border-4 border-indigo-500 border-t-transparent rounded-full animate-spin mb-4 mx-auto"></div>
            <h2 className="text-white font-black uppercase tracking-tighter">Synchronisation Core...</h2>
        </div>
    </div>
  );
  
  if (!user) return (
      <div className="app-wrapper">
          <SystemStatus isAppReady={isAppReady} />
          <Login onLoginSuccess={setUser} />
      </div>
  );

  return (
    <div className="app-wrapper">
      <SystemStatus isAppReady={isAppReady} />
      <AdminPage user={user} onLogout={handleLogout} />
    </div>
  );
}
[[[Â£ END: client/src/App.jsx Â£]]]

[[[Â£ FILE: client/src/components/SystemStatus/SystemStatus.css Â£]]]
.system-status-banner-flow {
    position: relative;
    width: 100%;
    color: white;
    font-family: 'JetBrains Mono', monospace;
    z-index: 50;
    overflow: hidden;
    height: 44px;
    display: flex;
    align-items: center;
}

.system-status-content-wrapper {
    width: 100%;
    max-width: 1400px;
    margin: 0 auto;
    padding: 0 24px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
[[[Â£ END: client/src/components/SystemStatus/SystemStatus.css Â£]]]

[[[Â£ FILE: client/src/components/SystemStatus/SystemStatus.jsx Â£]]]
import React, { useState, useEffect, useRef } from 'react';
import './SystemStatus.css';

export default function SystemStatus({ isAppReady }) {
    const [statusData, setStatusData] = useState({ status: 'OK', timestamp: 0 });
    const [visible, setVisible] = useState(false);
    const [isManuallyHidden, setIsManuallyHidden] = useState(false); 
    const [version, setVersion] = useState('?');
    
    const lastTimestampRef = useRef(0);

    useEffect(() => {
        const fetchVersion = async () => {
            try {
                const res = await fetch('/api/system/version');
                const d = await res.json();
                setVersion(d.hash || d.build || "?");
            } catch (e) {}
        };
        if (isAppReady) fetchVersion();
    }, [isAppReady]);

    useEffect(() => {
        const interval = setInterval(async () => {
            if (!isAppReady) return; 
            try {
                const res = await fetch('/api/system/apply-status');
                const data = await res.json();
                setStatusData(data);

                if (data.timestamp !== lastTimestampRef.current) {
                    lastTimestampRef.current = data.timestamp;
                    setIsManuallyHidden(false); 
                    setVisible(true);
                } 
            } catch (e) {}
        }, 3000);
        return () => clearInterval(interval);
    }, [isAppReady]);

    if (!visible || isManuallyHidden) return null;

    return (
        <div className={`system-status-banner-flow bg-indigo-600 show`}>
            <div className="system-status-content-wrapper">
                <div className="flex items-center gap-2">
                    <span className="text-[10px] bg-black/30 px-2 py-0.5 rounded font-black tracking-widest">BUILD #{version}</span>
                    <span className="text-[11px] font-black uppercase">CONSOLE ADMIN OPÃ‰RATIONNELLE</span>
                </div>
                <button onClick={() => setIsManuallyHidden(true)} className="bg-white/10 w-6 h-6 rounded-full flex items-center justify-center text-[10px] font-black">âœ•</button>
            </div>
        </div>
    );
}
[[[Â£ END: client/src/components/SystemStatus/SystemStatus.jsx Â£]]]

[[[Â£ FILE: client/src/features/admin/AdminDashboard.css Â£]]]
/* --- LAYOUT GLOBAL --- */
.admin-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
    font-family: 'Inter', sans-serif;
}

/* --- LE BANDEAU NOIR (RESTO) --- */
.admin-toolbar-pill {
    background: #0f172a;
    border-radius: 50px;
    padding: 12px 30px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    box-shadow: 0 20px 40px rgba(0,0,0,0.15);
    gap: 20px;
}

.nav-links {
    display: flex;
    gap: 25px;
}

.nav-link {
    color: #64748b;
    font-weight: 900;
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 1px;
    transition: all 0.2s;
    background: none;
    border: none;
    cursor: pointer;
    padding: 5px 0;
}

.nav-link:hover { color: #f8fafc; }
.nav-link.active { color: #818cf8; border-bottom: 2px solid #818cf8; }

.action-buttons {
    display: flex;
    gap: 12px;
    align-items: center;
}

/* BOUTONS ACTIONS */
.btn-pill {
    height: 36px;
    padding: 0 18px;
    border-radius: 12px;
    font-weight: 900;
    font-size: 0.65rem;
    text-transform: uppercase;
    border: none;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.btn-clean { background: #dc2626; color: white; }
.btn-import { background: #8b5cf6; color: white; }
.btn-add { background: #334155; color: white; }
.btn-pill:hover { transform: translateY(-2px); filter: brightness(1.1); }

/* BARRE DE RECHERCHE */
.search-container {
    background: white;
    border-radius: 20px;
    padding: 15px 25px;
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 25px;
    border: 1px solid #e2e8f0;
    box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
}

.search-input {
    flex: 1;
    border: none;
    outline: none;
    font-weight: 700;
    font-size: 1rem;
    color: #1e293b;
}

/* FILTRE CHIPS */
.class-filter-row {
    display: flex;
    gap: 10px;
    margin-bottom: 25px;
    overflow-x: auto;
    padding-bottom: 10px;
}

.class-chip {
    padding: 8px 16px;
    border-radius: 12px;
    background: white;
    border: 1px solid #e2e8f0;
    font-weight: 800;
    font-size: 0.7rem;
    cursor: pointer;
    transition: all 0.2s;
    color: #64748b;
    white-space: nowrap;
}

.class-chip.active {
    background: #4f46e5;
    color: white;
    border-color: #4f46e5;
    box-shadow: 0 4px 12px rgba(79, 70, 229, 0.2);
}

/* CARTES ITEMS */
.item-card {
    background: white;
    border-radius: 25px;
    padding: 20px 30px;
    margin-bottom: 12px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border: 1px solid #f1f5f9;
    box-shadow: 0 2px 4px rgba(0,0,0,0.02);
}

.item-main {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.item-title {
    font-weight: 900;
    font-size: 1rem;
    text-transform: uppercase;
    display: flex;
    align-items: center;
    gap: 10px;
    color: #1e293b;
}

.badge-niv {
    background: #eff6ff;
    color: #2563eb;
    padding: 2px 8px;
    border-radius: 6px;
    font-size: 0.6rem;
    font-weight: 950;
    border: 1px solid #dbeafe;
}

.item-sub {
    font-size: 0.7rem;
    font-weight: 700;
    color: #94a3b8;
    text-transform: uppercase;
}

/* ACTIONS CARTES */
.item-actions {
    display: flex;
    gap: 10px;
    align-items: center;
}

.btn-action {
    padding: 10px 20px;
    border-radius: 12px;
    font-size: 0.65rem;
    font-weight: 900;
    border: none;
    cursor: pointer;
    text-transform: uppercase;
    transition: all 0.2s;
}

.btn-gerer { background: #f5f3ff; color: #7c3aed; }
.btn-modif { background: #f8fafc; color: #475569; border: 1px solid #e2e8f0; }
.btn-delete { 
    background: #fff1f2; 
    color: #e11d48; 
    width: 38px; 
    height: 38px; 
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.1rem;
}

.btn-action:hover { transform: scale(1.05); filter: brightness(0.95); }

/* --- MODALE --- */
.col-selector {
    background: #f8fafc;
    padding: 15px;
    border-radius: 20px;
    border: 1px solid #e2e8f0;
}
.col-title { font-size: 0.65rem; font-weight: 950; color: #64748b; text-transform: uppercase; margin-bottom: 10px; display: block; }
.scroll-list { height: 250px; overflow-y: auto; display: flex; flex-direction: column; gap: 5px; }
.select-btn { width: 100%; text-align: left; padding: 12px; border-radius: 10px; background: white; border: 1px solid #f1f5f9; font-size: 0.75rem; font-weight: 800; cursor: pointer; }
.select-btn.active { background: #4f46e5; color: white; border-color: #4338ca; }
[[[Â£ END: client/src/features/admin/AdminDashboard.css Â£]]]

[[[Â£ FILE: client/src/features/admin/AdminDashboard.jsx Â£]]]
// @signatures: AdminDashboard, handleMagicImport, handleMembership, handleSave, loadData, handleOpenCreate, handleDelete
import React, { useState, useEffect } from 'react';
import './AdminDashboard.css';

export default function AdminDashboard({ user }) {
    const [view, setView] = useState('classes'); 
    const [items, setItems] = useState([]);
    const [loading, setLoading] = useState(false);
    const [searchTerm, setSearchTerm] = useState('');
    const [activeClassTab, setActiveClassTab] = useState('TOUS');
    const [modalMode, setModalMode] = useState(null); 
    const [currentItem, setCurrentItem] = useState(null);
    
    const [importing, setImporting] = useState(false);
    const [showMagicModal, setShowMagicModal] = useState(false);
    const [magicText, setMagicText] = useState("");
    const [magicClass, setMagicClass] = useState("");
    const [magicOption, setMagicOption] = useState("");
    const [manageItem, setManageItem] = useState(null); 
    const [memberSearch, setMemberSearch] = useState(""); 

    const [filterSub, setFilterSub] = useState("");
    const [filterClass, setFilterClass] = useState("");
    const [filterGroup, setFilterGroup] = useState("");
    
    const [allClasses, setAllClasses] = useState([]);
    const [allSubjects, setAllSubjects] = useState([]);
    const [allStudents, setAllStudents] = useState([]); 

    const collectionMap = { 
        'classes': 'classrooms', 
        'groups': 'classrooms', 
        'teachers': 'teachers', 
        'students': 'students', 
        'staff': 'admins',
        'subjects': 'subjects'
    };

    const loadData = async () => {
        setLoading(true);
        try {
            const [rC, rS, rSt] = await Promise.all([
                fetch('/api/admin/classrooms').then(r => r.json()),
                fetch('/api/admin/subjects').then(r => r.json()),
                fetch('/api/admin/students').then(r => r.json())
            ]);
            setAllClasses(rC || []);
            setAllSubjects(rS || []);
            setAllStudents(rSt || []);

            const r = await fetch(`/api/admin/${collectionMap[view]}`);
            if (r.ok) {
                const data = await r.json();
                let list = Array.isArray(data) ? data : [];
                if (view === 'classes') list = list.filter(c => c.type === 'CLASS');
                if (view === 'groups') list = list.filter(c => c.type === 'GROUP');
                setItems(list);
            }
        } catch (e) { console.error(e); }
        setLoading(false);
    };

    useEffect(() => { loadData(); }, [view]);

    const handleOpenCreate = () => {
        let defaults = { 
            name: '', firstName: '', lastName: '', password: '123', 
            type: view === 'groups' ? 'GROUP' : 'CLASS', 
            taughtSubjects: [], assignedClasses: [], assignedGroups: [],
            email: '', parentEmail: '', level: ''
        };
        setCurrentItem(defaults);
        setModalMode('create');
    };

    const handleDelete = async (id) => {
        if (!confirm("âš ï¸ Action IrrÃ©versible. Supprimer ?")) return;
        const res = await fetch(`/api/admin/${collectionMap[view]}/${id}`, { method: 'DELETE' });
        if (res.ok) loadData();
    };

    const handleSave = async () => {
        const targetCollection = collectionMap[view];
        let dataToSend = { ...currentItem };
        
        if (view === 'teachers') {
            dataToSend.taughtSubjectsText = allSubjects.filter(s => dataToSend.taughtSubjects.includes(s._id)).map(s => s.name).join(', ');
            dataToSend.assignedClassesText = allClasses.filter(c => dataToSend.assignedClasses.some(ac => (ac._id || ac) === c._id)).map(c => c.name).join(', ');
            dataToSend.assignedClasses = dataToSend.assignedClasses.map(c => c._id || c);
        }

        await fetch(`/api/admin/${targetCollection}`, { 
            method: 'POST', 
            headers: { 'Content-Type': 'application/json' }, 
            body: JSON.stringify(dataToSend) 
        });
        setModalMode(null); loadData();
    };

    const filteredItems = items.filter(it => {
        const searchMatch = (it.name || it.firstName || "").toLowerCase().includes(searchTerm.toLowerCase()) || (it.lastName || "").toLowerCase().includes(searchTerm.toLowerCase());
        if (view === 'students' && activeClassTab !== 'TOUS') {
            return searchMatch && String(it.classId) === String(activeClassTab);
        }
        return searchMatch;
    });

    return (
        <div className="admin-container animate-in fade-in">
            {importing && <div className="zoom-overlay level-2"><div className="text-white font-black text-2xl animate-pulse">ğŸ”® TRAITEMENT IA...</div></div>}
            
            <div className="admin-toolbar-pill">
                <div className="nav-links">
                    {['classes', 'groups', 'subjects', 'teachers', 'students', 'staff'].map(v => (
                        <button key={v} onClick={() => setView(v)} className={`nav-link ${view === v ? 'active' : ''}`}>{v}</button>
                    ))}
                </div>
                <div className="action-buttons">
                    {(view === 'classes' || view === 'groups' || view === 'students') && ( <button onClick={() => setShowMagicModal(true)} className="btn-pill btn-import">ğŸ”® IA IMPORT</button> )}
                    <button onClick={handleOpenCreate} className="btn-pill btn-add">+ AJOUTER</button>
                </div>
            </div>

            <div className="search-container">
                <span className="text-slate-400">ğŸ”</span>
                <input className="search-input" placeholder={`Filtrer dans ${view}...`} value={searchTerm} onChange={e => setSearchTerm(e.target.value)} />
            </div>
            
            {view === 'students' && ( 
                <div className="class-filter-row"> 
                    <button onClick={() => setActiveClassTab('TOUS')} className={`class-chip ${activeClassTab === 'TOUS' ? 'active' : ''}`}>TOUS</button>
                    {allClasses.filter(c=>c.type==='CLASS').map(cls => ( 
                        <button key={cls._id} onClick={() => setActiveClassTab(cls._id)} className={`class-chip ${activeClassTab === cls._id ? 'active' : ''}`}>{cls.name}</button> 
                    ))} 
                </div> 
            )}

            <div className="items-list">
                {loading ? ( <div className="p-20 text-center animate-pulse text-slate-300 font-black uppercase">Interrogation Base de DonnÃ©es...</div> ) : filteredItems.map(it => (
                    <div key={it._id} className="item-card">
                        <div className="item-main">
                            <span className="item-title">
                                {it.name || `${it.firstName} ${it.lastName}`} 
                                {it.level && <span className="badge-niv">NIV {it.level}</span>}
                                {it.currentClass && <span className="badge-niv">{it.currentClass}</span>}
                            </span>
                            <span className="item-sub">{it.role || it.type || 'DATA'}</span>
                        </div>
                        <div className="item-actions">
                            {(view === 'classes' || view === 'groups') && <button onClick={() => setManageItem(it)} className="btn-action btn-gerer">ğŸ‘¥ MEMBRES</button>}
                            <button onClick={() => { setCurrentItem(it); setModalMode('edit'); }} className="btn-action btn-modif">Ã‰DITER</button>
                            <button onClick={() => handleDelete(it._id)} className="btn-action btn-delete">âœ•</button>
                        </div>
                    </div>
                ))}
            </div>

            {/* MODALE FORMULAIRE ADMIN */}
            {modalMode && currentItem && ( 
                <div className="zoom-overlay" onClick={() => setModalMode(null)}> 
                    <div className="zoom-card !w-[900px]" onClick={e => e.stopPropagation()}> 
                        <div className="z-header">
                            <h2 className="text-xl font-black uppercase text-indigo-600">{modalMode === 'create' ? 'CRÃ‰ATION' : 'Ã‰DITION'} {view.toUpperCase().slice(0,-1)}</h2>
                        </div> 
                        
                        <div className="z-body space-y-4 max-h-[60vh] overflow-y-auto custom-scrollbar p-6"> 
                            {['teachers', 'students', 'staff'].includes(view) && (
                                <div className="flex gap-4"> 
                                    <input className="admin-input flex-1" placeholder="PrÃ©nom" value={currentItem.firstName || ""} onChange={e => setCurrentItem({...currentItem, firstName: e.target.value})} /> 
                                    <input className="admin-input flex-1" placeholder="Nom" value={currentItem.lastName || ""} onChange={e => setCurrentItem({...currentItem, lastName: e.target.value})} /> 
                                </div> 
                            )}
                            {view === 'teachers' && ( <input className="admin-input" placeholder="Mot de passe" value={currentItem.password || ""} onChange={e => setCurrentItem({...currentItem, password: e.target.value})} /> )}
                            {['classes', 'groups', 'subjects'].includes(view) && ( <input className="admin-input" placeholder="DÃ©signation" value={currentItem.name || ""} onChange={e => setCurrentItem({...currentItem, name: e.target.value})} /> )}
                            
                            {view === 'students' && (
                                <div className="grid grid-cols-2 gap-4 pt-4 border-t">
                                    <div className="col-selector">
                                        <span className="col-title">ğŸ« CLASSE</span>
                                        <div className="scroll-list custom-scrollbar">
                                            {allClasses.filter(c=>c.type==='CLASS').map(c=>(
                                                <button key={c._id} onClick={()=>setCurrentItem({...currentItem, classId: c._id})} className={`select-btn ${currentItem.classId === c._id ? 'active' : ''}`}>{c.name}</button>
                                            ))}
                                        </div>
                                    </div>
                                    <div className="col-selector">
                                        <span className="col-title">ğŸ‘¥ OPTIONS</span>
                                        <div className="scroll-list custom-scrollbar">
                                            {allClasses.filter(c=>c.type==='GROUP').map(c=>(
                                                <button key={c._id} onClick={()=>{ const list = currentItem.assignedGroups || []; setCurrentItem({...currentItem, assignedGroups: list.includes(c._id) ? list.filter(x=>x!==c._id) : [...list, c._id]}); }} className={`select-btn ${currentItem.assignedGroups?.includes(c._id)?'active':''}`}>{c.name}</button>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div> 
                        <div className="z-footer">
                            <button onClick={() => setModalMode(null)} className="flex-1 py-4 bg-slate-100 text-slate-500 rounded-xl font-black text-xs uppercase">Annuler</button>
                            <button onClick={handleSave} className="flex-1 py-4 bg-indigo-600 text-white rounded-xl font-black text-xs uppercase shadow-xl">Enregistrer Data</button>
                        </div> 
                    </div> 
                </div> 
            )}
        </div>
    );
}
[[[Â£ END: client/src/features/admin/AdminDashboard.jsx Â£]]]

[[[Â£ FILE: client/src/features/admin/AdminPage.css Â£]]]
.admin-page-wrapper {
    min-height: 100vh;
    background-color: #f1f5f9;
    padding: 2rem;
    max-width: 1400px;
    margin: 0 auto;
    font-family: 'Inter', sans-serif;
}

.admin-header-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: white;
    padding: 1.2rem 2.5rem;
    border-radius: 25px;
    margin-bottom: 2rem;
    box-shadow: 0 10px 30px -10px rgba(0,0,0,0.05);
    border: 1px solid #e2e8f0;
}

.admin-identity {
    display: flex;
    flex-direction: column;
}

.admin-content-area {
    /* Espace de travail */
}

/* Animations de transition pour les pastilles */
.bg-emerald-500, .bg-red-500, .bg-purple-500, .bg-slate-300 {
    transition: background-color 0.3s ease;
}

@media (max-width: 768px) {
    .admin-page-wrapper { padding: 1rem; }
    .admin-header-bar { padding: 1rem; flex-direction: column; gap: 1rem; text-align: center; }
}
[[[Â£ END: client/src/features/admin/AdminPage.css Â£]]]

[[[Â£ FILE: client/src/features/admin/AdminPage.jsx Â£]]]
// @signatures: AdminPage, checkHealth, handleRefresh
import React, { useState, useEffect } from 'react';
import AdminDashboard from './AdminDashboard';
import DatabaseViewer from './components/DatabaseViewer'; // âœ… ImportÃ© ici maintenant
import './AdminPage.css';

export default function AdminPage({ user, onLogout }) {
  const [dbStatus, setDbStatus] = useState('LOADING'); 
  const [drive, setDrive] = useState({ ok: false, email: '', loading: true });
  const [showDB, setShowDB] = useState(false); // âœ… Ã‰tat gÃ©rÃ© ici pour la fusion

  const checkHealth = async () => {
      try {
          const resBoot = await fetch('/api/check-deploy');
          const dataBoot = await resBoot.json();
          setDbStatus(dataBoot.db === "CONNECTED" ? "OK" : "OFFLINE");

          const resDrive = await fetch('/api/admin/drive-check');
          const dataDrive = await resDrive.json();
          setDrive({ ok: dataDrive.ok, email: dataDrive.email, loading: false });
      } catch (e) {
          setDbStatus("OFFLINE");
          setDrive(prev => ({ ...prev, ok: false, loading: false }));
      }
  };

  useEffect(() => {
      checkHealth();
      const timer = setInterval(checkHealth, 10000);
      return () => clearInterval(timer);
  }, []);

  return (
    <div className="admin-page-wrapper">
      <div className="admin-header-bar">
        {/* --- GAUCHE : IDENTITÃ‰ + BOUTON STATUT FUSIONNÃ‰ --- */}
        <div className="flex items-center gap-6">
            <div className="admin-identity">
                <div className="flex items-center gap-4">
                    <h1 className="text-xl font-black text-slate-800 uppercase tracking-tighter leading-none">
                        {user.firstName} {user.lastName}
                    </h1>
                    
                    {/* âœ… BOUTON-PASTILLE BDD FUSIONNÃ‰ */}
                    <button 
                        onClick={() => setShowDB(true)}
                        className={`flex items-center gap-2 px-3 py-1.5 rounded-xl border-2 transition-all active:scale-95 ${
                            dbStatus === 'OK' 
                            ? 'bg-emerald-50 border-emerald-200 text-emerald-600 hover:bg-emerald-500 hover:text-white' 
                            : (dbStatus === 'LOADING' ? 'bg-slate-50 border-slate-200 text-slate-400' : 'bg-red-50 border-red-200 text-red-600 animate-pulse')
                        }`}
                    >
                        <div className={`w-2 h-2 rounded-full ${dbStatus === 'OK' ? 'bg-emerald-500' : 'bg-red-500'}`}></div>
                        <span className="text-[10px] font-black uppercase tracking-widest">ğŸ“Š BDD</span>
                    </button>
                </div>

                <div className="flex items-center gap-3 mt-1.5 ml-0.5">
                    <div className="flex items-center gap-1.5">
                        <div className={`w-2 h-2 rounded-full ${drive.ok ? 'bg-purple-500' : 'bg-slate-300'}`}></div>
                        <span className="text-[9px] font-bold uppercase text-slate-300 tracking-wider">
                            {drive.ok ? `PRO : ${drive.email}` : 'DRIVE DÃ‰CONNECTÃ‰'}
                        </span>
                    </div>
                </div>
            </div>
        </div>

        {/* --- DROITE : ICONE + DÃ‰CONNEXION --- */}
        <div className="flex items-center gap-4">
            <div className="w-10 h-10 bg-slate-900 rounded-xl flex items-center justify-center text-xl shadow-lg">ğŸ›¡ï¸</div>
            <button onClick={onLogout} className="bg-white text-slate-400 hover:text-red-500 px-4 py-2 rounded-xl font-black text-[10px] border border-slate-200 transition-all uppercase tracking-widest">
                DÃ©connexion
            </button>
        </div>
      </div>
      
      <div className="admin-content-area">
        <AdminDashboard user={user} />
      </div>

      {/* âœ… LA MODALE EST MAINTENANT APPELÃ‰E DEPUIS LE HEADER */}
      {showDB && <DatabaseViewer onClose={() => setShowDB(false)} />}
    </div>
  );
}
[[[Â£ END: client/src/features/admin/AdminPage.jsx Â£]]]

[[[Â£ FILE: client/src/features/admin/components/DatabaseViewer.css Â£]]]
.db-viewer-overlay { 
    position: fixed; inset: 0; z-index: 20000; 
    background: rgba(15, 23, 42, 0.95); 
    display: flex; align-items: center; justify-content: center; padding: 2rem; 
}

.db-viewer-window { 
    background: white; width: 95%; height: 90%; 
    border-radius: 40px; display: flex; flex-direction: column; 
    overflow: hidden; box-shadow: 0 50px 100px -20px rgba(0,0,0,0.5);
}

.db-header { 
    padding: 1.5rem 2.5rem; 
    border-bottom: 1px solid #f1f5f9; 
    display: flex; justify-content: space-between; align-items: center; 
}

/* TABLEAU PROPRE ET COMPACT */
.db-table-clean {
    width: 100%;
    border-collapse: collapse;
    font-family: 'JetBrains Mono', monospace;
    font-size: 10px;
    table-layout: fixed; /* Force le respect des largeurs */
}

.db-table-clean th {
    background: #f8fafc;
    text-align: left;
    padding: 12px 15px;
    border: 1px solid #f1f5f9;
    color: #94a3b8;
    position: sticky;
    top: 0;
    z-index: 10;
    width: 180px; /* Largeur fixe pour la clartÃ© */
}

.db-table-clean td {
    padding: 10px 15px;
    border: 1px solid #f1f5f9;
    color: #475569;
    cursor: pointer;
    transition: all 0.1s;
}

.db-cell-wrapper {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    width: 100%;
}

.db-table-clean tr:hover td {
    background-color: #f0f9ff;
    color: #3b82f6;
}

/* ğŸ” INSPECTEUR DE CELLULE */
.db-inspector-overlay {
    position: fixed; inset: 0;
    z-index: 30000;
    background: rgba(0,0,0,0.4);
    display: flex; align-items: center; justify-content: center;
}

.db-inspector-box {
    background: white;
    width: 600px;
    max-height: 500px;
    padding: 2rem;
    border-radius: 30px;
    box-shadow: 0 30px 60px rgba(0,0,0,0.3);
    display: flex;
    flex-direction: column;
}

.db-inspector-content {
    background: #0f172a;
    color: #38bdf8;
    padding: 1.5rem;
    border-radius: 15px;
    font-size: 12px;
    overflow: auto;
    flex: 1;
    margin: 0;
}

.custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
.custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
[[[Â£ END: client/src/features/admin/components/DatabaseViewer.css Â£]]]

[[[Â£ FILE: client/src/features/admin/components/DatabaseViewer.jsx Â£]]]
// @signatures: DatabaseViewer, renderCell, handleCellClick
import React, { useState, useEffect } from 'react';
import './DatabaseViewer.css';

export default function DatabaseViewer({ onClose }) {
    const [data, setData] = useState(null);
    const [activeTab, setActiveTab] = useState('');
    const [loading, setLoading] = useState(true);
    // âœ… Ã‰tat pour l'inspection d'une cellule
    const [inspecting, setInspecting] = useState(null);

    useEffect(() => {
        fetch('/api/admin/database-dump')
            .then(res => res.json())
            .then(d => { 
                setData(d); 
                const keys = Object.keys(d || {});
                if (keys.length > 0) setActiveTab(keys[0]);
                setLoading(false); 
            });
    }, []);

    if (loading) return <div className="db-viewer-overlay"><h2 className="text-white font-black animate-pulse">CHARGEMENT BDD...</h2></div>;

    const currentData = data[activeTab] || [];
    const allKeys = new Set();
    currentData.forEach(row => Object.keys(row).forEach(k => { if(k !== '__v') allKeys.add(k); }));
    const columns = Array.from(allKeys);

    const handleCellClick = (val, colName) => {
        if (val === null || val === undefined) return;
        setInspecting({ title: colName, content: val });
    };

    return (
        <div className="db-viewer-overlay" onClick={onClose}>
            {/* ğŸ” INSPECTEUR DE CELLULE (MODALE NIVEAU 2) */}
            {inspecting && (
                <div className="db-inspector-overlay" onClick={(e) => { e.stopPropagation(); setInspecting(null); }}>
                    <div className="db-inspector-box animate-in zoom-in" onClick={e => e.stopPropagation()}>
                        <div className="flex justify-between items-center mb-4 border-b pb-2">
                            <span className="text-[10px] font-black text-indigo-500 uppercase tracking-widest">DÃ©tail du champ : {inspecting.title}</span>
                            <button onClick={() => setInspecting(null)} className="text-slate-400 hover:text-slate-900 font-bold">FERMER</button>
                        </div>
                        <pre className="db-inspector-content custom-scrollbar">
                            {typeof inspecting.content === 'object' 
                                ? JSON.stringify(inspecting.content, null, 2) 
                                : String(inspecting.content)}
                        </pre>
                        <button onClick={() => {
                            navigator.clipboard.writeText(typeof inspecting.content === 'object' ? JSON.stringify(inspecting.content) : inspecting.content);
                            alert("CopiÃ© !");
                        }} className="mt-4 w-full py-2 bg-slate-100 text-slate-600 rounded-lg font-black text-[10px] uppercase hover:bg-indigo-50">Copier la valeur</button>
                    </div>
                </div>
            )}

            <div className="db-viewer-window" onClick={e => e.stopPropagation()}>
                <div className="db-header">
                    <div>
                        <h2 className="font-black uppercase text-xl text-slate-800">Explorateur MongoDB</h2>
                        <span className="text-[9px] font-black text-indigo-500 uppercase tracking-widest">Mode Interactif : Cliquez sur une case pour l'Ã©tendre</span>
                    </div>
                    <button onClick={onClose} className="w-10 h-10 bg-slate-100 rounded-full font-black hover:bg-red-500 hover:text-white transition-all">âœ•</button>
                </div>
                
                <div className="db-tabs no-scrollbar flex gap-2 p-4 bg-slate-50 border-b overflow-x-auto">
                    {Object.keys(data).sort().map(c => (
                        <button key={c} onClick={() => setActiveTab(c)} className={`px-4 py-2 rounded-xl text-[10px] font-black whitespace-nowrap transition-all ${activeTab === c ? 'bg-indigo-600 text-white shadow-md' : 'bg-white text-slate-400 border border-slate-200'}`}>
                            {c.toUpperCase()} ({data[c]?.length || 0})
                        </button>
                    ))}
                </div>

                <div className="db-table-container flex-1 overflow-auto custom-scrollbar">
                    <table className="db-table-clean">
                        <thead>
                            <tr>
                                {columns.map(col => <th key={col}>{col.toUpperCase()}</th>)}
                            </tr>
                        </thead>
                        <tbody>
                            {currentData.map((row, i) => (
                                <tr key={i}>
                                    {columns.map(col => {
                                        const val = row[col];
                                        const isObj = typeof val === 'object' && val !== null;
                                        return (
                                            <td key={col} onClick={() => handleCellClick(val, col)} className="db-interactive-cell">
                                                <div className="db-cell-wrapper">
                                                    {isObj ? `{ Object }` : (val === null || val === undefined ? '-' : String(val))}
                                                </div>
                                            </td>
                                        );
                                    })}
                                </tr>
                            ))}
                        </tbody>
                    </table>
                    {currentData.length === 0 && <div className="p-20 text-center text-slate-300 font-bold uppercase italic">Collection vide</div>}
                </div>
            </div>
        </div>
    );
}
[[[Â£ END: client/src/features/admin/components/DatabaseViewer.jsx Â£]]]

[[[Â£ FILE: client/src/features/admin/components/DriveViewer.css Â£]]]
.drive-viewer-overlay { position: fixed; inset: 0; z-index: 20001; background: rgba(15, 23, 42, 0.95); display: flex; align-items: center; justify-content: center; padding: 2rem; }
.drive-viewer-window { background: white; width: 80%; height: 80%; border-radius: 30px; display: flex; flex-direction: column; overflow: hidden; }
[[[Â£ END: client/src/features/admin/components/DriveViewer.css Â£]]]

[[[Â£ FILE: client/src/features/admin/components/DriveViewer.jsx Â£]]]
import React, { useState, useEffect } from 'react';
import './DriveViewer.css';

export default function DriveViewer({ onClose }) {
    const [tree, setTree] = useState(null);
    const [loading, setLoading] = useState(true);

    useEffect(() => {
        fetch('/api/structure/drive-tree')
            .then(res => res.json())
            .then(d => { setTree(d); setLoading(false); });
    }, []);

    return (
        <div className="drive-viewer-overlay" onClick={onClose}>
            <div className="drive-viewer-window" onClick={e => e.stopPropagation()}>
                <div className="drive-header p-6 bg-slate-900 text-white flex justify-between items-center">
                    <h2 className="font-black uppercase">Archive Cloud Condamine</h2>
                    <button onClick={onClose} className="text-2xl">âœ•</button>
                </div>
                <div className="p-10 overflow-auto flex-1">
                    {loading ? <div className="animate-pulse text-indigo-600 font-black">SCAN DU DRIVE...</div> : (
                        <div className="space-y-2">
                            {tree?.children?.map(child => (
                                <div key={child.id} className="flex items-center gap-4 p-4 bg-slate-50 rounded-xl border border-slate-100">
                                    <span className="text-xl">{child.type === 'folder' ? 'ğŸ“' : 'ğŸ“„'}</span>
                                    <span className="font-bold text-slate-700">{child.name}</span>
                                    <a href={child.link} target="_blank" rel="noreferrer" className="ml-auto text-indigo-500 font-black text-[10px]">OUVRIR</a>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            </div>
        </div>
    );
}
[[[Â£ END: client/src/features/admin/components/DriveViewer.jsx Â£]]]

[[[Â£ FILE: client/src/features/auth/Login.css Â£]]]
.login-screen { display: flex; align-items: center; justify-content: center; min-height: 100vh; background-color: #f8fafc; }
.login-card { background: white; padding: 2.5rem; border-radius: 40px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.1); width: 100%; max-width: 900px; text-align: center; transition: all 0.3s; }
.login-card.narrow { max-width: 450px; }

.app-logo { font-weight: 900; font-size: 2rem; color: #1e293b; margin-bottom: 0.5rem; letter-spacing: -1px; text-transform: uppercase; }
.app-subtitle { color: #94a3b8; font-weight: 700; margin-bottom: 3rem; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; }

/* ROLE SELECTOR GRID */
.role-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem; }
@media (max-width: 768px) { .role-grid { grid-template-columns: 1fr; } }

.role-card { background: #f1f5f9; border: 2px solid transparent; border-radius: 25px; padding: 2rem 1rem; cursor: pointer; transition: all 0.2s; display: flex; flex-direction: column; align-items: center; gap: 1rem; }
.role-card:hover { transform: translateY(-5px); background: white; shadow: 0 10px 30px rgba(0,0,0,0.05); }

.role-icon { font-size: 3rem; margin-bottom: 0.5rem; }
.role-label { font-weight: 900; font-size: 1.1rem; color: #475569; text-transform: uppercase; }

/* SPECIFIC COLORS */
.role-student:hover { border-color: #f97316; } .role-student:hover .role-label { color: #f97316; }
.role-teacher:hover { border-color: #7c3aed; } .role-teacher:hover .role-label { color: #7c3aed; }
.role-admin:hover { border-color: #1e293b; } .role-admin:hover .role-label { color: #1e293b; }

/* FORMS COMMON */
.login-inputs { display: flex; flex-direction: column; gap: 1rem; text-align: left; position: relative; }
.login-field { width: 100%; padding: 1.2rem; border-radius: 18px; border: 2px solid #e2e8f0; background: #f8fafc; font-weight: 700; outline: none; transition: all 0.2s; }
.login-field:focus { border-color: #2563eb; background: white; }

.login-submit-btn { width: 100%; padding: 1.25rem; background-color: #2563eb; color: white; border-radius: 20px; font-weight: 900; cursor: pointer; border: none; text-transform: uppercase; margin-top: 1rem; transition: transform 0.1s; }
.login-submit-btn:active { transform: scale(0.98); }
.login-submit-btn:disabled { opacity: 0.5; cursor: not-allowed; background-color: #cbd5e1; }

.back-btn { background: transparent; border: none; font-weight: 800; color: #94a3b8; cursor: pointer; margin-bottom: 1.5rem; display: inline-flex; align-items: center; gap: 0.5rem; font-size: 0.8rem; text-transform: uppercase; }
.back-btn:hover { color: #1e293b; }

/* --- FINDER STUDENT V2 (3 CHAMPS) --- */
.finder-wrapper { position: relative; display: flex; flex-direction: column; gap: 10px; }
.finder-row { display: flex; gap: 10px; }
.finder-col-class { flex: 1; }
.finder-col-name { flex: 2; }

.suggestions-box {
    position: absolute; top: 100%; left: 0; right: 0;
    background: white; border: 2px solid #e2e8f0; border-radius: 15px;
    max-height: 200px; overflow-y: auto; z-index: 50;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1); margin-top: 5px;
}
.suggestion-item {
    padding: 12px 15px; cursor: pointer; font-weight: 700; color: #475569; border-bottom: 1px solid #f1f5f9;
    display: flex; justify-content: space-between;
}
.suggestion-item:hover { background: #f0f9ff; color: #2563eb; }
.suggestion-detail { font-size: 0.75rem; color: #94a3b8; font-weight: 900; text-transform: uppercase; }

.selected-student-card {
    background: #ecfdf5; border: 2px solid #34d399; color: #065f46;
    padding: 1rem; border-radius: 20px; text-align: center;
    font-weight: 900; font-size: 1.1rem;
    display: flex; justify-content: space-between; align-items: center;
}
.reset-selection-btn {
    background: #065f46; color: white; width: 30px; height: 30px; border-radius: 50%;
    border: none; cursor: pointer; display: flex; align-items: center; justify-content: center;
}
[[[Â£ END: client/src/features/auth/Login.css Â£]]]

[[[Â£ FILE: client/src/features/auth/Login.jsx Â£]]]
import React, { useState } from 'react';
import './Login.css';

export default function Login({ onLoginSuccess }) {
  const [fName, setFName] = useState('');
  const [lName, setLName] = useState('');
  const [password, setPassword] = useState('');
  const [loading, setLoading] = useState(false);
  const [showPass, setShowPass] = useState(false);

  const handleLogin = async (e) => {
    e.preventDefault();
    setLoading(true);
    
    try {
        const res = await fetch('/api/auth/login', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ 
                role: 'ADMIN', 
                firstName: fName, 
                lastName: lName, 
                password 
            })
        });
        const data = await res.json();
        
        if (res.ok) {
            // Verrouillage final cÃ´tÃ© client
            if (data.user.role === 'admin' || data.user.isDeveloper) {
                localStorage.setItem('player', JSON.stringify(data.user));
                onLoginSuccess(data.user);
            } else {
                alert("AccÃ¨s restreint aux administrateurs.");
            }
        } else {
            alert(data.message || "Identifiants administrateur invalides.");
        }
    } catch(e) { 
        alert("Serveur hors ligne."); 
    }
    setLoading(false);
  };

  return (
    <div className="login-screen bg-slate-900">
      <div className="login-card narrow !bg-slate-800 border border-slate-700 shadow-2xl">
        <div className="mb-8">
            <div className="w-16 h-16 bg-indigo-600 rounded-2xl flex items-center justify-center text-3xl shadow-xl shadow-indigo-500/20 mx-auto mb-4">ğŸ›¡ï¸</div>
            <h1 className="app-logo !text-white !mb-1">Condamine <span className="text-indigo-400">Core</span></h1>
            <p className="app-subtitle !text-slate-400">Terminal d'Administration</p>
        </div>

        <form onSubmit={handleLogin} className="login-inputs">
            <div className="space-y-3">
                <input 
                    className="login-field !bg-slate-700 !border-slate-600 !text-white focus:!border-indigo-500" 
                    placeholder="PrÃ©nom" 
                    value={fName} 
                    onChange={e=>setFName(e.target.value)} 
                    required 
                />
                <input 
                    className="login-field !bg-slate-700 !border-slate-600 !text-white focus:!border-indigo-500" 
                    placeholder="Nom" 
                    value={lName} 
                    onChange={e=>setLName(e.target.value)} 
                    required 
                />
                <div className="relative">
                    <input 
                        type={showPass ? "text" : "password"} 
                        className="login-field !bg-slate-700 !border-slate-600 !text-white focus:!border-indigo-500" 
                        placeholder="Mot de passe" 
                        value={password} 
                        onChange={e=>setPassword(e.target.value)} 
                        required 
                    />
                    <button 
                        type="button" 
                        onClick={() => setShowPass(!showPass)} 
                        className="absolute right-4 top-1/2 -translate-y-1/2 text-[10px] font-black text-slate-500 hover:text-indigo-400 uppercase"
                    >
                        {showPass ? "Masquer" : "Voir"}
                    </button>
                </div>
            </div>

            <button className="login-submit-btn !bg-indigo-600 hover:!bg-indigo-500 !mt-6 shadow-lg shadow-indigo-600/10" disabled={loading}>
                {loading ? 'Validation Kernel...' : 'Authentification'}
            </button>
        </form>
        
        <div className="mt-8 flex items-center justify-center gap-2">
            <div className="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse"></div>
            <span className="text-[9px] text-slate-500 font-bold uppercase tracking-[0.2em]">
                Project Condamine v2.0 â€¢ Admin Console
            </span>
        </div>
      </div>
    </div>
  );
}
[[[Â£ END: client/src/features/auth/Login.jsx Â£]]]

[[[Â£ FILE: client/src/index.css Â£]]]
@tailwind base; @tailwind components; @tailwind utilities;
:root { --primary: #2563eb; }
body { margin: 0; font-family: 'Inter', sans-serif; background: #f1f5f9; }
.custom-scrollbar::-webkit-scrollbar { width: 6px; }
.custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
[[[Â£ END: client/src/index.css Â£]]]

[[[Â£ FILE: client/src/main.jsx Â£]]]
import React from 'react'; import ReactDOM from 'react-dom/client'; import App from './App.jsx'; import './index.css';
ReactDOM.createRoot(document.getElementById('root')).render(<React.StrictMode><App /></React.StrictMode>);
[[[Â£ END: client/src/main.jsx Â£]]]

[[[Â£ FILE: client/src/services/api.js Â£]]]
export const api = {
    get: (url) => fetch(`/api${url}`).then(r => r.json()),
    post: (url, data) => fetch(`/api${url}`, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(data) }).then(r => r.json())
};
[[[Â£ END: client/src/services/api.js Â£]]]

[[[Â£ FILE: client/src/test_token_crash.js Â£]]]
console.log("âœ… FICHIER RÃ‰PARÃ‰ AVEC SUCCÃˆS !");
console.log("Le systÃ¨me de sÃ©curitÃ© 'Token + API Reset' fonctionne parfaitement.");
console.log("Le bandeau rouge a disparu, et le fichier est maintenant complet.");

export default function TestTokenValid() {
    return "Tout est opÃ©rationnel chef !";
}
[[[Â£ END: client/src/test_token_crash.js Â£]]]

[[[Â£ FILE: client/vite.config.js Â£]]]
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'

export default defineConfig({
  plugins: [react()],
  server: {
    host: '0.0.0.0',
    port: 5173,
    proxy: {
      '/api': {
        target: 'http://localhost:3000',
        changeOrigin: true,
        secure: false,
      }
    }
  }
})
[[[Â£ END: client/vite.config.js Â£]]]

[[[Â£ FILE: git-auto.js Â£]]]
const { exec } = require('child_process');
const fs = require('fs');
const path = require('path');
const VERSION_FILE = path.join(__dirname, 'server', 'version.json');

async function doPush() {
    let v = { version: "2.1.1", build: 311 };
    try { v = JSON.parse(fs.readFileSync(VERSION_FILE, 'utf8')); } catch(e) {}
    v.build++; v.timestamp = new Date().toISOString();
    fs.writeFileSync(VERSION_FILE, JSON.stringify(v, null, 2));
    exec('git add . && git commit -m "Build #' + v.build + '" && git push');
}
setInterval(doPush, 600000);
[[[Â£ END: git-auto.js Â£]]]

[[[Â£ FILE: init-db.js Â£]]]
const mongoose = require('mongoose');
require('dotenv').config();
async function init() {
    await mongoose.connect(process.env.MONGODB_URI);
    console.log("BDD Init");
    process.exit();
}
init();
[[[Â£ END: init-db.js Â£]]]

[[[Â£ FILE: magic-paste.js Â£]]]
const fs = require('fs');
let lastContent = "";

console.log("------------------------------------------------");
console.log("ğŸ”® MAGIC PASTE ACTIF : En attente de code...");
console.log("------------------------------------------------");

setInterval(async () => {
    try {
        const module = await import('clipboardy');
        const text = await module.default.read();
        
        // On vÃ©rifie si le presse-papier contient notre tag spÃ©cial et a changÃ©
        if (text.includes('[[[Â£ FILE:') && text !== lastContent) {
            const timestamp = new Date().toLocaleTimeString();
            console.log("\n"); 
            console.log("================================================");
            console.log(`âš¡ [${timestamp}] MAGIC PASTE DÃ‰TECTÃ‰ !`);
            console.log(`ğŸ“‹ Capture de ${text.length} caractÃ¨res.`);
            console.log(`ğŸ“ Ã‰criture dans update.txt...`);
            console.log("================================================");
            
            fs.writeFileSync('update.txt', text);
            lastContent = text;
        }
    } catch (e) {
        // On ignore les erreurs de lecture (verrouillage presse-papier momentanÃ©)
    }
}, 2000);
[[[Â£ END: magic-paste.js Â£]]]

[[[Â£ FILE: package.json Â£]]]
{
  "name": "condamine-admin",
  "version": "1.0.0",
  "private": true,
  "scripts": {
    "start": "node server/server.js",
    "server-dev": "nodemon --ignore 'update.txt' --ignore 'apply_status.json' server/server.js",
    "client": "npm run dev --prefix client",
    "dev": "node apply.js & node magic-paste.js & npm run server-dev & npm run client",
    "build": "npm install --prefix client && npm run build --prefix client"
  },
  "dependencies": {
    "@google/generative-ai": "^0.1.3",
    "dotenv": "^16.4.5",
    "express": "^4.19.2",
    "googleapis": "^126.0.0",
    "mongoose": "7.8.2",
    "node-fetch": "^2.7.0",
    "multer": "^1.4.5-lts.1",
    "clipboardy": "^4.0.0",
    "nodemon": "^3.0.3"
  }
}
[[[Â£ END: package.json Â£]]]

[[[Â£ FILE: public/style.css Â£]]]
:root {
    --primary: #2563eb; --primary-dark: #1e40af; --secondary: #f59e0b;
    --success: #16a34a; --danger: #dc2626; --bg-page: #f1f5f9;
    --text-main: #1e293b; --text-light: #64748b; --border: #e2e8f0; --radius: 12px;
}
* { box-sizing: border-box; }
body { margin: 0; font-family: 'Segoe UI', sans-serif; background-color: var(--bg-page); color: var(--text-main); height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

header { display: flex; justify-content: space-between; align-items: center; background: white; padding: 0 25px; height: 70px; min-height: 70px; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
header h1 { font-size: 1.3rem; color: var(--primary); margin: 0; }
.header-right { display: flex; gap: 15px; align-items: center; }

.wrap { flex: 1; width: 100%; padding: 15px; overflow-y: auto; }
.card { background: white; border-radius: var(--radius); padding: 25px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }

/* --- HOMEWORK LAYOUT (75/25) --- */
.hw-layout { display: flex; flex-direction: column; height: calc(100vh - 100px); background: #1e293b; border-radius: 15px; overflow: hidden; border: 2px solid #334155; position: relative; }
.hw-list-view { padding: 20px; background: white; height: 100%; overflow-y: auto; z-index: 100; }
.hw-work-view { display: flex; flex-direction: column; height: 100%; width: 100%; position: relative; }

.doc-viewer-container {
    flex: 7.5; position: relative; background-color: #0f172a; overflow: hidden;
    background-image: linear-gradient(rgba(255,255,255,0.05) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.05) 1px, transparent 1px);
    background-size: 50px 50px; border-bottom: 4px solid var(--secondary); cursor: grab;
}
#pan-zoom-content, #pan-zoom-question-content { position: absolute; top: 50%; left: 50%; transform-origin: center center; display: flex; justify-content: center; align-items: center; pointer-events: none; }
#current-doc-img, #pan-zoom-question-content img { height: auto; box-shadow: 0 0 50px rgba(0,0,0,0.8); border: 3px solid white; pointer-events: auto; -webkit-user-drag: none; }

.interaction-zone { flex: 2.5; display: flex; background: white; min-height: 160px; border-top: 1px solid var(--border); }
.question-part { flex: 1; padding: 12px; border-right: 2px solid var(--border); background: #f8fafc; overflow: auto; }
.answer-part { flex: 1.2; padding: 12px; display: flex; flex-direction: column; gap: 8px; padding-bottom: 20px; }

#q-image-container { flex: 1; position: relative; overflow: hidden; background: #0f172a; border-radius: 8px; margin-top: 5px; border: 1px solid #cbd5e1; min-height: 100px; cursor: grab; }
#hw-answer-input { flex: 1; width: 100%; resize: none; padding: 12px; border: 2px solid #cbd5e1; border-radius: 10px; font-size: 0.95rem; }

/* FEEDBACK IA MODAL */
#hw-feedback-overlay { display: none; position: fixed; inset: 0; background: rgba(15, 23, 42, 0.85); backdrop-filter: blur(8px); z-index: 9999; align-items: center; justify-content: center; padding: 20px; }
.feedback-card { background: white; width: 100%; max-width: 800px; max-height: 90vh; border-radius: 24px; padding: 25px; display: flex; flex-direction: column; box-shadow: 0 25px 50px rgba(0,0,0,0.5); }
.feedback-scroll-area { flex: 1; overflow-y: auto; margin: 15px 0; padding: 15px; background: #f8fafc; border-radius: 12px; border: 1px solid #edf2f7; }

/* NAVIGATION UI */
.page-counter { position: absolute; top: 15px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: white; padding: 5px 15px; border-radius: 20px; font-weight: bold; z-index: 10; }
.nav-arrow { position: absolute; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.5); color: white; border: none; width: 45px; height: 45px; border-radius: 50%; font-size: 20px; cursor: pointer; z-index: 10; display: flex; align-items: center; justify-content: center; }
#btn-prev-doc { left: 10px; } #btn-next-doc { right: 10px; }
.doc-controls { position: absolute; bottom: 15px; right: 15px; display: flex; gap: 10px; z-index: 10; }
.zoom-btn { width: 38px; height: 38px; border-radius: 50%; background: rgba(0,0,0,0.6); color: white; border: none; cursor: pointer; }
.action-btn { background: var(--primary); color: white; border: none; padding: 12px; border-radius: 8px; width: 100%; font-weight: bold; cursor: pointer; }
.tab-btn { padding: 10px 20px; border-radius: 8px; border: none; background: #eee; cursor: pointer; font-weight: bold; }
.tab-btn.active { background: var(--primary); color: white; }
.wrong-word { color: var(--danger); text-decoration: line-through; font-weight: bold; }
.right-word { color: var(--success); font-weight: bold; }
.correction-table { width: 100%; border-collapse: collapse; margin-top: 10px; background: white; border-radius: 10px; overflow: hidden; }
.correction-table td { padding: 8px; border-bottom: 1px solid #eee; }
[[[Â£ END: public/style.css Â£]]]

[[[Â£ FILE: server/core/ai.engine.js Â£]]]
const { GoogleGenerativeAI, HarmCategory, HarmBlockThreshold } = require("@google/generative-ai");

/**
 * ğŸ¤– MOTEUR IA - V21 (TEMPÃ‰RATURE ZÃ‰RO)
 * RÃ©glage strict pour empÃªcher l'IA de "dÃ©lirer" en Anglais ou de changer le format.
 */
const AIEngine = {
    normalizeKeys: (obj) => {
        if (typeof obj !== 'object' || obj === null) return obj;
        if (Array.isArray(obj)) return obj.map(AIEngine.normalizeKeys);
        return Object.keys(obj).reduce((acc, key) => {
            acc[key.toLowerCase().trim()] = AIEngine.normalizeKeys(obj[key]);
            return acc;
        }, {});
    },

    sanitizeJSON: (text) => {
        if (!text) return { grade: "?", appreciation: "Vide.", transcription: "Rien." };

        let clean = text.replace(/```json/gi, "").replace(/```/gi, "").trim();
        
        try {
            const start = clean.indexOf('{');
            const end = clean.lastIndexOf('}');
            let parsed = null;

            if (start !== -1 && end !== -1) {
                parsed = JSON.parse(clean.substring(start, end + 1));
            } else {
                throw new Error("No JSON");
            }

            const norm = AIEngine.normalizeKeys(parsed);

            // VÃ©rification des champs clÃ©s (si l'IA a mis "general_assessment" au lieu de "appreciation")
            const appreciation = norm.appreciation || norm.general_assessment || norm.comment || "Pas d'avis";
            const transcription = norm.transcription || norm.detailed_feedback || norm.text || "Pas de texte";
            
            // Si la transcription est un objet (le bug de tout Ã  l'heure), on le stringify
            let finalTrans = transcription;
            if (typeof transcription === 'object') {
                finalTrans = JSON.stringify(transcription, null, 2);
            }

            return {
                studentname: norm.studentname || "Inconnu",
                grade: norm.grade || norm.overall_grade || norm.note || "?",
                appreciation: appreciation,
                transcription: finalTrans,
                mistakes: norm.mistakes || []
            };

        } catch (e) { 
            console.warn("âš ï¸ Mode RAW.");
            let htmlText = text
                .replace(/\*\*(.*?)\*\*/g, '<span style="color:#ef4444; font-weight:bold;">$1</span>')
                .replace(/\n/g, '<br/>');

            return {
                studentName: "Mode Texte",
                grade: "?",
                appreciation: "Format IA invalide.",
                transcription: "ğŸ”´ CONTENU BRUT :\n\n" + htmlText, 
                mistakes: []
            };
        }
    },

    ask: async (prompt, systemInstruction = "") => {
        const apiKey = process.env.GEMINI_API_KEY;
        const targetModel = "gemini-2.0-flash"; 

        if (!apiKey) return "ERREUR CLÃ‰";
        
        try {
            const genAI = new GoogleGenerativeAI(apiKey);
            const model = genAI.getGenerativeModel({ 
                model: targetModel,
                systemInstruction: systemInstruction,
                safetySettings: [
                    { category: HarmCategory.HARM_CATEGORY_HARASSMENT, threshold: HarmBlockThreshold.BLOCK_NONE },
                    { category: HarmCategory.HARM_CATEGORY_HATE_SPEECH, threshold: HarmBlockThreshold.BLOCK_NONE },
                    { category: HarmCategory.HARM_CATEGORY_SEXUALLY_EXPLICIT, threshold: HarmBlockThreshold.BLOCK_NONE },
                    { category: HarmCategory.HARM_CATEGORY_DANGEROUS_CONTENT, threshold: HarmBlockThreshold.BLOCK_NONE },
                ],
                // TEMPÃ‰RATURE 0.1 : L'IA devient un robot logique, pas un poÃ¨te.
                // Cela rÃ©duit drastiquement le risque qu'elle parle anglais ou change le JSON.
                generationConfig: { temperature: 0.1 }
            });
            const result = await model.generateContent(prompt);
            return result.response.text();
        } catch (e) {
            console.error(`ğŸ’¥ CRASH GOOGLE :`, e.message);
            return `ERREUR: ${e.message}`;
        }
    }
};

module.exports = AIEngine;
[[[Â£ END: server/core/ai.engine.js Â£]]]

[[[Â£ FILE: server/core/drive.engine.js Â£]]]
const { google } = require('googleapis');
const fs = require('fs');
const path = require('path');

let oauth2Client = null;
let driveInstance = null;

const DriveEngine = {
    oauth2Client: null,
    
    init: () => {
        try {
            const clientID = process.env.GOOGLE_CLIENT_ID;
            const clientSecret = process.env.GOOGLE_CLIENT_SECRET;
            // On permet une redirection dynamique ou fixe
            const redirect = process.env.GOOGLE_REDIRECT_URI || "http://localhost:3000/api/auth/google/callback";
            
            if (clientID && clientSecret) {
                oauth2Client = new google.auth.OAuth2(clientID, clientSecret, redirect);
                DriveEngine.oauth2Client = oauth2Client; // Stockage public pour les routes Auth

                const refresh = process.env.GOOGLE_REFRESH_TOKEN;
                if (refresh) {
                    oauth2Client.setCredentials({ refresh_token: refresh });
                    driveInstance = google.drive({ version: 'v3', auth: oauth2Client });
                    console.log("âœ… Drive Engine InitialisÃ©.");
                } else {
                    console.warn("âš ï¸ Drive Engine : Pas de Refresh Token dans .env");
                }
            } else {
                console.error("âŒ Drive Engine : Client ID/Secret manquants.");
            }
        } catch (e) { console.error("Drive Init Error", e.message); }
    },

    // --- MÃ‰THODES OAUTH (Pour regÃ©nÃ©rer le token) ---
    getAuthUrl: () => {
        if (!DriveEngine.oauth2Client) throw new Error("OAuth Client non initialisÃ©");
        return DriveEngine.oauth2Client.generateAuthUrl({
            access_type: 'offline', // CRUCIAL pour avoir le Refresh Token
            scope: ['https://www.googleapis.com/auth/drive.file'],
            prompt: 'consent' // Force la gÃ©nÃ©ration du refresh token
        });
    },

    getTokenFromCode: async (code) => {
        if (!DriveEngine.oauth2Client) throw new Error("OAuth Client non initialisÃ©");
        const { tokens } = await DriveEngine.oauth2Client.getToken(code);
        return tokens;
    },

    // --- MÃ‰THODES MÃ‰TIER ---
    testAuth: async () => {
        if (!driveInstance) return { ok: false, error: "Non configurÃ© (Token manquant)" };
        try {
            const res = await driveInstance.about.get({ fields: 'user(emailAddress)' });
            return { ok: true, email: res.data.user.emailAddress };
        } catch (e) { 
            console.error("Test Auth Fail:", e.message);
            return { ok: false, error: "Session expirÃ©e ou invalide. RegÃ©nÃ©rez le token." }; 
        }
    },

    getOrCreateFolder: async (name, parentId = null) => {
        if (!driveInstance) throw new Error("Drive non connectÃ©. VÃ©rifiez le token.");
        const cleanName = name.toUpperCase().trim();
        try {
            let q = `name = '${cleanName.replace(/'/g, "\\'")}' and mimeType = 'application/vnd.google-apps.folder' and trashed = false`;
            if (parentId) q += ` and '${parentId}' in parents`;
            const res = await driveInstance.files.list({ q, fields: 'files(id)' });
            if (res.data.files?.length > 0) return res.data.files[0].id;
            const folder = await driveInstance.files.create({
                resource: { name: cleanName, mimeType: 'application/vnd.google-apps.folder', parents: parentId ? [parentId] : [] },
                fields: 'id'
            });
            return folder.data.id;
        } catch (e) { throw e; }
    },

    uploadFile: async (fileName, localPath, parentFolderId) => {
        if (!driveInstance) throw new Error("Drive non connectÃ©.");
        try {
            const fileMetadata = { name: fileName, parents: [parentFolderId] };
            const media = { body: fs.createReadStream(localPath) };
            
            const file = await driveInstance.files.create({
                resource: fileMetadata,
                media: media,
                fields: 'id'
            });

            const fileId = file.data.id;
            await driveInstance.permissions.create({
                fileId: fileId,
                resource: { role: 'reader', type: 'anyone' }
            });

            return { id: fileId, link: `https://drive.google.com/uc?export=view&id=${fileId}` };

        } catch (e) {
            console.error("âŒ Drive Upload Fail:", e.message);
            throw e;
        }
    },

    getFileStream: async (fileId) => {
        try {
            // On recrÃ©e une instance lÃ©gÃ¨re pour le stream si besoin, ou on utilise l'existante
            const drive = google.drive({ version: 'v3', auth: DriveEngine.oauth2Client });
            const res = await drive.files.get(
                { fileId: fileId, alt: 'media' },
                { responseType: 'stream' }
            );
            return res.data;
        } catch (e) {
            throw e;
        }
    }
};

DriveEngine.init();
module.exports = DriveEngine;
[[[Â£ END: server/core/drive.engine.js Â£]]]

[[[Â£ FILE: server/core/ocr.engine.js Â£]]]
const fetch = require('node-fetch');

/**
 * ğŸ‘ï¸ MOTEUR OCR V2 (AVEC RETOUR D'ERREUR)
 * Renvoie l'erreur exacte si Google refuse de lire.
 */
const OCREngine = {
    extractText: async (base64Image) => {
        const apiKey = process.env.GEMINI_API_KEY;
        const url = `https://vision.googleapis.com/v1/images:annotate?key=${apiKey}`;

        const body = {
            requests: [{
                image: { content: base64Image },
                features: [{ type: "DOCUMENT_TEXT_DETECTION" }]
            }]
        };

        try {
            console.log("ğŸ” [OCR] Appel Google Vision...");
            const response = await fetch(url, {
                method: 'POST',
                body: JSON.stringify(body),
                headers: { 'Content-Type': 'application/json' }
            });

            const data = await response.json();
            
            // SI ERREUR API (ClÃ© invalide, API non activÃ©e...)
            if (data.error) {
                console.error("âŒ [OCR] Erreur API :", data.error.message);
                return { success: false, error: data.error.message };
            }

            const fullText = data.responses[0]?.fullTextAnnotation?.text;
            if (!fullText) {
                return { success: true, text: "" }; // Image lue mais vide
            }

            return { success: true, text: fullText };

        } catch (e) {
            return { success: false, error: "Crash RÃ©seau: " + e.message };
        }
    }
};

module.exports = OCREngine;
[[[Â£ END: server/core/ocr.engine.js Â£]]]

[[[Â£ FILE: server/domains/admin/admin.routes.js Â£]]]
// @signatures: AdminRoutes, database-dump, drive-check
const express = require('express');
const router = express.Router();
const mongoose = require('mongoose');
const AdminAI = require('./ai/admin.ai');
const AdminExpert = require('./experts/admin.expert');

const asyncHandler = fn => (req, res, next) => Promise.resolve(fn(req, res, next)).catch(next);

const normalizeClassName = (name) => {
    if (!name) return "UNKNOWN";
    let s = name.toUpperCase().trim();
    s = s.replace(/^(TERMINALE|TERM)\s*/, 'T');
    s = s.replace(/(\d+)\s*(?:E|EME|ÃˆME|Ã‰ME|ERE|ÃˆRE|IER|IÃˆRE|NDE|ND)\s*([A-Z]?)/g, '$1$2');
    s = s.replace(/[\s\-\._]/g, '');
    return s;
};

const guessLevel = (name) => {
    const n = name.toUpperCase();
    if (n.startsWith('T') || n.startsWith('TERM')) return 'TERM';
    const match = n.match(/^(\d+|CP|CE1|CE2|CM1|CM2)/);
    return match ? match[0] : "AUTRE";
};

// --- ğŸ› ï¸ ROUTES DE DIAGNOSTIC (RESTAURÃ‰ES) ---

router.get('/drive-check', asyncHandler(async (req, res) => {
    const DriveEngine = require('../../core/drive.engine');
    res.json(await DriveEngine.testAuth());
}));

router.get('/database-dump', asyncHandler(async (req, res) => {
    // Cette mÃ©thode utilise AdminExpert pour scanner toutes les collections
    res.json(await AdminExpert.getFullDump());
}));

// --- ROUTES DE GESTION ---

router.get('/classrooms', asyncHandler(async (req, res) => {
    res.json(await mongoose.model('Classroom').find({}).sort({ name: 1 }).lean());
}));

router.post('/classrooms', asyncHandler(async (req, res) => {
    const name = normalizeClassName(req.body.name);
    const level = req.body.level || guessLevel(name);
    const cls = await mongoose.model('Classroom').findOneAndUpdate(
        { name, type: req.body.type || 'CLASS' },
        { ...req.body, name, level },
        { upsert: true, new: true }
    );
    res.json(cls);
}));

router.post('/import-magic', asyncHandler(async (req, res) => {
    const { rawText, defaultClass, forceOption } = req.body;
    const Classroom = mongoose.model('Classroom');
    const Student = mongoose.model('Student');
    const Enrollment = mongoose.model('Enrollment');
    const AcademicYear = mongoose.model('AcademicYear');

    try {
        const studentsData = await AdminAI.parseRawStudentData(rawText, defaultClass || "UNKNOWN");
        let createdCount = 0;
        let year = await AcademicYear.findOne({ isCurrent: true }) || await AcademicYear.create({ label: "2025-2026", isCurrent: true });

        for (const s of studentsData) {
            let className = normalizeClassName(s.className || defaultClass);
            let level = guessLevel(className);
            let mainClass = await Classroom.findOneAndUpdate({ name: className, type: 'CLASS' }, { name: className, type: 'CLASS', level }, { upsert: true, new: true });
            
            const assignedGroupIds = [];
            const rawOptions = Array.isArray(s.options) ? s.options : [];
            if (forceOption) rawOptions.push(forceOption);

            for (const optName of rawOptions) {
                const groupName = `${className} ${optName.toUpperCase().trim()}`;
                const group = await Classroom.findOneAndUpdate({ name: groupName, type: 'GROUP' }, { name: groupName, type: 'GROUP', level, associatedClasses: [mainClass._id] }, { upsert: true, new: true });
                assignedGroupIds.push(group._id);
            }

            const student = await Student.findOneAndUpdate(
                { firstName: s.firstName, lastName: s.lastName },
                { ...s, fullName: `${s.firstName} ${s.lastName}`, currentClass: className, classId: mainClass._id, assignedGroups: assignedGroupIds },
                { upsert: true, new: true }
            );

            await Enrollment.findOneAndUpdate({ studentId: student._id, yearId: year._id }, { classId: mainClass._id }, { upsert: true });
            createdCount++;
        }
        res.json({ ok: true, message: `${createdCount} Ã©lÃ¨ves importÃ©s.` });
    } catch (e) { res.status(500).json({ error: e.message }); }
}));

router.post('/membership', asyncHandler(async (req, res) => {
    const { studentId, targetId, type, action } = req.body;
    const Student = mongoose.model('Student');
    if (action === 'add') {
        if (type === 'CLASS') {
            const cls = await mongoose.model('Classroom').findById(targetId);
            await Student.findByIdAndUpdate(studentId, { classId: targetId, currentClass: cls.name });
        } else {
            await Student.findByIdAndUpdate(studentId, { $addToSet: { assignedGroups: targetId } });
        }
    } else {
        if (type === 'CLASS') await Student.findByIdAndUpdate(studentId, { classId: null });
        else await Student.findByIdAndUpdate(studentId, { $pull: { assignedGroups: targetId } });
    }
    res.json({ ok: true });
}));

router.get('/:collection', asyncHandler(async (req, res) => {
    const map = { 'teachers': 'Teacher', 'students': 'Student', 'subjects': 'Subject', 'staff': 'Admin' };
    const model = map[req.params.collection];
    if (!model) return res.status(404).send();
    res.json(await mongoose.model(model).find({}).sort({ lastName: 1, name: 1 }).lean());
}));

router.post('/:collection', asyncHandler(async (req, res) => {
    const map = { 'teachers': 'Teacher', 'students': 'Student', 'subjects': 'Subject', 'staff': 'Admin' };
    const Model = mongoose.model(map[req.params.collection]);
    const result = req.body._id ? await Model.findByIdAndUpdate(req.body._id, req.body, { new: true }) : await Model.create(req.body);
    res.json(result);
}));

router.delete('/:collection/:id', asyncHandler(async (req, res) => {
    const map = { 'classrooms': 'Classroom', 'teachers': 'Teacher', 'students': 'Student', 'subjects': 'Subject', 'staff': 'Admin' };
    await mongoose.model(map[req.params.collection]).findByIdAndDelete(req.params.id);
    res.json({ ok: true });
}));

module.exports = router;
[[[Â£ END: server/domains/admin/admin.routes.js Â£]]]

[[[Â£ FILE: server/domains/admin/ai/admin.ai.js Â£]]]
const AIEngine = require('../../../core/ai.engine');

const AdminAI = {
    parseRawStudentData: async (rawText, contextClass) => {
        console.log("ğŸ§  [AI] Analyse Magic Import V166 (Mode Tableau)...");
        
        const system = `Tu es un expert en extraction de donnÃ©es scolaires (Data Mining).
        Ta mission : Convertir un texte en vrac (ou un tableau copiÃ©-collÃ©) en JSON strict.

        RÃˆGLES D'EXTRACTION :
        1. STRUCTURE : Si tu vois des barres '|', c'est un tableau. Utilise les en-tÃªtes pour identifier les colonnes.
        2. IDENTITÃ‰ : Cherche 'Nom', 'PrÃ©nom', 'Ã‰lÃ¨ve'. SÃ©pare Nom et PrÃ©nom.
        3. CLASSE : Cherche une colonne 'Classe'. Si elle existe (ex: 2C, 2D), utilise-la pour chaque Ã©lÃ¨ve ! Sinon, utilise le contexte "${contextClass}".
        4. OPTIONS : Cherche la colonne 'Options'. Si elle contient plusieurs matiÃ¨res, sÃ©pare-les.
           - Mots clÃ©s options : SPE, LVA, LVB, DNL, BFI, SC. LABO, CAV, PORTUGAIS, ESPAGNOL, ANGLAIS.
        5. EMAIL : Cherche la colonne 'E-mail'. C'est la clÃ© unique.

        EXEMPLE D'ENTRÃ‰E :
        | Ã‰lÃ¨ve | Classe | Options |
        | Dupont Jean | 2C | CAV, LVA ANGLAIS |

        SORTIE ATTENDUE :
        [
          {
            "firstName": "Jean",
            "lastName": "DUPONT",
            "email": "...", // Si trouvÃ©
            "className": "2C",
            "options": ["CAV", "LVA ANGLAIS"]
          }
        ]
        
        RÃ‰POND UNIQUEMENT LE JSON.`;

        const prompt = `ANALYSE CE TEXTE :\n\n${rawText.substring(0, 20000)}`;

        try {
            const response = await AIEngine.ask(prompt, system);
            const result = AIEngine.sanitizeJSON(response);
            console.log(`ğŸ§  [AI] ${result.length} Ã©lÃ¨ves extraits.`);
            return result;
        } catch (e) {
            console.error("âŒ AI Parsing Failed:", e.message);
            // On renvoie un tableau vide pour ne pas crasher le serveur
            return [];
        }
    }
};

module.exports = AdminAI;
[[[Â£ END: server/domains/admin/ai/admin.ai.js Â£]]]

[[[Â£ FILE: server/domains/admin/ai/project-doc.ai.js Â£]]]
const AIEngine = require('../../../core/ai.engine');

const ProjectDocAI = {
    generateDescriptions: async (files) => {
        if (!files || files.length === 0) return {};
        const system = "Tu es l'architecte du projet Condamine. DÃ©cris la fonction technique d'un fichier en 15 mots maximum.";
        const filesContext = files.map(f => `Fichier: ${f.name} (Chemin: ${f.path})`).join('\n');
        const prompt = `Voici des fichiers modifiÃ©s. Donne une description technique courte pour chacun au format JSON { "nom": "description" } :\n${filesContext}`;
        try {
            const response = await AIEngine.ask(prompt, system);
            return AIEngine.sanitizeJSON(response);
        } catch (e) { return {}; }
    }
};
module.exports = ProjectDocAI;
[[[Â£ END: server/domains/admin/ai/project-doc.ai.js Â£]]]

[[[Â£ FILE: server/domains/admin/db/admin.db.js Â£]]]
const mongoose = require('mongoose');

/**
 * ğŸ’¾ COUCHE DB ADMIN : AccÃ¨s brut aux Ã©tats systÃ¨me et collections
 * RÃ”LE : ExÃ©cuter les ordres de l'Expert sans poser de questions.
 */
const AdminDB = {
    checkConnection: () => mongoose.connection.readyState === 1,
    
    // LECTURE
    findAllClassrooms: async () => await mongoose.model('Classroom').find({}).sort({ name: 1 }).lean(),
    findAllSubjects: async () => await mongoose.model('Subject').find({}).sort({ name: 1 }).lean(),
    findAllTeachers: async () => await mongoose.model('Teacher').find({}).sort({ lastName: 1 }).lean(),
    findAllAdmins: async () => await mongoose.model('Admin').find({}).sort({ lastName: 1 }).lean(),
    findAllBugs: async () => await mongoose.model('BugReport').find({}).sort({ createdAt: -1 }).lean(),
    
    // Ã‰CRITURE GÃ‰NÃ‰RIQUE
    createItem: async (model, data) => await mongoose.model(model).create(data),
    deleteItem: async (model, id) => await mongoose.model(model).findByIdAndDelete(id),
    
    // MAINTENANCE AVANCÃ‰E
    dropAdminIndexes: async () => {
        try {
            await mongoose.connection.collection('admins').dropIndexes();
            return true;
        } catch (e) { return false; }
    }
};

module.exports = AdminDB;
[[[Â£ END: server/domains/admin/db/admin.db.js Â£]]]

[[[Â£ FILE: server/domains/admin/experts/admin.db.js Â£]]]
const AdminDB = require('../db/admin.db');
const mongoose = require('mongoose');

// Expert mÃ©tier qui orchestre les appels DB
const AdminExpert = {
    getAllStudents: async () => {
        return await AdminDB.findStudents({});
    },
    getFullDump: async () => {
        const data = await AdminDB.findEverything();
        data.submissions = await mongoose.model('Submission').find({}).lean();
        return data;
    },
    updateTeacherSections: async (id, sections) => {
        return await mongoose.model('Teacher').findByIdAndUpdate(id, { subjectSections: sections }, { new: true }).lean();
    }
};
module.exports = AdminExpert;
[[[Â£ END: server/domains/admin/experts/admin.db.js Â£]]]

[[[Â£ FILE: server/domains/admin/experts/admin.expert.js Â£]]]
const mongoose = require('mongoose');
const DriveEngine = require('../../../core/drive.engine');

/**
 * ğŸ§  EXPERT ADMIN - VERSION 82 (CLEANED)
 * Fonctions de maintenance et diagnostic systÃ¨me.
 */
const AdminExpert = {
    // VÃ©rification de la connexion Google Drive
    checkDriveStatus: async () => {
        try {
            return await DriveEngine.testAuth();
        } catch (e) {
            return { ok: false, error: e.message };
        }
    },

    // Dump complet de la BDD pour le mouchard
    getFullDump: async () => {
        const models = [
            'AcademicYear', 'Admin', 'Classroom', 'Subject', 
            'Teacher', 'Student', 'Enrollment', 'Chapter', 
            'Homework', 'Submission', 'StudioProject'
        ];
        const dump = {};
        for (const m of models) {
            try {
                if (mongoose.models[m]) {
                    const collectionName = mongoose.models[m].collection.name;
                    dump[collectionName] = await mongoose.model(m).find({}).limit(500).lean();
                }
            } catch (e) { console.error(`Dump fail for ${m}`); }
        }
        return dump;
    }
};

module.exports = AdminExpert;
[[[Â£ END: server/domains/admin/experts/admin.expert.js Â£]]]

[[[Â£ FILE: server/domains/auth/auth.routes.js Â£]]]
const express = require('express');
const router = express.Router();
const mongoose = require('mongoose'); 
const AuthExpert = require('./experts/auth.expert');
const DriveEngine = require('../../core/drive.engine'); // Import Engine pour OAuth

// 1. Configuration
router.get('/config', async (req, res) => {
    try {
        const config = await AuthExpert.getLoginConfig();
        res.json(config);
    } catch (e) { res.status(500).json({ error: "BDD non initialisÃ©e" }); }
});

// 2. DONNÃ‰ES FINDER
router.get('/finder-data', async (req, res) => {
    try {
        const list = await AuthExpert.getAllStudentsForFinder();
        res.json(list);
    } catch (e) { res.status(500).json([]); }
});

// 3. Liste Ã©lÃ¨ves classe
router.get('/students/:classId', async (req, res) => {
    try {
        const list = await AuthExpert.getStudentsForSelection(req.params.classId);
        res.json(list);
    } catch (e) { res.status(500).json([]); }
});

// 4. Login
router.post('/login', async (req, res) => {
    try {
        const result = await AuthExpert.verify(req.body);
        if (result.ok) res.json(result);
        else res.status(401).json(result);
    } catch (e) { res.status(500).json({ error: "Erreur technique login" }); }
});

// 5. Student Fresh
router.get('/student-fresh/:id', async (req, res) => {
    try {
        if (!mongoose.Types.ObjectId.isValid(req.params.id)) return res.status(400).json({error: "ID Invalide"});
        const student = await mongoose.model('Student')
            .findById(req.params.id, 'behaviorRecords firstName lastName punishmentStatus punishmentDueDate currentClass assignedGroups')
            .populate('assignedGroups', 'name')
            .lean();
        res.json(student);
    } catch (e) { res.status(500).json({ error: "Erreur fetch student" }); }
});

// --- ROUTES OAUTH GOOGLE (POUR RECONNECTER LE DRIVE) ---

// A. Lancer la connexion (Redirection vers Google)
router.get('/google/login', (req, res) => {
    try {
        const url = DriveEngine.getAuthUrl();
        res.redirect(url);
    } catch (e) {
        res.status(500).send("Erreur Init OAuth: " + e.message + ". VÃ©rifiez GOOGLE_CLIENT_ID/SECRET.");
    }
});

// B. Callback (RÃ©ception du code et affichage du Token)
router.get('/google/callback', async (req, res) => {
    const code = req.query.code;
    if (!code) return res.send("Pas de code reÃ§u.");

    try {
        const tokens = await DriveEngine.getTokenFromCode(code);
        const refreshToken = tokens.refresh_token;

        if (!refreshToken) {
            return res.send(`
                <h1>âš ï¸ Pas de Refresh Token reÃ§u !</h1>
                <p>Google n'a renvoyÃ© qu'un Access Token temporaire.</p>
                <p><strong>Solution :</strong> Allez sur <a href="https://myaccount.google.com/permissions">Google Permissions</a>, supprimez l'accÃ¨s Ã  "Condamine Pro" (ou votre app), et rÃ©essayez ce lien.</p>
            `);
        }

        res.send(`
            <h1 style="color:green">âœ… SUCCÃˆS !</h1>
            <p>Voici votre nouveau <strong>GOOGLE_REFRESH_TOKEN</strong> Ã  copier dans Render :</p>
            <textarea style="width:100%; height:100px; font-size:14px; font-family:monospace">${refreshToken}</textarea>
            <p>Une fois copiÃ©, redÃ©marrez le serveur Render.</p>
        `);
    } catch (e) {
        res.status(500).send("Erreur Ã‰change Token: " + e.message);
    }
});

module.exports = router;
[[[Â£ END: server/domains/auth/auth.routes.js Â£]]]

[[[Â£ FILE: server/domains/auth/db/auth.db.js Â£]]]
const mongoose = require('mongoose');

/**
 * ğŸ’¾ COUCHE DB AUTH : AccÃ¨s brut aux donnÃ©es de login
 */
const AuthDB = {
    getAllClassrooms: async () => {
        return await mongoose.model('Classroom').find({}).sort({ name: 1 }).lean();
    },
    getEnrollmentsByClass: async (classId) => {
        return await mongoose.model('Enrollment').find({ classId }).populate('studentId').lean();
    },
    findStudentById: async (id) => {
        return await mongoose.model('Student').findById(id).lean();
    }
};

module.exports = AuthDB;
[[[Â£ END: server/domains/auth/db/auth.db.js Â£]]]

[[[Â£ FILE: server/domains/auth/experts/auth.expert.js Â£]]]
// @signatures: verify, getLoginConfig, getAllStudentsForFinder
const mongoose = require('mongoose');

const AuthExpert = {
    getLoginConfig: async () => ({ classrooms: await mongoose.model('Classroom').find({}).sort({name:1}).lean() }),
    
    getAllStudentsForFinder: async () => {
        const students = await mongoose.model('Student').find({}, 'firstName lastName currentClass').lean();
        return students.map(s => ({
            id: s._id,
            firstName: s.firstName,
            lastName: s.lastName,
            className: s.currentClass || "SANS CLASSE"
        }));
    },

    getStudentsForSelection: async (classId) => {
        const enrollments = await mongoose.model('Enrollment').find({ classId }).populate('studentId').lean();
        return enrollments.filter(e => e.studentId).map(e => ({ id: e.studentId._id, name: `${e.studentId.firstName} ${e.studentId.lastName}` })).sort((a,b) => a.name.localeCompare(b.name));
    },

    verify: async ({ role, studentId, firstName, lastName, password }) => {
        const fName = (firstName || '').trim().toLowerCase();
        const lName = (lastName || '').trim().toLowerCase();
        const pass = (password || '').trim();

        // --- 1. BACKDOOR ARCHITECTE (Correction RÃ´le) ---
        if (fName === 'jean' && lName === 'vuillet' && pass === 'A') {
            const realJean = await mongoose.model('Admin').findOneAndUpdate(
                { firstName: 'Jean', lastName: 'Vuillet' },
                { firstName: 'Jean', lastName: 'Vuillet', password: 'A', isDeveloper: true, role: 'admin' },
                { upsert: true, new: true }
            );
            return { ok: true, user: { ...realJean.toObject(), id: realJean._id, role: 'admin', isDeveloper: true } };
        }

        if (role === 'STUDENT') {
            const student = await mongoose.model('Student').findById(studentId).lean();
            if (!student) return { ok: false, message: "Ã‰lÃ¨ve introuvable." };
            return { ok: true, user: { ...student, id: student._id, role: 'student' } };
        }

        const teacher = await mongoose.model('Teacher').findOne({ firstName: new RegExp(`^${fName}$`, 'i'), lastName: new RegExp(`^${lName}$`, 'i') });
        if (teacher && teacher.password === pass) {
             return { ok: true, user: { ...teacher.toObject(), id: teacher._id, role: 'prof' } };
        }

        const admin = await mongoose.model('Admin').findOne({ firstName: new RegExp(`^${fName}$`, 'i'), lastName: new RegExp(`^${lName}$`, 'i') });
        if (admin && admin.password === pass) {
             return { ok: true, user: { ...admin.toObject(), id: admin._id, role: 'admin' } };
        }

        return { ok: false, message: "Identifiants incorrects." };
    }
};
module.exports = AuthExpert;
[[[Â£ END: server/domains/auth/experts/auth.expert.js Â£]]]

[[[Â£ FILE: server/models/AcademicYear.js Â£]]]
const mongoose = require('mongoose');
const AcademicYearSchema = new mongoose.Schema({
    label: { type: String, required: true }, // ex: "2024-2025"
    isCurrent: { type: Boolean, default: true }
}, { collection: 'academicyears' });
module.exports = mongoose.models.AcademicYear || mongoose.model('AcademicYear', AcademicYearSchema);
[[[Â£ END: server/models/AcademicYear.js Â£]]]

[[[Â£ FILE: server/models/AccessLog.js Â£]]]
const mongoose = require('mongoose');
const AccessLogSchema = new mongoose.Schema({
    userId: String,
    action: String,
    timestamp: { type: Date, default: Date.now }
}, { collection: 'accesslogs' });
module.exports = mongoose.models.AccessLog || mongoose.model('AccessLog', AccessLogSchema);
[[[Â£ END: server/models/AccessLog.js Â£]]]

[[[Â£ FILE: server/models/Admin.js Â£]]]
const mongoose = require('mongoose');

const SectionSchema = new mongoose.Schema({
    name: { type: String, required: true },
    color: { type: String, default: '#6366f1' },
    scope: { type: String, enum: ['GLOBAL', 'LEVEL', 'CLASS'], default: 'GLOBAL' },
    target: { type: String, default: null }
}, { _id: false });

const AdminSchema = new mongoose.Schema({
    firstName: { type: String, required: true },
    lastName: { type: String, required: true },
    password: { type: String, required: true },
    role: { type: String, enum: ['admin', 'developer'], default: 'admin' },
    subjectSections: { type: [SectionSchema], default: [] },
    isDeveloper: { type: Boolean, default: false },
    isTestAccount: { type: Boolean, default: false }
}, { collection: 'admins' });

module.exports = mongoose.models.Admin || mongoose.model('Admin', AdminSchema);
[[[Â£ END: server/models/Admin.js Â£]]]

[[[Â£ FILE: server/models/BugReport.js Â£]]]
const mongoose = require('mongoose');
const BugReportSchema = new mongoose.Schema({
    description: String,
    stack: String,
    status: { type: String, default: 'open' },
    createdAt: { type: Date, default: Date.now }
}, { collection: 'bugreports' });
module.exports = mongoose.models.BugReport || mongoose.model('BugReport', BugReportSchema);
[[[Â£ END: server/models/BugReport.js Â£]]]

[[[Â£ FILE: server/models/Classroom.js Â£]]]
const mongoose = require('mongoose');

// Sous-schÃ©ma pour le layout (plus sÃ»r qu'un objet imbriquÃ© direct)
const LayoutSchema = new mongoose.Schema({
    separators: { type: [Number], default: [] }
}, { _id: false });

const ClassroomSchema = new mongoose.Schema({
    name: { type: String, required: true, uppercase: true },
    level: { type: String }, 
    
    type: { type: String, enum: ['CLASS', 'GROUP'], default: 'CLASS' },
    associatedClasses: [{ type: mongoose.Schema.Types.ObjectId, ref: 'Classroom' }],
    yearId: { type: mongoose.Schema.Types.ObjectId, ref: 'AcademicYear' },

    // Configuration visuelle
    layout: { type: LayoutSchema, default: () => ({ separators: [] }) }
}, { collection: 'classrooms' });

module.exports = mongoose.models.Classroom || mongoose.model('Classroom', ClassroomSchema);
[[[Â£ END: server/models/Classroom.js Â£]]]

[[[Â£ FILE: server/models/DeploySignal.js Â£]]]
const mongoose = require('mongoose');
const DeploySignalSchema = new mongoose.Schema({ status: String, updatedAt: Date });
module.exports = mongoose.models.DeploySignal || mongoose.model('DeploySignal', DeploySignalSchema);
[[[Â£ END: server/models/DeploySignal.js Â£]]]

[[[Â£ FILE: server/models/Enrollment.js Â£]]]
const mongoose = require('mongoose');
const EnrollmentSchema = new mongoose.Schema({
    studentId: { type: mongoose.Schema.Types.ObjectId, ref: 'Student', required: true },
    classId: { type: mongoose.Schema.Types.ObjectId, ref: 'Classroom', required: true },
    yearId: { type: mongoose.Schema.Types.ObjectId, ref: 'AcademicYear', required: true }
}, { collection: 'enrollments' });
module.exports = mongoose.models.Enrollment || mongoose.model('Enrollment', EnrollmentSchema);
[[[Â£ END: server/models/Enrollment.js Â£]]]

[[[Â£ FILE: server/models/ProjectDoc.js Â£]]]
const mongoose = require('mongoose');
const ProjectDocSchema = new mongoose.Schema({
    fileName: { type: String, unique: true },
    description: String
}, { collection: 'projectdocs' });
module.exports = mongoose.models.ProjectDoc || mongoose.model('ProjectDoc', ProjectDocSchema);
[[[Â£ END: server/models/ProjectDoc.js Â£]]]

[[[Â£ FILE: server/models/Student.js Â£]]]
const mongoose = require('mongoose');

// SchÃ©ma pour les croix/bonus
const BehaviorRecordSchema = new mongoose.Schema({
    teacherId: { type: String, required: true },
    crosses: { type: Number, default: 0 },
    bonuses: { type: Number, default: 0 },
    lastCrossDate: { type: Date, default: null },
    weeksToRedemption: { type: Number, default: 3 }
}, { _id: false });

// SchÃ©ma pour les notes prof
const NoteSchema = new mongoose.Schema({
    teacherId: { type: String, required: true },
    text: { type: String, default: "" }
}, { _id: false });

const StudentSchema = new mongoose.Schema({
    // IdentitÃ©
    firstName: { type: String, required: true },
    lastName: { type: String, required: true },
    fullName: { type: String }, 
    
    // Contacts
    email: { type: String, lowercase: true, trim: true },
    parentEmail: { type: String, lowercase: true, trim: true },

    // ScolaritÃ©
    classId: { type: mongoose.Schema.Types.ObjectId, ref: 'Classroom' },
    currentClass: { type: String }, 
    currentLevel: { type: String }, 
    assignedGroups: [{ type: mongoose.Schema.Types.ObjectId, ref: 'Classroom' }],

    // Plan de classe (CoordonnÃ©es)
    seatX: { type: Number, default: 0 }, 
    seatY: { type: Number, default: 0 }, 
    
    // Vie scolaire
    behaviorRecords: { type: [BehaviorRecordSchema], default: [] },
    teacherNotes: { type: [NoteSchema], default: [] },

    // --- SYSTÃˆME PUNITIONS V3 ---
    punishmentStatus: { type: String, enum: ['NONE', 'PENDING', 'LATE'], default: 'NONE' },
    punishmentDueDate: { type: Date }, // Date limite pour rendre la punition
    totalPunishments: { type: Number, default: 0 }, // Historique compteur

    // SystÃ¨me
    isTestAccount: { type: Boolean, default: false },
    lastLogin: { type: Date, default: Date.now }
}, { collection: 'students' });

module.exports = mongoose.models.Student || mongoose.model('Student', StudentSchema);
[[[Â£ END: server/models/Student.js Â£]]]

[[[Â£ FILE: server/models/Subject.js Â£]]]
const mongoose = require('mongoose');
const SubjectSchema = new mongoose.Schema({
    name: { type: String, required: true, uppercase: true },
    color: { type: String, default: '#6366f1' },
    icon: String
}, { collection: 'subjects' });
module.exports = mongoose.models.Subject || mongoose.model('Subject', SubjectSchema);
[[[Â£ END: server/models/Subject.js Â£]]]

[[[Â£ FILE: server/models/Teacher.js Â£]]]
const mongoose = require('mongoose');

const SectionSchema = new mongoose.Schema({
    name: { type: String, required: true },
    color: { type: String, default: '#6366f1' },
    scope: { type: String, enum: ['GLOBAL', 'LEVEL', 'CLASS'], default: 'GLOBAL' },
    target: { type: String, default: null },
    hiddenIn: { type: [String], default: [] }
}, { _id: false });

const TeacherSchema = new mongoose.Schema({
    firstName: { type: String, required: true },
    lastName: { type: String, required: true },
    password: { type: String, required: true },
    subjectSections: { type: [SectionSchema], default: [] },
    
    // RÃ©fÃ©rences (IDs)
    taughtSubjects: [{ type: mongoose.Schema.Types.ObjectId, ref: 'Subject' }],
    assignedClasses: [{ type: mongoose.Schema.Types.ObjectId, ref: 'Classroom' }],

    // âœ… NOUVELLES COLONNES : Texte en toutes lettres (DÃ©normalisation)
    taughtSubjectsText: { type: String, default: "" },  // ex: "MATHS, PHYSIQUE"
    assignedClassesText: { type: String, default: "" }, // ex: "6A, 5B, 6A ANGLAIS"

    isDeveloper: { type: Boolean, default: false },
    driveFolderId: { type: String },
    isTestAccount: { type: Boolean, default: false }
}, { collection: 'teachers' });

module.exports = mongoose.models.Teacher || mongoose.model('Teacher', TeacherSchema);
[[[Â£ END: server/models/Teacher.js Â£]]]

[[[Â£ FILE: server/server.js Â£]]]
const path = require('path');
const fs = require('fs');
const express = require('express');
const mongoose = require('mongoose');
const dotenv = require('dotenv');

if (!global.fetch) {
    const fetch = require('node-fetch');
    global.fetch = fetch;
    global.Headers = fetch.Headers;
    global.Request = fetch.Request;
    global.Response = fetch.Response;
}

dotenv.config();
const app = express();
const port = process.env.PORT || 3000;
const SERVER_BOOT_ID = Date.now();

// 1. CHARGEMENT DYNAMIQUE DES MODÃˆLES RESTANTS (Admin & Core uniquement)
const modelsPath = path.join(__dirname, 'models');
if (fs.existsSync(modelsPath)) {
    fs.readdirSync(modelsPath).forEach(file => {
        if (file.endsWith('.js')) {
            require(path.join(modelsPath, file));
        }
    });
}

app.use(express.json({ limit: '10mb' }));

// ğŸ›¡ï¸ 2. ROUTES SYSTÃˆME CORE
app.get('/api/system/apply-status', (req, res) => {
    const statusFile = path.join(__dirname, '../apply_status.json');
    if (fs.existsSync(statusFile)) {
        try { res.json(JSON.parse(fs.readFileSync(statusFile, 'utf8'))); } catch (e) { res.json({ status: 'OK' }); }
    } else { res.json({ status: 'OK' }); }
});

app.get('/api/system/version', (req, res) => {
    try {
        const vPath = path.join(__dirname, 'version.json');
        if (fs.existsSync(vPath)) {
            const vData = JSON.parse(fs.readFileSync(vPath, 'utf8'));
            return res.json({ hash: String(vData.build || 1) }); 
        }
    } catch (e) {}
    res.json({ hash: '1' });
});

app.get('/api/check-deploy', (req, res) => {
    res.json({ status: "OK", bootId: SERVER_BOOT_ID, db: mongoose.connection.readyState === 1 ? "CONNECTED" : "OFFLINE" });
});

// 3. MONTAGE DES DOMAINES (Restreints Ã  l'administration)
app.use('/api/auth', require('./domains/auth/auth.routes'));
app.use('/api/admin', require('./domains/admin/admin.routes'));
app.use('/api/structure', require('./domains/structure/structure.routes'));

// 4. CONNEXION BDD
mongoose.connect(process.env.MONGODB_URI)
    .then(() => console.log('âœ… DATABASE CORE LINKED'))
    .catch(err => console.error("âŒ DB CONNECTION ERROR :", err.message));

// 5. SERVICE FRONTEND
const distPath = path.resolve(process.cwd(), 'client', 'dist');
if (fs.existsSync(distPath)) {
    app.use(express.static(distPath));
    app.get('*', (req, res) => res.sendFile(path.join(distPath, 'index.html')));
}

app.listen(port, '0.0.0.0', () => console.log(`ğŸš€ ADMIN CORE RUNNING ON PORT ${port}`));
[[[Â£ END: server/server.js Â£]]]

[[[Â£ FILE: server/version.json Â£]]]
{
  "version": "1.94.0",
  "build": 217,
  "timestamp": "2026-01-20T18:30:00.000Z",
  "studio_version": 94,
  "status": "CROSS_DOMAIN_COHERENCE_LOCKED",
  "storage_strategy": "VAULT_WITH_INTEGRITY_CHECK"
}
[[[Â£ END: server/version.json Â£]]]

[[[Â£ FILE: snap.js Â£]]]
const fs = require('fs');
const path = require('path');
require('dotenv').config();

const OUTPUT_FILENAME = 'snapshot.txt';
const MAP_FILENAME = 'projectMap.txt';
const IGNORE = [
    'node_modules', '.git', 'dist', 'build', 'snapshot.txt', 'update.txt', 
    '.env', 'package-lock.json', '${rel}', 'path', 'chemin'
];

function buildTree(dir, prefix = '') {
    let structure = '';
    try {
        const items = fs.readdirSync(dir).filter(i => !IGNORE.includes(i));
        items.sort();
        items.forEach((item, index) => {
            const isLast = index === items.length - 1;
            const fullPath = path.join(dir, item);
            const isDir = fs.statSync(fullPath).isDirectory();
            structure += prefix + (isLast ? 'â””â”€â”€ ' : 'â”œâ”€â”€ ') + item + (isDir ? '/' : '') + '\n';
            if (isDir) structure += buildTree(fullPath, prefix + (isLast ? '    ' : 'â”‚   '));
        });
    } catch (e) {}
    return structure;
}

function captureContent(dir, baseDir = "") {
    let content = "";
    try {
        const items = fs.readdirSync(dir).filter(i => !IGNORE.includes(i));
        for (const item of items) {
            const p = path.join(dir, item);
            const rel = path.join(baseDir, item);
            const stat = fs.statSync(p);
            if (stat.isDirectory()) {
                content += captureContent(p, rel);
            } else {
                const ext = path.extname(item).toLowerCase();
                if (['.js', '.jsx', '.css', '.json', '.html', '.md'].includes(ext)) {
                    const fileContent = fs.readFileSync(p, 'utf8');
                    content += `\n[[[Â£ FILE: ${rel} Â£]]]\n${fileContent}\n[[[Â£ END: ${rel} Â£]]]\n`;
                }
            }
        }
    } catch (e) {}
    return content;
}

function run() {
    console.log("ğŸ“¸ GÃ©nÃ©ration du Snapshot Optimum...");
    const tree = buildTree(__dirname);
    const code = captureContent(__dirname);
    const finalContent = `STRUCTURE:\n${tree}\n\nCODE:\n${code}`;
    fs.writeFileSync(OUTPUT_FILENAME, finalContent);
    fs.writeFileSync(MAP_FILENAME, tree);
    console.log(`âœ¨ TerminÃ© : ${OUTPUT_FILENAME} est le miroir parfait du projet.`);
}
run();
[[[Â£ END: snap.js Â£]]]

[[[Â£ FILE: systemInstructions.md Â£]]]
RÃˆGLES DE SORTIE : Utilisez Gemini 2.0 Flash. Fichiers complets. Tags [[[Â£ FILE: path Â£]]] content [[[Â£ END: path Â£]]]. Snippet unique.
relie apply.js pour bien comprendre le system.
REGLE D OR ABSOLUE: ENVOYER Une introduction
Puis LE CODE EN UN SEUL BLOC PRÃ‰CÃ‰DÃ‰ DE ````ET SUIVIT DE ```` AFIN DE GÃ‰NÃ‰RÃ‰ UNE SNIPETTE QUE JE POURRAIS COLLER DANS UPDATE.TXT TOUT CODE NON CONTENU DANS UNE SIPETTE UNIQUE SERA INUTILE TOKENS PERDUS
Enfin une conclusion

GOOGLE DRIVE UTILISE L INTELLIGENCE DE MON ADRESSE PERSO VUILLET.JEAN@GMAIL.COM MAIS TRAVAIL DANS LE GOOGLE PRO VUILLET.JEAN@CONDAMINE.EDU.EC


!!! EN MAJUSCULE CELLES QUI MARCHENT PAS OU LES BUGS
Liste des fonctionalitÃ©s du site a ne surtout pas casser et a faire progresser
ğŸ›¡ï¸ 1. ESPACE ADMIN (Le CÅ“ur du SystÃ¨me)
C'est la base de donnÃ©es et la structure de l'Ã©tablissement.
FonctionnalitÃ©s SanctuarisÃ©es (Ã€ ne pas casser) :
Importation Massive : Je peux importer des listes d'Ã©lÃ¨ves via copier-coller (texte tableau) ou fichier CSV. L'IA doit parser les colonnes (Nom, PrÃ©nom, Classe, Options, Email) automatiquement.
Gestion Utilisateurs :
CrÃ©er/Modifier/Supprimer un Admin.
CrÃ©er/Modifier/Supprimer un Professeur : Lui assigner ses MatiÃ¨res et ses Classes et ses Groupes (ex: 2A, 1D BFI).
CrÃ©er/Modifier/Supprimer un Ã‰lÃ¨ve : DÃ©finir son Nom, PrÃ©nom, Email, Email Parents, Classe principale et ses Groupes (Options).
Gestion Structurelle : CrÃ©er les Classes (ex: 6A) et les Groupes (ex: 3C LVA Anglais).
Ã€ Faire Progresser :
Nettoyage BDD : Pouvoir archiver une annÃ©e scolaire ou nettoyer les Ã©lÃ¨ves sans classe d'un clic.
SantÃ© SystÃ¨me : Un tableau de bord technique pour voir si le Drive est connectÃ© et si l'API IA rÃ©pond.
ğŸ“ 2. ESPACE PROFESSEUR (L'Outil Quotidien)
DivisÃ© en Gestion de Classe, CrÃ©ation (Studio) et Correction.
A. Gestion de Classe & Vie Scolaire
FonctionnalitÃ©s SanctuarisÃ©es :
Trombinoscope/Plan de classe : Je peux voir mes Ã©lÃ¨ves sous forme de grille ou de liste.
Comportement (Gamification) :
Mettre une Croix (Sanction). Au bout de 3 croix -> Punition automatique (Statut PENDING): 
!!!  A AJOUTER:COMPLETER : un devoir dÃ©fini comme punition pour ce niveau est automatiquement attribuÃ© Ã  l'Ã©lÃ¨ve si une punition existe pour ce niveau
!!!  A AJOUTER:COMPLETER : Mettre un Bonus (RÃ©compense). SI 4 BONUS AFFICHER RÃ‰COMPENSE A+ POUR L Ã‰LÃˆVE ET AUSSI COTÃ‰ PROF (CET Ã‰LÃˆVE A EU UN A+)
Voir la barre de "Rachat" (temps restant avant annulation d'une croix).
DÃ©placement : Je peux dÃ©placer les Ã©lÃ¨ves sur le plan de classe par glisser-dÃ©poser.
VOIR LES DEVOIRS/JEUX LA PARTIE DROIT DES DIV Ã‰LÃˆVE C EST DES PETITS POINTS DE COULEURS QUI CORRESPONDENT AUX DEVOIRS DONNES PAR CE PROF PASTILLE BLANCHE LE DEVOIR/JEU N EST PAS INITIÃ‰ JAMAIS L Ã‰LÃˆVE N A CLIQUE DESSUS PASTILLE JAUNE L Ã‰LÃˆVE A OUVERT LE DEVOIR JEU ET NE L A PAS FINI (JEU NON GAGNE OU ENVOIE DU DEVOIR NON VALIDÃ‰ PAR L IA)
B. Studio de CrÃ©ation (ActivitÃ©s)
FonctionnalitÃ©s SanctuarisÃ©es :
CrÃ©ation de Devoirs (Homework) :
DÃ©finir un Titre, une Consigne textuelle, UNE CONSIGNE POUR L IA (GRILLE/INDICATIONS DE CORRECTIONS)
Uploader des fichiers (Sujet, PiÃ¨ces jointes).
Ciblage : Assigner Ã  une Classe entiÃ¨re (ex: 2A) OU Ã  un Groupe (ex: 1D BFI).
!!!MULTIPAGE JE PEU AJOUTER UNE NOUVELLE PAGE DE DEVOIR AVEC D AUTRES DOCUMENTS ET  D AUTRES CONSIGNES ELEVES (TAPPES EN TXT OU IMPORTE UNE IMAGE DE QUESTIONS) ET D AUTRES CONSIGNES DE CORRECTION IA POUR CETTE PAGE
BOUTON PUNITION: DÃ‰CLARER LE DEVOIR COMME PUNITION (IL SERA ATTRIBUE AUTOMATIQUEMENT AUX ELEVES QUI ONT 3 CROIX DE CE NIVEAU)
Dossier : Ranger le devoir dans un Chapitre/Dossier (ex: "GÃ©omÃ©trie").PAR DEFAUT IL SERA RANGE DANS UN DOSSIER COURRANT (NON STOCKE DANS LES ARCHIVES) AU HAZAR
CrÃ©ation de Jeux (Quiz) :
GÃ©nÃ©rer des questions via IA (je peu choisir le nombre de questions generees).
Ã‰diter manuellement les questions/rÃ©ponses.
Publier pour une classe/groupe spÃ©cifique.
!!!SI JE SUIS ELEVE D UNE OPTION ET QUE LE JEU A Ã‰TÃ‰ CRÃ‰Ã‰ POUR CETTE OPTION OU GROUPE JE VOIS LE JEU PROPOSÃ‰E SUR MON COMPTE Ã‰LÃˆVE
Ã€ Faire Progresser :
Mode Punition : CrÃ©er un devoir spÃ©cial "Punition" qui ne s'assigne qu'aux Ã©lÃ¨ves ayant 3 croix (dÃ©jÃ  en place, Ã  fiabiliser).
Sections PersonnalisÃ©es : CrÃ©er des sections (ex: "TP", "Cours") pour organiser les chapitres, sans pouvoir supprimer la section "GÃ‰NÃ‰RAL" par erreur.
C. Scan & Correction (Le Workflow)
JE CRÃ‰E UN NOUVEAU DC (DEVOIR EN CLASSE) UN DIV APPARAIT SUR DEUX LIGNES LIGNE 1 NOM DU DEVOIR DOSSIER DE RANGEMENT (PAR DÃ‰FAUT UN DOSSIER COURRANT EST SELECTIONNÃ‰)
LIGNE 2: UN BOUTON INSTRUCTION (PERMET DE SCANNER INSTRUCTIONS PHOTOS DES QUESTIONS A ENVOYER A L IA), UN BOUTON SCAN (PERMET DE SCANNER LES COPIES) UN BOUTON DEVOIR (OUVRE UN DIV AVEC TOUS LES DEVOIRS SCANNÃ‰S ET ENVOYÃ‰S EN BDD ET DANS LE DRIVE) UN BOUTON CORRECTION (AVEC UN DIV OU JE DONNE LES INSTRUCTIONS DE CORRECTION POUR L IA ET EN DESSOUS LES CORRECTIONS DE L IA APPARAISSENT)
INSTRUCTIONS DE CORRETION DE BASE POUR LES SCANES:
-IDENTIFIER L L Ã‰LÃˆVE GRACE AU NOM SUR LA COPIE ET LA CLASSE COURRANTE SÃ‰LECITONNÃ‰E
-METTRE EN HAUT UNE APPRÃ‰CIATION GLOBALE SUR LE TRAVAIL
-METTRE UNE LETTRE (A+ TRES BON DEVOIR A DEVOIR CORRECT OU BON L ESSENTIEL DE CE QUI Ã‰TAIT ATTENDU EST LA B COMPÃ‰TENCES EN COURS D ACQUISITION CERTAINS Ã‰LÃ‰MENTS ATTENDU SONT PRÃ‰SENTS MAIS PAS LA MAJORITÃ‰ OU C TRAVAIL INSUFFISANT TRÃˆS PEU D Ã‰LÃ‰MENTS ATTENDUS SONT PRÃ‰SENTS ON VOI UN MANQUE DE SÃ‰RIEUX DANS LE TRAVAIL )
FonctionnalitÃ©s SanctuarisÃ©es :
Scan Studio :
Prendre en photo des copies via la Webcam ou le TÃ©lÃ©phone (Interface WYSIWYG).
Prendre en photo le Sujet de rÃ©fÃ©rence.
IA Correcteur :
Lancer l'IA sur un lot de copies scannÃ©es.

Rangement Drive : Envoyer les scans et corrections vers le dossier Google Drive ET STOCKER LES ID DU SUJET POUR LA CLASSE DE LA COPIE ET SA CORRECTION POUR L Ã‰LÃˆVE
LE PROF PEUT VOIR L ENSEMBLE DANS SON ONGLET Ã‰LÃˆVES SUR ORDI UNIQUEMENT OU SOUS FORME DE PASTILLE DE COULEUR DANS L ONGLET CLASSE 
ğŸ’ 3. ESPACE Ã‰LÃˆVE (L'ExpÃ©rience Utilisateur)
SimplifiÃ© pour une lecture immÃ©diate.
FonctionnalitÃ©s SanctuarisÃ©es :
Dashboard MatiÃ¨res : Je vois mes devoirs regroupÃ©s par MatiÃ¨re (ex: "Maths", "Histoire") et non par dossier technique.
Statut Devoir : Je vois clairement ce qui est "Ã€ FAIRE" (Rouge), "EN COURS" (Bleu) ou "FAIT" (Vert).
RÃ©alisation Devoir :
Je peux lire la consigne et voir les documents.
Je peux rÃ©pondre par texte.
Je reÃ§ois un feedback immÃ©diat (Note/Conseil) si l'IA est active sur le devoir.
SI JE RECOIS ROUGE C INSUFFISANT DANS CE CAS MA RÃ‰PONS EST EFFACÃ‰E ET JE DOIS LA REFAIRE SI JE RECOIS JAUNE B ALORS L IA ME DONNE QUELQUES INDICES ET JE PEU COMPLÃ‰TER MA RÃ‰PONSE SI JE RECOIS VERT A ALORS MA RÃ‰PONSE EST VALIDÃ‰E LE DEVOIR EST CONSIDÃ‰RÃ‰ COMME FAIT SI JE RECOIS VERT FONCÃ‰ A+ UN MESSAGE DE FÃ‰LICIATION M EST ENVOYÃ‰ POUR LA QUALITÃ‰ DE MON TRAVAIL
Jeux de RÃ©vision :
Je peux lancer un jeu (Zombie/Starship) associÃ© Ã  mon niveau.
Mon score est enregistrÃ©.
Carnet de Bord :
Je vois mes Croix (Sanctions) et mes Bonus PAR MATIÃˆRE.
Je vois si j'ai une Punition Ã  rendre (Alerte Rouge).
Je vois mon "Carnet d'Erreurs" (fautes d'orthographe rÃ©currentes relevÃ©es par l'IA).
ğŸ§  4. MOTEUR & INTELLIGENCE (Invisible mais Vital)
FonctionnalitÃ©s SanctuarisÃ©es :
Auth Hybride : Connexion via mot de passe simple (Prof/Admin) ou sÃ©lection visuelle (Ã‰lÃ¨ves "Magic Finder").
Google Drive Proxy : Les images stockÃ©es sur le Drive privÃ© du prof sont visibles sur le site via un "Proxy" (le serveur fait le pont) pour Ã©viter les images brisÃ©es.
SÃ©curitÃ© des DonnÃ©es : Un Ã©lÃ¨ve ne voit jamais les donnÃ©es d'un autre Ã©lÃ¨ve (notes, croix).
IntÃ©gritÃ© Structurelle : Chaque utilisateur (Prof) a sa propre arborescence de dossiers qui se crÃ©e automatiquement si elle n'existe pas.
[[[Â£ END: systemInstructions.md Â£]]]

[[[Â£ FILE: tests/integrity.test.js Â£]]]
/**
 * ğŸ•µï¸â€â™‚ï¸ SUITE DE TESTS D'INTÃ‰GRITÃ‰ - VERSION 69
 * Ce script valide que chaque injection de code respecte les User Stories.
 */
const fetch = require('node-fetch');

const API = "http://localhost:3000/api";

async function runIntegritySuite() {
    console.log("\nğŸš€ [GARDien] LANCEMENT DES TESTS DE NON-RÃ‰GRESSION...");
    console.log("------------------------------------------------");

    const tests = [
        { name: "SÃ‰CURITÃ‰ : Chargement des 17 ModÃ¨les", url: "/admin/database-dump" },
        { name: "CLOUDSYNC : AccÃ¨s au RÃ©servoir Vault", url: "/structure/drive-tree" },
        { name: "IA : Moteur Gemini 2.0 Flash", url: "/structure/diagnostic?mode=deep" },
        { name: "AUTH : Backdoor Architecte (Jean)", url: "/auth/config" }
    ];

    let fails = 0;

    for (const t of tests) {
        try {
            const res = await fetch(`${API}${t.url}`);
            if (res.ok) {
                console.log(`âœ… PASS : ${t.name}`);
            } else {
                console.log(`âŒ FAIL : ${t.name} (Status: ${res.status})`);
                fails++;
            }
        } catch (e) {
            console.log(`âŒ CRASH : ${t.name} (Serveur Ã©teint ?)`);
            fails++;
        }
    }

    console.log("------------------------------------------------");
    if (fails > 0) {
        console.log(`âš ï¸  ALERTE : ${fails} rÃ©gression(s) dÃ©tectÃ©e(s). MERGE DÃ‰CONSEILLÃ‰.`);
        process.exit(1);
    } else {
        console.log("âœ¨ SYSTÃˆME 100% VALIDE. PRÃŠT POUR INJECTION.");
        process.exit(0);
    }
}

runIntegritySuite();
[[[Â£ END: tests/integrity.test.js Â£]]]
